(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();function Sa(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Mr=/[\\\"\x00-\x1F]/g,Le={};for(var us=0;us<32;++us)Le[String.fromCharCode(us)]="\\U"+("0000"+us.toString(16)).slice(-4).toUpperCase();Le["\b"]="\\b";Le["	"]="\\t";Le[`
`]="\\n";Le["\f"]="\\f";Le["\r"]="\\r";Le['"']='\\"';Le["\\"]="\\\\";function Bn(n){return Mr.lastIndex=0,n.replace(Mr,function(e){return Le[e]})}function Li(n){switch(typeof n){case"string":return'"'+Bn(n)+'"';case"number":return isFinite(n)?n:"null";case"boolean":return n;case"object":return n===null?"null":Array.isArray(n)?Ia(n):Ea(n);default:throw new Error("Cannot stringify: "+typeof n)}}function Ia(n){for(var e="[",t="",s=0;s<n.length;++s)t+=e,e=",",t+=Li(n[s]);return e!=","?"[]":t+"]"}function Ea(n){var e="{",t="",s=Object.keys(n);s.sort();for(var i=0;i<s.length;++i){var r=s[i];t+=e+'"'+Bn(r)+'":',e=",",t+=Li(n[r])}return e!=","?"{}":t+"}"}var Kn={stringify:Li},at={};(function(){for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Uint8Array(256),t=0;t<n.length;t++)e[n.charCodeAt(t)]=t;at.encode=function(s){var i=new Uint8Array(s),r,o=i.length,a="";for(r=0;r<o;r+=3)a+=n[i[r]>>2],a+=n[(i[r]&3)<<4|i[r+1]>>4],a+=n[(i[r+1]&15)<<2|i[r+2]>>6],a+=n[i[r+2]&63];return o%3===2?a=a.substring(0,a.length-1)+"=":o%3===1&&(a=a.substring(0,a.length-2)+"=="),a},at.decode=function(s){var i=s.length*.75,r=s.length,o,a=0,l,c,h,d;s[s.length-1]==="="&&(i--,s[s.length-2]==="="&&i--);var m=new ArrayBuffer(i),p=new Uint8Array(m);for(o=0;o<r;o+=4)l=e[s.charCodeAt(o)],c=e[s.charCodeAt(o+1)],h=e[s.charCodeAt(o+2)],d=e[s.charCodeAt(o+3)],p[a++]=l<<2|c>>4,p[a++]=(c&15)<<4|h>>2,p[a++]=(h&3)<<6|d&63;return m}})();/*! @license DOMPurify 2.4.0 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/2.4.0/LICENSE */function qe(n){return qe=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},qe(n)}function yi(n,e){return yi=Object.setPrototypeOf||function(s,i){return s.__proto__=i,s},yi(n,e)}function ka(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Ms(n,e,t){return ka()?Ms=Reflect.construct:Ms=function(i,r,o){var a=[null];a.push.apply(a,r);var l=Function.bind.apply(i,a),c=new l;return o&&yi(c,o.prototype),c},Ms.apply(null,arguments)}function de(n){return Ra(n)||Ca(n)||Ta(n)||Ma()}function Ra(n){if(Array.isArray(n))return vi(n)}function Ca(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function Ta(n,e){if(!!n){if(typeof n=="string")return vi(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);if(t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set")return Array.from(n);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return vi(n,e)}}function vi(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,s=new Array(e);t<e;t++)s[t]=n[t];return s}function Ma(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var Aa=Object.hasOwnProperty,Ar=Object.setPrototypeOf,xa=Object.isFrozen,Na=Object.getPrototypeOf,Da=Object.getOwnPropertyDescriptor,se=Object.freeze,Se=Object.seal,Oa=Object.create,$n=typeof Reflect<"u"&&Reflect,Ds=$n.apply,wi=$n.construct;Ds||(Ds=function(e,t,s){return e.apply(t,s)});se||(se=function(e){return e});Se||(Se=function(e){return e});wi||(wi=function(e,t){return Ms(e,de(t))});var La=pe(Array.prototype.forEach),xr=pe(Array.prototype.pop),Lt=pe(Array.prototype.push),As=pe(String.prototype.toLowerCase),Pa=pe(String.prototype.match),Be=pe(String.prototype.replace),Va=pe(String.prototype.indexOf),Ua=pe(String.prototype.trim),Q=pe(RegExp.prototype.test),ci=Fa(TypeError);function pe(n){return function(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];return Ds(n,e,s)}}function Fa(n){return function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return wi(n,t)}}function R(n,e,t){t=t||As,Ar&&Ar(n,null);for(var s=e.length;s--;){var i=e[s];if(typeof i=="string"){var r=t(i);r!==i&&(xa(e)||(e[s]=r),i=r)}n[i]=!0}return n}function Ze(n){var e=Oa(null),t;for(t in n)Ds(Aa,n,[t])&&(e[t]=n[t]);return e}function ms(n,e){for(;n!==null;){var t=Da(n,e);if(t){if(t.get)return pe(t.get);if(typeof t.value=="function")return pe(t.value)}n=Na(n)}function s(i){return console.warn("fallback value for",i),null}return s}var Nr=se(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),hi=se(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),di=se(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Ba=se(["animate","color-profile","cursor","discard","fedropshadow","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),ui=se(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"]),Ka=se(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Dr=se(["#text"]),Or=se(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","xmlns","slot"]),mi=se(["accent-height","accumulate","additive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Lr=se(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),ps=se(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),$a=Se(/\{\{[\w\W]*|[\w\W]*\}\}/gm),ja=Se(/<%[\w\W]*|[\w\W]*%>/gm),qa=Se(/^data-[\-\w.\u00B7-\uFFFF]/),Ha=Se(/^aria-[\-\w]+$/),Wa=Se(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),za=Se(/^(?:\w+script|data):/i),Ga=Se(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),Ya=Se(/^html$/i),Ja=function(){return typeof window>"u"?null:window},Qa=function(e,t){if(qe(e)!=="object"||typeof e.createPolicy!="function")return null;var s=null,i="data-tt-policy-suffix";t.currentScript&&t.currentScript.hasAttribute(i)&&(s=t.currentScript.getAttribute(i));var r="dompurify"+(s?"#"+s:"");try{return e.createPolicy(r,{createHTML:function(a){return a},createScriptURL:function(a){return a}})}catch{return console.warn("TrustedTypes policy "+r+" could not be created."),null}};function jn(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Ja(),e=function(u){return jn(u)};if(e.version="2.4.0",e.removed=[],!n||!n.document||n.document.nodeType!==9)return e.isSupported=!1,e;var t=n.document,s=n.document,i=n.DocumentFragment,r=n.HTMLTemplateElement,o=n.Node,a=n.Element,l=n.NodeFilter,c=n.NamedNodeMap,h=c===void 0?n.NamedNodeMap||n.MozNamedAttrMap:c,d=n.HTMLFormElement,m=n.DOMParser,p=n.trustedTypes,_=a.prototype,g=ms(_,"cloneNode"),b=ms(_,"nextSibling"),S=ms(_,"childNodes"),I=ms(_,"parentNode");if(typeof r=="function"){var C=s.createElement("template");C.content&&C.content.ownerDocument&&(s=C.content.ownerDocument)}var v=Qa(p,t),k=v?v.createHTML(""):"",x=s,O=x.implementation,pt=x.createNodeIterator,la=x.createDocumentFragment,ca=x.getElementsByTagName,ha=t.importNode,ar={};try{ar=Ze(s).documentMode?s.documentMode:{}}catch{}var fe={};e.isSupported=typeof I=="function"&&O&&typeof O.createHTMLDocument<"u"&&ar!==9;var zs=$a,Gs=ja,da=qa,ua=Ha,ma=za,lr=Ga,Ys=Wa,$=null,cr=R({},[].concat(de(Nr),de(hi),de(di),de(ui),de(Dr))),H=null,hr=R({},[].concat(de(Or),de(mi),de(Lr),de(ps))),B=Object.seal(Object.create(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Nt=null,Js=null,dr=!0,Qs=!0,ur=!1,_t=!1,Xe=!1,Xs=!1,Zs=!1,gt=!1,as=!1,ls=!1,mr=!0,pr=!1,pa="user-content-",ei=!0,Dt=!1,ft={},yt=null,_r=R({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),gr=null,fr=R({},["audio","video","img","source","image","track"]),ti=null,yr=R({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),si="http://www.w3.org/1998/Math/MathML",ii="http://www.w3.org/2000/svg",Fe="http://www.w3.org/1999/xhtml",cs=Fe,ri=!1,vt,_a=["application/xhtml+xml","text/html"],ga="text/html",j,wt=null,fa=s.createElement("form"),vr=function(u){return u instanceof RegExp||u instanceof Function},ni=function(u){wt&&wt===u||((!u||qe(u)!=="object")&&(u={}),u=Ze(u),vt=_a.indexOf(u.PARSER_MEDIA_TYPE)===-1?vt=ga:vt=u.PARSER_MEDIA_TYPE,j=vt==="application/xhtml+xml"?function(f){return f}:As,$="ALLOWED_TAGS"in u?R({},u.ALLOWED_TAGS,j):cr,H="ALLOWED_ATTR"in u?R({},u.ALLOWED_ATTR,j):hr,ti="ADD_URI_SAFE_ATTR"in u?R(Ze(yr),u.ADD_URI_SAFE_ATTR,j):yr,gr="ADD_DATA_URI_TAGS"in u?R(Ze(fr),u.ADD_DATA_URI_TAGS,j):fr,yt="FORBID_CONTENTS"in u?R({},u.FORBID_CONTENTS,j):_r,Nt="FORBID_TAGS"in u?R({},u.FORBID_TAGS,j):{},Js="FORBID_ATTR"in u?R({},u.FORBID_ATTR,j):{},ft="USE_PROFILES"in u?u.USE_PROFILES:!1,dr=u.ALLOW_ARIA_ATTR!==!1,Qs=u.ALLOW_DATA_ATTR!==!1,ur=u.ALLOW_UNKNOWN_PROTOCOLS||!1,_t=u.SAFE_FOR_TEMPLATES||!1,Xe=u.WHOLE_DOCUMENT||!1,gt=u.RETURN_DOM||!1,as=u.RETURN_DOM_FRAGMENT||!1,ls=u.RETURN_TRUSTED_TYPE||!1,Zs=u.FORCE_BODY||!1,mr=u.SANITIZE_DOM!==!1,pr=u.SANITIZE_NAMED_PROPS||!1,ei=u.KEEP_CONTENT!==!1,Dt=u.IN_PLACE||!1,Ys=u.ALLOWED_URI_REGEXP||Ys,cs=u.NAMESPACE||Fe,u.CUSTOM_ELEMENT_HANDLING&&vr(u.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(B.tagNameCheck=u.CUSTOM_ELEMENT_HANDLING.tagNameCheck),u.CUSTOM_ELEMENT_HANDLING&&vr(u.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(B.attributeNameCheck=u.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),u.CUSTOM_ELEMENT_HANDLING&&typeof u.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(B.allowCustomizedBuiltInElements=u.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),_t&&(Qs=!1),as&&(gt=!0),ft&&($=R({},de(Dr)),H=[],ft.html===!0&&(R($,Nr),R(H,Or)),ft.svg===!0&&(R($,hi),R(H,mi),R(H,ps)),ft.svgFilters===!0&&(R($,di),R(H,mi),R(H,ps)),ft.mathMl===!0&&(R($,ui),R(H,Lr),R(H,ps))),u.ADD_TAGS&&($===cr&&($=Ze($)),R($,u.ADD_TAGS,j)),u.ADD_ATTR&&(H===hr&&(H=Ze(H)),R(H,u.ADD_ATTR,j)),u.ADD_URI_SAFE_ATTR&&R(ti,u.ADD_URI_SAFE_ATTR,j),u.FORBID_CONTENTS&&(yt===_r&&(yt=Ze(yt)),R(yt,u.FORBID_CONTENTS,j)),ei&&($["#text"]=!0),Xe&&R($,["html","head","body"]),$.table&&(R($,["tbody"]),delete Nt.tbody),se&&se(u),wt=u)},wr=R({},["mi","mo","mn","ms","mtext"]),br=R({},["foreignobject","desc","title","annotation-xml"]),ya=R({},["title","style","font","a","script"]),hs=R({},hi);R(hs,di),R(hs,Ba);var oi=R({},ui);R(oi,Ka);var va=function(u){var f=I(u);(!f||!f.tagName)&&(f={namespaceURI:Fe,tagName:"template"});var y=As(u.tagName),N=As(f.tagName);return u.namespaceURI===ii?f.namespaceURI===Fe?y==="svg":f.namespaceURI===si?y==="svg"&&(N==="annotation-xml"||wr[N]):Boolean(hs[y]):u.namespaceURI===si?f.namespaceURI===Fe?y==="math":f.namespaceURI===ii?y==="math"&&br[N]:Boolean(oi[y]):u.namespaceURI===Fe?f.namespaceURI===ii&&!br[N]||f.namespaceURI===si&&!wr[N]?!1:!oi[y]&&(ya[y]||!hs[y]):!1},Re=function(u){Lt(e.removed,{element:u});try{u.parentNode.removeChild(u)}catch{try{u.outerHTML=k}catch{u.remove()}}},ai=function(u,f){try{Lt(e.removed,{attribute:f.getAttributeNode(u),from:f})}catch{Lt(e.removed,{attribute:null,from:f})}if(f.removeAttribute(u),u==="is"&&!H[u])if(gt||as)try{Re(f)}catch{}else try{f.setAttribute(u,"")}catch{}},Sr=function(u){var f,y;if(Zs)u="<remove></remove>"+u;else{var N=Pa(u,/^[\r\n\t ]+/);y=N&&N[0]}vt==="application/xhtml+xml"&&(u='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+u+"</body></html>");var ie=v?v.createHTML(u):u;if(cs===Fe)try{f=new m().parseFromString(ie,vt)}catch{}if(!f||!f.documentElement){f=O.createDocument(cs,"template",null);try{f.documentElement.innerHTML=ri?"":ie}catch{}}var z=f.body||f.documentElement;return u&&y&&z.insertBefore(s.createTextNode(y),z.childNodes[0]||null),cs===Fe?ca.call(f,Xe?"html":"body")[0]:Xe?f.documentElement:z},Ir=function(u){return pt.call(u.ownerDocument||u,u,l.SHOW_ELEMENT|l.SHOW_COMMENT|l.SHOW_TEXT,null,!1)},wa=function(u){return u instanceof d&&(typeof u.nodeName!="string"||typeof u.textContent!="string"||typeof u.removeChild!="function"||!(u.attributes instanceof h)||typeof u.removeAttribute!="function"||typeof u.setAttribute!="function"||typeof u.namespaceURI!="string"||typeof u.insertBefore!="function")},Ot=function(u){return qe(o)==="object"?u instanceof o:u&&qe(u)==="object"&&typeof u.nodeType=="number"&&typeof u.nodeName=="string"},Ce=function(u,f,y){!fe[u]||La(fe[u],function(N){N.call(e,f,y,wt)})},Er=function(u){var f;if(Ce("beforeSanitizeElements",u,null),wa(u)||Q(/[\u0080-\uFFFF]/,u.nodeName))return Re(u),!0;var y=j(u.nodeName);if(Ce("uponSanitizeElement",u,{tagName:y,allowedTags:$}),u.hasChildNodes()&&!Ot(u.firstElementChild)&&(!Ot(u.content)||!Ot(u.content.firstElementChild))&&Q(/<[/\w]/g,u.innerHTML)&&Q(/<[/\w]/g,u.textContent)||y==="select"&&Q(/<template/i,u.innerHTML))return Re(u),!0;if(!$[y]||Nt[y]){if(!Nt[y]&&Rr(y)&&(B.tagNameCheck instanceof RegExp&&Q(B.tagNameCheck,y)||B.tagNameCheck instanceof Function&&B.tagNameCheck(y)))return!1;if(ei&&!yt[y]){var N=I(u)||u.parentNode,ie=S(u)||u.childNodes;if(ie&&N)for(var z=ie.length,W=z-1;W>=0;--W)N.insertBefore(g(ie[W],!0),b(u))}return Re(u),!0}return u instanceof a&&!va(u)||(y==="noscript"||y==="noembed")&&Q(/<\/no(script|embed)/i,u.innerHTML)?(Re(u),!0):(_t&&u.nodeType===3&&(f=u.textContent,f=Be(f,zs," "),f=Be(f,Gs," "),u.textContent!==f&&(Lt(e.removed,{element:u.cloneNode()}),u.textContent=f)),Ce("afterSanitizeElements",u,null),!1)},kr=function(u,f,y){if(mr&&(f==="id"||f==="name")&&(y in s||y in fa))return!1;if(!(Qs&&!Js[f]&&Q(da,f))){if(!(dr&&Q(ua,f))){if(!H[f]||Js[f]){if(!(Rr(u)&&(B.tagNameCheck instanceof RegExp&&Q(B.tagNameCheck,u)||B.tagNameCheck instanceof Function&&B.tagNameCheck(u))&&(B.attributeNameCheck instanceof RegExp&&Q(B.attributeNameCheck,f)||B.attributeNameCheck instanceof Function&&B.attributeNameCheck(f))||f==="is"&&B.allowCustomizedBuiltInElements&&(B.tagNameCheck instanceof RegExp&&Q(B.tagNameCheck,y)||B.tagNameCheck instanceof Function&&B.tagNameCheck(y))))return!1}else if(!ti[f]){if(!Q(Ys,Be(y,lr,""))){if(!((f==="src"||f==="xlink:href"||f==="href")&&u!=="script"&&Va(y,"data:")===0&&gr[u])){if(!(ur&&!Q(ma,Be(y,lr,"")))){if(y)return!1}}}}}}return!0},Rr=function(u){return u.indexOf("-")>0},Cr=function(u){var f,y,N,ie;Ce("beforeSanitizeAttributes",u,null);var z=u.attributes;if(!!z){var W={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:H};for(ie=z.length;ie--;){f=z[ie];var ds=f,G=ds.name,li=ds.namespaceURI;if(y=G==="value"?f.value:Ua(f.value),N=j(G),W.attrName=N,W.attrValue=y,W.keepAttr=!0,W.forceKeepAttr=void 0,Ce("uponSanitizeAttribute",u,W),y=W.attrValue,!W.forceKeepAttr&&(ai(G,u),!!W.keepAttr)){if(Q(/\/>/i,y)){ai(G,u);continue}_t&&(y=Be(y,zs," "),y=Be(y,Gs," "));var Tr=j(u.nodeName);if(!!kr(Tr,N,y)){if(pr&&(N==="id"||N==="name")&&(ai(G,u),y=pa+y),v&&qe(p)==="object"&&typeof p.getAttributeType=="function"&&!li)switch(p.getAttributeType(Tr,N)){case"TrustedHTML":y=v.createHTML(y);break;case"TrustedScriptURL":y=v.createScriptURL(y);break}try{li?u.setAttributeNS(li,G,y):u.setAttribute(G,y),xr(e.removed)}catch{}}}}Ce("afterSanitizeAttributes",u,null)}},ba=function w(u){var f,y=Ir(u);for(Ce("beforeSanitizeShadowDOM",u,null);f=y.nextNode();)Ce("uponSanitizeShadowNode",f,null),!Er(f)&&(f.content instanceof i&&w(f.content),Cr(f));Ce("afterSanitizeShadowDOM",u,null)};return e.sanitize=function(w){var u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},f,y,N,ie,z;if(ri=!w,ri&&(w="<!-->"),typeof w!="string"&&!Ot(w)){if(typeof w.toString!="function")throw ci("toString is not a function");if(w=w.toString(),typeof w!="string")throw ci("dirty is not a string, aborting")}if(!e.isSupported){if(qe(n.toStaticHTML)==="object"||typeof n.toStaticHTML=="function"){if(typeof w=="string")return n.toStaticHTML(w);if(Ot(w))return n.toStaticHTML(w.outerHTML)}return w}if(Xs||ni(u),e.removed=[],typeof w=="string"&&(Dt=!1),Dt){if(w.nodeName){var W=j(w.nodeName);if(!$[W]||Nt[W])throw ci("root node is forbidden and cannot be sanitized in-place")}}else if(w instanceof o)f=Sr("<!---->"),y=f.ownerDocument.importNode(w,!0),y.nodeType===1&&y.nodeName==="BODY"||y.nodeName==="HTML"?f=y:f.appendChild(y);else{if(!gt&&!_t&&!Xe&&w.indexOf("<")===-1)return v&&ls?v.createHTML(w):w;if(f=Sr(w),!f)return gt?null:ls?k:""}f&&Zs&&Re(f.firstChild);for(var ds=Ir(Dt?w:f);N=ds.nextNode();)N.nodeType===3&&N===ie||Er(N)||(N.content instanceof i&&ba(N.content),Cr(N),ie=N);if(ie=null,Dt)return w;if(gt){if(as)for(z=la.call(f.ownerDocument);f.firstChild;)z.appendChild(f.firstChild);else z=f;return H.shadowroot&&(z=ha.call(t,z,!0)),z}var G=Xe?f.outerHTML:f.innerHTML;return Xe&&$["!doctype"]&&f.ownerDocument&&f.ownerDocument.doctype&&f.ownerDocument.doctype.name&&Q(Ya,f.ownerDocument.doctype.name)&&(G="<!DOCTYPE "+f.ownerDocument.doctype.name+`>
`+G),_t&&(G=Be(G,zs," "),G=Be(G,Gs," ")),v&&ls?v.createHTML(G):G},e.setConfig=function(w){ni(w),Xs=!0},e.clearConfig=function(){wt=null,Xs=!1},e.isValidAttribute=function(w,u,f){wt||ni({});var y=j(w),N=j(u);return kr(y,N,f)},e.addHook=function(w,u){typeof u=="function"&&(fe[w]=fe[w]||[],Lt(fe[w],u))},e.removeHook=function(w){if(fe[w])return xr(fe[w])},e.removeHooks=function(w){fe[w]&&(fe[w]=[])},e.removeAllHooks=function(){fe={}},e}var Xa=jn(),js={exports:{}},Za=function(n){var e={};function t(s){if(e[s])return e[s].exports;var i=e[s]={i:s,l:!1,exports:{}};return n[s].call(i.exports,i,i.exports,t),i.l=!0,i.exports}return t.m=n,t.c=e,t.d=function(s,i,r){t.o(s,i)||Object.defineProperty(s,i,{enumerable:!0,get:r})},t.r=function(s){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(s,"__esModule",{value:!0})},t.t=function(s,i){if(1&i&&(s=t(s)),8&i||4&i&&typeof s=="object"&&s&&s.__esModule)return s;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:s}),2&i&&typeof s!="string")for(var o in s)t.d(r,o,function(a){return s[a]}.bind(null,o));return r},t.n=function(s){var i=s&&s.__esModule?function(){return s.default}:function(){return s};return t.d(i,"a",i),i},t.o=function(s,i){return Object.prototype.hasOwnProperty.call(s,i)},t.p="",t(t.s=0)}([function(n,e,t){function s(c){let h,d;const m={light:function(){return!_()},dark:_,lighten:S,darken:b,saturate:I,desaturate:function(v=0){return I(v*=-1)},increaseContrast:function(v=0){return C(v*=-1)},decreaseContrast:C,active:function(){return C(.123)},highlight:function(){return C(.1)},selected:function(){return C(.066)},text:function(){return d=g()?i("#333333"):i("#FFFFFF"),m},shadow:function(){return d=g()?i("#000000"):i("#FFFFFF"),m},hex:function(){const v=d;return d=h,"#"+v.map(k=>parseInt(k+"",10).toString(16).padStart(2,"0")).join("")},rgb:function(){const v=d;return d=h,`rgb(${v.join()})`},rgba:function(v=1){const k=d;return d=h,`rgba(${k.join()}, ${v})`},setHex:p,setRgb:function(v=[0,0,0]){let[k,x,O]=v;return k=l(k,0,255),x=l(x,0,255),O=l(O,0,255),h=[k,x,O],d=[k,x,O],m}};function p(v="#000000"){return h=i(v),d=h,m}function _(){const[v,k,x]=d;return d=h,(299*v+587*k+114*x)/1e3<128}function g(){const[v,k,x]=d;return(299*v+587*k+114*x)/1e3>=128}function b(v=0){return S(v*=-1)}function S(v=0){let[k,x,O]=a(d);return O=l(O+v,0,1),d=r([k,x,O]),m}function I(v=0){let[k,x,O]=a(d);return x=l(x+v,0,1),d=r([k,x,O]),m}function C(v=0){return g()?b(v):S(v)}return p(c),m}function i(c){if(typeof c!="string")throw new TypeError("Expected a string");(c=c.replace(/^#/,"")).length===3&&(c=c[0]+c[0]+c[1]+c[1]+c[2]+c[2]);var h=parseInt(c,16);return[h>>16,h>>8&255,255&h]}function r(c){const[h,d,m]=c;let p,_,g;if(d===0)p=_=g=m;else{const b=function(C,v,k){return k<0&&(k+=1),k>1&&(k-=1),k<.16666666666666666?C+6*(v-C)*k:k<.5?v:k<.6666666666666666?C+(v-C)*(.6666666666666666-k)*6:C},S=m<.5?m*(1+d):m+d-m*d,I=2*m-S;p=l(b(I,S,h+1/3),0,1),_=l(b(I,S,h),0,1),g=l(b(I,S,h-1/3),0,1)}return[Math.round(255*p),Math.round(255*_),Math.round(255*g)]}t.r(e),t.d(e,"offColor",function(){return s}),t.d(e,"hexRgb",function(){return i}),t.d(e,"hslToRgb",function(){return r}),t.d(e,"color",function(){return o}),t.d(e,"rgbToHsl",function(){return a});const o=s;function a(c){const h=c[0]/255,d=c[1]/255,m=c[2]/255,p=Math.max(h,d,m),_=Math.min(h,d,m);let g=(p+_)/2,b=(p+_)/2;const S=(p+_)/2;if(p===_)g=b=0;else{const I=p-_;switch(b=S>.5?I/(2-p-_):I/(p+_),p){case h:g=(d-m)/I+(d<m?6:0);break;case d:g=(m-h)/I+2;break;case m:g=(h-d)/I+4}g/=6}return[g,b,S]}function l(c,h,d){return c=(c=c<=d?c:d)>=h?c:h}}]);(function(n){n.exports=Za})(js);const qn=Sa(js.exports);var el=Object.defineProperty,tl=Object.defineProperties,sl=Object.getOwnPropertyDescriptors,Os=Object.getOwnPropertySymbols,Hn=Object.prototype.hasOwnProperty,Wn=Object.prototype.propertyIsEnumerable,Pr=(n,e,t)=>e in n?el(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Jt=(n,e)=>{for(var t in e||(e={}))Hn.call(e,t)&&Pr(n,t,e[t]);if(Os)for(var t of Os(e))Wn.call(e,t)&&Pr(n,t,e[t]);return n},il=(n,e)=>tl(n,sl(e)),rl=(n,e)=>{var t={};for(var s in n)Hn.call(n,s)&&e.indexOf(s)<0&&(t[s]=n[s]);if(n!=null&&Os)for(var s of Os(n))e.indexOf(s)<0&&Wn.call(n,s)&&(t[s]=n[s]);return t},Vr,Ur;class Ie extends Error{get name(){return"AbortError"}}class zn extends Error{constructor(e,t){super(`${e}: ${t.message}`),this.cause=t}get name(){return"WrappedError"}}class Gn extends Error{constructor(e,t,s,i){super(`${s?s.error:i} on ${e} ${t}`),this.errcode=s?s.errcode:null,this.retry_after_ms=s?s.retry_after_ms:0,this.statusCode=i}get name(){return"HomeServerError"}}class We extends Error{constructor(e,t){super(e||"ConnectionError"),this.isTimeout=t}get name(){return"ConnectionError"}}class Pi{constructor(){this._handlers=new Set}onSubscribeFirst(){}onUnsubscribeLast(){}subscribe(e){return this._handlers.add(e),this._handlers.size===1&&this.onSubscribeFirst(),()=>this.unsubscribe(e)}unsubscribe(e){e&&(this._handlers.delete(e),this._handlers.size===0&&this.onUnsubscribeLast())}unsubscribeAll(){this._handlers.size!==0&&(this._handlers.clear(),this.onUnsubscribeLast())}get hasSubscriptions(){return this._handlers.size!==0}}class Tt extends Pi{emit(e){for(const t of this._handlers)t(e)}waitFor(e){return e(this.get())?new ol(Promise.resolve(this.get())):new nl(this,e)}flatMap(e){return new al(this,e)}}class nl{constructor(e,t){this._promise=new Promise((s,i)=>{this._reject=i,this._subscription=e.subscribe(r=>{t(r)&&(this._reject=null,s(r),this.dispose())})})}get promise(){return this._promise}dispose(){this._subscription&&(this._subscription(),this._subscription=null),this._reject&&(this._reject(new Ie),this._reject=null)}}class ol{constructor(e){this.promise=e}dispose(){}}class Ee extends Tt{constructor(e){super(),this._value=e}get(){return this._value}set(e){e!==this._value&&(this._value=e,this.emit(this._value))}}class bi extends Ee{constructor(e,t){super(e),this._freeCallback=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this._freeCallback()}}class al extends Tt{constructor(e,t){super(),this.source=e,this.mapper=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this.sourceSubscription=this.sourceSubscription(),this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}onSubscribeFirst(){super.onSubscribeFirst(),this.sourceSubscription=this.source.subscribe(()=>{this.updateTargetSubscription(),this.emit(this.get())}),this.updateTargetSubscription()}updateTargetSubscription(){const e=this.source.get();if(e){const t=this.mapper(e);if(t){this.targetSubscription||(this.targetSubscription=t.subscribe(()=>this.emit(this.get())));return}}this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}get(){const e=this.source.get();if(!e)return;const t=this.mapper(e);return t?.get()}}function ll(n,e,t,s){const i=n(e);let r=!1;return i.elapsed().then(()=>{r=!0,t.abort()},()=>{}),s.then(o=>(i.abort(),o),o=>{throw i.abort(),o.name==="AbortError"&&r?new We(`Request timed out after ${e}ms`,!0):o})}function Yn(n,e=Math.random){return n.includes("?")?n=n+"&":n=n+"?",n+`_cacheBuster=${Math.ceil(e()*Number.MAX_SAFE_INTEGER)}`}function Jn(n){var e;const t=new FormData;for(const[s,i]of n)((e=i.blob)==null?void 0:e.nativeBlob)&&i.name?t.set(s,i.blob.nativeBlob,i.name):t.set(s,i);return t}class cl{constructor(e,t){this._promise=e,this._xhr=t}abort(){this._xhr.abort()}response(){return this._promise}}function hl(n,{method:e,headers:t,timeout:s,format:i,uploadProgress:r}){const o=new XMLHttpRequest;if(r&&o.upload.addEventListener("progress",a=>r(a.loaded)),o.open(e,n),i==="buffer"&&(o.responseType="arraybuffer"),t)for(const[a,l]of t.entries())try{o.setRequestHeader(a,l)}catch(c){console.info(`Could not set ${a} header: ${c.message}`)}return s&&(o.timeout=s),o}function dl(n,e,t){return new Promise((s,i)=>{n.addEventListener("load",()=>s(n)),n.addEventListener("abort",()=>i(new Ie)),n.addEventListener("error",()=>i(new We(`Error ${e} ${t}`))),n.addEventListener("timeout",()=>i(new We(`Timeout ${e} ${t}`,!0)))})}function Qn(n,e){let{cache:t,format:s,body:i,method:r}=e;t||(n=Yn(n));const o=hl(n,e),a=dl(o,r,n).then(l=>{const{status:c}=l;let h=null;return s==="buffer"?h=l.response:l.getResponseHeader("Content-Type")==="application/json"&&(h=JSON.parse(l.responseText)),{status:c,body:h}});return i?.nativeBlob&&(i=i.nativeBlob),i instanceof Map&&(i=Jn(i)),o.send(i||null),new cl(a,o)}class Fr{constructor(e,t){if(t)this.promise=e,this._controller=t;else{const s=new Promise((i,r)=>{this._controller={abort(){const o=new Error("fetch request aborted");o.name="AbortError",r(o)}}});this.promise=Promise.race([e,s])}}abort(){this._controller.abort()}response(){return this.promise}}function ul(n,e){return function(s,i){if(e?.haltRequests)return new Fr(new Promise(()=>{}),{});if(i?.uploadProgress)return Qn(s,i);let{method:r,headers:o,body:a,timeout:l,format:c,cache:h=!1}=i;const d=typeof AbortController=="function"?new AbortController:null;a?.nativeBlob&&(a=a.nativeBlob),a instanceof Map&&(a=Jn(a));let m={method:r,body:a};if(d&&(m=Object.assign(m,{signal:d.signal})),h||(s=Yn(s)),m=Object.assign(m,{mode:"cors",credentials:"omit",referrer:"no-referrer",cache:"default"}),o){const g=new Headers;for(const[b,S]of o.entries())g.append(b,S);m.headers=g}const p=fetch(s,m).then(async g=>{const{status:b}=g;let S;try{c==="json"?S=await g.json():c==="buffer"?S=await g.arrayBuffer():c==="text"&&(S=await g.text())}catch(I){if(!(I.name==="SyntaxError"&&b>=400))throw I}return{status:b,body:S}},g=>{throw g.name==="AbortError"?new Ie:g instanceof TypeError?new We(`${r} ${s}: ${g.message}`):g}),_=new Fr(p,d);return l&&(_.promise=ll(n,l,_,_.promise)),_}}var V=(n=>(n.session="session",n.roomState="roomState",n.roomSummary="roomSummary",n.archivedRoomSummary="archivedRoomSummary",n.invites="invites",n.roomMembers="roomMembers",n.timelineEvents="timelineEvents",n.timelineRelations="timelineRelations",n.timelineFragments="timelineFragments",n.pendingEvents="pendingEvents",n.userIdentities="userIdentities",n.deviceIdentities="deviceIdentities",n.olmSessions="olmSessions",n.inboundGroupSessions="inboundGroupSessions",n.outboundGroupSessions="outboundGroupSessions",n.groupSessionDecryptions="groupSessionDecryptions",n.operations="operations",n.accountData="accountData",n))(V||{});const Qt=Object.values(V);class xe extends Error{constructor(e,t=null){super(e),t&&(this.errcode=t.name),this.cause=t}get name(){return"StorageError"}}const F={get minStorageKey(){return 0},get middleStorageKey(){return 2147483647},get maxStorageKey(){return 4294967295}};function ml(n){return"objectStore"in n?`${n.objectStore.name}.${n.name}`:n.name}function pl(n){var e,t,s,i,r;return"objectStore"in n?(s=(t=(e=n.objectStore)==null?void 0:e.transaction)==null?void 0:t.db)==null?void 0:s.name:(r=(i=n.transaction)==null?void 0:i.db)==null?void 0:r.name}class Xn extends xe{constructor(e,t,s=null){const i=t&&"source"in t?t.source:t,r=i?ml(i):"",o=i?pl(i):"";let a=`${e} on ${o}.${r}`;s&&(a+=": ",typeof s.name=="string"&&(a+=`(name: ${s.name}) `),typeof s.code=="number"&&(a+=`(code: ${s.code}) `)),s&&(a+=s.message),super(a,s),this.storeName=r,this.databaseName=o}}class Vi extends Xn{constructor(e){const t=e.target,s=t.source,i=t.error;super("IDBRequest failed",s,i),this.errorEvent=e}preventTransactionAbort(){this.errorEvent.preventDefault()}}class Te extends Xn{constructor(e,t,s,i){super(`${e}(${i.map(r=>JSON.stringify(r)).join(", ")}) failed`,t,s)}}const Br={done:!0},Ye={done:!1};function Ls(n){const e=n.toString(16);return"0".repeat(8-e.length)+e}function Si(n){return parseInt(n,16)}function Ui(n,e,t,s=window.indexedDB){const i=s.open(n,t);return i.onupgradeneeded=async r=>{const o=r.target,a=o.result,l=o.transaction,c=r.oldVersion;try{await e(a,l,c,t)}catch{try{l.abort()}catch{}}},te(i)}function te(n){return new Promise((e,t)=>{n.addEventListener("success",s=>{e(s.target.result)}),n.addEventListener("error",s=>{const i=new Vi(s);t(i)})})}function Xt(n){return new Promise((e,t)=>{n.addEventListener("complete",()=>{e()}),n.addEventListener("abort",s=>{t(new Ie)})})}function q(n,e){return new Promise((t,s)=>{n.onerror=i=>{s(new Vi(i))},n.onsuccess=i=>{const r=i.target.result;if(!r){t(!1);return}const o=e(r.value,r.key,r),a=o?.done,l=o?.jumpTo;a?t(!0):l?r.continue(l):r.continue()}}).catch(t=>{throw new xe("iterateCursor failed",t)})}async function _l(n,e){const t=[];return await q(n,s=>(t.push(s),{done:e(t)})),t}var ve=(n=>(n[n.All=1]="All",n[n.Debug=2]="Debug",n[n.Detail=3]="Detail",n[n.Info=4]="Info",n[n.Warn=5]="Warn",n[n.Error=6]="Error",n[n.Fatal=7]="Fatal",n[n.Off=8]="Off",n))(ve||{});class Ii{constructor(e){this._parentFilter=e}filter(e,t){return!(this._parentFilter&&!this._parentFilter.filter(e,t)||this._min!==void 0&&!Array.isArray(t)&&e.logLevel<this._min)}minLevel(e){return this._min=e,this}}function Ps(){}class gl{constructor(){this.item=new fl(this)}log(){}run(e,t){return t(this.item)}wrapOrRun(e,t,s){return e?e.wrap(t,s):this.run(t,s)}runDetached(e,t){return new Promise(s=>s(t(this.item))).then(Ps,Ps),this.item}async export(){}get level(){return ve}}class fl{constructor(e){this.logger=e}wrap(e,t){return t(this)}log(){return this}set(){return this}runDetached(e,t){return new Promise(s=>s(t(this))).then(Ps,Ps),this}wrapDetached(e,t){return this.refDetached()}refDetached(){}ensureRefId(){}get level(){return ve}get duration(){return 0}catch(e){return e}child(){return this}finish(){}serialize(){}}const yl=new gl;class Kr{constructor(e,t){this._target=e,this._transaction=t}get idbFactory(){return this._transaction.idbFactory}get IDBKeyRange(){return this._transaction.IDBKeyRange}get databaseName(){return this._transaction.databaseName}_openCursor(e,t){return e&&t?this._target.openCursor(e,t):e?this._target.openCursor(e):t?this._target.openCursor(null,t):this._target.openCursor()}supports(e){return this._target.supports(e)}count(e){return te(this._target.count(e))}get(e){return te(this._target.get(e))}getKey(e){return this._target.supports("getKey")?te(this._target.getKey(e)):te(this._target.get(e)).then(t=>{if(t){let s=this._target.keyPath;return typeof s=="string"&&(s=[s]),s.reduce((i,r)=>i[r],t)}})}reduce(e,t,s){return this._reduce(e,t,s,"next")}reduceReverse(e,t,s){return this._reduce(e,t,s,"prev")}selectLimit(e,t){return this._selectLimit(e,t,"next")}selectLimitReverse(e,t){return this._selectLimit(e,t,"prev")}selectWhile(e,t){return this._selectWhile(e,t,"next")}selectWhileReverse(e,t){return this._selectWhile(e,t,"prev")}async selectAll(e,t){const s=this._openCursor(e,t),i=[];return await q(s,r=>(i.push(r),Ye)),i}selectFirst(e){return this._find(e,()=>!0,"next")}selectLast(e){return this._find(e,()=>!0,"prev")}find(e,t){return this._find(e,t,"next")}findReverse(e,t){return this._find(e,t,"prev")}async findMaxKey(e){const t=this._target.openKeyCursor(e,"prev");let s;return await q(t,(i,r)=>(s=r,Br)),s}async iterateValues(e,t){const s=this._target.openCursor(e,"next");await q(s,(i,r,o)=>({done:t(i,r,o)}))}async iterateKeys(e,t){const s=this._target.openKeyCursor(e,"next");await q(s,(i,r,o)=>({done:t(r,o)}))}async findExistingKeys(e,t,s){const i=(d,m)=>t?-this.idbFactory.cmp(d,m):this.idbFactory.cmp(d,m),r=e.slice().sort(i),o=r[0],a=r[r.length-1],l=t?"prev":"next",c=this._target.openKeyCursor(this.IDBKeyRange.bound(o,a),l);let h=0;await q(c,(d,m,p)=>{for(;h<r.length&&i(r[h],m)<0;)h+=1;let _=!1;if(r[h]===m){const g=p.primaryKey;_=s(m,g),h+=1}return _||h>=r.length?Br:{done:!1,jumpTo:r[h]}})}_reduce(e,t,s,i){let r=s;const o=this._openCursor(e,i);return q(o,a=>(r=t(r,a),Ye))}_selectLimit(e,t,s){return this._selectUntil(e,i=>i.length===t,s)}async _selectUntil(e,t,s){const i=this._openCursor(e,s),r=[];return await q(i,o=>(r.push(o),{done:t(r,o)})),r}async _selectWhile(e,t,s){const i=this._openCursor(e,s),r=[];return await q(i,o=>{const a=t(o);return a&&r.push(o),{done:!a}}),r}async iterateWhile(e,t){const s=this._openCursor(e,"next");await q(s,i=>({done:!t(i)}))}async _find(e,t,s){const i=this._openCursor(e,s);let r;if(await q(i,a=>{const l=t(a);return l&&(r=a),{done:l}}))return r}}const Ke=!1;function $e(n,e,t){var s,i;const r=t?.name,o=(i=(s=t?.transaction)==null?void 0:s.db)==null?void 0:i.name;console.info(`${o}.${r}.${n}(${e.map(a=>JSON.stringify(a)).join(", ")})`)}class $r{constructor(e){this._qt=e}get keyPath(){return this._qtStore.keyPath}get _qtStore(){return"objectStore"in this._qt?this._qt.objectStore:this._qt}supports(e){return!!this._qt[e]}openKeyCursor(e,t){try{return this._qt.openKeyCursor?(Ke&&$e("openKeyCursor",[e,t],this._qt),this._qt.openKeyCursor(e,t)):(Ke&&$e("openCursor",[e,t],this._qt),this.openCursor(e,t))}catch(s){throw new Te("openKeyCursor",this._qt,s,[e,t])}}openCursor(e,t){try{return Ke&&$e("openCursor",[],this._qt),this._qt.openCursor(e,t)}catch(s){throw new Te("openCursor",this._qt,s,[e,t])}}put(e,t){try{return Ke&&$e("put",[e,t],this._qt),this._qtStore.put(e,t)}catch(s){throw new Te("put",this._qt,s,[e,t])}}add(e,t){try{return Ke&&$e("add",[e,t],this._qt),this._qtStore.add(e,t)}catch(s){throw new Te("add",this._qt,s,[e,t])}}get(e){try{return Ke&&$e("get",[e],this._qt),this._qt.get(e)}catch(t){throw new Te("get",this._qt,t,[e])}}getKey(e){try{return Ke&&$e("getKey",[e],this._qt),this._qt.getKey(e)}catch(t){throw new Te("getKey",this._qt,t,[e])}}delete(e){try{return Ke&&$e("delete",[e],this._qt),this._qtStore.delete(e)}catch(t){throw new Te("delete",this._qt,t,[e])}}count(e){try{return this._qt.count(e)}catch(t){throw new Te("count",this._qt,t,[e])}}index(e){try{return this._qtStore.index(e)}catch(t){throw new Te("index",this._qt,t,[e])}}get indexNames(){return Array.from(this._qtStore.indexNames)}}class Zn extends Kr{constructor(e,t){super(new $r(e),t)}get _idbStore(){return this._target}index(e){return new Kr(new $r(this._idbStore.index(e)),this._transaction)}put(e,t){const s=this._idbStore.put(e);this._prepareErrorLog(s,t,"put",void 0,e)}add(e,t){const s=this._idbStore.add(e);this._prepareErrorLog(s,t,"add",void 0,e)}async tryAdd(e,t){try{return await te(this._idbStore.add(e)),!0}catch(s){if(s instanceof Vi)return t.log({l:"could not write",id:this._getKeys(e),e:s},t.level.Warn),s.preventTransactionAbort(),!1;throw s}}delete(e,t){const s=this._idbStore.delete(e);this._prepareErrorLog(s,t,"delete",e,void 0)}_prepareErrorLog(e,t,s,i,r){t&&t.ensureRefId(),te(e).catch(o=>{let a;r?a=this._getKeys(r):i&&(a=[i]),this._transaction.addWriteError(o,t,s,a)})}_getKeys(e){const t=[],{keyPath:s}=this._idbStore;try{t.push(this._readKeyPath(e,s))}catch{console.warn("could not read keyPath",s)}for(const i of this._idbStore.indexNames)try{const r=this._idbStore.index(i);t.push(this._readKeyPath(e,r.keyPath))}catch{console.warn("could not read index",i)}return t}_readKeyPath(e,t){if(Array.isArray(t)){let s=e;for(const i of t)if(typeof s=="object")s=s[i];else break;return s}else return e[t]}}function Pe(...n){const e={};for(const t of n)e[t]=t;return Object.freeze(e)}const nt=Pe("Sync","Timeline","Retry"),ae="e2ee:",Fi="m.olm.v1.curve25519-aes-sha2",ke="m.megolm.v1.aes-sha2";class Y extends Error{constructor(e,t,s=null){super(`Decryption error ${e}${s?": "+JSON.stringify(s):""}`),this.code=e,this.event=t,this.details=s}}const eo="ed25519";function to(n,e,t,s,i,r=void 0){var o,a;const l=Object.assign({},i);delete l.unsigned,delete l.signatures;const c=Kn.stringify(l),h=(a=(o=i?.signatures)==null?void 0:o[e])==null?void 0:a[`${eo}:${t}`];try{if(!h)throw new Error("no signature");return n.ed25519_verify(s,c,h),!0}catch(d){if(r){const m=r.log({l:"Invalid signature, ignoring.",ed25519Key:s,canonicalJson:c,signature:h});m.error=d,m.logLevel=r.level.Warn}return!1}}function vl(){return{type:"m.room.encryption",state_key:"",content:{algorithm:ke,rotation_period_ms:6048e5,rotation_period_msgs:100}}}const _s=Object.freeze({Joined:"joined",Invited:"invited",WorldReadable:"world_readable",Shared:"shared"});function gs(n,e){switch(e){case _s.WorldReadable:return!0;case _s.Shared:return n!==void 0;case _s.Joined:return n==="join";case _s.Invited:return n==="invite"||n==="join";default:return!1}}function wl(n){return JSON.stringify(so(n))}function bl(n){return io(JSON.parse(n))}function so(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(n.byteLength)return{_type:n.constructor.name,value:Array.from(n)};let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=so(n[t]));return e}else return n}function io(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(typeof n._type=="string")switch(n._type){case"Int8Array":return Int8Array.from(n.value);case"Uint8Array":return Uint8Array.from(n.value);case"Uint8ClampedArray":return Uint8ClampedArray.from(n.value);case"Int16Array":return Int16Array.from(n.value);case"Uint16Array":return Uint16Array.from(n.value);case"Int32Array":return Int32Array.from(n.value);case"Uint32Array":return Uint32Array.from(n.value);case"Float32Array":return Float32Array.from(n.value);case"Float64Array":return Float64Array.from(n.value);case"BigInt64Array":return BigInt64Array.from(n.value);case"BigUint64Array":return BigUint64Array.from(n.value);default:return n.value}let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=io(n[t]));return e}else return n}class Bi{constructor(e,t){this._sessionStore=e,this._localStorage=t}get _localStorageKeyPrefix(){return`${this._sessionStore.databaseName}.session.`}async get(e){const t=await this._sessionStore.get(e);if(t)return t.value}_writeKeyToLocalStorage(e,t){try{const s=this._localStorageKeyPrefix+e,i=wl(t);this._localStorage.setItem(s,i)}catch(s){console.error("could not write to localStorage",s)}}writeE2EEIdentityToLocalStorage(){this._sessionStore.iterateValues(void 0,(e,t)=>(t.startsWith(ae)&&this._writeKeyToLocalStorage(t,e.value),!1))}async tryRestoreE2EEIdentityFromLocalStorage(e){let t=!1;const s=this._localStorageKeyPrefix,i=s+ae;for(let r=0;r<this._localStorage.length;r+=1){const o=this._localStorage.key(r);if(o.startsWith(i)){const a=bl(this._localStorage.getItem(o)),l=o.substr(s.length),c=await this._sessionStore.getKey(l)===l;e.set(l,!c),c||(this._sessionStore.put({key:l,value:a}),t=!0)}}return t}set(e,t){e.startsWith(ae)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.put({key:e,value:t})}add(e,t){e.startsWith(ae)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.add({key:e,value:t})}remove(e){e.startsWith(ae)&&this._localStorage.removeItem(this._localStorageKeyPrefix+e),this._sessionStore.delete(e)}}class jr{constructor(e){this._summaryStore=e}getAll(){return this._summaryStore.selectAll()}set(e){this._summaryStore.put(e)}get(e){return this._summaryStore.get(e)}async has(e){const t=await this._summaryStore.getKey(e);return e===t}remove(e){this._summaryStore.delete(e)}}class Sl{constructor(e){this._inviteStore=e}getAll(){return this._inviteStore.selectAll()}set(e){this._inviteStore.put(e)}remove(e){this._inviteStore.delete(e)}}class K{constructor(e,t){this.fragmentId=e,this.eventIndex=t}nextFragmentKey(){return new K(this.fragmentId+1,F.middleStorageKey)}nextKeyForDirection(e){return e.isForward?this.nextKey():this.previousKey()}previousKey(){return new K(this.fragmentId,this.eventIndex-1)}nextKey(){return new K(this.fragmentId,this.eventIndex+1)}static get maxKey(){return new K(F.maxStorageKey,F.maxStorageKey)}static get minKey(){return new K(F.minStorageKey,F.minStorageKey)}static get defaultLiveKey(){return K.defaultFragmentKey(F.minStorageKey)}static defaultFragmentKey(e){return new K(e,F.middleStorageKey)}toString(){return`[${this.fragmentId}/${this.eventIndex}]`}equals(e){return this.fragmentId===e?.fragmentId&&this.eventIndex===e?.eventIndex}}function ro(n,e,t){return{fragmentId:n.fragmentId,eventIndex:n.eventIndex,roomId:e,event:t}}function qt(n,e,t){t.isForward?n.push(e):n.unshift(e)}function Il(n,e,t){return t.isForward?n.concat(e):e.concat(n)}function ue(n,e,t){return`${n}|${Ls(e)}|${Ls(t)}`}function El(n){const[e,t,s]=n.split("|");return{roomId:e,eventKey:new K(Si(t),Si(s))}}function fs(n,e){return`${n}|${e}`}function qr(n){const[e,t]=n.split("|");return{roomId:e,eventId:t}}class ys{constructor(e,t,s,i,r=!1,o=!1){this._IDBKeyRange=e,this._only=t,this._lower=s,this._upper=i,this._lowerOpen=r,this._upperOpen=o}asIDBKeyRange(e){try{if(this._only)return this._IDBKeyRange.only(ue(e,this._only.fragmentId,this._only.eventIndex));if(this._lower&&!this._upper)return this._IDBKeyRange.bound(ue(e,this._lower.fragmentId,this._lower.eventIndex),ue(e,this._lower.fragmentId,F.maxStorageKey),this._lowerOpen,!1);if(!this._lower&&this._upper)return this._IDBKeyRange.bound(ue(e,this._upper.fragmentId,F.minStorageKey),ue(e,this._upper.fragmentId,this._upper.eventIndex),!1,this._upperOpen);if(this._lower&&this._upper)return this._IDBKeyRange.bound(ue(e,this._lower.fragmentId,this._lower.eventIndex),ue(e,this._upper.fragmentId,this._upper.eventIndex),this._lowerOpen,this._upperOpen)}catch(t){throw new xe("IDBKeyRange failed with data: "+JSON.stringify(this),t)}}}class kl{constructor(e){this._timelineStore=e}onlyRange(e){return new ys(this._timelineStore.IDBKeyRange,e)}upperBoundRange(e,t=!1){return new ys(this._timelineStore.IDBKeyRange,void 0,void 0,e,void 0,t)}lowerBoundRange(e,t=!1){return new ys(this._timelineStore.IDBKeyRange,void 0,e,void 0,t)}boundRange(e,t,s=!1,i=!1){return new ys(this._timelineStore.IDBKeyRange,void 0,e,t,s,i)}async lastEvents(e,t,s){const i=K.maxKey;return i.fragmentId=t,this.eventsBefore(e,i,s)}async firstEvents(e,t,s){const i=K.minKey;return i.fragmentId=t,this.eventsAfter(e,i,s)}eventsAfter(e,t,s){const i=this.lowerBoundRange(t,!0).asIDBKeyRange(e);return this._timelineStore.selectLimit(i,s)}async eventsBefore(e,t,s){const i=this.upperBoundRange(t,!0).asIDBKeyRange(e),r=await this._timelineStore.selectLimitReverse(i,s);return r.reverse(),r}async getEventKeysForIds(e,t){const s=this._timelineStore.index("byEventId"),i=t.map(o=>fs(e,o)),r=new Map;return await s.findExistingKeys(i,!1,(o,a)=>{const{eventId:l}=qr(o),{eventKey:c}=El(a);return r.set(l,c),!1}),r}async findFirstOccurringEventId(e,t){const s=this._timelineStore.index("byEventId"),i=t.map(l=>fs(e,l)),r=new Array(i.length);let o;function a(){for(let l=0;l<r.length;++l){if(r[l]===void 0)return;if(r[l]===!0)return i[l]}}return await s.findExistingKeys(i,!1,(l,c)=>{const h=i.indexOf(l);return r[h]=c,o=a(),!!o}),o&&qr(o).eventId}tryInsert(e,t){return e.key=ue(e.roomId,e.fragmentId,e.eventIndex),e.eventIdKey=fs(e.roomId,e.event.event_id),this._timelineStore.tryAdd(e,t)}update(e){this._timelineStore.put(e)}get(e,t){return this._timelineStore.get(ue(e,t.fragmentId,t.eventIndex))}getByEventId(e,t){return this._timelineStore.index("byEventId").get(fs(e,t))}removeAllForRoom(e){const t=ue(e,F.minStorageKey,F.minStorageKey),s=ue(e,F.maxStorageKey,F.maxStorageKey),i=this._timelineStore.IDBKeyRange.bound(t,s);this._timelineStore.delete(i)}}const ne="\0",J="\u{10FFFF}";function ye(n,e,t,s){return`${n}|${e}|${t}|${s}`}function Hr(n){const[e,t,s,i]=n.split("|");return{roomId:e,targetEventId:t,relType:s,sourceEventId:i}}class Rl{constructor(e){this._store=e}add(e,t,s,i){this._store.add({key:ye(e,t,s,i)})}remove(e,t,s,i){this._store.delete(ye(e,t,s,i))}removeAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(ye(e,t,ne,ne),ye(e,t,J,J),!0,!0);this._store.delete(s)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(ye(e,ne,ne,ne),ye(e,J,J,J),!0,!0);this._store.delete(t)}async getForTargetAndType(e,t,s){const i=this._store.IDBKeyRange.bound(ye(e,t,s,ne),ye(e,t,s,J),!0,!0);return(await this._store.selectAll(i)).map(o=>Hr(o.key))}async getAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(ye(e,t,ne,ne),ye(e,t,J,J),!0,!0);return(await this._store.selectAll(s)).map(r=>Hr(r.key))}}function Wr(n,e,t){return`${n}|${e}|${t}`}class Cl{constructor(e){this._roomStateStore=e}get(e,t,s){const i=Wr(e,t,s);return this._roomStateStore.get(i)}set(e,t){const s=Wr(e,t.type,t.state_key),i={roomId:e,event:t,key:s};this._roomStateStore.put(i)}removeAllForRoom(e){const t=this._roomStateStore.IDBKeyRange.bound(e,`${e}|${J}`,!0,!0);this._roomStateStore.delete(t)}}function vs(n,e){return`${n}|${e}`}function Tl(n){const[e,t]=n.split("|");return{roomId:e,userId:t}}class no{constructor(e){this._roomMembersStore=e}get(e,t){return this._roomMembersStore.get(vs(e,t))}set(e){e.key=vs(e.roomId,e.userId),this._roomMembersStore.put(e)}getAll(e){const t=this._roomMembersStore.IDBKeyRange.lowerBound(vs(e,""));return this._roomMembersStore.selectWhile(t,s=>s.roomId===e)}async getAllUserIds(e){const t=[],s=this._roomMembersStore.IDBKeyRange.lowerBound(vs(e,""));return await this._roomMembersStore.iterateKeys(s,i=>{const r=Tl(i);return r.roomId===e?(t.push(r.userId),!1):!0}),t}removeAllForRoom(e){const t=this._roomMembersStore.IDBKeyRange.bound(e,`${e}|${J}`,!0,!0);this._roomMembersStore.delete(t)}}function ws(n,e){return`${n}|${Ls(e)}`}class Ml{constructor(e){this._store=e}_allRange(e){try{return this._store.IDBKeyRange.bound(ws(e,F.minStorageKey),ws(e,F.maxStorageKey))}catch(t){throw new xe(`error from IDBKeyRange with roomId ${e}`,t)}}all(e){return this._store.selectAll(this._allRange(e))}liveFragment(e){return this._store.findReverse(this._allRange(e),t=>typeof t.nextId!="number"&&typeof t.nextToken!="string")}add(e){e.key=ws(e.roomId,e.id),this._store.add(e)}update(e){this._store.put(e)}get(e,t){return this._store.get(ws(e,t))}removeAllForRoom(e){this._store.delete(this._allRange(e))}}function et(n,e){return`${n}|${Ls(e)}`}function Al(n){const[e,t]=n.split("|"),s=Si(t);return{roomId:e,queueIndex:s}}class xl{constructor(e){this._eventStore=e}async getMaxQueueIndex(e){const t=this._eventStore.IDBKeyRange.bound(et(e,F.minStorageKey),et(e,F.maxStorageKey),!1,!1),s=await this._eventStore.findMaxKey(t);if(s)return Al(s).queueIndex}remove(e,t){const s=this._eventStore.IDBKeyRange.only(et(e,t));this._eventStore.delete(s)}async exists(e,t){const s=this._eventStore.IDBKeyRange.only(et(e,t));return!!await this._eventStore.getKey(s)}add(e){e.key=et(e.roomId,e.queueIndex),this._eventStore.add(e)}update(e){this._eventStore.put(e)}getAll(){return this._eventStore.selectAll()}removeAllForRoom(e){const t=et(e,F.minStorageKey),s=et(e,F.maxStorageKey),i=this._eventStore.IDBKeyRange.bound(t,s);this._eventStore.delete(i)}}class Nl{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e){this._store.put(e)}remove(e){this._store.delete(e)}}function tt(n,e){return`${n}|${e}`}function Dl(n){const[e,t]=n.split("|");return{userId:e,deviceId:t}}class Ol{constructor(e){this._store=e}getAllForUserId(e){const t=this._store.IDBKeyRange.lowerBound(tt(e,""));return this._store.selectWhile(t,s=>s.userId===e)}async getAllDeviceIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(tt(e,""));return await this._store.iterateKeys(s,i=>{const r=Dl(i);return r.userId===e?(t.push(r.deviceId),!1):!0}),t}get(e,t){return this._store.get(tt(e,t))}set(e){e.key=tt(e.userId,e.deviceId),this._store.put(e)}getByCurve25519Key(e){return this._store.index("byCurve25519Key").get(e)}remove(e,t){this._store.delete(tt(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(tt(e,ne),tt(e,J),!0,!0);this._store.delete(t)}}function Pt(n,e){return`${n}|${e}`}function Ll(n){const[e,t]=n.split("|");return{senderKey:e,sessionId:t}}class Pl{constructor(e){this._store=e}async getSessionIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(Pt(e,""));return await this._store.iterateKeys(s,i=>{const r=Ll(i);return r.senderKey===e?(t.push(r.sessionId),!1):!0}),t}getAll(e){const t=this._store.IDBKeyRange.lowerBound(Pt(e,""));return this._store.selectWhile(t,s=>s.senderKey===e)}get(e,t){return this._store.get(Pt(e,t))}set(e){e.key=Pt(e.senderKey,e.sessionId),this._store.put(e)}remove(e,t){this._store.delete(Pt(e,t))}}var qs=(n=>(n[n.NotBackedUp=0]="NotBackedUp",n[n.BackedUp=1]="BackedUp",n))(qs||{}),is=(n=>(n[n.DeviceMessage=1]="DeviceMessage",n[n.Backup=2]="Backup",n[n.Outbound=3]="Outbound",n))(is||{});function bt(n,e,t){return`${n}|${e}|${t}`}class Vl{constructor(e){this._store=e}async has(e,t,s){const i=bt(e,t,s),r=await this._store.getKey(i);return i===r}get(e,t,s){return this._store.get(bt(e,t,s))}set(e){const t=e;t.key=bt(e.roomId,e.senderKey,e.sessionId),this._store.put(t)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(bt(e,ne,ne),bt(e,J,J));this._store.delete(t)}countNonBackedUpSessions(){return this._store.index("byBackup").count(this._store.IDBKeyRange.only(0))}getFirstNonBackedUpSessions(e){return this._store.index("byBackup").selectLimit(this._store.IDBKeyRange.only(0),e)}async markAsBackedUp(e,t,s){const i=await this._store.get(bt(e,t,s));i&&(i.backup=1,this._store.put(i))}async markAllAsNotBackedUp(){const e=this._store.IDBKeyRange.only(1);let t=0;return await this._store.index("byBackup").iterateValues(e,(s,i,r)=>(s.backup=0,r.update(s),t+=1,!1)),t}}class Ul{constructor(e){this._store=e}remove(e){this._store.delete(e)}get(e){return this._store.get(e)}set(e){this._store.put(e)}}function bs(n,e,t){return`${n}|${e}|${t}`}class Fl{constructor(e){this._store=e}get(e,t,s){return this._store.get(bs(e,t,s))}set(e,t,s,i){i.key=bs(e,t,s),this._store.put(i)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(bs(e,ne,ne),bs(e,J,J));this._store.delete(t)}}function Kt(n,e){return`${n}|${e}`}class Bl{constructor(e){this._store=e}getAll(){return this._store.selectAll()}async getAllByTypeAndScope(e,t){const s=Kt(t,e),i=[];return await this._store.index("byScopeAndType").iterateWhile(s,r=>r.scopeTypeKey!==s?!1:(i.push(r),!0)),i}add(e){e.scopeTypeKey=Kt(e.scope,e.type),this._store.add(e)}update(e){this._store.put(e)}remove(e){this._store.delete(e)}async removeAllForScope(e){const t=this._store.IDBKeyRange.bound(Kt(e,ne),Kt(e,J));await this._store.index("byScopeAndType").iterateValues(t,(i,r,o)=>(o.delete(),!0))}}class Kl{constructor(e){this._store=e}async get(e){return await this._store.get(e)}set(e){this._store.put(e)}}class $l{constructor(e,t,s,i){this.error=e,this.refItem=t,this.operationName=s,this.keys=i}}class zr{constructor(e,t,s){this._txn=e,this._allowedStoreNames=t,this._stores={},this._storage=s,this._writeErrors=[]}get idbFactory(){return this._storage.idbFactory}get IDBKeyRange(){return this._storage.IDBKeyRange}get databaseName(){return this._storage.databaseName}get logger(){return this._storage.logger}_idbStore(e){if(!this._allowedStoreNames.includes(e))throw new xe(`Invalid store for transaction: ${e}, only ${this._allowedStoreNames.join(", ")} are allowed.`);return new Zn(this._txn.objectStore(e),this)}_store(e,t){if(!this._stores[e]){const s=this._idbStore(e);this._stores[e]=t(s)}return this._stores[e]}get session(){return this._store(V.session,e=>new Bi(e,this._storage.localStorage))}get roomSummary(){return this._store(V.roomSummary,e=>new jr(e))}get archivedRoomSummary(){return this._store(V.archivedRoomSummary,e=>new jr(e))}get invites(){return this._store(V.invites,e=>new Sl(e))}get timelineFragments(){return this._store(V.timelineFragments,e=>new Ml(e))}get timelineEvents(){return this._store(V.timelineEvents,e=>new kl(e))}get timelineRelations(){return this._store(V.timelineRelations,e=>new Rl(e))}get roomState(){return this._store(V.roomState,e=>new Cl(e))}get roomMembers(){return this._store(V.roomMembers,e=>new no(e))}get pendingEvents(){return this._store(V.pendingEvents,e=>new xl(e))}get userIdentities(){return this._store(V.userIdentities,e=>new Nl(e))}get deviceIdentities(){return this._store(V.deviceIdentities,e=>new Ol(e))}get olmSessions(){return this._store(V.olmSessions,e=>new Pl(e))}get inboundGroupSessions(){return this._store(V.inboundGroupSessions,e=>new Vl(e))}get outboundGroupSessions(){return this._store(V.outboundGroupSessions,e=>new Ul(e))}get groupSessionDecryptions(){return this._store(V.groupSessionDecryptions,e=>new Fl(e))}get operations(){return this._store(V.operations,e=>new Bl(e))}get accountData(){return this._store(V.accountData,e=>new Kl(e))}async complete(e){try{await Xt(this._txn)}catch(t){throw this._writeErrors.length?(this._logWriteErrors(e),this._writeErrors[0].error):t}}getCause(e){return e instanceof xe&&e.errcode==="AbortError"&&this._writeErrors.length?this._writeErrors[0].error:e}abort(e){try{this._txn.abort()}catch{e?.set("couldNotAbortTxn",!0)}this._writeErrors.length&&this._logWriteErrors(e)}addWriteError(e,t,s,i){(e.errcode!=="AbortError"||this._writeErrors.length===0)&&this._writeErrors.push(new $l(e,t,s,i))}_logWriteErrors(e){const t=i=>{e||i.set("allowedStoreNames",this._allowedStoreNames);for(const r of this._writeErrors)i.wrap({l:r.operationName,id:r.keys},o=>{r.refItem&&o.refDetached(r.refItem),o.catch(r.error)})},s=`${this._writeErrors.length} storage write operation(s) failed`;e?e.wrap(s,t):this.logger.run(s,t)}}const Gr="782rh281re38-boguskey";class jl{constructor(e,t,s,i,r,o){this._db=e,this.idbFactory=t,this.IDBKeyRange=s,this._hasWebkitEarlyCloseTxnBug=i,this.storeNames=V,this.localStorage=r,this.logger=o}_validateStoreNames(e){const t=e.findIndex(s=>!Qt.includes(s));if(t!==-1)throw new xe(`Tried top, a transaction unknown store ${e[t]}`)}async readTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readonly");return this._hasWebkitEarlyCloseTxnBug&&await te(t.objectStore(e[0]).get(Gr)),new zr(t,e,this)}catch(t){throw new xe("readTxn failed",t)}}async readWriteTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readwrite");return this._hasWebkitEarlyCloseTxnBug&&await te(t.objectStore(e[0]).get(Gr)),new zr(t,e,this)}catch(t){throw new xe("readWriteTxn failed",t)}}close(){this._db.close()}get databaseName(){return this._db.name}}async function ql(n){const e=n.transaction(Qt,"readonly"),t={};return await Promise.all(Qt.map(async s=>{const i=t[s]=[],r=e.objectStore(s);await q(r.openCursor(),o=>(i.push(o),Ye))})),t}async function Hl(n,e){const t=n.transaction(Qt,"readwrite");for(const s of Qt){const i=t.objectStore(s);for(const r of e[s])i.add(r)}await Xt(t)}function Ei(n){var e;return((e=n.unsigned)==null?void 0:e.prev_content)||n.prev_content}const be="m.room.redaction";function ki(n){var e;return!!((e=n?.unsigned)!=null&&e.redacted_because)}var U=(n=>(n[n.None=1]="None",n[n.BeingCreated=2]="BeingCreated",n[n.Invited=4]="Invited",n[n.Joined=8]="Joined",n[n.Replaced=16]="Replaced",n[n.Archived=32]="Archived",n))(U||{}),le=(n=>(n[n.DirectMessage=0]="DirectMessage",n[n.Private=1]="Private",n[n.Public=2]="Public",n))(le||{});function Wl(n,e){var t,s;let i;const r=l=>{const c=e(l);c instanceof Promise&&(i=i??[],i.push(c))},o=(t=n.state)==null?void 0:t.events;if(o)for(let l=0;l<o.length;l++)r(o[l]);let a=(s=n.timeline)==null?void 0:s.events;if(a)for(let l=0;l<a.length;l++){const c=a[l];typeof c.state_key=="string"&&r(c)}if(i)return Promise.all(i).then(()=>{})}const ce="m.room.member";class P{constructor(e){this._data=e}static fromUserId(e,t,s){return new P({roomId:e,userId:t,membership:s})}static fromMemberEvent(e,t){const s=t?.state_key;if(typeof s!="string")return;const i=t.content,r=Ei(t),o=i?.membership,a=i?.displayname||r?.displayname,l=i?.avatar_url||r?.avatar_url;return this._validateAndCreateMember(e,s,o,a,l)}static fromReplacingMemberEvent(e,t){const s=t&&t.state_key;if(typeof s!="string")return;const i=Ei(t);return this._validateAndCreateMember(e,s,i?.membership,i?.displayname,i?.avatar_url)}static _validateAndCreateMember(e,t,s,i,r){if(typeof s=="string")return new P({roomId:e,userId:t,membership:s,avatarUrl:r,displayName:i})}get membership(){return this._data.membership}get displayName(){return this._data.displayName}get name(){return this._data.displayName||this._data.userId}get avatarUrl(){return this._data.avatarUrl}get roomId(){return this._data.roomId}get userId(){return this._data.userId}serialize(){return this._data}equals(e){const t=this._data,s=e._data;return t.roomId===s.roomId&&t.userId===s.userId&&t.membership===s.membership&&t.displayName===s.displayName&&t.avatarUrl===s.avatarUrl}}class oo{constructor(e,t){this.member=e,this.previousMembership=t}get roomId(){return this.member.roomId}get userId(){return this.member.userId}get membership(){return this.member.membership}get wasInvited(){return this.previousMembership==="invite"&&this.membership!=="invite"}get hasLeft(){return this.previousMembership==="join"&&this.membership!=="join"}get hasJoined(){return this.previousMembership!=="join"&&this.membership==="join"}}const ao=[Gl,Yl,Jl,Ql,Xl,Zl,ec,tc,sc,ic,rc,nc,oc,ac,lc,cc];function zl(n){return{databaseName:n.name,get idbFactory(){throw new Error("unused")},get IDBKeyRange(){throw new Error("unused")},addWriteError(){}}}function Gl(n){n.createObjectStore("session",{keyPath:"key"}),n.createObjectStore("roomSummary",{keyPath:"roomId"}),n.createObjectStore("timelineFragments",{keyPath:"key"}),n.createObjectStore("timelineEvents",{keyPath:"key"}).createIndex("byEventId","eventIdKey",{unique:!0}),n.createObjectStore("roomState",{keyPath:"key"}),n.createObjectStore("pendingEvents",{keyPath:"key"})}async function Yl(n,e){const t=new no(n.createObjectStore("roomMembers",{keyPath:"key"})),s=e.objectStore("roomState");await q(s.openCursor(),i=>{if(i.event.type===ce){s.delete(i.key);const r=P.fromMemberEvent(i.roomId,i.event);r&&t.set(r.serialize())}return Ye})}async function Jl(n,e,t){const s=e.objectStore("session");try{const r=await te(s.get(1));if(r){s.delete(1);const{syncToken:o,syncFilterId:a,serverVersions:l}=r.value,c=new Bi(s,t);c.set("sync",{token:o,filterId:a}),c.set("serverVersions",l)}}catch(i){e.abort(),console.error("could not migrate session",i.stack)}}function Ql(n){n.createObjectStore("userIdentities",{keyPath:"userId"}),n.createObjectStore("deviceIdentities",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0}),n.createObjectStore("olmSessions",{keyPath:"key"}),n.createObjectStore("inboundGroupSessions",{keyPath:"key"}),n.createObjectStore("outboundGroupSessions",{keyPath:"roomId"}),n.createObjectStore("groupSessionDecryptions",{keyPath:"key"}),n.createObjectStore("operations",{keyPath:"id"}).createIndex("byTypeAndScope","typeScopeKey",{unique:!1})}async function Xl(n,e){var t;const s=e.objectStore("roomSummary"),i=e.objectStore("roomState"),r=[];await q(s.openCursor(),o=>(r.push(o),Ye));for(const o of r){const a=await te(i.get(`${o.roomId}|m.room.encryption|`));a&&(o.encryption=(t=a?.event)==null?void 0:t.content,delete o.isEncrypted,s.put(o))}}function Zl(n){n.createObjectStore("accountData",{keyPath:"type"})}function ec(n){n.createObjectStore("invites",{keyPath:"roomId"})}function tc(n){n.createObjectStore("archivedRoomSummary",{keyPath:"summary.roomId"})}async function sc(n,e){try{const t=e.objectStore("operations");t.deleteIndex("byTypeAndScope"),await q(t.openCursor(),(s,i,r)=>{const{typeScopeKey:o}=s;delete s.typeScopeKey;const[a,l]=o.split("|");return s.scopeTypeKey=Kt(l,a),r.update(s),Ye}),t.createIndex("byScopeAndType","scopeTypeKey",{unique:!1})}catch(t){e.abort(),console.error("could not migrate operations",t.stack)}}function ic(n){n.createObjectStore("timelineRelations",{keyPath:"key"})}function rc(){}async function nc(n,e){const t=e.objectStore("session"),s=await te(t.get("ssssKey"));s&&t.put({key:`${ae}ssssKey`,value:s.value})}async function oc(n,e,t,s){const i=e.objectStore("session"),r=new Bi(new Zn(i,zl(n)),t);r.writeE2EEIdentityToLocalStorage();const o=await r.tryRestoreE2EEIdentityFromLocalStorage(s);s.set("restored",o)}async function ac(n,e){for(const t of n.objectStoreNames){const s=e.objectStore(t);switch(t){case"inboundGroupSessions":case"outboundGroupSessions":case"olmSessions":case"operations":continue;case"session":{await q(s.openCursor(),(i,r,o)=>(r.startsWith(ae)||o.delete(),Ye));break}default:{s.clear();break}}}}async function lc(n,e,t,s){e.objectStore("inboundGroupSessions").createIndex("byBackup","backup",{unique:!1})}async function cc(n,e,t,s){const i=e.objectStore("inboundGroupSessions");let r=0,o=0;await q(i.openCursor(),(a,l,c)=>(a.session?(a.backup=qs.NotBackedUp,a.source=is.DeviceMessage,c.update(a),r+=1):o+=1,Ye)),s.set("countWithoutSession",o),s.set("countWithSession",r)}async function hc(n){const e="hydrogen_webkit_test_inactive_txn_bug";try{const t=await Ui(e,r=>{r.createObjectStore("test",{keyPath:"key"})},1,n),s=t.transaction(["test"],"readonly");await te(s.objectStore("test").get("somekey")),await new Promise(r=>setTimeout(r,0));const i=t.transaction(["test"],"readwrite");await Promise.resolve(),i.objectStore("test").add({key:"somekey",value:"foo"}),await Xt(i),t.close()}catch(t){if(t.name==="TransactionInactiveError")return!0}return!1}const lo=n=>`hydrogen_session_${n}`,pi=function(n,e,t,s){const i=(r,o,a,l)=>mc(r,o,a,l,t,s);return Ui(lo(n),i,ao.length,e)};async function dc(){var n,e;const t=this;if((e=(n=t?.navigator)==null?void 0:n.storage)!=null&&e.persist)return await t.navigator.storage.persist();if(t?.document.requestStorageAccess)try{return await t.document.requestStorageAccess(),!0}catch(s){return console.warn("requestStorageAccess threw an error:",s),!1}else return!1}class uc{constructor(e,t=window.indexedDB,s=window.IDBKeyRange,i=window.localStorage){this._serviceWorkerHandler=e,this._idbFactory=t,this._IDBKeyRange=s,this._localStorage=i}async create(e,t){var s;await((s=this._serviceWorkerHandler)==null?void 0:s.preventConcurrentSessionAccess(e)),dc().then(o=>{o||console.warn("no persisted storage, database can be evicted by browser")});const i=await hc(this._idbFactory),r=await pi(e,this._idbFactory,this._localStorage,t);return new jl(r,this._idbFactory,this._IDBKeyRange,i,this._localStorage,t.logger)}delete(e){const t=lo(e),s=this._idbFactory.deleteDatabase(t);return te(s)}async export(e,t){const s=await pi(e,this._idbFactory,this._localStorage,t);return await ql(s)}async import(e,t,s){const i=await pi(e,this._idbFactory,this._localStorage,s);return await Hl(i,t)}}async function mc(n,e,t,s,i,r){const o=t||0;return r.wrap({l:"storage migration",oldVersion:t,version:s},async a=>{for(let l=o;l<s;++l){const c=ao[l];await a.wrap(`v${l+1}`,h=>c(n,e,i,h))}})}class pc{constructor(e){this._name=e}getAll(){const e=localStorage.getItem(this._name);if(e){const t=JSON.parse(e);if(Array.isArray(t))return Promise.resolve(t)}return Promise.resolve([])}async updateLastUsed(e,t){const s=await this.getAll();if(s){const i=s.find(r=>r.id===e);i&&(i.lastUsed=t,localStorage.setItem(this._name,JSON.stringify(s)))}}async get(e){const t=await this.getAll();if(t)return t.find(s=>s.id===e)}async add(e){const t=await this.getAll();t.push(e),localStorage.setItem(this._name,JSON.stringify(t))}async delete(e){let t=await this.getAll();t=t.filter(s=>s.id!==e),localStorage.setItem(this._name,JSON.stringify(t))}}class _c{constructor(e){this._prefix=e}async setInt(e,t){this._set(e,t)}async getInt(e,t=0){const s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?parseInt(s,10):t}async setBool(e,t){this._set(e,t)}async getBool(e,t=!1){const s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?s==="true":t}async setString(e,t){this._set(e,t)}async getString(e){return window.localStorage.getItem(`${this._prefix}${e}`)}async remove(e){window.localStorage.removeItem(`${this._prefix}${e}`)}async _set(e,t){window.localStorage.setItem(`${this._prefix}${e}`,t)}}class gc{constructor(){this._encoder=null,this._decoder=null}encode(e){return this._encoder||(this._encoder=new TextEncoder),this._encoder.encode(e)}decode(e){return this._decoder||(this._decoder=new TextDecoder),this._decoder.decode(e)}}class fc{encodeUnpadded(e){const t=at.encode(e),s=t.indexOf("=");return s!==-1?t.substr(0,s):t}encode(e){return at.encode(e)}decode(e){return at.decode(e)}}function yc(n){if(n.__esModule)return n;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(n).forEach(function(t){var s=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(e,t,s.get?s:{enumerable:!0,get:function(){return n[t]}})}),e}var co={isBuffer:function(n){return n instanceof Uint8Array},from:function(n){return n},allocUnsafe:function(n){return co.alloc(n)},alloc:function(n){return new Uint8Array(n)}},vc=Object.freeze(Object.defineProperty({__proto__:null,Buffer:co},Symbol.toStringTag,{value:"Module"})),wc=yc(vc),Ss=wc.Buffer;function bc(n){if(n.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var s=0;s<n.length;s++){var i=n.charAt(s),r=i.charCodeAt(0);if(e[r]!==255)throw new TypeError(i+" is ambiguous");e[r]=s}var o=n.length,a=n.charAt(0),l=Math.log(o)/Math.log(256),c=Math.log(256)/Math.log(o);function h(p){if((Array.isArray(p)||p instanceof Uint8Array)&&(p=Ss.from(p)),!Ss.isBuffer(p))throw new TypeError("Expected Buffer");if(p.length===0)return"";for(var _=0,g=0,b=0,S=p.length;b!==S&&p[b]===0;)b++,_++;for(var I=(S-b)*c+1>>>0,C=new Uint8Array(I);b!==S;){for(var v=p[b],k=0,x=I-1;(v!==0||k<g)&&x!==-1;x--,k++)v+=256*C[x]>>>0,C[x]=v%o>>>0,v=v/o>>>0;if(v!==0)throw new Error("Non-zero carry");g=k,b++}for(var O=I-g;O!==I&&C[O]===0;)O++;for(var pt=a.repeat(_);O<I;++O)pt+=n.charAt(C[O]);return pt}function d(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return Ss.alloc(0);var _=0;if(p[_]!==" "){for(var g=0,b=0;p[_]===a;)g++,_++;for(var S=(p.length-_)*l+1>>>0,I=new Uint8Array(S);p[_];){var C=e[p.charCodeAt(_)];if(C===255)return;for(var v=0,k=S-1;(C!==0||v<b)&&k!==-1;k--,v++)C+=o*I[k]>>>0,I[k]=C%256>>>0,C=C/256>>>0;if(C!==0)throw new Error("Non-zero carry");b=v,_++}if(p[_]!==" "){for(var x=S-b;x!==S&&I[x]===0;)x++;var O=Ss.allocUnsafe(g+(S-x));O.fill(0,0,g);for(var pt=g;x!==S;)O[pt++]=I[x++];return O}}}function m(p){var _=d(p);if(_)return _;throw new Error("Non-base"+o+" character")}return{encode:h,decodeUnsafe:d,decode:m}}var Sc=bc,Ic=Sc,Ec="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",Yr=Ic(Ec);class kc{encode(e){return Yr.encode(e)}decode(e){return Yr.decode(e)}}class Rc{constructor(){this.utf8=new gc,this.base64=new fc,this.base58=new kc}}class Cc{constructor(e){this._workerPool=e}megolmDecrypt(e,t){const s=e.export_session(e.first_known_index());return this._workerPool.send({type:"megolm_decrypt",ciphertext:t,sessionKey:s})}async createAccountAndOTKs(e,t){let s;window.msCrypto&&(s=[window.msCrypto.getRandomValues(new Uint8Array(64)),window.msCrypto.getRandomValues(new Uint8Array(t*32))]);const i=await this._workerPool.send({type:"olm_create_account_otks",randomValues:s,otkAmount:t}).response();e.unpickle("",i)}async createOutboundOlmSession(e,t,s,i){const r=e.pickle("");let o;window.msCrypto&&(o=[window.msCrypto.getRandomValues(new Uint8Array(64))]);const a=await this._workerPool.send({type:"olm_create_outbound",accountPickle:r,theirIdentityKey:s,theirOneTimeKey:i,randomValues:o}).response();t.unpickle("",a)}dispose(){this._workerPool.dispose()}}class Ht{constructor(e,t,s,i){this._logger=s,this.start=s._now(),this._values=typeof e=="string"?{l:e}:e,this.logLevel=t,this._filterCreator=i}runDetached(e,t,s,i){return this._logger.runDetached(e,t,s,i)}wrapDetached(e,t,s,i){this.refDetached(this.runDetached(e,t,s,i))}refDetached(e,t){e.ensureRefId(),this.log({ref:e.values.refId},t)}ensureRefId(){this._values.refId||this.set("refId",this._logger._createRefId())}wrap(e,t,s,i){return this.child(e,s,i).run(t)}get duration(){if(this.end)return this.end-this.start}durationWithoutType(e){const t=this.durationOfType(e);if(this.duration&&t)return this.duration-t}durationOfType(e){return this._values.t===e?this.duration:this._children?this._children.reduce((t,s)=>{const i=s.durationOfType(e);return t+(i??0)},0):0}log(e,t){const s=this.child(e,t);return s.end=s.start,s}set(e,t){if(typeof e=="object"){const s=e;Object.assign(this._values,s)}else this._values[e]=t;return this}serialize(e,t,s){if(this._filterCreator)try{e=this._filterCreator(new Ii(e),this)}catch(o){console.error("Error creating log filter",o)}let i=null;if(this._children&&(i=this._children.reduce((o,a)=>{const l=a.serialize(e,this.start,!1);return l&&(o===null&&(o=[]),o.push(l)),o},null)),e&&!e.filter(this,i))return;const r={s:typeof t=="number"?this.start-t:this.start,d:this.duration,v:this._values,l:this.logLevel};return this.error&&(r.e={stack:this.error.stack,name:this.error.name,message:this.error.message.split(`
`)[0]}),s&&(r.f=!0),i&&(r.c=i),r}run(e){this.end!==void 0&&console.trace("log item is finished, additional logs will likely not be recorded");try{const t=e(this);return t instanceof Promise?t.then(s=>(this.finish(),s),s=>{throw this.catch(s)}):(this.finish(),t)}catch(t){throw this.catch(t)}}finish(){if(this.end===void 0){if(this._children)for(const e of this._children)e.finish();this.end=this._logger._now()}}get level(){return ve}catch(e){return this.error=e,this.logLevel=ve.Error,this.finish(),e}child(e,t,s){this.end&&console.trace("log item is finished, additional logs will likely not be recorded"),t||(t=this.logLevel||ve.Info);const i=new Ht(e,t,this._logger,s);return this._children||(this._children=[]),this._children.push(i),i}get logger(){return this._logger}get values(){return this._values}get children(){return this._children}}class ho{constructor({platform:e,serializedTransformer:t=s=>s}){this._openItems=new Set,this._platform=e,this._serializedTransformer=t}log(e,t=ve.Info){const s=new Ht(e,t,this);s.end=s.start,this._persistItem(s,void 0,!1)}wrapOrRun(e,t,s,i,r){return e?e.wrap(t,s,i,r):this.run(t,s,i,r)}runDetached(e,t,s,i){s||(s=ve.Info);const r=new Ht(e,s,this);return this._run(r,t,s,!1,i),r}run(e,t,s,i){s===void 0&&(s=ve.Info);const r=new Ht(e,s,this);return this._run(r,t,s,!0,i)}_run(e,t,s,i,r){this._openItems.add(e);const o=()=>{let a=new Ii;if(r)try{a=r(a,e)}catch(l){console.error("Error while creating log filter",l)}else a=a.minLevel(s);try{this._persistItem(e,a,!1)}catch(l){console.error("Could not persist log item",l)}this._openItems.delete(e)};try{let a=e.run(t);if(a instanceof Promise){if(a=a.then(l=>(o(),l),l=>{if(o(),i)throw l}),i)return a}else if(o(),i)return a}catch(a){if(o(),i)throw a}}_finishOpenItems(){for(const e of this._openItems){e.finish();try{this._persistItem(e,new Ii,!0)}catch(t){console.error("Could not serialize log item",t)}}this._openItems.clear()}get level(){return ve}_now(){return this._platform.clock.now()}_createRefId(){return Math.round(this._platform.random()*Number.MAX_SAFE_INTEGER)}}class Tc extends ho{constructor(e){super(e);const{name:t,flushInterval:s=60*1e3,limit:i=3e3}=e;this._name=t,this._limit=i,this._queuedItems=this._loadQueuedItems(),window.addEventListener("pagehide",this,!1),this._flushInterval=this._platform.clock.createInterval(()=>this._tryFlush(),s)}dispose(){window.removeEventListener("pagehide",this,!1),this._flushInterval.dispose()}handleEvent(e){e.type==="pagehide"&&this._finishAllAndFlush()}async _tryFlush(){const e=await this._openDB();try{const t=e.transaction(["logs"],"readwrite"),s=t.objectStore("logs"),i=this._queuedItems.length;for(const o of this._queuedItems)s.add(o);const r=await te(s.count());if(r>this._limit){let o=r-this._limit+Math.round(.1*this._limit);await q(s.openCursor(),(a,l,c)=>(c.delete(),o-=1,{done:o===0}))}await Xt(t),this._queuedItems.splice(0,i)}catch(t){console.error("Could not flush logs",t)}finally{try{e.close()}catch{}}}_finishAllAndFlush(){this._finishOpenItems(),this.log({l:"pagehide, closing logs",t:"navigation"}),this._persistQueuedItems(this._queuedItems)}_loadQueuedItems(){const e=`${this._name}_queuedItems`;try{const t=window.localStorage.getItem(e);if(t)return window.localStorage.removeItem(e),JSON.parse(t)}catch(t){console.error("Could not load queued log items",t)}return[]}_openDB(){return Ui(this._name,e=>e.createObjectStore("logs",{keyPath:"id",autoIncrement:!0}),1)}_persistItem(e,t,s){const i=e.serialize(t,void 0,s);if(i){const r=this._serializedTransformer(i);this._queuedItems.push({json:JSON.stringify(r)})}}_persistQueuedItems(e){try{window.localStorage.setItem(`${this._name}_queuedItems`,JSON.stringify(e))}catch(t){console.error("Could not persist queued log items in localStorage, they will likely be lost",t)}}async export(){const e=await this._openDB();try{const s=e.transaction(["logs"],"readonly").objectStore("logs"),r=(await _l(s.openCursor(),()=>!1)).concat(this._queuedItems);return new Mc(r,this,this._platform)}finally{try{e.close()}catch{}}}async _removeItems(e){const t=await this._openDB();try{const s=t.transaction(["logs"],"readwrite"),i=s.objectStore("logs");for(const r of e)if(typeof r.id=="number")i.delete(r.id);else{const o=this._queuedItems.indexOf(r);o===-1&&this._queuedItems.splice(o,1)}await Xt(s)}finally{try{t.close()}catch{}}}}class Mc{constructor(e,t,s){this._items=e,this._logger=t,this._platform=s}get count(){return this._items.length}removeFromStore(){return this._logger._removeItems(this._items)}asBlob(){var e;const t={formatVersion:1,appVersion:(e=this._platform.updateService)==null?void 0:e.version,items:this._items.map(o=>JSON.parse(o.json))},s=JSON.stringify(t),i=this._platform.encoding.utf8.encode(s);return this._platform.createBlob(i,"application/json")}}class Ac extends ho{_persistItem(e){uo(e)}async export(){}}const xc=["l","id"];function Nc(n){return Object.entries(n).filter(([e])=>!xc.includes(e)).reduce((e,[t,s])=>(e=e||{},e[t]=s,e),null)}function uo(n){const e=`${Dc(n)} (${n.duration}ms)`,t=Nc(n.values),s=n.children||t;if(s?(n.error?console.group(e):console.groupCollapsed(e),n.error&&console.error(n.error)):n.error?console.error(n.error):console.log(e),t&&console.table(t),n.children)for(const i of n.children)uo(i);s&&console.groupEnd()}function Dc(n){return n.values.t==="network"?`${n.values.method} ${n.values.url}`:n.values.l&&typeof n.values.id<"u"?`${n.values.l} ${n.values.id}`:n.values.l&&typeof n.values.status<"u"?`${n.values.l} (${n.values.status})`:n.values.l&&n.error?`${n.values.l} failed`:typeof n.values.ref<"u"?`ref ${n.values.ref}`:n.values.l||n.values.type}function mo(n){return typeof n!="object"||"nodeType"in n||Array.isArray(n)}function Et(n,e){return Object.entries(n).reduce((t,[s,i])=>(typeof i=="function"&&(i=i(e)),i?t+(t.length?" ":"")+s:t),"")}function It(n,e,t){e==="className"&&(e="class"),t===!1?n.removeAttribute(e):(t===!0&&(t=e),n.setAttribute(e,t))}function Oc(n,e,t){return po(Ki,n,e,t)}function po(n,e,t,s){t&&mo(t)&&(s=t,t=void 0);const i=document.createElementNS(n,e);if(t)for(let[r,o]of Object.entries(t))typeof o=="object"&&(o=o!==null&&r==="className"?Et(o,void 0):!1),It(i,r,o);if(s){Array.isArray(s)||(s=[s]);for(let r of s)typeof r=="string"&&(r=Ne(r)),i.appendChild(r)}return i}function Ne(n){return document.createTextNode(n)}const Ki="http://www.w3.org/1999/xhtml",Lc="http://www.w3.org/2000/svg",_o={[Ki]:["br","a","ol","ul","li","div","h1","h2","h3","h4","h5","h6","p","strong","em","span","img","section","main","article","aside","del","blockquote","table","thead","tbody","tr","th","td","hr","pre","code","button","time","input","textarea","select","option","label","form","progress","output","video"],[Lc]:["svg","g","path","circle","ellipse","rect","use"]},T={};for(const[n,e]of Object.entries(_o))for(const t of e)T[t]=function(s,i){return po(n,t,s,i)};function Zt(n,e){let t;try{t=n.mount(e)}catch(s){t=Pc(s)}return t}function Pc(n){const e=new Error().stack;let t=null;return e&&(t=e.split(`
`)[1]),T.div([T.h2("Something went wrong\u2026"),T.h3(n.message),T.p(`This occurred while running ${t}.`),T.pre(n.stack)])}function Jr(n,e,t){if(e===n.childElementCount)n.appendChild(t);else{const i=n.children[e];n.insertBefore(t,i)}}function Vc(n){n.innerHTML=""}function Uc(n){return async e=>{var t,s;(t=e.target)==null||t.setAttribute("disabled","disabled"),await n(e),(s=e.target)==null||s.removeAttribute("disabled")}}class rs{constructor({list:e,onItemClick:t,className:s,tagName:i="ul",parentProvidesUpdates:r=!0},o){this._onItemClick=t,this._list=e,this._className=s,this._tagName=i,this._root=void 0,this._subscription=void 0,this._childCreator=o,this._childInstances=void 0,this._mountArgs={parentProvidesUpdates:r}}root(){return this._root}update(e){if(e.list){if(this._subscription)for(this._unloadList();this._root.lastChild;)this._root.lastChild.remove();this._list=e.list,this.loadList()}}mount(){const e={};this._className&&(e.className=this._className);const t=this._root=Oc(this._tagName,e);return this.loadList(),this._onItemClick&&t.addEventListener("click",this),t}handleEvent(e){e.type==="click"&&this._handleClick(e)}unmount(){this._list&&this._unloadList()}_handleClick(e){if(e.target===this._root||!this._onItemClick)return;let t=e.target;for(;t.parentNode!==this._root;)t=t.parentNode;const s=Array.prototype.indexOf.call(this._root.childNodes,t),i=this._childInstances[s];i&&this._onItemClick(i,e)}_unloadList(){this._subscription=this._subscription();for(let e of this._childInstances)e.unmount();this._childInstances=void 0}loadList(){if(!this._list)return;this._subscription=this._list.subscribe(this),this._childInstances=[];const e=document.createDocumentFragment();for(let t of this._list){const s=this._childCreator(t);this._childInstances.push(s),e.appendChild(Zt(s,this._mountArgs))}this._root.appendChild(e)}onReset(){for(const e of this._childInstances)e.root().remove(),e.unmount();this._childInstances.length=0}onAdd(e,t){this.addChild(e,t)}onRemove(e,t){this.removeChild(e)}onMove(e,t,s){this.moveChild(e,t)}onUpdate(e,t,s){this.updateChild(e,t,s)}addChild(e,t){const s=this._childCreator(t);this._childInstances.splice(e,0,s),Jr(this._root,e,Zt(s,this._mountArgs))}removeChild(e){const[t]=this._childInstances.splice(e,1);t.root().remove(),t.unmount()}moveChild(e,t){const[s]=this._childInstances.splice(e,1);this._childInstances.splice(t,0,s),s.root().remove(),Jr(this._root,t,s.root())}updateChild(e,t,s){if(this._childInstances){const i=this._childInstances[e];i&&i.update(t,s)}}recreateItem(e,t){if(this._childInstances){const s=this._childCreator(t);if(!s)this.onRemove(e,t);else{const[i]=this._childInstances.splice(e,1,s);this._root.replaceChild(s.mount(this._mountArgs),i.root()),i.unmount()}}}getChildInstanceByIndex(e){var t;return(t=this._childInstances)==null?void 0:t[e]}}class go{constructor(e){this._value=e,this._boundUpdateFromValue=null}subscribeOnMount(e){e&&e.parentProvidesUpdates||this._subscribe()}unmount(){this._unsubscribe()}get value(){return this._value}_updateFromValue(e){this.update(this._value,e)}_subscribe(){var e;typeof((e=this._value)==null?void 0:e.on)=="function"&&(this._boundUpdateFromValue=this._updateFromValue.bind(this),this._value.on("change",this._boundUpdateFromValue))}_unsubscribe(){this._boundUpdateFromValue&&(typeof this._value.off=="function"&&this._value.off("change",this._boundUpdateFromValue),this._boundUpdateFromValue=null)}}function Fc(n){for(const e of Object.values(n))if(typeof e=="function")return!0;return!1}class E extends go{constructor(){super(...arguments),this._eventListeners=void 0,this._bindings=void 0,this._root=void 0,this._subViews=void 0}_attach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.addEventListener(t,s,i)}_detach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.removeEventListener(t,s,i)}mount(e){const t=new fo(this);try{this._root=this.render(t,this._value)}finally{t.close()}return this.subscribeOnMount(e),this._attach(),this._root}unmount(){if(this._detach(),super.unmount(),this._subViews)for(const e of this._subViews)e.unmount()}root(){return this._root}update(e,t){if(this._value=e,this._bindings)for(const s of this._bindings)s()}_addEventListener(e,t,s,i=!1){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push({node:e,name:t,fn:s,useCapture:i})}_addBinding(e){this._bindings||(this._bindings=[]),this._bindings.push(e)}addSubView(e){this._subViews||(this._subViews=[]),this._subViews.push(e)}removeSubView(e){if(!this._subViews)return;const t=this._subViews.indexOf(e);t!==-1&&this._subViews.splice(t,1)}updateSubViews(e,t){if(this._subViews)for(const s of this._subViews)s.update(e,t)}}class fo{constructor(e){this._closed=!1,this._templateView=e}close(){this._closed=!0}_addBinding(e){this._closed&&console.trace("Adding a binding after render will likely cause memory leaks"),this._templateView._addBinding(e)}get _value(){return this._templateView.value}addEventListener(e,t,s,i=!1){this._templateView._addEventListener(e,t,s,i)}_addAttributeBinding(e,t,s){let i;const r=()=>{const o=s(this._value);i!==o&&(i=o,It(e,t,o))};this._addBinding(r),r()}_addClassNamesBinding(e,t){this._addAttributeBinding(e,"className",s=>Et(t,s))}_addTextBinding(e){const t=e(this._value)+"",s=Ne(t);let i=t;const r=()=>{const o=e(this._value)+"";i!==o&&(i=o,s.textContent=o)};return this._addBinding(r),s}_isEventHandler(e,t){return e.startsWith("on")&&e.length>2&&typeof t=="function"}_setNodeAttributes(e,t){for(let[s,i]of Object.entries(t))if(typeof i=="object"){if(s!=="className"||i===null)continue;Fc(i)?this._addClassNamesBinding(e,i):It(e,s,Et(i,this._value))}else if(this._isEventHandler(s,i)){const r=s.substr(2,1).toLowerCase()+s.substr(3),o=i;this._templateView._addEventListener(e,r,o)}else typeof i=="function"?this._addAttributeBinding(e,s,i):It(e,s,i)}_setNodeChildren(e,t){Array.isArray(t)||(t=[t]);for(let s of t)typeof s=="function"?s=this._addTextBinding(s):typeof s=="string"&&(s=Ne(s)),e.appendChild(s)}_addReplaceNodeBinding(e,t){let s=e(this._value),i=t(null);const r=()=>{const o=e(this._value);if(s!==o){s=o;const a=t(i);i.parentNode&&i.parentNode.replaceChild(a,i),i=a}};return this._addBinding(r),i}el(e,t,s){return this.elNS(Ki,e,t,s)}elNS(e,t,s,i){let r;s&&(mo(s)?i=s:r=s);const o=document.createElementNS(e,t);return r&&this._setNodeAttributes(o,r),i&&this._setNodeChildren(o,i),o}view(e,t){return this._templateView.addSubView(e),Zt(e,t)}mapView(e,t){return this._addReplaceNodeBinding(e,s=>{if(s&&s.nodeType!==Node.COMMENT_NODE){const r=this._templateView._subViews;if(r){const o=r.findIndex(a=>a.root()===s);if(o!==-1){const[a]=r.splice(o,1);a.unmount()}}}const i=t(e(this._value));return i?this.view(i):document.createComment("node binding placeholder")})}map(e,t){return this.mapView(e,s=>new Vs(this._value,(i,r)=>{const o=t(s,i,r);return o||document.createComment("map placeholder")}))}ifView(e,t){return this.mapView(s=>!!e(s),s=>s?t(this._value):null)}if(e,t){return this.ifView(e,s=>new Vs(s,t))}mapSideEffect(e,t){let s=e(this._value);const i=()=>{const r=e(this._value);s!==r&&(t(r,s),s=r)};this._addBinding(i),t(s,void 0)}}for(const[n,e]of Object.entries(_o))for(const t of e)fo.prototype[t]=function(s,i){return this.elNS(n,t,s,i)};class Vs extends E{constructor(e,t){super(e),this._render=t}render(e,t){return this._render(e,t)}}function ot(n,e,t=void 0){const s=!!n.avatarUrl(e);let i=Et({avatar:!0,[`size-${e}`]:!0,[`usercolor${n.avatarColorNumber}`]:!s});t&&(i+=` ${t}`);const r=s?yo(n,e):Ne(n.avatarLetter),o=T.div({className:i,"data-testid":"avatar"},[r]);return s&&(It(o,"data-avatar-letter",n.avatarLetter),It(o,"data-avatar-color",n.avatarColorNumber)),o}function yo(n,e){const t=e.toString();return T.img({src:n.avatarUrl(e),width:t,height:t,title:n.avatarTitle})}function Bc(n){const e=n.target,t=e.parentElement;return e.tagName==="IMG"&&t.classList.contains("avatar")}function Qr(n){if(!Bc(n))return;const e=n.target.parentElement,t=e.getAttribute("data-avatar-color");e.classList.add(`usercolor${t}`);const s=e.getAttribute("data-avatar-letter");e.textContent=s}class mt extends go{constructor(e,t){super(e),this._root=null,this._avatarUrl=null,this._avatarTitle=null,this._avatarLetter=null,this._size=t}_avatarUrlChanged(){return this.value.avatarUrl(this._size)!==this._avatarUrl?(this._avatarUrl=this.value.avatarUrl(this._size),!0):!1}_avatarTitleChanged(){return this.value.avatarTitle!==this._avatarTitle?(this._avatarTitle=this.value.avatarTitle,!0):!1}_avatarLetterChanged(){return this.value.avatarLetter!==this._avatarLetter?(this._avatarLetter=this.value.avatarLetter,!0):!1}mount(e){return this._avatarUrlChanged(),this._avatarLetterChanged(),this._avatarTitleChanged(),this._root=ot(this.value,this._size),this.subscribeOnMount(e),this._root}root(){return this._root}update(e){if(this._avatarUrlChanged()){const s=`usercolor${e.avatarColorNumber}`;e.avatarUrl(this._size)?(this._root.replaceChild(yo(e,this._size),this._root.firstChild),this._root.classList.remove(s)):(this._root.textContent=e.avatarLetter,this._root.classList.add(s))}const t=!!e.avatarUrl(this._size);if(this._avatarTitleChanged()&&t){const s=this._root.firstChild;s.tagName==="IMG"&&s.setAttribute("title",e.avatarTitle)}this._avatarLetterChanged()&&!t&&(this._root.textContent=e.avatarLetter)}}let Is;function Ve(n,e=void 0){Is===void 0&&(Is=document.querySelector(".hydrogen"));const t=Object.assign({spinner:!0},e);return Is?.classList.contains("legacy")?n.div({className:t},[n.div(),n.div(),n.div(),n.div()]):n.svg({className:t,viewBox:"0 0 100 100"},n.circle({cx:"50%",cy:"50%",r:"45%",pathLength:"100"}))}class Kc extends E{render(e,t){const s={active:i=>i.isOpen,hidden:i=>i.hidden};return e.li({className:s},[e.a({href:t.url},[e.view(new mt(t,32),{parentProvidesUpdates:!0}),e.div({className:"description"},[e.div({className:{name:!0,unread:i=>i.isUnread}},i=>i.name),e.map(i=>i.busy,i=>i?Ve(e):e.div({className:{badge:!0,highlighted:r=>r.isHighlighted,hidden:r=>!r.badgeCount}},r=>r.badgeCount))])])])}update(e,t){super.update(e),this.updateSubViews(e,t)}}class $c extends E{render(e,t){const s=()=>{i.value="",i.blur(),r.blur(),t.clear()},i=e.input({type:"text",placeholder:t?.label,"aria-label":t?.label,autocomplete:t?.autocomplete,enterkeyhint:"search",name:t?.name,onInput:o=>t.set(o.target.value),onKeydown:o=>{(o.key==="Escape"||o.key==="Esc")&&s()},onFocus:()=>i.select()}),r=e.button({onClick:s,title:t.i18n`Clear`,"aria-label":t.i18n`Clear`});return e.div({className:"FilterField"},[i,r])}}class jc extends E{render(e,t){const s=o=>o.gridEnabled?o.i18n`Show single room`:o.i18n`Enable grid layout`,i=e.view(new rs({className:"RoomList",list:t.tileViewModels},o=>new Kc(o))),r=e.div({className:"utilities"},[e.a({className:"button-utility close-session",href:t.closeUrl,"aria-label":t.i18n`Back to account list`,title:t.i18n`Back to account list`}),e.view(new $c({i18n:t.i18n,label:t.i18n`Filter rooms`,name:"room-filter",autocomplete:!0,set:o=>{t.setFilter(o)&&(i.scrollTop=0)},clear:()=>t.clearFilter()})),e.button({onClick:()=>t.toggleGrid(),className:{"button-utility":!0,grid:!0,on:o=>o.gridEnabled},title:s,"aria-label":s}),e.a({className:"button-utility settings",href:t.settingsUrl,"aria-label":t.i18n`Settings`,title:t.i18n`Settings`}),e.a({className:"button-utility create",href:t.createRoomUrl,"aria-label":t.i18n`Create room`,title:t.i18n`Create room`})]);return e.div({className:"LeftPanel"},[r,i])}}class $i{constructor(e,t=null){this._view=e,this._target=null,this._arrangement=null,this._scroller=null,this._fakeRoot=null,this._trackingTemplateView=null,this._closeCallback=t}_getPopupContainer(){const e=this._target.closest(".hydrogen");let t=e.querySelector(".popupContainer");return t||(t=T.div({className:"popupContainer"}),e.appendChild(t)),t}trackInTemplateView(e){this._trackingTemplateView=e,this._trackingTemplateView.addSubView(this)}showRelativeTo(e,t=0){this._target=e,this._verticalPadding=t,this._scroller=qc(this._target),this._view.mount(),this._getPopupContainer().appendChild(this._popup),this._position(),this._scroller&&document.body.addEventListener("scroll",this,!0),setTimeout(()=>{document.body.addEventListener("click",this,!1)},10)}get isOpen(){return!!this._view}close(){this._view&&(this._view.unmount(),this._trackingTemplateView.removeSubView(this),this._scroller&&document.body.removeEventListener("scroll",this,!0),document.body.removeEventListener("click",this,!1),this._popup.remove(),this._view=null,this._closeCallback&&this._closeCallback())}get _popup(){return this._view.root()}handleEvent(e){e.type==="scroll"?this._position()||this.close():e.type==="click"&&this._onClick(e)}_onClick(){this.close()}_position(){const e=this._target.getBoundingClientRect(),t=this._popup.clientWidth,s=this._popup.clientHeight,i=(this._scroller?this._scroller:document.documentElement).getBoundingClientRect();if(e.top>i.bottom||e.left>i.right||e.bottom<i.top||e.right<i.left)return!1;if(i.bottom>=e.bottom+s)this._popup.style.top=`${e.bottom+this._verticalPadding}px`;else if(i.top<=e.top-s)this._popup.style.top=`${e.top-s-this._verticalPadding}px`;else return!1;if(i.right>=e.right+t)this._popup.style.left=`${e.left}px`;else if(i.left<=e.left-t)this._popup.style.left=`${e.right-t}px`;else return!1;return!0}root(){return this._fakeRoot}mount(){return this._fakeRoot=document.createComment("popup"),this._fakeRoot}unmount(){this.close()}update(){}}function qc(n){let e=n;do if(e=e.parentElement,e.scrollHeight>e.clientHeight){const s=window.getComputedStyle(e).getPropertyValue("overflow-y");if(s==="auto"||s==="scroll")return e}while(e!==document.body)}class ee extends E{static option(e,t){return new Hc(e,t)}constructor(e){super(),this._options=e}render(e){return e.ul({className:"menu",role:"menu"},this._options.map(t=>t.toDOM(e)))}}class Hc{constructor(e,t){this.label=e,this.callback=t,this.icon=null,this.destructive=!1}setIcon(e){return this.icon=e,this}setDestructive(){return this.destructive=!0,this}toDOM(e){const t={destructive:this.destructive};return this.icon&&(t.icon=!0,t[this.icon]=!0),e.li({className:t},e.button({className:"menu-item",onClick:this.callback},this.label))}}function Xr(n){return n.offsetTop+n.clientHeight}function Zr(n,e,t=n.children.length-1){for(var s=t;s>=0;s--)if(n.children[s].offsetTop<e)return s;return 0}class Wc extends E{constructor(e,t){super(e),this.viewClassForTile=t,this.anchoredBottom=0,this.stickToBottom=!0}render(e,t){requestAnimationFrame(()=>{this.restoreScrollPosition()}),this.tilesView=new zc(t.tiles,()=>this.restoreScrollPosition(),this.viewClassForTile);const s=e.div({className:"Timeline"},[e.div({className:"Timeline_scroller bottom-aligned-scroll",onScroll:()=>this.onScroll()},e.view(this.tilesView)),e.button({className:{Timeline_jumpDown:!0,hidden:i=>!i.showJumpDown},title:"Jump down",onClick:()=>this.jumpDown()})]);return typeof ResizeObserver=="function"&&(this.resizeObserver=new ResizeObserver(()=>{this.restoreScrollPosition()}),this.resizeObserver.observe(s)),s}get scrollNode(){return this.root().firstElementChild}get tilesNode(){return this.tilesView.root()}jumpDown(){const{scrollNode:e}=this;this.stickToBottom=!0,e.scrollTop=e.scrollHeight}unmount(){super.unmount(),this.resizeObserver&&(this.resizeObserver.unobserve(this.root()),this.resizeObserver=void 0)}restoreScrollPosition(){const{scrollNode:e,tilesNode:t}=this,s=e.clientHeight-t.clientHeight;if(s>0){t.style.setProperty("margin-top",`${s}px`);const i=this.value.tiles.length;this.updateVisibleRange(0,i-1)}else if(t.style.removeProperty("margin-top"),this.stickToBottom)e.scrollTop=e.scrollHeight;else if(this.anchoredNode){const i=Xr(this.anchoredNode);if(i!==this.anchoredBottom){const r=i-this.anchoredBottom;typeof e.scrollBy=="function"?e.scrollBy(0,r):e.scrollTop=e.scrollTop+r,this.anchoredBottom=i}}}onScroll(){const{scrollNode:e,tilesNode:t}=this,{scrollHeight:s,scrollTop:i,clientHeight:r}=e;let o;if(this.stickToBottom=Math.abs(s-(i+r))<1,this.stickToBottom)o=this.value.tiles.length-1;else{const l=i+r,c=Zr(t,l);this.anchoredNode=t.childNodes[c],this.anchoredBottom=Xr(this.anchoredNode),o=c}let a=Zr(t,i,o);this.updateVisibleRange(a,o)}updateVisibleRange(e,t){const s=this.tilesView.getChildInstanceByIndex(e),i=this.tilesView.getChildInstanceByIndex(t);this.value.setVisibleTileRange(s?.value,i?.value)}}class zc extends rs{constructor(e,t,s){super({list:e,onItemClick:(i,r)=>i.onClick(r)},i=>{const r=s(i);return new r(i,s)}),this.viewClassForTile=s,this.onChanged=t}onReset(){super.onReset(),this.onChanged()}onUpdate(e,t,s){if(s==="shape"){const i=this.viewClassForTile(t),r=this.getChildInstanceByIndex(e);if(!i||!(r instanceof i)){super.recreateItem(e,t);return}}super.onUpdate(e,t,s),this.onChanged()}onAdd(e,t){super.onAdd(e,t),this.onChanged()}onRemove(e,t){super.onRemove(e,t),this.onChanged()}onMove(e,t,s){super.onMove(e,t,s),this.onChanged()}}class Gc extends E{render(e,t){return e.div({className:"TimelineLoadingView"},[Ve(e),e.div(t.isEncrypted?t.i18n`Loading encrypted messages`:t.i18n`Loading messages`)])}}class Yc extends E{constructor(e,t){super(e),this._viewClassForTile=t,this._input=null,this._attachmentPopup=null,this._focusInput=null,this._rafResizeHandle=void 0}render(e,t){this._input=e.textarea({onKeydown:r=>this._onKeyDown(r),onInput:()=>{t.setInput(this._input.value),this._input.value?this._adjustHeight():this._clearHeight()},placeholder:r=>r.isEncrypted?"Send an encrypted message\u2026":"Send a message\u2026",rows:"1"}),this._focusInput=()=>this._input.focus(),this.value.on("focus",this._focusInput);const s=e.map(r=>r.replyViewModel,(r,o)=>{const a=r&&this._viewClassForTile(r);return a?o.div({className:"MessageComposer_replyPreview"},[o.span({className:"replying"},"Replying"),o.button({className:"cancel",onClick:()=>this._clearReplyingTo()},"Close"),o.view(new a(r,this._viewClassForTile,{interactive:!1},"div"))]):null}),i=e.div({className:"MessageComposer_input"},[this._input,e.button({className:"sendFile",title:t.i18n`Pick attachment`,onClick:r=>this._toggleAttachmentMenu(r)},t.i18n`Send file`),e.button({className:"send",title:t.i18n`Send`,onClick:()=>this._trySend()},t.i18n`Send`)]);return e.div({className:{MessageComposer:!0,MessageComposer_canSend:r=>r.canSend}},[s,i])}unmount(){this._focusInput&&this.value.off("focus",this._focusInput),super.unmount()}_clearReplyingTo(){this.value.clearReplyingTo()}async _trySend(){this._input.focus();const{value:e}=this._input,t=()=>{this._input.value=e,this._adjustHeight()};this._input.value="",this._clearHeight();try{await this.value.sendMessage(e)||t()}catch(s){t(),console.error(s)}}_onKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this._trySend())}_toggleAttachmentMenu(e){if(this._attachmentPopup&&this._attachmentPopup.isOpen)this._attachmentPopup.close();else{const t=this.value;this._attachmentPopup=new $i(new ee([ee.option(t.i18n`Send video`,()=>t.sendVideo()).setIcon("video"),ee.option(t.i18n`Send picture`,()=>t.sendPicture()).setIcon("picture"),ee.option(t.i18n`Send file`,()=>t.sendFile()).setIcon("file")])),this._attachmentPopup.trackInTemplateView(this),this._attachmentPopup.showRelativeTo(e.target,12)}}_adjustHeight(){this._rafResizeHandle||(this._rafResizeHandle=window.requestAnimationFrame(()=>{const e=this._input.scrollHeight;this._input.style.height=`${e}px`,this._rafResizeHandle=void 0}))}_clearHeight(){this._input.style.removeProperty("height")}}class Jc extends E{render(e){return e.div({className:"DisabledComposerView"},e.h3(t=>t.description))}}class vo extends E{constructor(e,t){super(e),this._viewClassForTile=t,this._optionsPopup=null}render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new mt(t,32)),e.div({className:"room-description"},[e.h2(s=>s.name)]),e.button({className:"button-utility room-options","aria-label":t.i18n`Room options`,onClick:s=>this._toggleOptionsMenu(s)})]),e.div({className:"RoomView_body"},[e.div({className:"RoomView_error"},[e.if(s=>s.error,s=>s.div([s.p({},i=>i.error),s.button({className:"RoomView_error_closerButton",onClick:i=>t.dismissError(i)})]))]),e.mapView(s=>s.timelineViewModel,s=>s?new Wc(s,this._viewClassForTile):new Gc(t)),e.mapView(s=>s.composerViewModel,s=>{switch(s?.kind){case"composer":return new Yc(t.composerViewModel,this._viewClassForTile);case"disabled":return new Jc(t.composerViewModel)}})])])}_toggleOptionsMenu(e){if(this._optionsPopup&&this._optionsPopup.isOpen)this._optionsPopup.close();else{const t=this.value,s=[];if(s.push(ee.option(t.i18n`Room details`,()=>t.openDetailsPanel())),t.canLeave&&s.push(ee.option(t.i18n`Leave room`,()=>this._confirmToLeaveRoom()).setDestructive()),t.canForget&&s.push(ee.option(t.i18n`Forget room`,()=>t.forgetRoom()).setDestructive()),t.canRejoin&&s.push(ee.option(t.i18n`Rejoin room`,()=>t.rejoinRoom())),!s.length)return;this._optionsPopup=new $i(new ee(s)),this._optionsPopup.trackInTemplateView(this),this._optionsPopup.showRelativeTo(e.target,10)}}_confirmToLeaveRoom(){confirm(this.value.i18n`Are you sure you want to leave "${this.value.name}"?`)&&this.value.leaveRoom()}}class Qc extends E{render(e,t){return e.main({className:"UnknownRoomView middle"},e.div([e.h2([t.i18n`You are currently not in ${t.roomIdOrAlias}.`,e.br(),t.i18n`Want to join it?`]),e.button({className:"button-action primary",onClick:()=>t.join(),disabled:s=>s.busy},t.i18n`Join room`),e.if(s=>s.error,s=>s.p({className:"error"},t.error))]))}}class kt{constructor(e,t=void 0){typeof e=="function"&&!t&&(t=e,e=null),this._root=t?t(T,e):this.render(T,e)}mount(){return this._root}root(){return this._root}unmount(){}update(){}}class wo extends kt{constructor(e="Loading"){super(e,(t,s)=>t.div({className:"LoadingView"},[Ve(t),s]))}}class bo extends E{render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new mt(t,32)),e.div({className:"room-description"},[e.h2(s=>s.name)])]),e.div({className:"RoomView_body"},[e.mapView(s=>s.error,s=>s?new Xc(t):new wo(t.i18n`Setting up the room`))])])}}class Xc extends E{render(e,t){return e.div({className:"RoomBeingCreated_error centered-column"},[e.h3(t.i18n`Could not create the room, something went wrong:`),e.div({className:"RoomView_error form-group"},t.error),e.div({className:"button-row"},e.button({className:"button-action primary destructive",onClick:()=>t.cancel()},t.i18n`Cancel`))])}}class So extends E{render(e,t){var s;let i=[];t.isDirectMessage&&i.push(ot(t,128,"InviteView_dmAvatar"));let r;return t.isDirectMessage?r=[e.strong(t.name),` (${(s=t.inviter)==null?void 0:s.id}) wants to chat with you.`]:t.inviter?r=[ot(t.inviter,24),e.strong(t.inviter.name),` (${t.inviter.id}) invited you.`]:r="You were invited to join.",i.push(e.p({className:"InviteView_inviter"},r)),t.isDirectMessage||i.push(e.div({className:"InviteView_roomProfile"},[ot(t,64,"InviteView_roomAvatar"),e.h3(t.name),e.p({className:"InviteView_roomDescription"},t.roomDescription)])),e.main({className:"InviteView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close invite`}),ot(t,32),e.div({className:"room-description"},[e.h2(o=>o.name)])]),e.if(o=>o.error,o=>o.div({className:"RoomView_error"},a=>a.error)),e.div({className:"InviteView_body"},[e.div({className:"InviteView_invite"},[...i,e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary",disabled:o=>o.busy,onClick:()=>t.accept()},t.i18n`Accept`)),e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary destructive",disabled:o=>o.busy,onClick:()=>t.reject()},t.i18n`Reject`))])])])}}class Zc extends E{render(e,t){const s=e.a({href:t.closeUrl,title:t.i18n`Close`,className:"close"}),i=e.div({role:"img","aria-label":l=>l.name,title:l=>l.name,className:{picture:!0,hidden:l=>!l.imageUrl},style:l=>`background-image: url('${l.imageUrl}'); max-width: ${l.imageWidth}px; max-height: ${l.imageHeight}px;`}),r=e.div({className:{loading:!0,hidden:l=>!!l.imageUrl}},[Ve(e),e.div(t.i18n`Loading image`)]),o=e.div({className:"details"},[e.strong(l=>l.name),e.br(),"uploaded by ",e.strong(l=>l.sender),l=>` at ${l.time} on ${l.date}.`]),a=e.div({role:"dialog",className:"lightbox",onClick:l=>this.clickToClose(l),onKeydown:l=>this.closeOnEscKey(l)},[i,r,o,s]);return eh(e,a),a}clickToClose(e){e.target===this.root()&&this.value.close()}closeOnEscKey(e){(e.key==="Escape"||e.key==="Esc")&&this.value.close()}}function eh(n,e){const t=th(e),s=t[0],i=t[t.length-1];n.addEventListener(e,"keydown",r=>{r.key==="Tab"&&(r.shiftKey?document.activeElement===s&&(i.focus(),r.preventDefault()):document.activeElement===i&&(s.focus(),r.preventDefault()))},!0),Promise.resolve().then(()=>{s.focus()})}function th(n){return n.querySelectorAll("a[href], button, textarea, input, select")}class sh extends E{render(e,t){return e.div({className:{SessionStatusView:!0,hidden:s=>!s.isShown}},[Ve(e,{hidden:s=>!s.isWaiting}),e.p(s=>s.statusLabel),e.if(s=>s.isConnectNowShown,s=>s.button({className:"link",onClick:()=>t.connectNow()},"Retry now")),e.if(s=>s.isSecretStorageShown,s=>s.a({href:t.setupKeyBackupUrl},"Go to settings")),e.if(s=>s.canDismiss,s=>s.div({className:"end"},s.button({className:"dismiss",onClick:()=>t.dismiss()})))])}}class ih extends E{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const s=[];for(let i=0;i<t.height*t.width;i+=1)s.push(e.div({onClick:()=>t.focusTile(i),onFocusin:()=>t.focusTile(i),className:{container:!0,[`tile${i}`]:!0,focused:r=>r.focusIndex===i}},e.mapView(r=>r.roomViewModelAt(i),r=>r?r.kind==="roomBeingCreated"?new bo(r):r.kind==="invite"?new So(r):new vo(r,this._viewClassForTile):new kt(o=>o.div({className:"room-placeholder"},[o.h2({className:"focused"},t.i18n`Select a room on the left`),o.h2({className:"unfocused"},t.i18n`Click to select this tile`)])))));return s.push(e.div({className:i=>`focus-ring tile${i.focusIndex}`})),e.div({className:"RoomGridView middle layout3x2"},s)}}class Io extends E{render(e){return e.div([e.map(t=>t.status,(t,s,i)=>{switch(t){case"Enabled":return rh(s,i);case"NewVersionAvailable":return nh(s,i);case"SetupKey":return oh(s,i);case"SetupPhrase":return ah(s,i);case"Pending":return s.p(i.i18n`Waiting to go online`)}}),e.map(t=>t.backupWriteStatus,(t,s,i)=>{switch(t){case"Writing":{const r=s.progress({min:0,max:100,value:o=>o.backupPercentage});return s.div(["Backup in progress ",r," ",o=>o.backupInProgressLabel])}case"Stopped":{let r;return i.backupError?r=`Backup has stopped because of an error: ${i.backupError}`:r="Backup has stopped",s.p(r," ",s.button({onClick:()=>i.startBackup()},"Backup now"))}case"Done":return s.p("All keys are backed up.");default:return null}})])}}function rh(n,e){const t=[n.p([e.i18n`Key backup is enabled, using backup version ${e.backupVersion}. `,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return e.dehydratedDeviceId&&t.push(n.p(e.i18n`A dehydrated device id was set up with id ${e.dehydratedDeviceId} which you can use during your next login with your secret storage key.`)),n.div(t)}function nh(n,e){const t=[n.p([e.i18n`A new backup version has been created from another device. Disable key backup and enable it again with the new key.`,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return n.div(t)}function oh(n,e){const t=n.button({className:"link",onClick:()=>e.showPhraseSetup()},e.i18n`use a security phrase`);return n.div([n.p(e.i18n`Enter your secret storage security key below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security key is a code of 12 groups of 4 characters separated by a space that Element created for you when setting up security.`),ko(n),Eo(n,e,e.i18n`Security key`,(s,i)=>e.enterSecurityKey(s,i)),n.p([e.i18n`Alternatively, you can `,t,e.i18n` if you have one.`])])}function ah(n,e){const t=n.button({className:"link",onClick:()=>e.showKeySetup()},e.i18n`use your security key`);return n.div([n.p(e.i18n`Enter your secret storage security phrase below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security phrase is a freeform secret phrase you optionally chose when setting up security in Element. It is different from your password to login, unless you chose to set them to the same value.`),ko(n),Eo(n,e,e.i18n`Security phrase`,(s,i)=>e.enterSecurityPhrase(s,i)),n.p([e.i18n`You can also `,t,e.i18n`.`])])}function Eo(n,e,t,s){let i;const r=()=>s(o.value,i?.checked||!1),o=n.input({type:"password",disabled:l=>l.isBusy,placeholder:t}),a=[n.p([o,n.button({disabled:l=>l.isBusy,onClick:r},e.decryptAction)])];if(e.offerDehydratedDeviceSetup){i=n.input({type:"checkbox",id:"enable-dehydrated-device"});const l=n.a({href:"https://github.com/uhoreg/matrix-doc/blob/dehydration/proposals/2697-device-dehydration.md",target:"_blank",rel:"noopener"},"more info");a.push(n.p([i,n.label({for:i.id},[e.i18n`Back up my device as well (`,l,")"])]))}return n.div({className:"row"},[n.div({className:"label"},t),n.div({className:"content"},a)])}function ko(n){return n.if(e=>e.error,(e,t)=>e.div([e.p({className:"error"},s=>s.i18n`Could not enable key backup: ${s.error}.`),e.p(t.i18n`Try double checking that you did not mix up your security key, security phrase and login password as explained above.`)]))}class lh extends E{render(e,t){let s=t.version;t.showUpdateButton&&(s=e.span([t.version,e.button({onClick:()=>t.checkForUpdate()},t.i18n`Check for updates`)]));const i=(a,l,c,h="")=>a.div({className:`row ${h}`},[a.div({className:"label"},l),a.div({className:"content"},c)]),r=[];r.push(e.h3("Session"),i(e,t.i18n`User ID`,t.userId),i(e,t.i18n`Session ID`,t.deviceId,"code"),i(e,t.i18n`Session key`,t.fingerprintKey,"code"),i(e,"",e.button({onClick:()=>t.logout(),disabled:a=>a.isLoggingOut},t.i18n`Log out`))),r.push(e.h3("Key backup"),e.view(new Io(t.keyBackupViewModel))),r.push(e.h3("Notifications"),e.map(a=>a.pushNotifications.supported,(a,l)=>{if(a===null)return l.p(t.i18n`Loading`);if(a){const c=d=>d.pushNotifications.enabled?d.i18n`Push notifications are enabled`:d.i18n`Push notifications are disabled`,h=d=>d.pushNotifications.enabled?d.i18n`Disable`:d.i18n`Enable`;return i(l,c,l.button({onClick:()=>t.togglePushNotifications(),disabled:d=>d.pushNotifications.updating},h))}else return l.p(t.i18n`Push notifications are not supported on this browser`)}),e.if(a=>a.pushNotifications.supported&&a.pushNotifications.enabled,a=>a.div([a.p(["If you think push notifications are not being delivered, ",a.button({className:"link",onClick:()=>t.checkPushEnabledOnServer()},"check")," if they got disabled on the server"]),a.map(l=>l.pushNotifications.enabledOnServer,(l,c)=>{if(l===!0)return c.p("Push notifications are still enabled on the server, so everything should be working. Sometimes notifications can get dropped if they can't be delivered within a given time.");if(l===!1)return c.p("Push notifications have been disabled on the server, likely due to a bug. Please re-enable them by clicking Disable and then Enable again above.")}),a.map(l=>l.pushNotifications.serverError,(l,c)=>{if(l)return c.p("Couldn't not check on server: "+l.message)})]))),r.push(e.h3("Preferences"),i(e,t.i18n`Scale down images when sending`,this._imageCompressionRange(e,t)),e.if(a=>a.activeTheme,(a,l)=>i(a,l.i18n`Use the following theme`,this._themeOptions(a,l))));const o=[];return t.canSendLogsToServer&&o.push(e.button({onClick:Uc(()=>t.sendLogsToServer())},`Submit logs to ${t.logsServer}`)),o.push(e.button({onClick:()=>t.exportLogs()},"Download logs")),r.push(e.h3("Application"),i(e,t.i18n`Version`,s),i(e,t.i18n`Storage usage`,a=>`${a.storageUsage} / ${a.storageQuota}`),i(e,t.i18n`Debug logs`,o),e.p({className:{hidden:a=>!a.logsFeedbackMessage}},a=>a.logsFeedbackMessage),e.p(["Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our ",e.a({href:"https://element.io/privacy",target:"_blank",rel:"noopener"},"privacy policy"),"."])),e.main({className:"Settings middle"},[e.div({className:"middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close settings`}),e.h2("Settings")]),e.div({className:"SettingsBody"},r)])}_imageCompressionRange(e,t){const i=Math.ceil(t.minSentImageSizeLimit/32)*32,r=(Math.floor(t.maxSentImageSizeLimit/32)+1)*32,o=a=>t.setSentImageSizeLimit(parseInt(a.target.value,10));return[e.input({type:"range",step:32,min:i,max:r,value:a=>a.sentImageSizeLimit||r,onInput:o,onChange:o})," ",e.output(a=>a.sentImageSizeLimit?a.i18n`resize to ${a.sentImageSizeLimit}px`:a.i18n`no resizing`)]}_themeOptions(e,t){const{themeName:s,themeVariant:i}=t.activeTheme,r=[];for(const _ of Object.keys(t.themeMapping))r.push(e.option({value:_,selected:_===s},_));const o=e.select({onChange:_=>{const g=_.target.value;if(!("id"in t.themeMapping[g])){const b=h.checked?"dark":m.checked?"light":"default";a(b);return}t.changeThemeOption(g)}},r),a=_=>{const g=o.options[o.selectedIndex].value;t.changeThemeOption(g,_)},l=i==="dark",c=i==="light",h=e.input({type:"radio",name:"radio-chooser",value:"dark",id:"dark",checked:l}),d=e.input({type:"radio",name:"radio-chooser",value:"default",id:"default",checked:!(l||c)}),m=e.input({type:"radio",name:"radio-chooser",value:"light",id:"light",checked:c}),p=e.form({className:{hidden:()=>{const _=o.options[o.selectedIndex].value;return"id"in t.themeMapping[_]}},onChange:_=>a(_.target.value)},[d,e.label({for:"default"},"Match system theme"),h,e.label({for:"dark"},"dark"),m,e.label({for:"light"},"light")]);return e.div({className:"theme-chooser"},[o,p])}}class ch extends E{render(e,t){return e.main({className:"middle"},e.div({className:"CreateRoomView centered-column"},[e.h2("Create room"),e.form({className:"CreateRoomView_detailsForm form",onChange:s=>this.onFormChange(s),onSubmit:s=>this.onSubmit(s)},[e.div({className:"vertical-layout"},[e.button({type:"button",className:"CreateRoomView_selectAvatar",onClick:()=>t.selectAvatar()},e.mapView(s=>s.hasAvatar,s=>s?new mt(t,64):new kt(void 0,i=>i.div({className:"CreateRoomView_selectAvatarPlaceholder"})))),e.div({className:"stretch form-row text"},[e.label({for:"name"},t.i18n`Room name`),e.input({onInput:s=>t.setName(s.target.value),type:"text",name:"name",id:"name",placeholder:t.i18n`Enter a room name`})])]),e.div({className:"form-row text"},[e.label({for:"topic"},t.i18n`Topic (optional)`),e.textarea({onInput:s=>t.setTopic(s.target.value),name:"topic",id:"topic",placeholder:t.i18n`Topic`})]),e.div({className:"form-group"},[e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPrivate",value:"false",checked:!t.isPublic}),e.label({for:"isPrivate"},t.i18n`Private room, only upon invitation.`)]),e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPublic",value:"true",checked:t.isPublic}),e.label({for:"isPublic"},t.i18n`Public room, anyone can join`)])]),e.div({className:{"form-row check":!0,hidden:s=>s.isPublic}},[e.input({type:"checkbox",name:"isEncrypted",id:"isEncrypted",checked:t.isEncrypted}),e.label({for:"isEncrypted"},t.i18n`Enable end-to-end encryption`)]),e.div({className:{"form-row text":!0,hidden:s=>!s.isPublic}},[e.label({for:"roomAlias"},t.i18n`Room alias`),e.input({onInput:s=>t.setRoomAlias(s.target.value),type:"text",name:"roomAlias",id:"roomAlias",placeholder:t.i18n`Room alias (<alias>, or #<alias> or #<alias>:hs.tld`})]),e.div({className:"form-group"},[e.div(e.button({className:"link",type:"button",onClick:()=>t.toggleAdvancedShown()},s=>s.isAdvancedShown?s.i18n`Hide advanced settings`:s.i18n`Show advanced settings`)),e.div({className:{"form-row check":!0,hidden:s=>!s.isAdvancedShown}},[e.input({type:"checkbox",name:"isFederationDisabled",id:"isFederationDisabled",checked:t.isFederationDisabled}),e.label({for:"isFederationDisabled"},[t.i18n`Disable federation`,e.p({className:"form-row-description"},t.i18n`Can't be changed later. This will prevent people on other homeservers from joining the room. This is typically used when only people from your own organisation (if applicable) should be allowed in the room, and is otherwise not needed.`)])])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s=>!s.canCreate},t.i18n`Create room`)])])]))}onFormChange(e){switch(e.target.name){case"isEncrypted":this.value.setEncrypted(e.target.checked);break;case"isPublic":this.value.setPublic(e.currentTarget.isPublic.value==="true");break;case"isFederationDisabled":this.value.setFederationDisabled(e.target.checked);break}}onSubmit(e){e.preventDefault(),this.value.create()}}class hh extends E{render(e,t){const s=()=>t.isEncrypted?t.i18n`On`:t.i18n`Off`;return e.div({className:"RoomDetailsView"},[e.div({className:"RoomDetailsView_avatar"},[e.view(new mt(t,52)),e.mapView(i=>i.isEncrypted,i=>new dh(i))]),e.div({className:"RoomDetailsView_name"},[e.h2(i=>i.name)]),this._createRoomAliasDisplay(t),e.div({className:"RoomDetailsView_rows"},[this._createRightPanelButtonRow(e,t.i18n`People`,{MemberCount:!0},i=>i.memberCount,()=>t.openPanel("members")),this._createRightPanelRow(e,t.i18n`Encryption`,{EncryptionStatus:!0},s)])])}_createRoomAliasDisplay(e){return e.canonicalAlias?T.div({className:"RoomDetailsView_id"},[e.canonicalAlias]):""}_createRightPanelRow(e,t,s,i){const r=Et(Jt({RoomDetailsView_label:!0},s));return e.div({className:"RoomDetailsView_row"},[e.div({className:r},[t]),e.div({className:"RoomDetailsView_value"},i)])}_createRightPanelButtonRow(e,t,s,i,r){const o=Et(Jt({RoomDetailsView_label:!0},s));return e.button({className:"RoomDetailsView_row",onClick:r},[e.div({className:o},[t]),e.div({className:"RoomDetailsView_value"},i)])}}class dh extends E{render(e,t){return e.div({className:"EncryptionIconView"},[e.div({className:t?"EncryptionIconView_encrypted":"EncryptionIconView_unencrypted"})])}}class uh{constructor(e,t){this.start=e,this.end=t}get length(){return this.end-this.start}contains(e){return e.start>=this.start&&e.end<=this.end}containsIndex(e){return e>=this.start&&e<this.end}toLocalIndex(e){return e-this.start}intersects(e){return e.start<this.end&&this.start<e.end}forEachInIterator(e,t){let s=0;for(s=0;s<this.start;s+=1)e.next();for(s=0;s<this.length;s+=1){const i=e.next();if(i.done)break;t(i.value,this.start+s)}}[Symbol.iterator](){return new mh(this)}reverseIterable(){return new ph(this)}clampIndex(e,t=this.end-1){return Math.min(Math.max(this.start,e),t)}getIndexZone(e){return e<this.start?lt.Before:e<this.end?lt.Inside:lt.After}}var lt=(n=>(n[n.Before=1]="Before",n[n.Inside=2]="Inside",n[n.After=3]="After",n))(lt||{});class mh{constructor(e){this.range=e,this.idx=e.start-1}next(){return this.idx<this.range.end-1?(this.idx+=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}class ph{constructor(e){this.range=e,this.idx=e.end}[Symbol.iterator](){return this}next(){return this.idx>this.range.start?(this.idx-=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}class Mt extends Pi{emitReset(){for(let e of this._handlers)e.onReset(this)}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t,this)}emitUpdate(e,t,s){for(let i of this._handlers)i.onUpdate(e,t,s,this)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t,this)}emitMove(e,t,s){for(let i of this._handlers)i.onMove(e,t,s,this)}}class _h extends Mt{constructor(e=[]){super(),this._items=e}append(e){this._items.push(e),this.emitAdd(this._items.length-1,e)}remove(e){const[t]=this._items.splice(e,1);this.emitRemove(e,t)}insertMany(e,t){for(let s of t)this.insert(e,s),e+=1}insert(e,t){this._items.splice(e,0,t),this.emitAdd(e,t)}move(e,t){if(e<this._items.length&&t<this._items.length){const[s]=this._items.splice(e,1);this._items.splice(t,0,s),this.emitMove(e,t,s)}}update(e,t,s=null){e<this._items.length&&(this._items[e]=t,this.emitUpdate(e,t,s))}get array(){return this._items}at(e){if(this._items&&e>=0&&e<this._items.length)return this._items[e]}get length(){return this._items.length}[Symbol.iterator](){return this._items.values()}}function gh(n,e){let t=0;for(;t<e;)if(t+=1,n.next().done)return!1;return!0}function Es(n,e){if(gh(n,e)){const t=n.next();if(!t.done)return t.value}}var St=(n=>(n[n.Move=0]="Move",n[n.Add=1]="Add",n[n.Remove=2]="Remove",n[n.RemoveAndAdd=3]="RemoveAndAdd",n[n.UpdateRange=4]="UpdateRange",n))(St||{});class Wt extends uh{constructor(e,t,s,i=t-e){super(e,t),this._totalLength=s,this._viewportItemCount=i}expand(e){if(this.length===0)return this;const t=Math.max(0,this.start-e),s=Math.min(this.totalLength,this.end+e);return new Wt(t,s,this.totalLength,this._viewportItemCount)}get totalLength(){return this._totalLength}get viewportItemCount(){return this._viewportItemCount}static fromViewport(e,t,s,i){const r=Math.min(Math.max(0,Math.floor(i/t)),e),o=e-r,a=s!==0?Math.ceil(s/t):0,l=Math.min(a,o);return new Wt(r,r+l,e,a)}queryAdd(e,t,s){const i=this.viewportItemCount>this.length?this.end:this.end-1;if(e<=i){const r=this.clampIndex(e,i),o=r===e?t:Es(s[Symbol.iterator](),r);return this.createAddResult(r,o)}else return{type:4,newRange:this.deriveRange(1,0)}}queryRemove(e,t){if(e<this.end){const s=this.clampIndex(e);return this.createRemoveResult(s,t)}else return{type:4,newRange:this.deriveRange(-1,0)}}queryMove(e,t,s,i){const r=this.getIndexZone(e),o=this.getIndexZone(t);if(r===o){if(r===lt.Before||r===lt.After)return;if(r===lt.Inside)return{type:0,fromIdx:e,toIdx:t}}else{const a=this.clampIndex(t),l=this.clampIndex(e),c=a===t?s:Es(i[Symbol.iterator](),a);return{type:3,removeIdx:l,addIdx:a,value:c}}}createAddResult(e,t){if(this.viewportItemCount>this.length)return{type:1,addIdx:e,value:t,newRange:this.deriveRange(1,1)};{const s=this.clampIndex(Number.MAX_SAFE_INTEGER);return{type:3,removeIdx:s,addIdx:e,value:t,newRange:this.deriveRange(1,0)}}}createRemoveResult(e,t){if(this.end<this.totalLength){const s=this.clampIndex(Number.MAX_SAFE_INTEGER),i=Es(t[Symbol.iterator](),s);return{type:3,removeIdx:e,value:i,addIdx:s,newRange:this.deriveRange(-1,0)}}else if(this.start!==0){const s=this.deriveRange(-1,0,1),i=s.start,r=Es(t[Symbol.iterator](),i);return{type:3,removeIdx:e,value:r,addIdx:i,newRange:s}}else return{type:2,removeIdx:e,newRange:this.deriveRange(-1,0)}}deriveRange(e,t,s=0){const i=this.start-s,r=this.totalLength+e,o=Math.min(Math.max(i,this.end-s+t),r);return new Wt(i,o,r,this.viewportItemCount)}}class fh extends rs{constructor(e,t){var s=e,{itemHeight:i,overflowItems:r=20}=s,o=rl(s,["itemHeight","overflowItems"]);super(o,t),this.itemHeight=i,this.overflowItems=r}handleEvent(e){e.type==="scroll"?this.handleScroll():super.handleEvent(e)}handleScroll(){const e=this._getVisibleRange();if(e.length!==0&&!this.renderRange.contains(e)){const t=this.renderRange;this.renderRange=e.expand(this.overflowItems),this.renderUpdate(t,this.renderRange)}}async loadList(){if(await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>requestAnimationFrame(t)),!this._list)return;this._subscription=this._list.subscribe(this);const e=this._getVisibleRange();this.renderRange=e.expand(this.overflowItems),this._childInstances=[],this.reRenderFullRange(this.renderRange)}_getVisibleRange(){const{clientHeight:e,scrollTop:t}=this.root();if(e===0)throw new Error("LazyListView height is 0");return Wt.fromViewport(this._list.length,this.itemHeight,e,t)}reRenderFullRange(e){Vc(this._listElement);const t=document.createDocumentFragment(),s=this._list[Symbol.iterator]();this._childInstances.length=0,e.forEachInIterator(s,i=>{const r=this._childCreator(i);this._childInstances.push(r),t.appendChild(Zt(r,this._mountArgs))}),this._listElement.appendChild(t),this.adjustPadding(e)}renderUpdate(e,t){if(t.intersects(e)){for(const s of e.reverseIterable())if(!t.containsIndex(s)){const i=s-e.start;this.removeChild(i)}t.forEachInIterator(this._list[Symbol.iterator](),(s,i)=>{if(!e.containsIndex(i)){const r=i-t.start;this.addChild(r,s)}}),this.adjustPadding(t)}else this.reRenderFullRange(t)}adjustPadding(e){const t=e.start*this.itemHeight,s=(e.totalLength-e.end)*this.itemHeight,i=this._listElement.style;i.paddingTop=`${t}px`,i.paddingBottom=`${s}px`}mount(){const e=super.mount();return this.scrollContainer=T.div({className:"LazyListParent"},e),this.scrollContainer.addEventListener("scroll",this),this.scrollContainer}unmount(){this.root().removeEventListener("scroll",this),this.scrollContainer=void 0,super.unmount()}root(){return this.scrollContainer}get _listElement(){return super.root()}onAdd(e,t){const s=this.renderRange.queryAdd(e,t,this._list);this.applyRemoveAddResult(s)}onRemove(e,t){const s=this.renderRange.queryRemove(e,this._list);this.applyRemoveAddResult(s)}onMove(e,t,s){const i=this.renderRange.queryMove(e,t,s,this._list);i&&(i.type===St.Move?this.moveChild(this.renderRange.toLocalIndex(i.fromIdx),this.renderRange.toLocalIndex(i.toIdx)):this.applyRemoveAddResult(i))}onUpdate(e,t,s){this.renderRange.containsIndex(e)&&this.updateChild(this.renderRange.toLocalIndex(e),t,s)}applyRemoveAddResult(e){(e.type===St.Remove||e.type===St.RemoveAndAdd)&&this.removeChild(this.renderRange.toLocalIndex(e.removeIdx)),e.newRange&&(this.renderRange=e.newRange,this.adjustPadding(this.renderRange)),(e.type===St.Add||e.type===St.RemoveAndAdd)&&this.addChild(this.renderRange.toLocalIndex(e.addIdx),e.value)}}class yh extends E{render(e,t){return e.li({className:"MemberTileView"},e.a({href:t.detailsUrl},[e.view(new mt(t,32)),e.div({className:"MemberTileView_name"},s=>s.name)]))}}class vh extends fh{constructor(e){super({list:e.memberTileViewModels,className:"MemberListView",itemHeight:40},t=>new yh(t))}}class wh extends E{render(e,t){return e.div({className:"MemberDetailsView"},[e.view(new mt(t,128)),e.div({className:"MemberDetailsView_name"},e.h2(s=>s.name)),e.div({className:"MemberDetailsView_id"},t.userId),this._createSection(e,t.i18n`Role`,s=>s.role),this._createSection(e,t.i18n`Security`,t.isEncrypted?t.i18n`Messages in this room are end-to-end encrypted.`:t.i18n`Messages in this room are not end-to-end encrypted.`),this._createOptions(e,t)])}_createSection(e,t,s){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t),e.div({className:"MemberDetailsView_value"},s)])}_createOptions(e,t){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t.i18n`Options`),e.div({className:"MemberDetailsView_options"},[e.a({href:t.linkToUser,target:"_blank",rel:"noopener"},t.i18n`Open Link to User`),e.button({className:"text",onClick:()=>t.openDirectMessage()},t.i18n`Open direct message`)])])}}class bh extends E{render(e){return e.div({className:"RightPanelView"},[e.ifView(t=>t.activeViewModel,t=>new Sh(t)),e.mapView(t=>t.activeViewModel,t=>this._viewFromType(t))])}_viewFromType(e){switch(e?.type){case"room-details":return new hh(e);case"member-list":return new vh(e);case"member-details":return new wh(e);default:return new wo}}}class Sh extends E{render(e,t){return e.div({className:"RightPanelView_buttons"},[e.button({className:{back:!0,"button-utility":!0,hide:!t.activeViewModel.shouldShowBackButton},onClick:()=>t.showPreviousPanel()}),e.button({className:"close button-utility",onClick:()=>t.closePanel()})])}}class Ih extends rs{constructor(e){const t={className:"Timeline_messageReactions",tagName:"div",list:e.reactions,onItemClick:s=>s.onClick()};super(t,s=>new Eh(s))}}class Eh extends E{render(e,t){return e.button({className:{active:s=>s.isActive,pending:s=>s.isPending}},[t.key," ",s=>`${s.count}`])}onClick(){this.value.toggle()}}class At extends E{constructor(e,t,s,i="li"){super(e),this._menuPopup=null,this._tagName=i,this._viewClassForTile=t,this._renderFlags=s}get _interactive(){var e,t;return(t=(e=this._renderFlags)==null?void 0:e.interactive)!=null?t:!0}get _isReplyPreview(){var e;return(e=this._renderFlags)==null?void 0:e.reply}render(e,t){const s=[this.renderMessageBody(e,t)];this._interactive&&s.push(e.button({className:"Timeline_messageOptions"},"\u22EF"));const i=e.el(this._tagName,{className:{Timeline_message:!0,own:t.isOwn,unsent:t.isUnsent,unverified:t.isUnverified,disabled:!this._interactive,continuation:o=>o.isContinuation},"data-event-id":t.eventId},s);e.mapSideEffect(o=>o.isContinuation,(o,a)=>{if(o&&a===!1)i.removeChild(i.querySelector(".Timeline_messageAvatar")),i.removeChild(i.querySelector(".Timeline_messageSender"));else if(!o&&!this._isReplyPreview){const l=T.a({href:t.memberPanelLink,className:"Timeline_messageAvatar"},[ot(t,30)]),c=T.div({className:`Timeline_messageSender usercolor${t.avatarColorNumber}`},t.displayName);i.insertBefore(l,i.firstChild),i.insertBefore(c,i.firstChild)}});let r=null;return e.mapSideEffect(o=>o.reactions,o=>{o&&this._interactive&&!r?(r=new Ih(o),this.addSubView(r),i.appendChild(Zt(r))):!o&&r&&(i.removeChild(r.root()),r.unmount(),this.removeSubView(r),r=null)}),i}onClick(e){e.target.className==="Timeline_messageOptions"&&this._toggleMenu(e.target)}_toggleMenu(e){if(this._menuPopup&&this._menuPopup.isOpen)this._menuPopup.close();else{const t=this.createMenuOptions(this.value);if(!t.length)return;this.root().classList.add("menuOpen");const s=()=>this.root().classList.remove("menuOpen");this._menuPopup=new $i(new ee(t),s),this._menuPopup.trackInTemplateView(this),this._menuPopup.showRelativeTo(e,2)}}createMenuOptions(e){const t=[];return e.canReact&&e.shape!=="redacted"&&!e.isPending&&(t.push(new kh(e)),t.push(ee.option(e.i18n`Reply`,()=>e.startReply()))),e.canAbortSending?t.push(ee.option(e.i18n`Cancel`,()=>e.abortSending())):e.canRedact&&t.push(ee.option(e.i18n`Delete`,()=>e.redact()).setDestructive()),t}renderMessageBody(){}}class kh{constructor(e){this._vm=e}toDOM(e){const t=["\u{1F44D}","\u{1F44E}","\u{1F604}","\u{1F389}","\u{1F615}","\u2764\uFE0F","\u{1F680}","\u{1F440}"].map(i=>e.button({onClick:()=>this._vm.react(i)},i)),s=e.button({onClick:()=>{const i=prompt("Enter your reaction (emoji)");i&&this._vm.react(i)}},"\u2026");return e.li({className:"quick-reactions"},[...t,s])}}class Rh extends E{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const s=this._viewClassForTile(t);if(!s)throw new Error(`Shape ${t.shape} is unrecognized.`);const i=new s(t,this._viewClassForTile,{reply:!0,interactive:!1});return e.div({className:"ReplyPreviewView"},e.blockquote([e.a({className:"link",href:t.permaLink},"In reply to"),e.a({className:"pill",href:t.senderProfileLink},[ot(t,12,void 0),t.displayName]),e.br(),e.view(i)]))}}class Ch extends E{render(e){return e.blockquote({className:"ReplyPreviewView"},[e.div({className:"Timeline_messageBody statusMessage"},"This reply could not be found.")])}}class Th extends At{renderMessageBody(e,t){const s=e.time({className:{hidden:!t.date}},t.date+" "+t.time),i=e.div({className:{Timeline_messageBody:!0,statusMessage:o=>o.shape==="message-status"}},e.mapView(o=>o.replyTile,o=>this._isReplyPreview?null:t.isReply&&!o?new Ch:o?new Rh(o,this._viewClassForTile):null)),r=o=>o?.nodeType!==Node.COMMENT_NODE&&o.className!=="ReplyPreviewView";return e.mapSideEffect(o=>o.body,o=>{for(;r(i.lastChild);)i.removeChild(i.lastChild);for(const a of o.parts)i.appendChild(Ro(a));i.appendChild(s)}),i}}function Mh(n){const e=n.items.map(s=>T.li(ct(s))),t=n.startOffset;return t?T.ol({start:t},e):T.ul(e)}function Ah(n){const e={src:n.src};return n.width&&(e.width=n.width),n.height&&(e.height=n.height),n.alt&&(e.alt=n.alt),n.title&&(e.title=n.title),T.img(e)}function xh(n){const e=`avatar size-12 usercolor${n.avatarColorNumber}`,t=T.div({class:e},Ne(n.avatarInitials)),s=ct(n.children);return s.unshift(t),T.a({class:"pill",href:n.href,rel:"noopener",target:"_blank"},s)}function Nh(n){const e=[];if(n.head){const s=n.head.map(i=>T.th(ct(i)));e.push(T.thead(T.tr(s)))}const t=[];for(const s of n.body){const i=s.map(r=>T.td(ct(r)));t.push(T.tr(i))}return e.push(T.tbody(t)),T.table(e)}const Dh={header:n=>T["h"+Math.min(6,n.level)](ct(n.inlines)),codeblock:n=>T.pre(T.code(Ne(n.text))),table:n=>Nh(n),code:n=>T.code(Ne(n.text)),text:n=>Ne(n.text),link:n=>T.a({href:n.url,className:"link",target:"_blank",rel:"noopener"},ct(n.inlines)),pill:xh,format:n=>T[n.format](ct(n.children)),rule:()=>T.hr(),list:Mh,image:Ah,newline:()=>T.br()};function Ro(n){const e=Dh[n.type];return e?e(n):Ne(`[unknown part type ${n.type}]`)}function ct(n){return Array.from(n,Ro)}class Co extends At{renderMessageBody(e,t){let i=`padding-top: ${t.height/t.width*100}%;`;t.platform.isIE11&&(i=`height: ${t.height}px`);const r=[e.div({className:"spacer",style:i}),this.renderMedia(e,t),e.time(t.date+" "+t.time)],o=e.div({className:{status:!0,hidden:a=>!a.status}},a=>a.status);if(r.push(o),t.isPending){const a=e.progress({min:0,max:100,value:l=>l.uploadPercentage,className:{hidden:l=>!l.isUploading}});r.push(a)}return e.div({className:"Timeline_messageBody"},[e.div({className:"media",style:`max-width: ${t.width}px`,"data-testid":"media"},r),e.if(a=>a.error,a=>a.p({className:"error"},t.error))])}createMenuOptions(e){const t=super.createMenuOptions(e);if(!e.isPending){let s;switch(e.shape){case"image":s=e.i18n`Download image`;break;case"video":s=e.i18n`Download video`;break;default:s=e.i18n`Download media`;break}t.push(ee.option(s,()=>e.downloadMedia()))}return t}}class Oh extends Co{renderMedia(e,t){const s=e.img({src:i=>i.thumbnailUrl,alt:i=>i.label,title:i=>i.label,style:`max-width: ${t.width}px; max-height: ${t.height}px;`});return t.isPending||!t.lightboxUrl?s:e.a({href:t.lightboxUrl},s)}}function Us(n,e){return new Promise((t,s)=>{let i;const r=a=>{i(),s(a.target.error)},o=()=>{i(),t()};i=()=>{n.removeEventListener(e,o),n.removeEventListener("error",r)},n.addEventListener(e,o),n.addEventListener("error",r)})}class Lh extends Co{renderMedia(e){const t=e.video({src:s=>s.videoUrl||`data:${s.mimeType},`,title:s=>s.label,controls:!0,preload:"none",poster:s=>s.thumbnailUrl,onPlay:this._onPlay.bind(this),style:s=>`max-width: ${s.width}px; max-height: ${s.height}px;${s.isPending?"z-index: -1":""}`});return t.addEventListener("error",this._onError.bind(this)),t}async _onPlay(e){const t=this.value;if(!t.videoUrl)try{const s=e.target;await t.loadVideo();const i=Us(s,"loadeddata");s.load(),await i,s.play()}catch{}}_onError(e){const t=this.value,s=e.target,i=s.error;if(i instanceof window.MediaError&&i.code===4)if(!s.src.startsWith("data:"))t.setViewError(new Error(`this browser does not support videos of type ${t.mimeType}.`));else return;else t.setViewError(i)}}class Ph extends At{renderMessageBody(e,t){const s=[];return t.isPending?s.push(i=>i.label):s.push(e.button({className:"link",onClick:()=>t.download()},i=>i.label),e.time(t.date+" "+t.time)),e.p({className:"Timeline_messageBody statusMessage"},s)}}class Vh extends At{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},[e.span(t.label),e.a({className:"Timeline_locationLink",href:t.mapsLink,target:"_blank",rel:"noopener"},t.i18n`Open in maps`),e.time(t.date+" "+t.time)])}}class Uh extends At{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},t.label)}}class Fh extends E{constructor(e){super(e)}render(e){return e.li({className:"AnnouncementView"},e.div(t=>t.announcement))}onClick(){}}class Bh extends At{renderMessageBody(e){return e.p({className:"Timeline_messageBody statusMessage"},t=>t.description)}createMenuOptions(e){const t=super.createMenuOptions(e);return e.isRedacting&&t.push(ee.option(e.i18n`Cancel`,()=>e.abortPendingRedaction())),t}}class Kh extends E{constructor(e){super(e)}render(e){const t={GapView:!0,isLoading:s=>s.isLoading,isAtTop:s=>s.isAtTop};return e.li({className:t},[Ve(e),e.div(s=>s.isLoading?s.i18n`Loading more messages `:s.i18n`Not loading!`),e.if(s=>s.error,s=>s.strong(i=>i.error))])}onClick(){}}function en(n){switch(n.shape){case"gap":return Kh;case"announcement":return Fh;case"message":case"message-status":return Th;case"image":return Oh;case"video":return Lh;case"file":return Ph;case"location":return Vh;case"missing-attachment":return Uh;case"redacted":return Bh;default:throw new Error(`Tiles of shape "${n.shape}" are not supported, check the tileClassForEntry function in the view model`)}}class $h extends E{render(e,t){return e.div({className:{SessionView:!0,"middle-shown":s=>!!s.activeMiddleViewModel,"right-shown":s=>!!s.rightPanelViewModel}},[e.view(new sh(t.sessionStatusViewModel)),e.view(new jc(t.leftPanelViewModel)),e.mapView(s=>s.activeMiddleViewModel,()=>t.roomGridViewModel?new ih(t.roomGridViewModel,en):t.settingsViewModel?new lh(t.settingsViewModel):t.createRoomViewModel?new ch(t.createRoomViewModel):t.currentRoomViewModel?t.currentRoomViewModel.kind==="invite"?new So(t.currentRoomViewModel):t.currentRoomViewModel.kind==="room"?new vo(t.currentRoomViewModel,en):t.currentRoomViewModel.kind==="roomBeingCreated"?new bo(t.currentRoomViewModel):new Qc(t.currentRoomViewModel):new kt(s=>s.div({className:"room-placeholder"},s.h2(t.i18n`Choose a room on the left side.`)))),e.mapView(s=>s.lightboxViewModel,s=>s?new Zc(s):null),e.mapView(s=>s.rightPanelViewModel,s=>s?new bh(s):null)])}}function To(n){return n.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web"},"Hydrogen on Github")}class jh extends E{render(e,t){const s=o=>!!o.isBusy,i=e.input({id:"username",type:"text",placeholder:t.i18n`Username`,disabled:s}),r=e.input({id:"password",type:"password",placeholder:t.i18n`Password`,disabled:s});return e.div({className:"PasswordLoginView form"},[e.if(o=>o.error,o=>o.div({className:"error"},a=>a.error)),e.form({onSubmit:o=>{o.preventDefault(),t.login(i.value,r.value)}},[e.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage))),e.div({className:"form-row text"},[e.label({for:"username"},t.i18n`Username`),i]),e.div({className:"form-row text"},[e.label({for:"password"},t.i18n`Password`),r]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s},t.i18n`Log In`)])])])}}class qh extends E{render(e,t){return e.div({className:"Settings"},[e.h3(t.i18n`Restore your encrypted history?`),e.ifView(s=>s.decryptDehydratedDeviceViewModel,s=>new Io(s.decryptDehydratedDeviceViewModel)),e.map(s=>s.deviceDecrypted,(s,i)=>s?i.p(t.i18n`That worked out, you're good to go!`):i.p(t.i18n`This will claim the dehydrated device ${t.dehydratedDeviceId}, and will set up a new one.`)),e.div({className:"button-row"},[e.button({className:"button-action primary",onClick:()=>{t.finish()},type:"button"},s=>s.deviceDecrypted?s.i18n`Continue`:s.i18n`Continue without restoring`)])])}}class Hs extends E{render(e){const t=e.if(i=>i.hasError,(i,r)=>i.button({onClick:()=>r.exportLogs()},r.i18n`Export logs`)),s=e.if(i=>i.hasError,(i,r)=>i.button({onClick:()=>r.logout()},r.i18n`Log out`));return e.div({className:"SessionLoadStatusView"},[e.p({className:"status"},[Ve(e,{hidden:i=>!i.loading}),e.p(i=>i.loadLabel),t,s]),e.ifView(i=>i.accountSetupViewModel,i=>new qh(i.accountSetupViewModel))])}}class Hh extends E{render(e){return e.div({className:"CompleteSSOView"},[e.p({className:"CompleteSSOView_title"},"Finishing up your SSO Login"),e.if(t=>t.errorMessage,(t,s)=>t.p({className:"error"},s.i18n(s.errorMessage))),e.mapView(t=>t.loadViewModel,t=>t?new Hs(t):null)])}}class Wh extends E{render(e,t){const s=i=>i.isBusy;return e.div({className:"PreSessionScreen"},[e.button({className:"button-utility LoginView_back",onClick:()=>t.goBack(),disabled:s}),e.div({className:"logo"}),e.h1([t.i18n`Sign In`]),e.mapView(i=>i.completeSSOLoginViewModel,i=>i?new Hh(i):null),e.if(i=>i.showHomeserver,(i,r)=>i.div({className:"LoginView_sso form-row text"},[i.label({for:"homeserver"},r.i18n`Homeserver`),i.input({id:"homeserver",type:"text",placeholder:r.i18n`Your matrix homeserver`,value:r.homeserver,disabled:s,onInput:o=>r.setHomeserver(o.target.value),onChange:()=>r.queryHomeserver()}),i.p({className:{LoginView_forwardInfo:!0,hidden:o=>!o.resolvedHomeserver}},o=>o.i18n`You will connect to ${o.resolvedHomeserver}.`),i.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage)))])),e.if(i=>i.isFetchingLoginOptions,i=>i.div({className:"LoginView_query-spinner"},[Ve(i),i.p("Fetching available login options...")])),e.mapView(i=>i.passwordLoginViewModel,i=>i?new jh(i):null),e.if(i=>i.passwordLoginViewModel&&i.startSSOLoginViewModel,i=>i.p({className:"LoginView_separator"},t.i18n`or`)),e.mapView(i=>i.startSSOLoginViewModel,i=>i?new zh(i):null),e.mapView(i=>i.loadViewModel,i=>i?new Hs(i):null),e.p(To(e))])}}class zh extends E{render(e,t){return e.div({className:"StartSSOLoginView"},e.button({className:"StartSSOLoginView_button button-action secondary",type:"button",onClick:()=>t.startSSOLogin(),disabled:s=>s.isBusy},t.i18n`Log in with SSO`))}}class Gh extends E{render(e,t){const s=new Vs(t,r=>r.div([r.p("Are you sure you want to log out?"),r.div({className:"button-row"},[r.a({className:"button-action",type:"submit",href:t.cancelUrl},["Cancel"]),r.button({className:"button-action primary destructive",type:"submit",onClick:()=>t.logout()},t.i18n`Log out`)])])),i=new Vs(t,r=>r.p({className:"status",hidden:o=>!o.showStatus},[Ve(r,{hidden:o=>!o.busy}),r.span(o=>o.status)]));return e.div({className:"LogoutScreen"},[e.div({className:"content"},[e.mapView(r=>r.showConfirm,r=>r?s:i)])])}}class Yh extends E{render(e,t){return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionLoadView"},[e.view(new Hs(t))]),e.div({className:{"button-row":!0,hidden:s=>s.loading}},e.a({className:"button-action primary",href:t.backUrl},t.i18n`Go back`))])}}class Jh extends E{_onDeleteClick(){confirm("Are you sure?")&&this.value.delete()}_onClearClick(){confirm("Are you sure?")&&this.value.clear()}render(e,t){return e.li([e.a({className:"session-info",href:t.openUrl},[e.div({className:`avatar usercolor${t.avatarColorNumber}`},s=>s.avatarInitials),e.div({className:"user-id"},s=>s.label)])])}}class Qh extends E{render(e,t){const s=new rs({list:t.sessions,parentProvidesUpdates:!1},i=>new Jh(i));return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionPickerView"},[e.h1(["Continue as \u2026"]),e.view(s),e.div({className:"button-row"},[e.a({className:"button-action primary",href:t.cancelUrl},t.i18n`Sign In`)]),e.ifView(i=>i.loadViewModel,()=>new Hs(t.loadViewModel)),e.p(To(e))])])}}class Xh extends E{render(e,t){return e.mapView(s=>s.activeSection,s=>{switch(s){case"error":return new kt(i=>i.div({className:"StatusView"},[i.h1("Something went wrong"),i.p(t.errorText)]));case"session":return new $h(t.sessionViewModel);case"login":return new Wh(t.loginViewModel);case"logout":return new Gh(t.logoutViewModel);case"picker":return new Qh(t.sessionPickerViewModel);case"redirecting":return new kt(i=>i.p("Redirecting..."));case"loading":return new Yh(t.sessionLoadViewModel);default:throw new Error(`Unknown section: ${t.activeSection}`)}})}}class Zh{constructor(e){this._reject=null,this._handle=null,this._promise=new Promise((t,s)=>{this._reject=s,this._handle=setTimeout(()=>{this._reject=null,t()},e)})}elapsed(){return this._promise}abort(){this._reject&&(this._reject(new Ie),clearTimeout(this._handle),this._handle=null,this._reject=null)}dispose(){this.abort()}}class ed{constructor(e,t){this._handle=setInterval(t,e)}dispose(){this._handle&&(clearInterval(this._handle),this._handle=null)}}class td{constructor(){this._start=window.performance.now()}measure(){return window.performance.now()-this._start}}class sd{createMeasure(){return new td}createTimeout(e){return new Zh(e)}createInterval(e,t){return new ed(t,e)}now(){return Date.now()}}class id{constructor(){this._waitingForReply=new Map,this._messageIdCounter=0,this._navigation=null,this._registration=null,this._registrationPromise=null,this._currentController=null,this.haltRequests=!1}setNavigation(e){this._navigation=e}registerAndStart(e){this._registrationPromise=(async()=>{navigator.serviceWorker.addEventListener("message",this),navigator.serviceWorker.addEventListener("controllerchange",this),this._registration=await navigator.serviceWorker.register(e),await navigator.serviceWorker.ready,this._currentController=navigator.serviceWorker.controller,this._registration.addEventListener("updatefound",this),this._registrationPromise=null,this._registration.waiting&&this._registration.active&&this._proposeUpdate(),console.log("Service Worker registered")})()}_onMessage(e){const{data:t}=e,s=t.replyTo;if(s){const i=this._waitingForReply.get(s);i&&(this._waitingForReply.delete(s),i(t.payload))}if(t.type==="hasSessionOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId;e.source.postMessage({replyTo:t.id,payload:i})}else if(t.type==="hasRoomOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId,r=this._navigation.observe("room").get()===t.payload.roomId;e.source.postMessage({replyTo:t.id,payload:i&&r})}else if(t.type==="closeSession"){const{sessionId:i}=t.payload;this._closeSessionIfNeeded(i).finally(()=>{e.source.postMessage({replyTo:t.id})})}else t.type==="haltRequests"?(this.haltRequests=!0,e.source.postMessage({replyTo:t.id})):t.type==="openRoom"&&this._navigation.push("room",t.payload.roomId)}_closeSessionIfNeeded(e){var t;const s=(t=this._navigation)==null?void 0:t.path.get("session");return e&&s?.value===e?new Promise(i=>{const r=this._navigation.pathObservable.subscribe(o=>{const a=o.get("session");(!a||a.value!==e)&&(r(),i())});this._navigation.push("session")}):Promise.resolve()}async _proposeUpdate(){if(document.hidden)return;const e=await this._sendAndWaitForReply("version",null,this._registration.waiting);confirm(`Version ${e.version} (${e.buildHash}) is available. Reload to apply?`)&&(await this._sendAndWaitForReply("haltRequests"),this._send("skipWaiting",null,this._registration.waiting))}handleEvent(e){switch(e.type){case"message":this._onMessage(e);break;case"updatefound":this._registration.installing.addEventListener("statechange",this);break;case"statechange":{e.target.state==="installed"&&(this._proposeUpdate(),e.target.removeEventListener("statechange",this));break}case"controllerchange":this._currentController?document.location.reload():this._currentController=navigator.serviceWorker.controller;break}}async _send(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),s.postMessage({type:e,payload:t})}async _sendAndWaitForReply(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),this._messageIdCounter+=1;const i=this._messageIdCounter,r=new Promise(o=>{this._waitingForReply.set(i,o)});return s.postMessage({type:e,id:i,payload:t}),await r}async checkForUpdate(){this._registrationPromise&&await this._registrationPromise,this._registration.update()}get version(){return"0.3.0"}get buildHash(){return null}async preventConcurrentSessionAccess(e){return this._sendAndWaitForReply("closeSession",{sessionId:e})}async getRegistration(){return this._registrationPromise&&await this._registrationPromise,this._registration}}class rd{constructor(e,t){this._serviceWorkerHandler=e,this._pushConfig=t}async enablePush(e,t){var s;const i=await((s=this._serviceWorkerHandler)==null?void 0:s.getRegistration());if(i?.pushManager){const o=(await i.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._pushConfig.applicationServerKey})).toJSON(),a=o.keys.p256dh,l={endpoint:o.endpoint,auth:o.keys.auth,events_only:!0,default_payload:t};return e.httpPusher(this._pushConfig.gatewayUrl,this._pushConfig.appId,a,l)}}async disablePush(){var e;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());if(t?.pushManager){const s=await t.pushManager.getSubscription();s&&await s.unsubscribe()}}async isPushEnabled(){var e;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());return t?.pushManager?!!await t.pushManager.getSubscription():!1}async supportsPush(){var e;if(!this._pushConfig)return!1;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());return t&&"pushManager"in t}async enableNotifications(){return"Notification"in window?await Notification.requestPermission()==="granted":!1}async supportsNotifications(){return"Notification"in window}async areNotificationsEnabled(){return"Notification"in window?Notification.permission==="granted":!1}async showNotification(e,t=void 0){var s;if("Notification"in window){new Notification(e,{body:t});return}const i=await((s=this._serviceWorkerHandler)==null?void 0:s.getRegistration());i?.showNotification(e,{body:t})}}class nd extends Tt{constructor(){super(),this._lastSessionHash=void 0}handleEvent(e){e.type==="hashchange"&&(this.emit(this.get()),this._storeHash(this.get()))}get(){return document.location.search.includes("loginToken")?document.location.search:document.location.hash}replaceUrlSilently(e){window.history.replaceState(null,null,e),this._storeHash(e)}pushUrlSilently(e){window.history.pushState(null,null,e),this._storeHash(e)}pushUrl(e){document.location.hash=e}urlAsPath(e){return e.startsWith("#")?e.substr(1):e}pathAsUrl(e){return`#${e}`}onSubscribeFirst(){var e;this._lastSessionHash=(e=window.localStorage)==null?void 0:e.getItem("hydrogen_last_url_hash"),window.addEventListener("hashchange",this)}onUnsubscribeLast(){window.removeEventListener("hashchange",this)}_storeHash(e){var t;(t=window.localStorage)==null||t.setItem("hydrogen_last_url_hash",e)}getLastSessionUrl(){return this._lastSessionHash}}class od extends Tt{constructor(){super(),this._onOffline=this._onOffline.bind(this),this._onOnline=this._onOnline.bind(this)}_onOffline(){this.emit(!1)}_onOnline(){this.emit(!0)}get(){return navigator.onLine}onSubscribeFirst(){window.addEventListener("offline",this._onOffline),window.addEventListener("online",this._onOnline)}onUnsubscribeLast(){window.removeEventListener("offline",this._onOffline),window.removeEventListener("online",this._onOnline)}}function Z(n,e){return n instanceof Promise?n:new Promise((t,s)=>{n.oncomplete=i=>t(i.target.result),n.onerror=()=>s(new Error("Crypto error on "+e))})}class ad{constructor(e){this._subtleCrypto=e}async verify(e,t,s,i){const r={name:"HMAC",hash:{name:ht(i)}},o=await Z(this._subtleCrypto.importKey("raw",e,r,!1,["verify"]),"importKey");return await Z(this._subtleCrypto.verify(r,o,t,s),"verify")}async compute(e,t,s){const i={name:"HMAC",hash:{name:ht(s)}},r=await Z(this._subtleCrypto.importKey("raw",e,i,!1,["sign"]),"importKey"),o=await Z(this._subtleCrypto.sign(i,r,t),"sign");return new Uint8Array(o)}}class ld{constructor(e,t,s){this._subtleCrypto=e,this._crypto=t,this._cryptoExtras=s}async pbkdf2(e,t,s,i,r){if(!this._subtleCrypto.deriveBits)throw new Error("PBKDF2 is not supported");const o=await Z(this._subtleCrypto.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits"]),"importKey"),a=await Z(this._subtleCrypto.deriveBits({name:"PBKDF2",salt:s,iterations:t,hash:ht(i)},o,r),"deriveBits");return new Uint8Array(a)}async hkdf(e,t,s,i,r){if(!this._subtleCrypto.deriveBits)return this._cryptoExtras.hkdf(this._crypto,e,t,s,i,r);const o=await Z(this._subtleCrypto.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),"importKey"),a=await Z(this._subtleCrypto.deriveBits({name:"HKDF",salt:t,info:s,hash:ht(i)},o,r),"deriveBits");return new Uint8Array(a)}}class cd{constructor(e,t){this._subtleCrypto=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:r=64}){const o={name:"AES-CTR",counter:s,length:r};let a;try{const l=e||t,c=t?"jwk":"raw";a=await Z(this._subtleCrypto.importKey(c,l,o,!1,["decrypt"]),"importKey")}catch(l){throw new Error(`Could not import key for AES-CTR decryption: ${l.message}`)}try{const l=await Z(this._subtleCrypto.decrypt(o,a,i),"decrypt");return new Uint8Array(l)}catch(l){throw new Error(`Could not decrypt with AES-CTR: ${l.message}`)}}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){const r={name:"AES-CTR",counter:s,length:64};let o;const a=e||t,l=t?"jwk":"raw";try{o=await Z(this._subtleCrypto.importKey(l,a,r,!1,["encrypt"]),"importKey")}catch(c){throw new Error(`Could not import key for AES-CTR encryption: ${c.message}`)}try{const c=await Z(this._subtleCrypto.encrypt(r,o,i),"encrypt");return new Uint8Array(c)}catch(c){throw new Error(`Could not encrypt with AES-CTR: ${c.message}`)}}async generateKey(e,t=256){const s=await Z(this._subtleCrypto.generateKey({name:"AES-CTR",length:t},!0,["encrypt","decrypt"]));return Z(this._subtleCrypto.exportKey(e,s))}async generateIV(){return Mo(this._crypto)}}function Mo(n){const e=n.getRandomValues(new Uint8Array(8)),t=new Uint8Array(16);for(let s=0;s<e.length;s+=1)t[s]=e[s];return t}function tn(n){if(n.alg!=="A256CTR")throw new Error(`Unknown algorithm: ${n.alg}`);if(!n.key_ops.includes("decrypt"))throw new Error("decrypt missing from key_ops");if(n.kty!=="oct")throw new Error(`Invalid key type, "oct" expected: ${n.kty}`);const t=n.k.replace(/-/g,"+").replace(/_/g,"/");return at.decode(t)}function hd(n){const e=at.encode(n),t=e.indexOf("=");return t!==-1?e.substr(0,t):e}function dd(n){return hd(n).replace(/\+/g,"-").replace(/\//g,"_")}function ud(n){return{alg:"A256CTR",ext:!0,k:dd(n),key_ops:["encrypt","decrypt"],kty:"oct"}}class md{constructor(e,t){this._aesjs=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:r=64}){if(r!==64)throw new Error(`Unsupported counter length: ${r}`);t&&(e=tn(t));const o=this._aesjs;var a=new o.ModeOfOperation.ctr(new Uint8Array(e),new o.Counter(new Uint8Array(s)));return a.decrypt(new Uint8Array(i))}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){t&&(e=tn(t));const r=this._aesjs;var o=new r.ModeOfOperation.ctr(new Uint8Array(e),new r.Counter(new Uint8Array(s)));return o.encrypt(new Uint8Array(i))}async generateKey(e,t=256){let s=crypto.getRandomValues(new Uint8Array(t/8));return e==="jwk"&&(s=ud(s)),s}async generateIV(){return Mo(this._crypto)}}function ht(n){if(n!=="SHA-256"&&n!=="SHA-512")throw new Error(`Invalid hash name: ${n}`);return n}class pd{constructor(e){const t=window.crypto||window.msCrypto,s=t.subtle||t.webkitSubtle;this._subtleCrypto=s,!s.deriveBits&&e?.aesjs?this.aes=new md(e.aesjs,t):this.aes=new cd(s,t),this.hmac=new ad(s),this.derive=new ld(s,this,e)}async digest(e,t){return await Z(this._subtleCrypto.digest(ht(e),t))}digestSize(e){switch(ht(e)){case"SHA-512":return 64;case"SHA-256":return 32;default:throw new Error(`Not implemented for ${ht(e)}`)}}}async function _d(){var n;if((n=navigator?.storage)!=null&&n.estimate){const{quota:e,usage:t}=await navigator.storage.estimate();return{quota:e,usage:t}}else return{quota:null,usage:null}}class gd{constructor(e){this.worker=e,this.busy=!1}attach(e){this.worker.addEventListener("message",e),this.worker.addEventListener("error",e)}detach(e){this.worker.removeEventListener("message",e),this.worker.removeEventListener("error",e)}}class fd{constructor(e,t){this._promise=new Promise((s,i)=>{this._resolve=s,this._reject=i}),this._message=e,this._pool=t,this._worker=null}abort(){this._isNotDisposed&&(this._pool._abortRequest(this),this._dispose())}response(){return this._promise}_dispose(){this._reject=null,this._resolve=null}get _isNotDisposed(){return this._resolve&&this._reject}}class yd{constructor(e,t){this._workers=[];for(let s=0;s<t;++s){const i=new gd(new Worker(e));i.attach(this),this._workers[s]=i}this._requests=new Map,this._counter=0,this._pendingFlag=!1,this._init=null}init(){const e=new Promise((t,s)=>{this._init={resolve:t,reject:s}});return this.sendAll({type:"ping"}).then(this._init.resolve,this._init.reject).finally(()=>{this._init=null}),e}handleEvent(e){if(e.type==="message"){const t=e.data,s=this._requests.get(t.replyToId);if(s){if(s._worker.busy=!1,s._isNotDisposed){if(t.type==="success")s._resolve(t.payload);else if(t.type==="error"){const i=new Error(t.message);i.stack=t.stack,s._reject(i)}s._dispose()}this._requests.delete(t.replyToId)}this._sendPending()}else e.type==="error"&&(this._init&&this._init.reject(new Error("worker error during init")),console.error("worker error",e))}_getPendingRequest(){for(const e of this._requests.values())if(!e._worker)return e}_getFreeWorker(){for(const e of this._workers)if(!e.busy)return e}_sendPending(){this._pendingFlag=!1;let e;do{e=!1;const t=this._getPendingRequest();if(t){const s=this._getFreeWorker();s&&(this._sendWith(t,s),e=!0)}}while(e)}_sendWith(e,t){e._worker=t,t.busy=!0,t.worker.postMessage(e._message)}_enqueueRequest(e){this._counter+=1,e.id=this._counter;const t=new fd(e,this);return this._requests.set(e.id,t),t}send(e){const t=this._enqueueRequest(e),s=this._getFreeWorker();return s&&this._sendWith(t,s),t}sendAll(e){const t=this._workers.map(s=>{const i=this._enqueueRequest(Object.assign({},e));return this._sendWith(i,s),i.response()});return Promise.all(t)}dispose(){for(const e of this._workers)e.detach(this),e.worker.terminate()}_trySendPendingInNextTick(){this._pendingFlag||(this._pendingFlag=!0,Promise.resolve().then(()=>{this._sendPending()}))}_abortRequest(e){e._reject(new Ie),e._worker&&(e._worker.busy=!1),this._requests.delete(e._message.id),this._trySendPendingInNextTick()}}const vd={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"video/quicktime":!0,"video/VP8":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0},sn="application/octet-stream";class ut{constructor(e,t=null){this._blob=e,this._buffer=t,this._url=null}static fromBuffer(e,t){return t=t?t.split(";")[0].trim():"",vd[t]||(t=sn),new ut(new Blob([e],{type:t}),e)}static fromBlob(e){return new ut(e)}get nativeBlob(){return this._blob}async readAsBuffer(){if(this._buffer)return this._buffer;{const e=new FileReader,t=new Promise((s,i)=>{e.addEventListener("load",r=>s(r.target.result)),e.addEventListener("error",r=>i(r.target.error))});return e.readAsArrayBuffer(this._blob),t}}get url(){return this._url||(this._url=URL.createObjectURL(this._blob)),this._url}get size(){return this._blob.size}get mimeType(){return this._blob.type||sn}dispose(){this._url&&(URL.revokeObjectURL(this._url),this._url=null)}}class es{static async fromBlob(e){const t=await rn(e),{width:s,height:i}=t;return new es(e,s,i,t)}constructor(e,t,s,i){this.blob=e,this.width=t,this.height=s,this._domElement=i}get maxDimension(){return Math.max(this.width,this.height)}async _getDomElement(){return this._domElement||(this._domElement=await rn(this.blob)),this._domElement}async scale(e){const t=this.width/this.height,s=Math.min(1,e/(t>=1?this.width:this.height)),i=Math.round(this.width*s),r=Math.round(this.height*s),o=document.createElement("canvas");o.width=i,o.height=r;const a=o.getContext("2d"),l=await this._getDomElement();a.drawImage(l,0,0,i,r);let c=this.blob.mimeType==="image/jpeg"?"image/jpeg":"image/png",h;if(o.toBlob)h=await new Promise(m=>o.toBlob(m,c));else if(o.msToBlob)c="image/png",h=o.msToBlob();else throw new Error("canvas can't be turned into blob");const d=ut.fromBlob(h);return new es(d,i,r,null)}dispose(){this.blob.dispose()}}class ji extends es{get duration(){if(typeof this._domElement.duration=="number")return Math.round(this._domElement.duration*1e3)}static async fromBlob(e){const t=await bd(e),{videoWidth:s,videoHeight:i}=t;return new ji(e,s,i,t)}}function wd(){const n=document.createElement("canvas");n.width=1,n.height=1;const e=n.getContext("2d"),t=[Math.round(Math.random()*255),Math.round(Math.random()*255),Math.round(Math.random()*255)];e.fillStyle=`rgb(${t[0]}, ${t[1]}, ${t[2]})`,e.fillRect(0,0,1,1);const s=e.getImageData(0,0,1,1).data;return s[0]===t[0]&&s[1]===t[1]&&s[2]===t[2]}async function rn(n){const e=document.createElement("img"),t=Us(e,"load");return e.src=n.url,await t,e}async function bd(n){const e=document.createElement("video");e.muted=!0;const t=Us(e,"loadedmetadata");e.src=n.url,e.load(),await t;const s=Us(e,"seeked");return await new Promise(i=>setTimeout(i,200)),e.currentTime=.1,await s,e}async function Sd(n,e,t,s,i){let r=n.querySelector("iframe.downloadSandbox");if(!r){r=document.createElement("iframe"),r.setAttribute("sandbox","allow-scripts allow-downloads allow-downloads-without-user-activation"),r.setAttribute("src",e),r.className="hidden downloadSandbox",n.appendChild(r);let o;await new Promise((a,l)=>{o=()=>{r.removeEventListener("load",a),r.removeEventListener("error",l)},r.addEventListener("load",a),r.addEventListener("error",l)}),o()}if(i){const o=await t.readAsBuffer();r.contentWindow.postMessage({type:"downloadBuffer",buffer:o,mimeType:t.mimeType,filename:s},"*")}else r.contentWindow.postMessage({type:"downloadBlob",blob:t.nativeBlob,filename:s},"*")}function _i(n){typeof n=="function"?n():n.dispose()}function Id(n){return n&&(typeof n=="function"||typeof n.dispose=="function")}class qi{constructor(){this._disposables=[]}track(e){if(!Id(e))throw new Error("Not a disposable");return this.isDisposed?(console.warn("Disposables already disposed, disposing new value"),_i(e),e):(this._disposables.push(e),e)}untrack(e){if(this.isDisposed){console.warn("Disposables already disposed, cannot untrack");return}const t=this._disposables.indexOf(e);t>=0&&this._disposables.splice(t,1)}dispose(){if(this._disposables){for(const e of this._disposables)_i(e);this._disposables=void 0}}get isDisposed(){return this._disposables===void 0}disposeTracked(e){if(e==null||this.isDisposed)return;const t=this._disposables.indexOf(e);if(t!==-1){const[s]=this._disposables.splice(t,1);_i(s)}else console.warn("disposable not found, did it leak?",e)}}class Ed{constructor(e){this._bodyNode=e}get rootNodes(){return Array.from(this._bodyNode.childNodes)}getChildNodes(e){return Array.from(e.childNodes)}getAttributeNames(e){return Array.from(e.getAttributeNames())}getAttributeValue(e,t){return e.getAttribute(t)}isTextNode(e){return e.nodeType===Node.TEXT_NODE}getNodeText(e){return e.textContent}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}getNodeElementName(e){return e.tagName}}const kd={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx|mxc):|[^a-z]|[a-z+.-]+(?:[^a-z+.-:]|$))/i,FORBID_TAGS:["mx-reply"],KEEP_CONTENT:!1};function Rd(n){const e=Xa.sanitize(n,kd),t=new DOMParser().parseFromString(`<!DOCTYPE html><html><body>${e}</body></html>`,"text/html").body;return new Ed(t)}var He=(n=>(n[n.Dark=0]="Dark",n[n.Light=1]="Light",n))(He||{});function Cd(n,e,t){let s=n.replaceAll("#ff00ff",e);if(s=s.replaceAll("#00ffff",t),n===s)throw new Error("svg-colorizer made no color replacements! The input svg should only contain colors #ff00ff (primary, case-sensitive) and #00ffff (secondary, case-sensitive).");return s}class Td{constructor(e,t,s,i){this._platform=e,this._iconVariables=t,this._resolvedVariables=s,this._manifestLocation=i}async toVariables(){const{parsedStructure:e,promises:t}=await this._fetchAndParseIcons();return await Promise.all(t),this._produceColoredIconVariables(e)}async _fetchAndParseIcons(){const e=[],t={};for(const[s,i]of Object.entries(this._iconVariables)){const r=new URL(`https://${i}`),o=r.hostname,a=new URL(o,new URL(this._manifestLocation,window.location.origin)),l=this._platform.request(a,{method:"GET",format:"text",cache:!0}).response();e.push(l);const c=r.searchParams;t[s]={svg:l,primary:c.get("primary"),secondary:c.get("secondary")}}return{parsedStructure:t,promises:e}}async _produceColoredIconVariables(e){let t={};for(const[s,{svg:i,primary:r,secondary:o}]of Object.entries(e)){const{body:a}=await i;if(!r)throw new Error(`Primary color variable ${r} not in list of variables!`);const l=this._resolvedVariables[r],c=this._resolvedVariables[o],h=Cd(a,l,c),d=`url('data:image/svg+xml;utf8,${encodeURIComponent(h)}')`;t[s]=d}return t}}const nn=(Vr=js.exports.offColor)!=null?Vr:qn.offColor;function on(n,e,t,s){const i=parseInt(t);switch(s&&(e==="darker"?e="lighter":e==="lighter"&&(e="darker")),e){case"darker":return nn(n).darken(i/100).hex();case"lighter":return nn(n).lighten(i/100).hex()}}class Md{constructor(e,t,s){this._aliases={},this._derivedAliases=[],this._baseVariables=e,this._variablesToDerive=t,this._isDark=s}toVariables(){var e;const t={};this._detectAliases();for(const s of this._variablesToDerive){const i=this._derive(s);i&&(t[s]=i)}for(const[s,i]of Object.entries(this._aliases))t[s]=(e=this._baseVariables[i])!=null?e:t[i];for(const s of this._derivedAliases){const i=this._deriveAlias(s,t);i&&(t[s]=i)}return t}_detectAliases(){const e=[];for(const t of this._variablesToDerive){const[s,i]=t.split("=");i?this._aliases[s]=i:e.push(t)}this._variablesToDerive=e}_derive(e){const t=/(.+)--(.+)-(.+)/,s=e.match(t);if(s){const[,i,r,o]=s,a=this._baseVariables[i];if(!a)if(this._aliases[i]){this._derivedAliases.push(e);return}else throw new Error(`Cannot find value for base variable "${i}"!`);return on(a,r,o,this._isDark)}}_deriveAlias(e,t){const s=/(.+)--(.+)-(.+)/,i=e.match(s);if(i){const[,r,o,a]=i,l=t[r];if(!l)throw new Error(`Cannot find value for alias "${r}" when trying to derive ${e}!`);return on(l,o,a,this._isDark)}}}(Ur=js.exports.offColor)!=null||qn.offColor;class Ad{constructor(e,t){this._themeMapping={},this._preferredColorScheme=t,this._platform=e}async parse(e,t,s,i){await i.wrap("RuntimeThemeParser.parse",async()=>{var r;const{cssLocation:o,derivedVariables:a,icons:l}=this._getSourceData(t,s,i),c=e.name;if(!c)throw new Error("Theme name not found in manifest!");let h={},d={};for(const[m,p]of Object.entries((r=e.values)==null?void 0:r.variants))try{const _=`${e.id}-${m}`,{name:g,default:b,dark:S,variables:I}=p,C=new Md(I,a,S).toVariables();Object.assign(I,C);const v=await new Td(this._platform,l,I,s).toVariables();Object.assign(I,C,v);const k=`${c} ${g}`;if(b){Object.assign(S?h:d,{variantName:g,id:_,cssLocation:o,variables:I});continue}this._themeMapping[k]={cssLocation:o,id:_,variables:I}}catch(_){console.error(_);continue}if(h.id&&d.id){const m=this._preferredColorScheme===He.Dark?h:d;this._themeMapping[c]={dark:h,light:d,default:m}}else{const m=h.id?h:d;this._themeMapping[`${c} ${m.variantName}`]={id:m.id,cssLocation:m.cssLocation}}})}_getSourceData(e,t,s){return s.wrap("getSourceData",()=>{var i,r,o;const a=(i=e.source)==null?void 0:i["runtime-asset"];if(!a)throw new Error(`Run-time asset not found in source section for theme at ${t}`);const l=new URL(a,new URL(t,window.location.origin)).href,c=(r=e.source)==null?void 0:r["derived-variables"];if(!c)throw new Error(`Derived variables not found in source section for theme at ${t}`);const h=(o=e.source)==null?void 0:o.icon;if(!h)throw new Error(`Icon mapping not found in source section for theme at ${t}`);return{cssLocation:l,derivedVariables:c,icons:h}})}get themeMapping(){return this._themeMapping}}class xd{constructor(e){this._themeMapping={},this._preferredColorScheme=e}parse(e,t,s){s.wrap("BuiltThemeParser.parse",()=>{var i,r,o;const a=(i=e.source)==null?void 0:i["built-assets"],l=e.name;if(!l)throw new Error(`Theme name not found in manifest at ${t}`);let c={},h={};for(let[d,m]of Object.entries(a)){try{m=new URL(m,new URL(t,window.location.origin)).href}catch{continue}const p=(r=d.match(/.+-(.+)/))==null?void 0:r[1],_=(o=e.values)==null?void 0:o.variants[p];if(!_)throw new Error(`Variant ${p} is missing in manifest at ${t}`);const{name:g,default:b,dark:S}=_,I=`${l} ${g}`;if(b){const C=S?c:h;C.variantName=g,C.id=d,C.cssLocation=m;continue}this._themeMapping[I]={cssLocation:m,id:d}}if(c.id&&h.id){const d=this._preferredColorScheme===He.Dark?c:h;this._themeMapping[l]={dark:c,light:h,default:d}}else{const d=c.id?c:h;this._themeMapping[`${l} ${d.variantName}`]={id:d.id,cssLocation:d.cssLocation}}})}get themeMapping(){return this._themeMapping}}class Nd{constructor(e){this._platform=e}async init(e,t){await this._platform.logger.wrapOrRun(t,"ThemeLoader.init",async s=>{const i=await Promise.all(e.map(l=>this._platform.request(l,{method:"GET",format:"json",cache:!0}).response())),r=new Ad(this._platform,this.preferredColorScheme),o=new xd(this.preferredColorScheme),a=[];for(let l=0;l<i.length;++l){const{body:c}=i[l];try{if(c.extends){const h=i.findIndex(_=>_.body.id===c.extends);if(h===-1)throw new Error(`Base manifest for derived theme at ${e[l]} not found!`);const{body:d}=i[h],m=e[h],p=r.parse(c,d,m,s);a.push(p)}else o.parse(c,e[l],s)}catch(h){console.error(h)}}await Promise.all(a),this._themeMapping=Jt(Jt({},o.themeMapping),r.themeMapping),Object.assign(this._themeMapping,o.themeMapping,r.themeMapping),this._addDefaultThemeToMapping(s),s.log({l:"Preferred colorscheme",scheme:this.preferredColorScheme===He.Dark?"dark":"light"}),s.log({l:"Result",themeMapping:this._themeMapping})})}setTheme(e,t,s){this._platform.logger.wrapOrRun(s,{l:"change theme",name:e,variant:t},()=>{let i,r,o=this._themeMapping[e];if("id"in o)i=o.cssLocation,r=o.variables;else{if(!t)throw new Error("themeVariant is undefined!");i=o[t].cssLocation,r=o[t].variables}this._platform.replaceStylesheet(i),r?(s?.log({l:"Derived Theme",variables:r}),this._injectCSSVariables(r)):this._removePreviousCSSVariables(),this._platform.settingsStorage.setString("theme-name",e),t?this._platform.settingsStorage.setString("theme-variant",t):this._platform.settingsStorage.remove("theme-variant")})}_injectCSSVariables(e){const t=document.documentElement;for(const[s,i]of Object.entries(e))t.style.setProperty(`--${s}`,i);this._injectedVariables=e}_removePreviousCSSVariables(){if(!this._injectedVariables)return;const e=document.documentElement;for(const t of Object.keys(this._injectedVariables))e.style.removeProperty(`--${t}`);this._injectedVariables=void 0}get themeMapping(){return this._themeMapping}async getActiveTheme(){let e=await this._platform.settingsStorage.getString("theme-name"),t=await this._platform.settingsStorage.getString("theme-variant");return(!e||!this._themeMapping[e])&&(e="Default"in this._themeMapping?"Default":Object.keys(this._themeMapping)[0],this._themeMapping[e][t]||(t="default"in this._themeMapping[e]?"default":void 0)),{themeName:e,themeVariant:t}}getDefaultTheme(){var e,t;switch(this.preferredColorScheme){case He.Dark:return(e=this._platform.config.defaultTheme)==null?void 0:e.dark;case He.Light:return(t=this._platform.config.defaultTheme)==null?void 0:t.light}}_findThemeDetailsFromId(e){var t,s;for(const[i,r]of Object.entries(this._themeMapping)){if("id"in r&&r.id===e)return{themeName:i,themeData:r};if("light"in r&&((t=r.light)==null?void 0:t.id)===e)return{themeName:i,themeData:r.light};if("dark"in r&&((s=r.dark)==null?void 0:s.id)===e)return{themeName:i,themeData:r.dark}}}_addDefaultThemeToMapping(e){e.wrap("addDefaultThemeToMapping",t=>{const s=this.getDefaultTheme();if(s){const i=this._findThemeDetailsFromId(s);if(i){this._themeMapping.Default={id:"default",cssLocation:i.themeData.cssLocation};const r=i.themeData.variables;r&&(this._themeMapping.Default.variables=r)}}t.log({l:"Default Theme",theme:s})})}get preferredColorScheme(){if(window.matchMedia("(prefers-color-scheme: dark)").matches)return He.Dark;if(window.matchMedia("(prefers-color-scheme: light)").matches)return He.Light}}function an(n){return new Promise(function(e,t){var s=document.createElement("script");s.setAttribute("src",n),s.onload=e,s.onerror=t,document.body.appendChild(s)})}async function Dd(n){return window.msCrypto&&!window.crypto&&(window.crypto=window.msCrypto),n?(window.WebAssembly?(await an(n.wasmBundle),await window.Olm.init({locateFile:()=>n.wasm})):(await an(n.legacyBundle),await window.Olm.init()),window.Olm):null}function Od(n){return n.startsWith("/")?n:new URL(n,document.location.href).pathname}async function Ld(n){const e=new yd(n.worker,4);return await e.init(),await e.sendAll({type:"load_olm",path:Od(n.olm.legacyBundle)}),new Cc(e)}function Pd(n){if(!window.visualViewport)return;const e=()=>{const t=n.querySelector(".SessionView");if(!t)return;const s=n.querySelector(".bottom-aligned-scroll");let i,r,o;s&&(i=s.scrollTop,r=s.offsetHeight);const a=t.offsetTop+t.offsetHeight-window.visualViewport.height;n.style.setProperty("--ios-viewport-height",window.visualViewport.height.toString()+"px"),n.style.setProperty("--ios-viewport-top",a.toString()+"px"),s&&(o=s.offsetHeight,s.scrollTop=i+r-o)};return window.visualViewport.addEventListener("resize",e),()=>{window.visualViewport.removeEventListener("resize",e)}}class Vd{constructor({container:e,assetPaths:t,config:s,configURL:i,options:r=null,cryptoExtras:o=null}){this._container=e,this._assetPaths=t,this._config=s,this._configURL=i,this.settingsStorage=new _c("hydrogen_setting_v1_"),this.clock=new sd,this.encoding=new Rc,this.random=Math.random,this._createLogger(r?.development),this.history=new nd,this.onlineStatus=new od,this._serviceWorkerHandler=null,t.serviceWorker&&"serviceWorker"in navigator&&(this._serviceWorkerHandler=new id,this._serviceWorkerHandler.registerAndStart(t.serviceWorker)),this.notificationService=void 0,this._assetPaths.olm&&(this.crypto=new pd(o)),this.storageFactory=new uc(this._serviceWorkerHandler),this.sessionInfoStorage=new pc("hydrogen_sessions_v1"),this.estimateStorageUsage=_d,typeof fetch=="function"?this.request=ul(this.clock.createTimeout,this._serviceWorkerHandler):this.request=Qn;const a=!!window.MSInputMethodContext&&!!document.documentMode;this.isIE11=a;const l=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1&&!window.MSStream;this.isIOS=l,this._disposables=new qi,this._olmPromise=void 0,this._workerPromise=void 0,this._themeLoader=new Nd(this)}async init(){try{await this.logger.run("Platform init",async e=>{var t;if(!this._config){if(!this._configURL)throw new Error("Neither config nor configURL was provided!");const{status:s,body:i}=await this.request(this._configURL,{method:"GET",format:"json",cache:!0}).response();if(s===404)throw new Error(`Could not find ${this._configURL}. Did you copy over config.sample.json?`);if(s>=400)throw new Error(`Got status ${s} while trying to fetch ${this._configURL}`);this._config=i}if(this.notificationService=new rd(this._serviceWorkerHandler,this._config.push),this._themeLoader){const s=this.config.themeManifests;await((t=this._themeLoader)==null?void 0:t.init(s,e));const{themeName:i,themeVariant:r}=await this._themeLoader.getActiveTheme();e.log({l:"Active theme",name:i,variant:r}),this._themeLoader.setTheme(i,r,e)}})}catch(e){throw this._container.innerText=e.message,e}}_createLogger(e){const t=s=>{var i;return(i=s.e)!=null&&i.stack&&(s.e.stack=s.e.stack.replace(/\/\?loginToken=(.+)/,"?loginToken=<snip>")),s};e?this.logger=new Ac({platform:this}):this.logger=new Tc({name:"hydrogen_logs",platform:this,serializedTransformer:t})}get updateService(){return this._serviceWorkerHandler}loadOlm(){return this._olmPromise||(this._olmPromise=Dd(this._assetPaths.olm)),this._olmPromise}get config(){return this._config}async loadOlmWorker(){if(!window.WebAssembly)return this._workerPromise||(this._workerPromise=Ld(this._assetPaths)),this._workerPromise}createAndMountRootView(e){if(this.isIE11&&(this._container.className+=" legacy"),this.isIOS){this._container.className+=" ios";const s=Pd(this._container);s&&this._disposables.track(s)}this._container.addEventListener("error",Qr,!0),this._disposables.track(()=>this._container.removeEventListener("error",Qr,!0)),window.__hydrogenViewModel=e;const t=new Xh(e);this._container.appendChild(t.mount())}setNavigation(e){var t;(t=this._serviceWorkerHandler)==null||t.setNavigation(e)}createBlob(e,t){return ut.fromBuffer(e,t)}saveFileAs(e,t){navigator.msSaveBlob?navigator.msSaveBlob(e.nativeBlob,t):Sd(this._container,this._assetPaths.downloadSandbox,e,t,this.isIOS)}openFile(e=null){const t=document.createElement("input");t.setAttribute("type","file"),t.className="hidden",e&&t.setAttribute("accept",e);const s=new Promise(i=>{const r=()=>{t.removeEventListener("change",r,!0);const o=t.files[0];this._container.removeChild(t),o?i({name:o.name,blob:ut.fromBlob(o)}):i()};t.addEventListener("change",r,!0)});return this._container.appendChild(t),t.click(),s}openUrl(e){location.href=e}parseHTML(e){return Rd(e)}async loadImage(e){return es.fromBlob(e)}async loadVideo(e){return ji.fromBlob(e)}hasReadPixelPermission(){return wd()}get devicePixelRatio(){return window.devicePixelRatio||1}get version(){return"0.3.0"}get themeLoader(){return this._themeLoader}replaceStylesheet(e){const t=document.querySelector("head");document.querySelectorAll(".theme").forEach(i=>i.remove());const s=document.createElement("link");s.href=e,s.rel="stylesheet",s.type="text/css",s.className="theme",t.appendChild(s)}get description(){var e;return(e=navigator.userAgent)!=null?e:"<unknown>"}dispose(){this._disposables.dispose()}}function ln(n){try{return new URL(n).origin}catch{return new URL(`https://${n}`).origin}}async function Ud(n,e){const t={format:"json",timeout:3e4,method:"GET"};try{const s=`${n}/.well-known/matrix/client`;return await e(s,t).response()}catch(s){if(s.name==="ConnectionError")return null;throw s}}async function Fd(n,e){var t;n=ln(n);const s=await Ud(n,e);if(s&&s.status===200){const{body:i}=s,r=(t=i["m.homeserver"])==null?void 0:t.base_url;typeof r=="string"&&(n=ln(r))}return n}class Ao{constructor(e){this._abortable=void 0;const t=i=>(this._abortable=i,i);this._progress=new Ee(void 0);const s=i=>{this._progress.set(i)};this.result=e(t,s)}get progress(){return this._progress}abort(){var e;(e=this._abortable)==null||e.abort(),this._abortable=void 0}}function xo(n){return Object.entries(n||{}).filter(([,e])=>e!==void 0).map(([e,t])=>(typeof t=="object"&&(t=JSON.stringify(t)),`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&")}function Bd(n){if(n instanceof ut){const e=n;return{mimeType:e.mimeType,body:e}}else{if(n instanceof Map)return{mimeType:"multipart/form-data",body:n};if(typeof n=="object"){const e=JSON.stringify(n);return{mimeType:"application/json",body:e}}else throw new Error("Unknown body type: "+n)}}class Kd{constructor(e,t,s,i){let r;if(i?.log){const o=i?.log;r=o.child({t:"network",url:t,method:e},o.level.Info)}this._log=r,this._sourceRequest=s,this._promise=s.response().then(o=>{var a,l;if(r?.set("status",o.status),o.status>=200&&o.status<300||((a=i?.allowedStatusCodes)==null?void 0:a.includes(o.status)))return r?.finish(),o.body;if(o.status>=500){const c=new We("Internal Server Error");throw r?.catch(c),c}else if(o.status>=400&&!((l=o.body)!=null&&l.errcode)){const c=new We(`HTTP error status ${o.status} without errcode in body, assume this is a load balancer complaining the server is offline.`);throw r?.catch(c),c}else{const c=new Gn(e,t,o.body,o.status);throw r?.set("errcode",c.errcode),r?.catch(c),c}},o=>{if(o.name==="AbortError"&&this._sourceRequest){const a=new We("Service worker aborted, either updating or hit #187.");throw r?.catch(a),a}else throw o.name==="ConnectionError"&&r?.set("timeout",o.isTimeout),r?.catch(o),o})}abort(){var e;this._sourceRequest&&((e=this._log)==null||e.set("aborted",!0),this._sourceRequest.abort(),this._sourceRequest=void 0)}response(){return this._promise}async responseCode(){return(await this._sourceRequest.response()).status}}const ks="/_matrix/client/r0",$d="/_matrix/client/v3",gi="/_matrix/client/unstable/org.matrix.msc2697.v2";class it{constructor({homeserver:e,accessToken:t,request:s,reconnector:i}){this._homeserver=e,this._accessToken=t,this._requestFn=s,this._reconnector=i}_url(e,t=ks){return this._homeserver+t+e}_baseRequest(e,t,s,i,r,o){const a=xo(s);t=`${t}?${a}`;let l;const c=new Map;if(o&&c.set("Authorization",`Bearer ${o}`),c.set("Accept","application/json"),i){const m=Bd(i);c.set("Content-Type",m.mimeType),l=m.body}const h=this._requestFn(t,{method:e,headers:c,body:l,timeout:r?.timeout,uploadProgress:r?.uploadProgress,format:"json",cache:e!=="GET"}),d=new Kd(e,t,h,r);return this._reconnector&&d.response().catch(m=>{m.name==="ConnectionError"&&this._reconnector.onRequestFailed(this)}),d}_unauthedRequest(e,t,s,i,r){return this._baseRequest(e,t,s,i,r)}_authedRequest(e,t,s,i,r){return this._baseRequest(e,t,s,i,r,this._accessToken)}_post(e,t,s,i){return this._authedRequest("POST",this._url(e,i?.prefix||ks),t,s,i)}_put(e,t,s,i){return this._authedRequest("PUT",this._url(e,i?.prefix||ks),t,s,i)}_get(e,t,s,i){return this._authedRequest("GET",this._url(e,i?.prefix||ks),t,s,i)}sync(e,t,s,i){return this._get("/sync",{since:e,timeout:s,filter:t},void 0,i)}context(e,t,s,i){return this._get(`/rooms/${encodeURIComponent(e)}/context/${encodeURIComponent(t)}`,{filter:i,limit:s})}messages(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/messages`,t,void 0,s)}members(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/members`,t,void 0,s)}send(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/send/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}redact(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/redact/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}receipt(e,t,s,i){return this._post(`/rooms/${encodeURIComponent(e)}/receipt/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},{},i)}state(e,t,s,i){return this._get(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},void 0,i)}getLoginFlows(){return this._unauthedRequest("GET",this._url("/login"))}register(e,t,s,i,r=!0,o={}){o.allowedStatusCodes=[401];const a={auth:i,password:t,initial_device_displayname:s,inhibit_login:r};return e&&(a.username=e),this._unauthedRequest("POST",this._url("/register",$d),void 0,a,o)}passwordLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.password",identifier:{type:"m.id.user",user:e},password:t,initial_device_display_name:s},i)}tokenLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.token",identifier:{type:"m.id.user"},token:e,txn_id:t,initial_device_display_name:s},i)}createFilter(e,t,s){return this._post(`/user/${encodeURIComponent(e)}/filter`,{},t,s)}versions(e){return this._unauthedRequest("GET",`${this._homeserver}/_matrix/client/versions`,void 0,void 0,e)}uploadKeys(e,t,s){let i="/keys/upload";return e&&(i=i+`/${encodeURIComponent(e)}`),this._post(i,{},t,s)}queryKeys(e,t){return this._post("/keys/query",{},e,t)}claimKeys(e,t){return this._post("/keys/claim",{},e,t)}sendToDevice(e,t,s,i){return this._put(`/sendToDevice/${encodeURIComponent(e)}/${encodeURIComponent(s)}`,{},t,i)}roomKeysVersion(e,t){let s="";return e&&(s=`/${encodeURIComponent(e)}`),this._get(`/room_keys/version${s}`,void 0,void 0,t)}roomKeyForRoomAndSession(e,t,s,i){return this._get(`/room_keys/keys/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{version:e},void 0,i)}uploadRoomKeysToBackup(e,t,s){return this._put("/room_keys/keys",{version:e},t,s)}uploadAttachment(e,t,s){return this._authedRequest("POST",`${this._homeserver}/_matrix/media/r0/upload`,{filename:t},e,s)}setPusher(e,t){return this._post("/pushers/set",{},e,t)}getPushers(e){return this._get("/pushers",void 0,void 0,e)}join(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/join`,{},{},t)}joinIdOrAlias(e,t){return this._post(`/join/${encodeURIComponent(e)}`,{},{},t)}leave(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/leave`,{},{},t)}forget(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/forget`,{},{},t)}logout(e){return this._post("/logout",{},{},e)}getDehydratedDevice(e={}){return e.prefix=gi,this._get("/dehydrated_device",void 0,void 0,e)}createDehydratedDevice(e,t={}){return t.prefix=gi,this._put("/dehydrated_device",{},e,t)}claimDehydratedDevice(e,t={}){return t.prefix=gi,this._post("/dehydrated_device/claim",{},{device_id:e},t)}profile(e,t){return this._get(`/profile/${encodeURIComponent(e)}`)}createRoom(e,t){return this._post("/createRoom",{},e,t)}setAccountData(e,t,s,i){return this._put(`/user/${encodeURIComponent(e)}/account_data/${encodeURIComponent(t)}`,{},s,i)}}class No{constructor(e){this._start=2e3,this._current=2e3;const t=2e3;this._start=t,this._current=t,this._createTimeout=e,this._max=60*5*1e3}async waitForRetry(){this._timeout=this._createTimeout(this._current);try{await this._timeout.elapsed();const e=2*this._current;this._current=Math.min(this._max,e)}catch(e){if(!(e instanceof Ie))throw e}finally{this._timeout=void 0}}abort(){this._timeout&&this._timeout.abort()}reset(){this._current=this._start,this.abort()}get nextValue(){return this._current}}var zt=(n=>(n[n.Waiting=0]="Waiting",n[n.Reconnecting=1]="Reconnecting",n[n.Online=2]="Online",n))(zt||{});class jd{constructor({retryDelay:e,createMeasure:t,onlineStatus:s}){this._onlineStatus=s,this._retryDelay=e,this._createTimeMeasure=t,this._state=new Ee(2),this._isReconnecting=!1}get lastVersionsResponse(){return this._versionsResponse}get connectionStatus(){return this._state}get retryIn(){return this._state.get()===0?this._retryDelay.nextValue-this._stateSince.measure():0}async onRequestFailed(e){if(!this._isReconnecting){this._isReconnecting=!0;const t=this._onlineStatus&&this._onlineStatus.subscribe(s=>{s&&this.tryNow()});try{await this._reconnectLoop(e)}catch(s){console.error(s)}finally{t&&t(),this._isReconnecting=!1}}}tryNow(){this._retryDelay&&this._retryDelay.abort()}_setState(e){e!==this._state.get()&&(e===0?this._stateSince=this._createTimeMeasure():this._stateSince=null,this._state.set(e))}async _reconnectLoop(e){for(this._versionsResponse=void 0,this._retryDelay.reset();!this._versionsResponse;)try{this._setState(1);const t=e.versions({timeout:3e4});this._versionsResponse=await t.response(),this._setState(2)}catch(t){if(t.name==="ConnectionError")this._setState(0),await this._retryDelay.waitForRetry();else throw t}}}async function qd(n,e,t){if(t===void 0||t.key===void 0||t.iv===void 0||t.hashes===void 0||t.hashes.sha256===void 0)throw new Error("Invalid info. Missing info.key, info.iv or info.hashes.sha256 key");const{crypto:s}=n,{base64:i}=n.encoding;var r=i.decode(t.iv),o=i.encode(i.decode(t.hashes.sha256));const a=await s.digest("SHA-256",e);if(i.encode(new Uint8Array(a))!=o)throw new Error("Mismatched SHA-256 digest");var l;return t.v=="v1"||t.v=="v2"?l=64:l=128,await s.aes.decryptCTR({jwkKey:t.key,iv:r,data:e,counterLength:l})}async function Hd(n,e){const{crypto:t}=n,{base64:s}=n.encoding,i=await t.aes.generateIV(),r=await t.aes.generateKey("jwk",256),o=await e.readAsBuffer(),a=await t.aes.encryptCTR({jwkKey:r,iv:i,data:o}),l=await t.digest("SHA-256",a);return{blob:n.createBlob(a,"application/octet-stream"),info:{v:"v2",key:r,iv:s.encodeUnpadded(i),hashes:{sha256:s.encodeUnpadded(l)}}}}class Wd{constructor({homeserver:e,platform:t}){this._homeserver=e,this._platform=t}mxcUrlThumbnail(e,t,s,i){const r=this._parseMxcUrl(e);if(r){const[o,a]=r;return`${this._homeserver}/_matrix/media/r0/thumbnail/${encodeURIComponent(o)}/${encodeURIComponent(a)}`+"?"+xo({width:Math.round(t),height:Math.round(s),method:i})}return null}mxcUrl(e){const t=this._parseMxcUrl(e);if(t){const[s,i]=t;return`${this._homeserver}/_matrix/media/r0/download/${encodeURIComponent(s)}/${encodeURIComponent(i)}`}else return null}_parseMxcUrl(e){const t="mxc://";return e.startsWith(t)?e.substr(t.length).split("/",2):null}async downloadEncryptedFile(e,t=!1){const s=this.mxcUrl(e.url),{body:i}=await this._platform.request(s,{method:"GET",format:"buffer",cache:t}).response(),r=await qd(this._platform,i,e);return this._platform.createBlob(r,e.mimetype)}async downloadPlaintextFile(e,t,s=!1){const i=this.mxcUrl(e),{body:r}=await this._platform.request(i,{method:"GET",format:"buffer",cache:s}).response();return this._platform.createBlob(r,t)}async downloadAttachment(e,t=!1){var s;return e.file?this.downloadEncryptedFile(e.file,t):this.downloadPlaintextFile(e.url,(s=e.info)==null?void 0:s.mimetype,t)}}class zd{constructor(e,t){this.methodName=e,this.args=t,this._responsePromise=new Promise((s,i)=>{this.responseResolve=s,this.responseReject=i})}abort(){var e;this._requestResult?this._requestResult.abort():(this.responseReject(new Ie),(e=this.responseCodeReject)==null||e.call(this,new Ie))}response(){return this._responsePromise}responseCode(){return this.requestResult?this.requestResult.responseCode():(this._responseCodePromise||(this._responseCodePromise=new Promise((e,t)=>{this.responseCodeResolve=e,this.responseCodeReject=t})),this._responseCodePromise)}async setRequestResult(e){var t,s,i;this._requestResult=e;const r=await((t=this._requestResult)==null?void 0:t.response());this.responseResolve(r);const o=await((s=this._requestResult)==null?void 0:s.responseCode());(i=this.responseCodeResolve)==null||i.call(this,o)}get requestResult(){return this._requestResult}}class Do{constructor(e){this._scheduler=e}}for(const n of Object.getOwnPropertyNames(it.prototype))n!=="constructor"&&!n.startsWith("_")&&(Do.prototype[n]=function(...e){return this._scheduler._hsApiRequest(n,e)});class Gd{constructor({hsApi:e,clock:t}){this._requests=new Set,this._stopped=!1,this._wrapper=new Do(this),this._hsApi=e,this._clock=t}get hsApi(){return this._wrapper}stop(){this._stopped=!0;for(const e of this._requests)e.abort();this._requests.clear()}start(){this._stopped=!1}_hsApiRequest(e,t){const s=new zd(e,t);return this._doSend(s),s}async _doSend(e){this._requests.add(e);try{let t;for(;!this._stopped;)try{const s=this._hsApi[e.methodName].apply(this._hsApi,e.args);await e.setRequestResult(s);return}catch(s){if(s instanceof Gn&&s.errcode==="M_LIMIT_EXCEEDED")Number.isSafeInteger(s.retry_after_ms)?await this._clock.createTimeout(s.retry_after_ms).elapsed():(t||(t=new No(this._clock.createTimeout)),await t.waitForRetry());else{e.responseReject(s);return}}this._stopped&&e.abort()}finally{this._requests.delete(e)}}}const Yd=3e4,L=Pe("InitialSync","CatchupSync","Syncing","Stopped");function Jd(n){var e;try{const t=(e=n?.timeline)==null?void 0:e.events;return Array.isArray(t)&&t.length===0}catch{return!0}}class Qd{constructor({hsApi:e,session:t,storage:s,logger:i}){this._hsApi=e,this._logger=i,this._session=t,this._storage=s,this._currentRequest=null,this._status=new Ee(L.Stopped),this._error=null}get status(){return this._status}get error(){return this._error}start(){if(this._status.get()!==L.Stopped)return;this._error=null;let e=this._session.syncToken;e?this._status.set(L.CatchupSync):this._status.set(L.InitialSync),this._syncLoop(e)}async _syncLoop(e){for(;this._status.get()!==L.Stopped;){let t,s,i=this._status.get()===L.CatchupSync||this._status.get()===L.InitialSync;await this._logger.run("sync",async r=>{r.set("token",e),r.set("status",this._status.get());try{const o=this._status.get()===L.Syncing?Yd:0,a=await this._syncRequest(e,o,r);e=a.syncToken,t=a.roomStates,s=a.sessionChanges,this._status.get()!==L.Syncing&&a.hadToDeviceMessages?this._status.set(L.CatchupSync):this._status.set(L.Syncing)}catch(o){if(o.name==="ConnectionError"&&o.isTimeout)return;this._error=o,o.name!=="AbortError"&&(r.error=o,r.logLevel=r.level.Fatal),r.set("stopping",!0),this._status.set(L.Stopped)}this._status.get()!==L.Stopped&&await r.wrap("afterSyncCompleted",o=>this._runAfterSyncCompleted(s,t,o))},this._logger.level.Info,(r,o)=>o.durationWithoutType("network")>=2e3||o.error||i?r.minLevel(o.level.Detail):r.minLevel(o.level.Info))}}async _runAfterSyncCompleted(e,t,s){const i=this._status.get()===L.CatchupSync,r=(async()=>{try{await s.wrap("session",l=>this._session.afterSyncCompleted(e,i,l),s.level.Detail)}catch{}})(),a=t.filter(l=>l.room.needsAfterSyncCompleted(l.changes)).map(async l=>{try{await s.wrap("room",c=>l.room.afterSyncCompleted(l.changes,c),s.level.Detail)}catch{}});await Promise.all(a.concat(r))}async _syncRequest(e,t,s){var i;let{syncFilterId:r}=this._session;typeof r!="string"&&(this._currentRequest=this._hsApi.createFilter(this._session.user.id,{room:{state:{lazy_load_members:!0}}},{log:s}),r=(await this._currentRequest.response()).filter_id);const o=t+80*1e3;this._currentRequest=this._hsApi.sync(e,r,t,{timeout:o,log:s});const a=await this._currentRequest.response(),l=!e,c=new Xd,h=this._parseInvites(a.rooms),{roomStates:d,archivedRoomStates:m}=await this._parseRoomsResponse(a.rooms,h,l,s);try{c.lock=await s.wrap("obtainSyncLock",()=>this._session.obtainSyncLock(a)),await s.wrap("prepare",_=>this._prepareSync(c,d,a,_)),await s.wrap("afterPrepareSync",_=>Promise.all(d.map(g=>g.room.afterPrepareSync(g.preparation,_)))),await s.wrap("write",async _=>this._writeSync(c,h,d,m,a,r,l,_))}finally{c.dispose()}s.wrap("after",_=>this._afterSync(c,h,d,m,_));const p=(i=a.to_device)==null?void 0:i.events;return{syncToken:a.next_batch,roomStates:d,sessionChanges:c.changes,hadToDeviceMessages:Array.isArray(p)&&p.length>0}}_openPrepareSyncTxn(){const e=this._storage.storeNames;return this._storage.readTxn([e.olmSessions,e.inboundGroupSessions,e.timelineFragments,e.timelineEvents])}async _prepareSync(e,t,s,i){var r,o;const a=await this._openPrepareSyncTxn();e.preparation=await i.wrap("session",c=>this._session.prepareSync(s,e.lock,a,c));const l=(r=e.preparation)==null?void 0:r.newKeysByRoom;if(l){const{hasOwnProperty:c}=Object.prototype;for(const h of l.keys())if(!(((o=s.rooms)==null?void 0:o.join)&&c.call(s.rooms.join,h))){let m=this._session.rooms.get(h);m&&t.push(new cn(m,!1,{},m.membership))}}await Promise.all(t.map(async c=>{const h=l?.get(c.room.id);c.preparation=await i.wrap("room",async d=>(c.isNewRoom&&await c.room.load(null,a,d),c.room.prepareSync(c.roomResponse,c.membership,h,a,d)),i.level.Detail)})),await a.complete()}async _writeSync(e,t,s,i,r,o,a,l){const c=await this._openSyncTxn();try{e.changes=await l.wrap("session",h=>this._session.writeSync(r,o,e.preparation,c,h)),await Promise.all(t.map(async h=>{h.changes=await l.wrap("invite",d=>h.invite.writeSync(h.membership,h.roomResponse,c,d))})),await Promise.all(s.map(async h=>{h.changes=await l.wrap("room",d=>h.room.writeSync(h.roomResponse,a,h.preparation,c,d))})),await Promise.all(i.map(async h=>{var d;const m=(d=h.roomState)==null?void 0:d.summaryChanges;h.changes=await l.wrap("archivedRoom",p=>h.archivedRoom.writeSync(m,h.roomResponse,h.membership,c,p))}))}catch(h){throw c.abort(l),c.getCause(h)}await c.complete(l)}_afterSync(e,t,s,i,r){r.wrap("session",o=>this._session.afterSync(e.changes,o),r.level.Detail);for(let o of i)r.wrap("archivedRoom",a=>{o.archivedRoom.afterSync(o.changes,a),o.archivedRoom.release()},r.level.Detail);for(let o of s)r.wrap("room",a=>o.room.afterSync(o.changes,a),r.level.Detail);for(let o of t)r.wrap("invite",a=>o.invite.afterSync(o.changes,a),r.level.Detail);this._session.applyRoomCollectionChangesAfterSync(t,s,i,r)}_openSyncTxn(){const e=this._storage.storeNames;return this._storage.readWriteTxn([e.session,e.roomSummary,e.archivedRoomSummary,e.invites,e.roomState,e.roomMembers,e.timelineEvents,e.timelineRelations,e.timelineFragments,e.pendingEvents,e.userIdentities,e.groupSessionDecryptions,e.deviceIdentities,e.outboundGroupSessions,e.operations,e.accountData,e.olmSessions,e.inboundGroupSessions])}async _parseRoomsResponse(e,t,s,i){const r=[],o=[];if(e){const a=["join","leave"];for(const l of a){const c=e[l];if(c)for(const[h,d]of Object.entries(c)){if(s&&Jd(d))continue;const m=this._session.invites.get(h);m&&t.push(new hn(m,!1,null,l));const p=this._createRoomSyncState(h,d,l,s);p&&r.push(p);const _=await this._createArchivedRoomSyncState(h,p,d,l,s,i);_&&o.push(_)}}}return{roomStates:r,archivedRoomStates:o}}_createRoomSyncState(e,t,s,i){let r=!1,o=this._session.rooms.get(e);if(!o&&(s==="join"||i&&s==="leave")&&(o=this._session.createJoinedRoom(e),r=!0),o)return new cn(o,r,t,s)}async _createArchivedRoomSyncState(e,t,s,i,r,o){let a;if(t?.shouldAdd&&!r?a=this._session.createOrGetArchivedRoomForSync(e):i==="leave"&&(t?a=this._session.createOrGetArchivedRoomForSync(e):a=await this._session.loadArchivedRoom(e,o)),a)return new Zd(a,t,s,i)}_parseInvites(e){const t=[];if(e?.invite)for(const[s,i]of Object.entries(e.invite)){let r=this._session.invites.get(s),o=!1;r||(r=this._session.createInvite(s),o=!0),t.push(new hn(r,o,i,"invite"))}return t}stop(){this._status.get()!==L.Stopped&&(this._status.set(L.Stopped),this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=null))}}class Xd{constructor(){this.lock=null,this.preparation=null,this.changes=null}dispose(){var e;(e=this.lock)==null||e.release()}}class cn{constructor(e,t,s,i){this.room=e,this.isNewRoom=t,this.roomResponse=s,this.membership=i,this.preparation=null,this.changes=null}get id(){return this.room.id}get shouldAdd(){return this.isNewRoom&&this.membership==="join"}get shouldRemove(){return!this.isNewRoom&&this.membership!=="join"}get summaryChanges(){var e;return(e=this.changes)==null?void 0:e.summaryChanges}}class Zd{constructor(e,t,s,i,r){this.archivedRoom=e,this.roomState=t,this.roomResponse=s,this.membership=i,this.isInitialSync=r,this.changes=null}get id(){return this.archivedRoom.id}get shouldAdd(){return(this.roomState||this.isInitialSync)&&this.membership==="leave"}get shouldRemove(){return this.membership==="join"}}class hn{constructor(e,t,s,i){this.invite=e,this.isNewInvite=t,this.membership=i,this.roomResponse=s,this.changes=null}get id(){return this.invite.id}get shouldAdd(){return this.isNewInvite}get shouldRemove(){return this.membership!=="invite"}}class Ws{constructor(){this._handlersByName={}}emit(e,t){const s=this._handlersByName[e];s&&s.forEach(i=>i(t))}disposableOn(e,t){return this.on(e,t),()=>{this.off(e,t)}}on(e,t){let s=this._handlersByName[e];s||(this.onFirstSubscriptionAdded(e),this._handlersByName[e]=s=new Set),s.add(t)}off(e,t){const s=this._handlersByName[e];s&&(s.delete(t),s.size===0&&(delete this._handlersByName[e],this.onLastSubscriptionRemoved(e)))}onFirstSubscriptionAdded(e){}onLastSubscriptionRemoved(e){}}function eu(n,e,t,s,i){return e.length&&(n=e.reduce((r,o)=>ru(r,o,t,s,i),n)),n}function Oo(n,e,t){var s,i;const r=(s=n?.state)==null?void 0:s.events;Array.isArray(r)&&(t=r.reduce(e,t));const o=(i=n?.timeline)==null?void 0:i.events;return Array.isArray(o)&&(t=o.reduce((a,l)=>(typeof l.state_key=="string"&&(t=e(t,l)),t),t)),t}function tu(n,e,t,s){e.summary&&(n=nu(n,e.summary)),t!==n.membership&&(n=n.cloneIfNeeded(),n.membership=t),e.account_data&&(n=e.account_data.events.reduce(iu,n)),n=Oo(e,(r,o)=>Lo(r,o,s),n);const i=e.unread_notifications;return i&&(n=su(n,i)),n}function su(n,e){const t=e.highlight_count||0;t!==n.highlightCount&&(n=n.cloneIfNeeded(),n.highlightCount=t);const s=e.notification_count;return s!==n.notificationCount&&(n=n.cloneIfNeeded(),n.notificationCount=s),n}function iu(n,e){var t;if(e?.type==="m.tag"){let s=(t=e?.content)==null?void 0:t.tags;(!s||Array.isArray(s)||typeof s!="object")&&(s=null),n=n.cloneIfNeeded(),n.tags=s}return n}function Lo(n,e,t){var s,i,r;if(e.type==="m.room.create")n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.origin_server_ts;else if(e.type==="m.room.encryption"){const o=(s=e.content)==null?void 0:s.algorithm;!n.encryption&&o===ke&&(n=n.cloneIfNeeded(),n.encryption=e.content)}else if(e.type==="m.room.name"){const o=(i=e.content)==null?void 0:i.name;o!==n.name&&(n=n.cloneIfNeeded(),n.name=o)}else if(e.type==="m.room.avatar"){const o=(r=e.content)==null?void 0:r.url;o!==n.avatarUrl&&(n=n.cloneIfNeeded(),n.avatarUrl=o)}else if(e.type==="m.room.canonical_alias"){const o=e.content;n=n.cloneIfNeeded(),n.canonicalAlias=o.alias}else if(e.type==="m.room.member"){const o=e.content;if(o.is_direct===!0&&o.membership==="invite"&&!n.isDirectMessage){let a;e.sender===t?a=e.state_key:e.state_key===t&&(a=e.sender),a&&(n=n.cloneIfNeeded(),n.isDirectMessage=!0,n.dmUserId=a)}else o.membership==="leave"&&n.isDirectMessage&&n.dmUserId===e.state_key&&(n=n.cloneIfNeeded(),n.isDirectMessage=!1,n.dmUserId=null)}return n}function ru(n,e,t,s,i){return e.eventType==="m.room.message"&&((!n.lastMessageTimestamp||e.timestamp>n.lastMessageTimestamp)&&(n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.timestamp),!t&&e.sender!==i&&s&&(n=n.cloneIfNeeded(),n.isUnread=!0)),n}function nu(n,e){const t=e["m.heroes"],s=e["m.joined_member_count"],i=e["m.invited_member_count"];return t&&Array.isArray(t)&&(n=n.cloneIfNeeded(),n.heroes=t),Number.isInteger(i)&&(n=n.cloneIfNeeded(),n.inviteCount=i),Number.isInteger(s)&&(n=n.cloneIfNeeded(),n.joinCount=s),n}class Me{constructor(e,t){this.roomId=e?e.roomId:t,this.name=e?e.name:null,this.lastMessageTimestamp=e?e.lastMessageTimestamp:null,this.isUnread=e?e.isUnread:!1,this.encryption=e?e.encryption:null,this.membership=e?e.membership:null,this.inviteCount=e?e.inviteCount:0,this.joinCount=e?e.joinCount:0,this.heroes=e?e.heroes:null,this.canonicalAlias=e?e.canonicalAlias:null,this.hasFetchedMembers=e?e.hasFetchedMembers:!1,this.isTrackingMembers=e?e.isTrackingMembers:!1,this.avatarUrl=e?e.avatarUrl:null,this.notificationCount=e?e.notificationCount:0,this.highlightCount=e?e.highlightCount:0,this.tags=e?e.tags:null,this.isDirectMessage=e?e.isDirectMessage:!1,this.dmUserId=e?e.dmUserId:null,this.cloned=!!e}changedKeys(e){return Object.getOwnPropertyNames(this).filter(s=>s!=="cloned"&&this[s]!==e[s])}cloneIfNeeded(){return this.cloned?this:new Me(this)}serialize(){return Object.entries(this).reduce((e,[t,s])=>(t!=="cloned"&&s!==null&&(e[t]=s),e),{})}applyTimelineEntries(e,t,s,i){return eu(this,e,t,s,i)}applySyncResponse(e,t,s){return tu(this,e,t,s)}get needsHeroes(){return!this.name&&!this.canonicalAlias&&this.heroes&&this.heroes.length>0}isNewJoin(e){return this.membership==="join"&&e.membership!=="join"}}class ou{constructor(e){this._data=null,this.applyChanges(new Me(null,e))}get data(){return this._data}writeClearUnread(e){const t=new Me(this._data);return t.isUnread=!1,t.notificationCount=0,t.highlightCount=0,e.roomSummary.set(t.serialize()),t}writeHasFetchedMembers(e,t){const s=new Me(this._data);return s.hasFetchedMembers=e,t.roomSummary.set(s.serialize()),s}writeIsTrackingMembers(e,t){const s=new Me(this._data);return s.isTrackingMembers=e,t.roomSummary.set(s.serialize()),s}writeData(e,t){if(e!==this._data)return t.roomSummary.set(e.serialize()),e}writeArchivedData(e,t){if(e!==this._data)return t.archivedRoomSummary.set(e.serialize()),e}async writeAndApplyData(e,t){if(e===this._data)return!1;const s=await t.readWriteTxn([t.storeNames.roomSummary]);try{s.roomSummary.set(e.serialize())}catch(i){throw s.abort(),i}return await s.complete(),this.applyChanges(e),!0}applyChanges(e){this._data=e,this._data.cloned=!1}async load(e){this.applyChanges(new Me(e))}}const Ri=Number.MAX_SAFE_INTEGER;class Po{constructor(e){this._fragmentIdComparer=e}compare(e){return this.fragmentId===e.fragmentId?this.entryIndex-e.entryIndex:this.fragmentId===Ri?1:e.fragmentId===Ri?-1:this._fragmentIdComparer.compare(this.fragmentId,e.fragmentId)}asEventKey(){return new K(this.fragmentId,this.entryIndex)}}const au="m.reaction",ze="m.annotation";function lu(n,e){return{"m.relates_to":{event_id:n,key:e,rel_type:ze}}}function Hi(n){var e;return n.event_id||((e=n["m.in_reply_to"])==null?void 0:e.event_id)}function Vo(n,e){n.event_id!==void 0?n.event_id=e:n["m.in_reply_to"]&&(n["m.in_reply_to"].event_id=e)}function cu(n){if(n.type===be)return n.redacts;{const e=je(n);if(e)return Hi(e)}return null}function Je(n){return n?.["m.relates_to"]}function je(n){return Je(n.content)}class hu{constructor(){this._entries=[]}get firstTimestamp(){return this._entries.reduce((e,t)=>t.isRedaction?e:Math.min(t.timestamp,e),Number.MAX_SAFE_INTEGER)}get annotationEntry(){return this._entries.find(e=>!e.isRedaction)}get redactionEntry(){return this._entries.find(e=>e.isRedaction)}get count(){return this._entries.reduce((e,t)=>e+(t.isRedaction?-1:1),0)}add(e){this._entries.push(e)}remove(e){const t=this._entries.indexOf(e);return t===-1?!1:(this._entries.splice(t,1),!0)}get willAnnotate(){const e=this._entries.reduce((t,s)=>!t||s.pendingEvent.queueIndex>t.pendingEvent.queueIndex?s:t,null);return e?!e.isRedaction:!1}get isEmpty(){return this._entries.length===0}}function dn(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function du(n){switch(n){case"m.file":return"sent a file.";case"m.image":return"sent an image.";case"m.video":return"sent a video.";case"m.audio":return"sent an audio file."}return null}function uu(n){return n==="m.emote"?"* ":""}function mu(n,e,t,s){return{msgtype:e,body:t,format:"org.matrix.custom.html",formatted_body:s,"m.relates_to":{"m.in_reply_to":{event_id:n}}}}function pu(n,e,t){const s=du(n.content.msgtype),i=uu(n.content.msgtype),r=n.sender,o=n.displayName||r,a=s||n.content.formatted_body||n.content.body&&dn(n.content.body)||"",l=`<mx-reply><blockquote>In reply to ${i}<a href="https://matrix.to/#/${r}">${o}</a><br />${a}</blockquote></mx-reply>`,h=(s||n.content.body||"").split(`
`);h[0]=`> ${i}<${r}> ${h[0]}`;const m=h.join(`
> `)+`

`+t,p=l+dn(t);return mu(n.id,e,m,p)}class Uo extends Po{constructor(e){super(e),this._pendingRedactions=null,this._pendingAnnotations=null,this._contextEntry=null,this._contextForEntries=null}get isReply(){var e;return!!((e=this.relation)!=null&&e["m.in_reply_to"])}get isRedacting(){return!!this._pendingRedactions}get isRedacted(){return this.isRedacting}get isRedaction(){return this.eventType===be}get redactionReason(){var e;return this._pendingRedactions?(e=this._pendingRedactions[0].content)==null?void 0:e.reason:null}setContextEntry(e){this._contextEntry=e,e._setAsContextOf(this)}_setAsContextOf(e){this._contextForEntries||(this._contextForEntries=[]),this._contextForEntries.push(e)}get contextForEntries(){return this._contextForEntries}get contextEntry(){return this._contextEntry}addLocalRelation(e){if(e.eventType===be&&e.isRelatedToId(this.id)){if(this._pendingRedactions||(this._pendingRedactions=[]),this._pendingRedactions.push(e),this._pendingRedactions.length===1)return"isRedacted"}else{const t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&t.relation.rel_type===ze&&this._addPendingAnnotation(e))return"pendingAnnotations"}}removeLocalRelation(e){var t;if(e.eventType===be&&e.isRelatedToId(this.id)&&this._pendingRedactions){const s=this._pendingRedactions.length;if(this._pendingRedactions=this._pendingRedactions.filter(i=>i!==e),this._pendingRedactions.length===0&&(this._pendingRedactions=null,s!==0))return"isRedacted"}else{const s=e.redactingEntry||e;if(s.isRelatedToId(this.id)&&((t=s.relation)==null?void 0:t.rel_type)===ze&&this._pendingAnnotations&&this._removePendingAnnotation(e))return"pendingAnnotations"}}_addPendingAnnotation(e){this._pendingAnnotations||(this._pendingAnnotations=new Map);const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s||(s=new hu,this._pendingAnnotations.set(t,s)),s.add(e),!0}return!1}_removePendingAnnotation(e){const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s.remove(e)&&s.isEmpty&&this._pendingAnnotations.delete(t),this._pendingAnnotations.size===0&&(this._pendingAnnotations=null),!0}return!1}async abortPendingRedaction(){if(this._pendingRedactions)for(const e of this._pendingRedactions)await e.pendingEvent.abort()}get pendingRedaction(){return this._pendingRedactions?this._pendingRedactions[0]:null}annotate(e){return lu(this.id,e)}reply(e,t){return pu(this,e,t)}isRelatedToId(e){return e&&this.relatedEventId===e}haveAnnotation(e){var t,s,i;const r=((s=(t=this.annotations)==null?void 0:t[e])==null?void 0:s.me)||!1,o=(i=this.pendingAnnotations)==null?void 0:i.get(e),a=o?.willAnnotate||!1;return r&&(!o||a)||!r&&a}get relation(){return Je(this.content)}get pendingAnnotations(){return this._pendingAnnotations}get annotations(){return null}}class _u extends Uo{constructor({pendingEvent:e,member:t,clock:s,redactingEntry:i}){super(null),this._pendingEvent=e,this._member=t,this._timestamp=s.now()-(100-e.queueIndex),this._redactingEntry=i}get fragmentId(){return Ri}get entryIndex(){return this._pendingEvent.queueIndex}get content(){return this._pendingEvent.content}get event(){return null}get eventType(){return this._pendingEvent.eventType}get stateKey(){return null}get sender(){var e;return(e=this._member)==null?void 0:e.userId}get displayName(){var e;return(e=this._member)==null?void 0:e.name}get avatarUrl(){var e;return(e=this._member)==null?void 0:e.avatarUrl}get timestamp(){return this._timestamp}get isPending(){return!0}get id(){return this._pendingEvent.txnId}get pendingEvent(){return this._pendingEvent}notifyUpdate(){}isRelatedToId(e){return e&&e===this._pendingEvent.relatedTxnId?!0:super.isRelatedToId(e)}get relatedEventId(){return this._pendingEvent.relatedEventId}get redactingEntry(){return this._redactingEntry}get contextEventId(){var e;return this.isReply?(e=this._pendingEvent.relatedEventId)!=null?e:this._pendingEvent.relatedTxnId:null}}const D=Pe("Waiting","EncryptingAttachments","UploadingAttachments","Encrypting","Sending","Sent","Error"),un=["m.relates_to"];class gu{constructor({data:e,remove:t,emitUpdate:s,attachments:i}){this._data=e,this._attachments=i,this._emitUpdate=s,this._removeFromQueueCallback=t,this._aborted=!1,this._status=D.Waiting,this._sendRequest=null,this._attachmentsTotalBytes=0,this._attachments&&(this._attachmentsTotalBytes=Object.values(this._attachments).reduce((r,o)=>r+o.size,0))}get roomId(){return this._data.roomId}get queueIndex(){return this._data.queueIndex}get eventType(){return this._data.eventType}get txnId(){return this._data.txnId}get remoteId(){return this._data.remoteId}get content(){return this._data.content}get relatedTxnId(){return this._data.relatedTxnId}get relatedEventId(){const e=Je(this.content);return e?Hi(e):this._data.relatedEventId}setRelatedEventId(e){const t=Je(this.content);t?Vo(t,e):this._data.relatedEventId=e}get data(){return this._data}getAttachment(e){return this._attachments&&this._attachments[e]}get needsSending(){return!this.remoteId&&!this.aborted}get needsEncryption(){return this._data.needsEncryption&&!this.aborted}get needsUpload(){return this._data.needsUpload&&!this.aborted}get isMissingAttachments(){return this.needsUpload&&!this._attachments}setEncrypting(){this._status=D.Encrypting,this._emitUpdate("status")}get contentForEncryption(){const e=Object.assign({},this._data.content);for(const t of un)delete e[t];return e}_preserveContentFields(e){const t=this._data.content;for(const s of un)t[s]!==void 0&&(e[s]=t[s])}setEncrypted(e,t){this._preserveContentFields(t),this._data.encryptedEventType=e,this._data.encryptedContent=t,this._data.needsEncryption=!1}setError(e){this._status=D.Error,this._error=e,this._emitUpdate("status")}setWaiting(){this._status=D.Waiting,this._emitUpdate("status")}get status(){return this._status}get error(){return this._error}get hasStartedSending(){return this._status===D.Sending||this._status===D.Sent}get attachmentsTotalBytes(){return this._attachmentsTotalBytes}get attachmentsSentBytes(){return this._attachments&&Object.values(this._attachments).reduce((e,t)=>e+t.sentBytes,0)}async uploadAttachments(e,t){if(!this.needsUpload)return;if(!this._attachments)throw new Error("attachments missing");if(this.needsEncryption){this._status=D.EncryptingAttachments,this._emitUpdate("status");for(const i of Object.values(this._attachments))if(await t.wrap("encrypt",()=>(t.set("size",i.size),i.encrypt())),this.aborted)throw new Ie}this._status=D.UploadingAttachments,this._emitUpdate("status");const s=Object.entries(this._attachments);s.sort(([,i],[,r])=>i.size-r.size);for(const[i,r]of s)await t.wrap("upload",o=>(o.set("size",r.size),r.upload(e,()=>{this._emitUpdate("attachmentsSentBytes")},o))),r.applyToContent(i,this.content);this._data.needsUpload=!1}async abort(){var e;if(!this._aborted){if(this._aborted=!0,this._attachments)for(const t of Object.values(this._attachments))t.abort();(e=this._sendRequest)==null||e.abort(),await this._removeFromQueueCallback()}}get aborted(){return this._aborted}async send(e,t){this._status=D.Sending,this._emitUpdate("status");const s=this._data.encryptedEventType||this._data.eventType,i=this._data.encryptedContent||this._data.content;s===be?this._sendRequest=e.redact(this.roomId,this._data.relatedEventId,this.txnId,i,{log:t}):this._sendRequest=e.send(this.roomId,s,this.txnId,i,{log:t});const r=await this._sendRequest.response();this._sendRequest=null,this._data.remoteId=r.event_id,t.set("id",this._data.remoteId),this._status=D.Sent,this._emitUpdate("status")}dispose(){if(this._attachments)for(const e of Object.values(this._attachments))e.dispose()}}class he extends Uo{constructor(e,t){super(t),this._eventEntry=e,this._decryptionError=null,this._decryptionResult=null}clone(){const e=new he(this._eventEntry,this._fragmentIdComparer);return e.updateFrom(this),e}updateFrom(e){e._decryptionResult&&!this._decryptionResult&&(this._decryptionResult=e._decryptionResult),e._decryptionError&&!this._decryptionError&&(this._decryptionError=e._decryptionError),this._contextForEntries=e.contextForEntries,this._contextEntry=e.contextEntry}get event(){return this._eventEntry.event}get fragmentId(){return this._eventEntry.fragmentId}get entryIndex(){return this._eventEntry.eventIndex}get content(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.content)||this._eventEntry.event.content}get prevContent(){return Ei(this._eventEntry.event)}get eventType(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.type)||this._eventEntry.event.type}get stateKey(){return this._eventEntry.event.state_key}get sender(){return this._eventEntry.event.sender}get displayName(){return this._eventEntry.displayName}get avatarUrl(){return this._eventEntry.avatarUrl}get timestamp(){return this._eventEntry.event.origin_server_ts}get id(){return this._eventEntry.event.event_id}setDecryptionResult(e){this._decryptionResult=e}get isEncrypted(){return this._eventEntry.event.type==="m.room.encrypted"}get isDecrypted(){var e;return!!((e=this._decryptionResult)!=null&&e.event)}get isVerified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isVerified)}get isUnverified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isUnverified)}setDecryptionError(e){this._decryptionError=e}get decryptionError(){return this._decryptionError}get relatedEventId(){return cu(this.event)}get isRedacted(){return super.isRedacted||ki(this._eventEntry.event)}get redactionReason(){var e,t;const s=(e=this._eventEntry.event.unsigned)==null?void 0:e.redacted_because;return s?(t=s.content)==null?void 0:t.reason:super.redactionReason}get annotations(){return this._eventEntry.annotations}get relation(){const e=this._eventEntry.event.content;return e&&Je(e)||Je(this.content)}get contextEventId(){return this.isReply?this.relatedEventId:null}}function Wi(n){return typeof n=="number"}const fu=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce(function(n,e){return n[e]=1,n},{}),yu={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}};function vu(n,e){for(const i of Object.keys(e))fu[i]||delete e[i];const{content:t}=e,s=yu[e.type];for(const i of Object.keys(t))s?.[i]||delete t[i];e.unsigned=e.unsigned||{},e.unsigned.redacted_because=n}function wu(n,e){const t=[];for(;Wi(n.previousId);){const s=e.get(n.previousId);if(!s)break;if(s.nextId!==n.id)throw new Error(`Previous fragment ${s.id} doesn't point back to ${n.id}`);e.delete(n.previousId),t.unshift(s),n=s}return t}function bu(n,e){const t=[];for(;Wi(n.nextId);){const s=e.get(n.nextId);if(!s)break;if(s.previousId!==n.id)throw new Error(`Next fragment ${s.id} doesn't point back to ${n.id}`);e.delete(n.nextId),t.push(s),n=s}return t}function Su(n){const e=new Map;for(let s of n)e.set(s.id,s);const t=[];for(;e.size;){const s=e.values().next().value;e.delete(s.id);const i=wu(s,e),r=bu(s,e),o=i.concat(s,r);t.push(o)}return t.map(s=>new Iu(s))}class fi{constructor(e,t,s){this.id=e,this.previousId=t,this.nextId=s}}class Iu{constructor(e){this._idToSortIndex=new Map,e.forEach((t,s)=>{this._idToSortIndex.set(t.id,s)})}compare(e,t){const s=this._idToSortIndex.get(e);if(s===void 0)throw new Error(`first id ${e} isn't part of this island`);const i=this._idToSortIndex.get(t);if(i===void 0)throw new Error(`second id ${t} isn't part of this island`);return s-i}get fragmentIds(){return this._idToSortIndex.keys()}}class mn extends Error{get name(){return"CompareError"}}class Eu{constructor(e){this._fragmentsById=e.reduce((t,s)=>(t.set(s.id,s),t),new Map),this.rebuild(e)}_getIsland(e){const t=this._idToIsland.get(e);if(t===void 0)throw new mn(`Unknown fragment id ${e}`);return t}compare(e,t){if(e===t)return 0;const s=this._getIsland(e),i=this._getIsland(t);if(s!==i)throw new mn(`${e} and ${t} are on different islands, can't tell order`);return s.compare(e,t)}rebuild(e){const t=Su(e);this._idToIsland=new Map;for(let s of t)for(let i of s.fragmentIds)this._idToIsland.set(i,s)}add(e){const t=new fi(e.id,e.previousId,e.nextId);this._fragmentsById.set(e.id,t),this.rebuild(this._fragmentsById.values())}append(e,t){const s=new fi(e,t,null),i=this._fragmentsById.get(t);i&&(i.nextId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}prepend(e,t){const s=new fi(e,null,t),i=this._fragmentsById.get(t);i&&(i.previousId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}}class Fo{constructor({roomId:e,ownUserId:t,fragmentIdComparer:s}){this._roomId=e,this._ownUserId=t,this._fragmentIdComparer=s}async writeRelation(e,t,s){const{relatedEventId:i}=e;if(i){const r=je(e.event);r&&r.rel_type&&t.timelineRelations.add(this._roomId,r.event_id,r.rel_type,e.id);const o=await t.timelineEvents.getByEventId(this._roomId,i);if(o){const a=await this._applyRelation(e,o,t,s);if(a)return a.map(l=>(t.timelineEvents.update(l),new he(l,this._fragmentIdComparer)))}}return null}async writeGapRelation(e,t,s,i){const r=new he(e,this._fragmentIdComparer),o=await this.writeRelation(r,s,i);if(t.isBackward&&!ki(e.event)){const a=await s.timelineRelations.getAllForTarget(this._roomId,r.id);if(a.length)for(const l of a){const c=await s.timelineEvents.getByEventId(this._roomId,l.sourceEventId);if(c){const h=new he(c,this._fragmentIdComparer);await this._applyRelation(h,e,s,i)}}}return o}async _applyRelation(e,t,s,i){if(e.eventType===be)return i.wrap("redact",async r=>{const o=t.event,a=je(o);if(this._applyRedaction(e.event,t,s,r)){const c=[t];if(a){const h=await this._reaggregateRelation(o,a,s,r);h&&c.push(h)}return c}return null});{const r=je(e.event);if(r&&!ki(t.event)&&r.rel_type===ze&&i.wrap("react",l=>this._aggregateAnnotation(e.event,t,l)))return[t]}return null}_applyRedaction(e,t,s,i){const r=t.event;i.set("redactionId",e.event_id),i.set("id",r.event_id);const o=je(r);return o&&o.rel_type&&s.timelineRelations.remove(this._roomId,o.event_id,o.rel_type,r.event_id),s.timelineRelations.removeAllForTarget(this._roomId,r.event_id),vu(e,r),delete t.annotations,!0}_aggregateAnnotation(e,t){const s=je(e);if(!s)return!1;let{annotations:i}=t;i||(t.annotations=i={});let r=i[s.key];r||(i[s.key]=r={count:0,me:!1,firstTimestamp:Number.MAX_SAFE_INTEGER});const o=e.sender===this._ownUserId;return r.me=r.me||o,r.count+=1,r.firstTimestamp=Math.min(r.firstTimestamp,e.origin_server_ts),!0}async _reaggregateRelation(e,t,s,i){return t.rel_type===ze?i.wrap("reaggregate annotations",r=>this._reaggregateAnnotation(t.event_id,t.key,s,r)):null}async _reaggregateAnnotation(e,t,s,i){const r=await s.timelineEvents.getByEventId(this._roomId,e);if(!r||!r.annotations)return null;i.set("id",e);const o=await s.timelineRelations.getForTargetAndType(this._roomId,e,ze);return i.set("relations",o.length),delete r.annotations[t],ku(r.annotations)&&delete r.annotations,await Promise.all(o.map(async a=>{const l=await s.timelineEvents.getByEventId(this._roomId,a.sourceEventId);l||i.log({l:"missing annotation",id:a.sourceEventId}),je(l.event).key===t&&this._aggregateAnnotation(l.event,r,i)})),r}}function ku(n){for(const e in n)if(n.hasOwnProperty(e))return!1;return!0}class Oe{constructor(e){this.isForward=e}get isBackward(){return!this.isForward}asApiString(){return this.isForward?"f":"b"}reverse(){return this.isForward?Oe.Backward:Oe.Forward}static get Forward(){return Ru}static get Backward(){return Cu}}const Ru=new Oe(!0),Cu=new Oe(!1);class me extends Po{constructor(e,t,s){super(s),this._fragment=e,this._isFragmentStart=t}static start(e,t){return new me(e,!0,t)}static end(e,t){return new me(e,!1,t)}get started(){return this._isFragmentStart}get hasEnded(){return!this.started}get fragment(){return this._fragment}get fragmentId(){return this._fragment.id}get entryIndex(){return this.started?F.minStorageKey:F.maxStorageKey}get isGap(){return!!this.token&&!this.edgeReached}get token(){return this.started?this.fragment.previousToken:this.fragment.nextToken}set token(e){this.started?this.fragment.previousToken=e:this.fragment.nextToken=e}get edgeReached(){return this.started?this.fragment.startReached:this.fragment.endReached}set edgeReached(e){this.started?this.fragment.startReached=e:this.fragment.endReached=e}get linkedFragmentId(){return this.started?this.fragment.previousId:this.fragment.nextId}set linkedFragmentId(e){this.started?this.fragment.previousId=e:this.fragment.nextId=e}get hasLinkedFragment(){return Wi(this.linkedFragmentId)}get direction(){return this.started?Oe.Backward:Oe.Forward}withUpdatedFragment(e){return new me(e,this._isFragmentStart,this._fragmentIdComparer)}createNeighbourEntry(e){return new me(e,!this._isFragmentStart,this._fragmentIdComparer)}addLocalRelation(){}removeLocalRelation(){}}function Tu(n){const e=new Set;return n.filter(t=>e.has(t.event_id)?!1:(e.add(t.event_id),!0))}class Mu{constructor({roomId:e,fragmentIdComparer:t,memberWriter:s,relationWriter:i}){this._roomId=e,this._memberWriter=s,this._relationWriter=i,this._fragmentIdComparer=t,this._lastLiveKey=null}async load(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s){const[i]=await e.timelineEvents.lastEvents(this._roomId,s.id,1),r=i?i.eventIndex:K.defaultLiveKey.eventIndex;this._lastLiveKey=new K(s.id,r)}this._lastLiveKey&&t.set("live key",this._lastLiveKey.toString())}async _createLiveFragment(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s)return s;{t||(t=null);const i={roomId:this._roomId,id:K.defaultLiveKey.fragmentId,previousId:null,nextId:null,previousToken:t,nextToken:null};return e.timelineFragments.add(i),this._fragmentIdComparer.add(i),i}}async _replaceLiveFragment(e,t,s,i){const r=await i.timelineFragments.get(this._roomId,e);if(!r)throw new Error(`old live fragment doesn't exist: ${e}`);r.nextId=t,i.timelineFragments.update(r);const o={roomId:this._roomId,id:t,previousId:e,nextId:null,previousToken:s,nextToken:null};return i.timelineFragments.add(o),this._fragmentIdComparer.append(t,e),{oldFragment:r,newFragment:o}}async _ensureLiveFragment(e,t,s,i,r){if(e){if(s.limited){const o=e.fragmentId;e=e.nextFragmentKey();const{oldFragment:a,newFragment:l}=await this._replaceLiveFragment(o,e.fragmentId,s.prev_batch,i);t.push(me.end(a,this._fragmentIdComparer)),t.push(me.start(l,this._fragmentIdComparer)),r.log({l:"live fragment",limited:!0,id:e.fragmentId})}}else{let o=await this._createLiveFragment(i,s.prev_batch);e=new K(o.id,K.defaultLiveKey.eventIndex),t.push(me.start(o,this._fragmentIdComparer)),r.log({l:"live fragment",first:!0,id:e.fragmentId})}return e}async _writeStateEvents(e,t,s){let i=0;for(const r of e)r.type!==ce&&(t.roomState.set(this._roomId,r),i+=1);s.set("stateEvents",i)}async _writeTimeline(e,t,s,i,r,o){const a=[],l=[];if(e?.length){i=await this._ensureLiveFragment(i,a,t,r,o),o.set("timelineEvents",e.length);let c=0;for(const h of e){i=i.nextKey();const d=ro(i,this._roomId,h);let m=await s.lookupMemberAtEvent(h.sender,h,r);if(m&&(d.displayName=m.displayName,d.avatarUrl=m.avatarUrl),!await r.timelineEvents.tryInsert(d,o))continue;const _=new he(d,this._fragmentIdComparer);a.push(_);const g=await this._relationWriter.writeRelation(_,r,o);g&&l.push(...g),typeof h.state_key=="string"&&h.type!==ce&&(c+=1,r.roomState.set(this._roomId,h))}o.set("timelineStateEventCount",c)}return{currentKey:i,entries:a,updatedEntries:l}}async _handleRejoinOverlap(e,t,s){if(this._lastLiveKey){const{fragmentId:i}=this._lastLiveKey,[r]=await t.timelineEvents.lastEvents(this._roomId,i,1);if(r){const o=r.event.event_id,{events:a}=e,l=a.findIndex(c=>c.event_id===o);if(l!==-1)return s.set("overlap_event_id",o),Object.assign({},e,{limited:!1,events:a.slice(l+1)})}}return e.limited?e:(s.set("force_limited_without_overlap",!0),Object.assign({},e,{limited:!0}))}async writeSync(e,t,s,i,r){let{timeline:o}=e;r.set("isRejoin",t),t&&(o=await this._handleRejoinOverlap(o,i,r));let a;Array.isArray(o?.events)&&(a=Tu(o.events));const{state:l}=e;let c;Array.isArray(l?.events)&&(c=l.events);const h=this._memberWriter.prepareMemberSync(c,a,s);c&&await this._writeStateEvents(c,i,r);const{currentKey:d,entries:m,updatedEntries:p}=await this._writeTimeline(a,o,h,this._lastLiveKey,i,r),_=await h.write(i);return{entries:m,updatedEntries:p,newLiveKey:d,memberChanges:_}}afterSync(e){this._lastLiveKey=e}get lastMessageKey(){return this._lastLiveKey}}class Bo{constructor(e){this.limit=e,this._entries=[]}get size(){return this._entries.length}_get(e){return this._getByIndexAndMoveUp(this._entries.findIndex(e))}_getByIndexAndMoveUp(e){if(e!==-1){const t=this._entries[e];return e>0&&(this._entries.splice(e,1),this._entries.unshift(t)),t}}_set(e,t){let s=t?this._entries.findIndex(t):-1;this._entries.unshift(e),s===-1?this._entries.length>this.limit&&(s=this._entries.length-1):s+=1,s!==-1&&(this.onEvictEntry(this._entries[s]),this._entries.splice(s,1))}onEvictEntry(e){}}class Au extends Bo{constructor(e,t){super(e),this._keyFn=t}get(e){return this._get(t=>this._keyFn(t)===e)}set(e){const t=this._keyFn(e);this._set(e,s=>this._keyFn(s)===t)}}class xu{constructor(e){this._roomId=e,this._cache=new Au(5,t=>t.userId)}prepareMemberSync(e,t,s){return new Nu(this,e,t,s)}async _writeMember(e,t){let s=this._cache.get(e.userId);if(!s){const i=await t.roomMembers.get(this._roomId,e.userId);i&&(s=new P(i))}if(!s||!s.equals(e))return t.roomMembers.set(e.serialize()),this._cache.set(e),new oo(e,s?.membership)}async lookupMember(e,t){let s=this._cache.get(e);if(!s){const i=await t.roomMembers.get(this._roomId,e);i&&(s=new P(i),this._cache.set(s))}return s}}class Nu{constructor(e,t,s,i){this._memberWriter=e,this._timelineEvents=s,this._hasFetchedMembers=i,this._newStateMembers=null,t&&(this._newStateMembers=this._stateEventsToMembers(t))}get _roomId(){return this._memberWriter._roomId}_stateEventsToMembers(e){let t;for(const s of e)if(s.type===ce){const i=P.fromMemberEvent(this._roomId,s);i&&(t||(t=new Map),t.set(i.userId,i))}return t}_timelineEventsToMembers(e){let t;for(let s=e.length-1;s>=0;s--){const i=e[s],r=i.state_key;if(i.type===ce&&!t?.has(r)){const o=P.fromMemberEvent(this._roomId,i);o&&(t||(t=new Map),t.set(o.userId,o))}}return t}async lookupMemberAtEvent(e,t,s){var i;let r;return this._timelineEvents&&(r=this._findPrecedingMemberEventInTimeline(e,t),r)||(r=(i=this._newStateMembers)==null?void 0:i.get(e),r)?r:await this._memberWriter.lookupMember(e,s)}async write(e){const t=new Map;let s;if(this._timelineEvents&&(s=this._timelineEventsToMembers(this._timelineEvents)),this._newStateMembers){for(const i of this._newStateMembers.values())if(!s?.has(i.userId)){const r=await this._memberWriter._writeMember(i,e);r&&(!this._hasFetchedMembers&&!r.previousMembership&&(r.previousMembership=i.membership),t.set(r.userId,r))}}if(s)for(const i of s.values()){const r=await this._memberWriter._writeMember(i,e);r&&t.set(r.userId,r)}return t}_findPrecedingMemberEventInTimeline(e,t){let s=-1;for(let i=this._timelineEvents.length-1;i>=0;i--)if(this._timelineEvents[i].event_id===t.event_id){s=i;break}for(let i=s-1;i>=0;i--){const r=this._timelineEvents[i];if(r.type===ce&&r.state_key===e){const o=P.fromMemberEvent(this._roomId,r);if(o)return o}}}}class Du{constructor({roomId:e,storage:t,fragmentIdComparer:s,relationWriter:i}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._relationWriter=i}async _findOverlappingEvents(e,t,s,i){const r=t.map(c=>c.event_id),o=await s.timelineEvents.getEventKeysForIds(this._roomId,r);i.set("existingEvents",o.size);const a=t.filter(c=>!o.has(c.event_id));i.set("nonOverlappingEvents",a.length);let l;if(e.hasLinkedFragment){i.set("linkedFragmentId",e.linkedFragmentId);for(const c of o.values())if(c.fragmentId===e.linkedFragmentId){i.set("foundLinkedFragment",!0);const h=await s.timelineFragments.get(this._roomId,e.linkedFragmentId);l=e.createNeighbourEntry(h);break}}return{nonOverlappingEvents:a,neighbourFragmentEntry:l}}async _findFragmentEdgeEventKey(e,t){const{fragmentId:s,direction:i}=e,r=await this._findFragmentEdgeEvent(s,i,t);return r?new K(r.fragmentId,r.eventIndex):K.defaultFragmentKey(e.fragmentId)}async _findFragmentEdgeEvent(e,t,s){if(t.isBackward){const[i]=await s.timelineEvents.firstEvents(this._roomId,e,1);return i}else{const[i]=await s.timelineEvents.lastEvents(this._roomId,e,1);return i}}async _storeEvents(e,t,s,i,r,o){const a=[],l=[];let c=t;for(let h=0;h<e.length;++h){const d=e[h];c=c.nextKeyForDirection(s);const m=ro(c,this._roomId,d),p=this._findMember(d.sender,i,e,h,s);p&&(m.displayName=p.displayName,m.avatarUrl=p.avatarUrl);const _=await this._relationWriter.writeGapRelation(m,s,r,o);if(_&&l.push(..._),await r.timelineEvents.tryInsert(m,o)){const g=new he(m,this._fragmentIdComparer);qt(a,g,s)}}return{entries:a,updatedEntries:l}}_findMember(e,t,s,i,r){function o(c){return c.type===ce&&c.state_key===e}const a=r.isBackward?1:-1;for(let c=i+a;c>=0&&c<s.length;c+=a){const h=s[c];if(o(h))return P.fromMemberEvent(this._roomId,h)}for(let c=i;c>=0&&c<s.length;c-=a){const h=s[c];if(o(h))return P.fromReplacingMemberEvent(this._roomId,h)}const l=t?.find(o);if(l)return P.fromMemberEvent(this._roomId,l)}async _updateFragments(e,t,s,i,r,o){const{direction:a}=e,l=[];return qt(i,e,a),t?(o.set("closedGapWith",t.fragmentId),t.token=null,e.token=null,r.timelineFragments.update(t.fragment),qt(i,t,a),l.push(e.fragment),l.push(t.fragment)):e.token=s,r.timelineFragments.update(e.fragment),l}async writeFragmentFill(e,t,s,i){const{fragmentId:r,direction:o}=e,{chunk:a,start:l,state:c}=t;let{end:h}=t;if(!Array.isArray(a))throw new Error("Invalid chunk in response");if(typeof h!="string"&&typeof h<"u")throw new Error("Invalid end token in response");const d=await s.timelineFragments.get(this._roomId,r);if(!d)throw new Error(`Unknown fragment: ${r}`);if(e=e.withUpdatedFragment(d),e.token!==l)throw new Error("start is not equal to prev_batch or next_batch");if(a.length===0)return e.edgeReached=!0,await s.timelineFragments.update(e.fragment),{entries:[e],updatedEntries:[],fragments:[]};let m=await this._findFragmentEdgeEventKey(e,s);i.set("lastKey",m.toString());const{nonOverlappingEvents:p,neighbourFragmentEntry:_}=await this._findOverlappingEvents(e,a,s,i),{entries:g,updatedEntries:b}=await this._storeEvents(p,m,o,c,s,i),S=await this._updateFragments(e,_,h,g,s,i);return{entries:g,updatedEntries:b,fragments:S}}}/**
 * @license
 * Based off baseSortedIndex function in Lodash <https://lodash.com/>
 * Copyright JS Foundation and other contributors <https://js.foundation/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */function Ge(n,e,t){let s=0,i=n.length;for(;s<i;){let r=s+i>>>1,o=t(e,n[r]);o>0?s=r+1:o<0?i=r:s=i=r}return i}class xt extends Pi{emitReset(){for(let e of this._handlers)e.onReset()}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t)}emitUpdate(e,t,s){for(let i of this._handlers)i.onUpdate(e,t,s)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t)}}class Gt extends xt{constructor(e){super(),this._values=new Map(e)}update(e,t){const s=this._values.get(e);return s!==void 0?(this._values.set(e,s),this.emitUpdate(e,s,t),!0):!1}add(e,t){return this._values.has(e)?!1:(this._values.set(e,t),this.emitAdd(e,t),!0)}remove(e){const t=this._values.get(e);return t!==void 0?(this._values.delete(e),this.emitRemove(e,t),!0):!1}set(e,t){return this._values.has(e)?(this._values.set(e,t),this.update(e,void 0)):this.add(e,t)}reset(){this._values.clear(),this.emitReset()}get(e){return this._values.get(e)}get size(){return this._values.size}[Symbol.iterator](){return this._values.entries()}values(){return this._values.values()}keys(){return this._values.keys()}}class Ou extends Mt{constructor(e,t){super(),this._sourceMap=e,this._comparator=(s,i)=>t(s.value,i.value),this._sortedPairs=null,this._mapSubscription=null}onAdd(e,t){const s={key:e,value:t},i=Ge(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,0,s),this.emitAdd(i,t)}onRemove(e,t){const s={key:e,value:t},i=Ge(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,1),this.emitRemove(i,t)}onUpdate(e,t,s){if(!this._sortedPairs)return;const i=this._sortedPairs.findIndex(a=>a.key===e);this._sortedPairs.splice(i,1);const r={key:e,value:t},o=Ge(this._sortedPairs,r,this._comparator);this._sortedPairs.splice(o,0,r),i!==o&&this.emitMove(i,o,t),this.emitUpdate(o,t,s)}onReset(){this._sortedPairs=[],this.emitReset()}onSubscribeFirst(){this._mapSubscription=this._sourceMap.subscribe(this),this._sortedPairs=new Array(this._sourceMap.size);let e=0;for(let[t,s]of this._sourceMap)this._sortedPairs[e]={key:t,value:s},++e;this._sortedPairs.sort(this._comparator),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._sortedPairs=null,this._mapSubscription=this._mapSubscription()}get(e){return this._sortedPairs[e].value}get length(){return this._sourceMap.size}[Symbol.iterator](){const e=this._sortedPairs.values();return{next(){const t=e.next();return t.value&&(t.value=t.value.value),t}}}}class Lu extends xt{constructor(e,t){super(),this._source=e,this._filter=t,this._included=null,this._subscription=null}setFilter(e){this._filter=e,this._subscription&&this._reapplyFilter()}_reapplyFilter(e=!1){if(this._filter){const t=this._included;this._included=this._included||new Map;for(const[s,i]of this._source){const r=this._filter(i,s);if(this._included.set(s,r),!e){const o=t?t.get(s):!0;this._emitForUpdate(o,r,s,i)}}}else{if(this._included&&!e)for(const[t,s]of this._source)this._included.get(t)||this.emitAdd(t,s);this._included=null}}onAdd(e,t){if(this._filter){const s=this._filter(t,e);if(this._included.set(e,s),!s)return}this.emitAdd(e,t)}onRemove(e,t){const s=!this._filter||this._included.get(e);this._included.delete(e),s&&this.emitRemove(e,t)}onUpdate(e,t,s){if(!!this._included)if(this._filter){const i=this._included.get(e),r=this._filter(t,e);this._included.set(e,r),this._emitForUpdate(i,r,e,t,s)}else this.emitUpdate(e,t,s)}_emitForUpdate(e,t,s,i,r=null){e&&!t?this.emitRemove(s,i):!e&&t?this.emitAdd(s,i):e&&t&&this.emitUpdate(s,i,r)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._reapplyFilter(!0),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._included=null,this._subscription=this._subscription()}onReset(){this._reapplyFilter(),this.emitReset()}[Symbol.iterator](){return new Pu(this._source,this._included)}get size(){let e=0;return this._included.forEach(t=>{t&&(e+=1)}),e}get(e){const t=this._source.get(e);if(t&&this._filter(t,e))return t}}class Pu{constructor(e,t){this._included=t,this._sourceIterator=e[Symbol.iterator]()}next(){for(;;){const e=this._sourceIterator.next();if(e.done)return e;const t=e.value[0];if(this._included.get(t))return e}}}class Vu extends xt{constructor(e,t,s){super(),this._source=e,this._mapper=t,this._updater=s,this._mappedValues=new Map}_emitSpontaneousUpdate(e,t){const s=this._mappedValues.get(e);s&&this.emitUpdate(e,s,t)}onAdd(e,t){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i),this.emitAdd(e,i)}onRemove(e){const t=this._mappedValues.get(e);this._mappedValues.delete(e)&&this.emitRemove(e,t)}onUpdate(e,t,s){var i;if(!this._mappedValues)return;const r=this._mappedValues.get(e);r!==void 0&&((i=this._updater)==null||i.call(this,r,s,t),this.emitUpdate(e,r,s))}onSubscribeFirst(){this._subscription=this._source.subscribe(this);for(let[e,t]of this._source){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i)}super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription=this._subscription(),this._mappedValues.clear()}onReset(){this._mappedValues.clear(),this.emitReset()}[Symbol.iterator](){return this._mappedValues.entries()}get size(){return this._mappedValues.size}get(e){return this._mappedValues.get(e)}}class Uu extends xt{constructor(e){super(),this._sources=e,this._subscriptions=null}onAdd(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitRemove(t,i),this.emitAdd(t,s)}}onRemove(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){this.emitRemove(t,s);const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitAdd(t,i)}}onUpdate(e,t,s,i){!this._subscriptions||this._isKeyAtSourceOccluded(e,t)||this.emitUpdate(t,s,i)}onReset(){this.emitReset()}onSubscribeFirst(){this._subscriptions=this._sources.map(e=>new Bu(e,this).subscribe()),super.onSubscribeFirst()}_isKeyAtSourceOccluded(e,t){const s=this._sources.indexOf(e);for(let i=0;i<s;i+=1)if(this._sources[i].get(t)!==void 0)return!0;return!1}_getValueFromOccludedSources(e,t){const s=this._sources.indexOf(e);for(let i=s+1;i<this._sources.length;i+=1){const o=this._sources[i].get(t);if(o!==void 0)return o}}onUnsubscribeLast(){super.onUnsubscribeLast();for(const e of this._subscriptions)e.dispose()}[Symbol.iterator](){return new Fu(this._sources)}get size(){return this._sources.reduce((e,t)=>e+t.size,0)}get(e){for(const t of this._sources){const s=t.get(e);if(s)return s}return null}}class Fu{constructor(e){this._sources=e,this._sourceIndex=-1,this._currentIterator=null,this._encounteredKeys=new Set}next(){let e;for(;!e;){if(!this._currentIterator){if(this._sourceIndex+=1,this._sources.length<=this._sourceIndex)return{done:!0};this._currentIterator=this._sources[this._sourceIndex][Symbol.iterator]()}const t=this._currentIterator.next();if(t.done){this._currentIterator=null;continue}else{const s=t.value[0];this._encounteredKeys.has(s)||(this._encounteredKeys.add(s),e=t)}}return e}}class Bu{constructor(e,t){this._source=e,this._joinedMap=t,this._subscription=null}subscribe(){return this._subscription=this._source.subscribe(this),this}dispose(){this._subscription=this._subscription()}onAdd(e,t){this._joinedMap.onAdd(this._source,e,t)}onRemove(e,t){this._joinedMap.onRemove(this._source,e,t)}onUpdate(e,t,s){this._joinedMap.onUpdate(this._source,e,t,s)}onReset(){this._joinedMap.onReset(this._source)}}function Ko(n,e,t,s){const i=e.findIndex(n);if(i!==-1){const r=e[i],o=s(r);return o!==!1&&t.emitUpdate(i,r,o),!0}return!1}class zi extends Mt{constructor(e){super(),this._items=[],this._comparator=e}setManyUnsorted(e){this.setManySorted(e)}setManySorted(e){for(let t of e)this.set(t)}findAndUpdate(e,t){return Ko(e,this._items,this,t)}getAndUpdate(e,t,s=null){const i=this.indexOf(e);if(i!==-1){const r=this._items[i],o=t(r,e);this._items[i]=o,this.emitUpdate(i,o,s)}}update(e,t=null){const s=this.indexOf(e);s!==-1&&(this._items[s]=e,this.emitUpdate(s,e,t))}indexOf(e){const t=Ge(this._items,e,this._comparator);return t<this._items.length&&this._comparator(this._items[t],e)===0?t:-1}_getNext(e){let t=Ge(this._items,e,this._comparator);for(;t<this._items.length&&this._comparator(this._items[t],e)<=0;)t+=1;return this.get(t)}set(e,t=null){const s=Ge(this._items,e,this._comparator);s>=this._items.length||this._comparator(this._items[s],e)!==0?(this._items.splice(s,0,e),this.emitAdd(s,e)):(this._items[s]=e,this.emitUpdate(s,e,t))}get(e){return this._items[e]}remove(e){const t=this._items[e];this._items.splice(e,1),this.emitRemove(e,t)}get array(){return this._items}get length(){return this._items.length}[Symbol.iterator](){return new Ku(this)}}class Ku{constructor(e){this._sortedArray=e,this._current=null}next(){if(this._sortedArray){if(this._current?this._current=this._sortedArray._getNext(this._current):this._current=this._sortedArray.get(0),this._current)return{value:this._current};this._sortedArray=null}if(!this._sortedArray)return{done:!0}}}class $u extends Mt{constructor(e,t,s,i){super(),this._sourceUnsubscribe=null,this._mappedValues=null,this._sourceList=e,this._mapper=t,this._updater=s,this._removeCallback=i}findAndUpdate(e,t){return Ko(e,this._mappedValues,this,t)}get length(){return this._mappedValues.length}[Symbol.iterator](){return this._mappedValues.values()}}function ju(n,e,t){n._mappedValues.splice(e,0,t),n.emitAdd(e,t)}function qu(n,e,t,s){const i=n._mappedValues[e];n._updater&&n._updater(i,s,t),n.emitUpdate(e,i,s)}function Hu(n,e){const t=n._mappedValues[e];n._mappedValues.splice(e,1),n._removeCallback&&n._removeCallback(t),n.emitRemove(e,t)}function Wu(n,e,t){const s=n._mappedValues[e];n._mappedValues.splice(e,1),n._mappedValues.splice(t,0,s),n.emitMove(e,t,s)}function zu(n){n._mappedValues=[],n.emitReset()}class Gu extends $u{constructor(){super(...arguments),this._eventQueue=null,this._flushing=!1}onSubscribeFirst(){this._sourceUnsubscribe=this._sourceList.subscribe(this),this._eventQueue=[],this._mappedValues=[];let e=0;for(const t of this._sourceList)this._eventQueue.push(new pn(e,t)),e+=1;this._flush()}async _flush(){if(!this._flushing){this._flushing=!0;try{for(;this._eventQueue.length;)await this._eventQueue.shift().run(this)}finally{this._flushing=!1}}}onReset(){this._eventQueue&&(this._eventQueue.push(new Xu),this._flush())}onAdd(e,t){this._eventQueue&&(this._eventQueue.push(new pn(e,t)),this._flush())}onUpdate(e,t,s){this._eventQueue&&(this._eventQueue.push(new Yu(e,t,s)),this._flush())}onRemove(e){this._eventQueue&&(this._eventQueue.push(new Ju(e)),this._flush())}onMove(e,t){this._eventQueue&&(this._eventQueue.push(new Qu(e,t)),this._flush())}onUnsubscribeLast(){this._sourceUnsubscribe(),this._eventQueue=null,this._mappedValues=null}}class pn{constructor(e,t){this.index=e,this.value=t}async run(e){const t=await e._mapper(this.value);ju(e,this.index,t)}}class Yu{constructor(e,t,s){this.index=e,this.value=t,this.params=s}async run(e){qu(e,this.index,this.value,this.params)}}class Ju{constructor(e){this.index=e}async run(e){Hu(e,this.index)}}class Qu{constructor(e,t){this.fromIdx=e,this.toIdx=t}async run(e){Wu(e,this.fromIdx,this.toIdx)}}class Xu{async run(e){zu(e)}}class Zu extends Mt{constructor(...e){super(),this._sourceUnsubscribes=null,this._sourceLists=e}_offsetForSource(e){const t=this._sourceLists.indexOf(e);let s=0;for(let i=0;i<t;++i)s+=this._sourceLists[i].length;return s}onSubscribeFirst(){this._sourceUnsubscribes=this._sourceLists.map(e=>e.subscribe(this))}onUnsubscribeLast(){for(const e of this._sourceUnsubscribes)e()}onReset(){this.emitReset();let e=0;for(const t of this)this.emitAdd(e,t),e+=1}onAdd(e,t,s){this.emitAdd(this._offsetForSource(s)+e,t)}onUpdate(e,t,s,i){!this._sourceUnsubscribes||this.emitUpdate(this._offsetForSource(i)+e,t,s)}onRemove(e,t,s){this.emitRemove(this._offsetForSource(s)+e,t)}onMove(e,t,s,i){const r=this._offsetForSource(i);this.emitMove(r+e,r+t,s)}get length(){let e=0;for(let t=0;t<this._sourceLists.length;++t)e+=this._sourceLists[t].length;return e}[Symbol.iterator](){let e=0,t=this._sourceLists[0][Symbol.iterator]();return{next:()=>{let s=t.next();for(;s.done;){if(e+=1,e>=this._sourceLists.length)return s;t=this._sourceLists[e][Symbol.iterator](),s=t.next()}return s}}}}Object.assign(xt.prototype,{sortValues(n){return new Ou(this,n)},mapValues(n,e){return new Vu(this,n,e)},filterValues(n){return new Lu(this,n)},join(...n){return new Uu([this].concat(n))}});class _n{constructor(e,t){this.decryptRequest=null,this._promise=e(this,t)}complete(){return this._promise}dispose(){this.decryptRequest&&(this.decryptRequest.dispose(),this.decryptRequest=null)}}async function em(n,e,t,s,i,r){let o=[];const a=r.timelineEvents,l=r.timelineFragments;for(;o.length<s&&e;){let c;t.isForward?c=await a.eventsAfter(n,e,s):c=await a.eventsBefore(n,e,s);let h=c.map(d=>new he(d,i));if(o=Il(o,h,t),o.length<s){const d=await l.get(n,e.fragmentId);let m=new me(d,t.isBackward,i);if(qt(o,m,t),!m.token&&m.hasLinkedFragment){const p=await l.get(n,m.linkedFragmentId);i.add(p);const _=new me(p,t.isForward,i);qt(o,_,t),e=_.asEventKey()}else e=null}}return o}class $o{constructor({roomId:e,storage:t,fragmentIdComparer:s}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._decryptEntries=null}enableEncryption(e){this._decryptEntries=e}get readTxnStores(){const e=[this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments];return this._decryptEntries&&e.push(this._storage.storeNames.inboundGroupSessions),e}readFrom(e,t,s,i){return new _n(async(r,o)=>{const a=await this._storage.readTxn(this.readTxnStores);return await this._readFrom(e,t,s,r,a,o)},i)}readFromEnd(e,t=null,s){return new _n(async(i,r)=>{const o=t||await this._storage.readTxn(this.readTxnStores),a=await o.timelineFragments.liveFragment(this._roomId);let l;if(!a)l=[];else{this._fragmentIdComparer.add(a);const c=me.end(a,this._fragmentIdComparer),h=c.asEventKey();l=await this._readFrom(h,Oe.Backward,e,i,o,r),l.unshift(c)}return l},s)}async readById(e,t){let s=[this._storage.storeNames.timelineEvents];this._decryptEntries&&s.push(this._storage.storeNames.inboundGroupSessions);const i=await this._storage.readTxn(s),r=await i.timelineEvents.getByEventId(this._roomId,e);if(r){const o=new he(r,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o],i,t).complete(),o}}async _readFrom(e,t,s,i,r,o){const a=await em(this._roomId,e,t,s,this._fragmentIdComparer,r);if(this._decryptEntries){i.decryptRequest=this._decryptEntries(a,r,o);try{await i.decryptRequest.complete()}finally{i.decryptRequest=null}}return a}}class tm extends he{get fragmentId(){throw new Error("Cannot access fragmentId for non-persisted EventEntry")}get entryIndex(){throw new Error("Cannot access entryIndex for non-persisted EventEntry")}get isNonPersisted(){return!0}get isRedacting(){return!1}get isRedacted(){return super.isRedacting}}class sm{constructor(e){this._userId=e}get id(){return this._userId}}class Fs{constructor({roomId:e,storage:t,closeCallback:s,fragmentIdComparer:i,pendingEvents:r,clock:o,powerLevelsObservable:a,hsApi:l}){this._roomId=e,this._storage=t,this._closeCallback=s,this._fragmentIdComparer=i,this._disposables=new qi,this._pendingEvents=r,this._clock=o,this._remoteEntries=new zi((c,h)=>c.compare(h)),this._ownMember=null,this._timelineReader=new $o({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}),this._readerRequest=null,this._allEntries=null,this._contextEntriesNotInTimeline=new Map,this._decryptEntries=null,this._hsApi=l,this.initializePowerLevels(a)}initializePowerLevels(e){e&&(this._powerLevels=e.get(),this._disposables.track(e.subscribe(t=>this._powerLevels=t)))}async load(e,t,s){const i=await this._storage.readTxn(this._timelineReader.readTxnStores.concat(this._storage.storeNames.roomMembers,this._storage.storeNames.roomState)),r=await i.roomMembers.get(this._roomId,e.id);r?this._ownMember=new P(r):this._ownMember=P.fromUserId(this._roomId,e.id,t);const o=this._disposables.track(this._timelineReader.readFromEnd(20,i,s));try{const a=await o.complete();this._loadContextEntriesWhereNeeded(a),this._setupEntries(a)}finally{this._disposables.disposeTracked(o)}}_setupEntries(e){this._remoteEntries.setManySorted(e),this._pendingEvents?this._localEntries=new Gu(this._pendingEvents,t=>this._mapPendingEventToEntry(t),(t,s)=>{t.notifyUpdate(s)},t=>this._applyAndEmitLocalRelationChange(t,s=>s.removeLocalRelation(t))):this._localEntries=new _h,this._allEntries=new Zu(this._remoteEntries,this._localEntries)}async _mapPendingEventToEntry(e){let t;e.eventType===be&&(t=await this._getOrLoadEntry(e.relatedTxnId,e.relatedEventId));const s=new _u({pendingEvent:e,member:this._ownMember,clock:this._clock,redactingEntry:t});return this._loadContextEntriesWhereNeeded([s]),this._applyAndEmitLocalRelationChange(s,i=>i.addLocalRelation(s)),s}_applyAndEmitLocalRelationChange(e,t){var s,i;const r=o=>{const a=t(o);return a||!1};if(this._findAndUpdateEntryById(e.pendingEvent.relatedTxnId,e.relatedEventId,r),e.redactingEntry){const o=(s=e.redactingEntry.pendingEvent)==null?void 0:s.relatedTxnId;this._findAndUpdateEntryById(o,e.redactingEntry.relatedEventId,r),(i=e.redactingEntry.contextForEntries)==null||i.forEach(a=>this._emitUpdateForEntry(a,"contextEntry"))}}_findAndUpdateEntryById(e,t,s){let i=!1;e&&(i=this._localEntries.findAndUpdate(r=>r.id===e,s)),!i&&t&&this._remoteEntries.findAndUpdate(r=>r.id===t,s)}async getOwnAnnotationEntry(e,t){const s=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations]),i=await s.timelineRelations.getForTargetAndType(this._roomId,e,ze);for(const r of i){const o=await s.timelineEvents.getByEventId(this._roomId,r.sourceEventId);if(o&&o.event.sender===this._ownMember.userId&&je(o.event).key===t){const a=new he(o,this._fragmentIdComparer);return this._addLocalRelationsToNewRemoteEntries([a]),a}}return null}updateOwnMember(e){this._ownMember=e}_addLocalRelationsToNewRemoteEntries(e){var t;if(!!((t=this._localEntries)!=null&&t.hasSubscriptions))for(const s of this._localEntries){if(s.relatedEventId){const i=e.find(r=>r.id===s.relatedEventId);i?.addLocalRelation(s)}if(s.redactingEntry){const i=s.redactingEntry.relatedEventId,r=e.find(o=>o.id===i);r?.addLocalRelation(s)}}}static _entryUpdater(e,t){var s;return(s=e.contextForEntries)==null||s.forEach(i=>i.setContextEntry(t)),t.updateFrom(e),t}replaceEntries(e){var t;this._addLocalRelationsToNewRemoteEntries(e);for(const s of e)try{this._remoteEntries.getAndUpdate(s,Fs._entryUpdater);const i=this._contextEntriesNotInTimeline.get(s.id);i&&(Fs._entryUpdater(i,s),this._contextEntriesNotInTimeline.set(s.id,s)),(t=s.contextForEntries)==null||t.forEach(r=>this._emitUpdateForEntry(r,"contextEntry"))}catch(i){if(i.name==="CompareError")continue;throw i}}addEntries(e){this._addLocalRelationsToNewRemoteEntries(e),this._updateEntriesFetchedFromHomeserver(e),this._moveEntryToRemoteEntries(e),this._loadContextEntriesWhereNeeded(e),this._remoteEntries.setManySorted(e)}_updateEntriesFetchedFromHomeserver(e){var t;for(const s of e){const i=this._contextEntriesNotInTimeline.get(s.relatedEventId);i?.isNonPersisted&&i?.addLocalRelation(s)&&((t=i.contextForEntries)==null||t.forEach(r=>this._emitUpdateForEntry(r,"contextEntry")))}}_moveEntryToRemoteEntries(e){for(const t of e){const s=this._contextEntriesNotInTimeline.get(t.id);s&&(s.contextForEntries.forEach(i=>{i.setContextEntry(t),this._emitUpdateForEntry(i,"contextEntry")}),this._contextEntriesNotInTimeline.delete(t.id))}}_emitUpdateForEntry(e,t){const s=e.isPending?e.id:null,i=e.isPending?null:e.id;this._findAndUpdateEntryById(s,i,()=>t)}async _loadContextEntriesWhereNeeded(e){for(const t of e){if(!t.contextEventId)continue;const s=t.contextEventId;let i=e.find(r=>r.id===s);i||(i=this._findLoadedEventById(s)),i?t.setContextEntry(i):this._loadContextEntryNotInTimeline(t)}}async _loadContextEntryNotInTimeline(e){const t=e.contextEventId;let s=await this._getEventFromStorage(t);s||(s=await this._getEventFromHomeserver(t)),s&&(this._contextEntriesNotInTimeline.set(t,s),e.setContextEntry(s),this._emitUpdateForEntry(e,"contextEntry"))}_findLoadedEventById(e){var t;return(t=this.getByEventId(e))!=null?t:this._contextEntriesNotInTimeline.get(e)}async _getEventFromStorage(e){return await this._timelineReader.readById(e)}async _getEventFromHomeserver(e){const t=await this._hsApi.context(this._roomId,e,0).response(),s=t.event.sender,i=t.state.find(a=>a.type===ce&&a.user_id===s),r={event:t.event,displayName:i.content.displayname,avatarUrl:i.content.avatar_url},o=new tm(r,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o]).complete(),o}async loadAtTop(e){if(this._disposables.isDisposed)return!0;const t=this._remoteEntries.array.find(i=>!!i.eventType);if(!t)return!0;const s=this._disposables.track(this._timelineReader.readFrom(t.asEventKey(),Oe.Backward,e));try{const i=await s.complete();return this.addEntries(i),i.length<e}finally{this._disposables.disposeTracked(s)}}async _getOrLoadEntry(e,t){var s;if(e){for(const i of this._localEntries)if(i.id===e)return i}return t?(s=this.getByEventId(t))!=null?s:await this._getEventFromStorage(t):null}getByEventId(e){for(let t=0;t<this._remoteEntries.length;t+=1){const s=this._remoteEntries.get(t);if(s.id===e)return s}return null}get entries(){return this._allEntries}get remoteEntries(){return this._remoteEntries.array}dispose(){this._closeCallback&&(this._disposables.dispose(),this._closeCallback(),this._closeCallback=null)}enableEncryption(e){this._decryptEntries=e,this._timelineReader.enableEncryption(e)}get powerLevels(){return this._powerLevels}get me(){return this._ownMember}}async function im({roomId:n,storage:e,txn:t}){return t||(t=await e.readTxn([e.storeNames.roomMembers])),(await t.roomMembers.getAll(n)).map(i=>new P(i))}async function rm({summary:n,syncToken:e,roomId:t,hsApi:s,storage:i,setChangedMembersMap:r},o){const a=new Map;r(a);const l=await s.members(t,{at:e},{log:o}).response(),c=await i.readWriteTxn([i.storeNames.roomSummary,i.storeNames.roomMembers]);let h,d;try{h=n.writeHasFetchedMembers(!0,c);const{roomMembers:m}=c,p=l.chunk;if(!Array.isArray(p))throw new Error("malformed");o.set("members",p.length),d=await Promise.all(p.map(async _=>{const g=_?.state_key;if(!g)throw new Error("malformed");const b=a.get(g);if(b)return b;{const S=P.fromMemberEvent(t,_);return S&&m.set(S.serialize()),S}}))}catch(m){throw c.abort(),m}finally{r(null)}return await c.complete(),n.applyChanges(h),d}async function nm(n,e){const{summary:t}=n;return t.data.hasFetchedMembers?im(n):e.wrapOrRun(n.log,"fetchMembers",s=>rm(n,s))}async function om(n,e){const t=await am(n),{summary:s}=n;return!s.data.hasFetchedMembers&&!t?e.wrapOrRun(n.log,"fetchMember",i=>lm(n,i)):t}async function am({roomId:n,userId:e,storage:t}){const i=await(await t.readTxn([t.storeNames.roomMembers])).roomMembers.get(n,e);return i?new P(i):null}async function lm({roomId:n,userId:e,hsApi:t,storage:s},i){let r;try{r=await t.state(n,"m.room.member",e,{log:i}).response()}catch(l){if(l.name==="HomeServerError"&&l.errcode==="M_NOT_FOUND")return null;throw l}const o=new P({roomId:n,userId:e,membership:r.membership,avatarUrl:r.avatar_url,displayName:r.displayname}),a=await s.readWriteTxn([s.storeNames.roomMembers]);try{a.roomMembers.set(o.serialize())}catch(l){throw a.abort(),l}return await a.complete(),o}class cm{constructor(e){this._retentionCount=1,this._freeCallback=e}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._freeCallback()}}class hm extends cm{constructor({members:e,closeCallback:t}){super(t),this._members=new Gt;for(const s of e)this._members.add(s.userId,s)}afterSync(e){for(const[t,s]of e.entries())this._members.set(t,s.member)}get members(){return this._members}}function Ci(n,e,t){const s=e.joinCount+e.inviteCount-1;if(n.length>=s)if(n.length>1){const i=n[n.length-1];return n.slice(0,n.length-1).map(o=>o.name).join(", ")+" and "+i.name}else{const i=n[0];return i?i.name:(t.log({l:"could get get other member name",length:n.length,otherMember:!!i,otherMemberMembership:i?.membership}),"Unknown DM Name")}else return n.length<s?n.map(i=>i.name).join(", ")+` and ${s} others`:null}class Gi{constructor(e){this._roomId=e,this._members=new Map}async calculateChanges(e,t,s){const i=new Map,r=[];for(const o of this._members.keys())e.indexOf(o)===-1&&r.push(o);for(const[o,a]of t.entries())(this._members.has(o)||e.indexOf(o)!==-1)&&i.set(o,a.member);for(const o of e)if(!this._members.has(o)&&!i.has(o)){const a=await s.roomMembers.get(this._roomId,o);if(a){const l=new P(a);i.set(l.userId,l)}}return{updatedHeroMembers:i.values(),removedUserIds:r}}applyChanges({updatedHeroMembers:e,removedUserIds:t},s,i){for(const o of t)this._members.delete(o);for(const o of e)this._members.set(o.userId,o);const r=Array.from(this._members.values()).sort((o,a)=>o.name.localeCompare(a.name));this._roomName=Ci(r,s,i)}get roomName(){return this._roomName}get roomAvatarUrl(){if(this._members.size===1)for(const e of this._members.values())return e.avatarUrl;return null}get roomAvatarColorId(){if(this._members.size===1)for(const e of this._members.keys())return e;return null}}class dm{constructor(e){this._map=new Map,this._notifyEmpty=e}observe(e,t=null){let s=this._map.get(e);return s||(s=new um(this,t,e),this._map.set(e,s)),s}updateEvents(e){for(let t=0;t<e.length;t+=1){const s=e[t],i=this._map.get(s.id);i?.update(s)}}_remove(e){this._map.delete(e),this._map.size===0&&this._notifyEmpty()}}class um extends Tt{constructor(e,t,s){super(),this._eventMap=e,this._entry=t,this._id=s,Promise.resolve().then(()=>{this.hasSubscriptions||(this._eventMap._remove(this._id),this._eventMap=null)})}subscribe(e){if(!this._eventMap)throw new Error("ObservedEvent expired, subscribe right after calling room.observeEvent()");return super.subscribe(e)}onUnsubscribeLast(){this._eventMap._remove(this._id),this._eventMap=null,super.onUnsubscribeLast()}update(e){this._entry=e,this.emit(this._entry)}get(){return this._entry}}function mm(n){return n||yl.item}const pm="m.room.power_levels";class xs{constructor({powerLevelEvent:e,createEvent:t,ownUserId:s,membership:i}){this._plEvent=e,this._createEvent=t,this._ownUserId=s,this._membership=i}canRedactFromSender(e){return e===this._ownUserId&&this._membership==="join"?!0:this.canRedact}canSendType(e){return this._myLevel>=this._getEventTypeLevel(e)}get canRedact(){return this._myLevel>=this._getActionLevel("redact")}get _myLevel(){return this._membership!=="join"?Number.MIN_SAFE_INTEGER:this.getUserLevel(this._ownUserId)}getUserLevel(e){var t,s,i,r;if(this._plEvent){let o=(s=(t=this._plEvent.content)==null?void 0:t.users)==null?void 0:s[e];if(typeof o!="number"&&(o=(i=this._plEvent.content)==null?void 0:i.users_default),typeof o=="number")return o}else if(this._createEvent&&e===((r=this._createEvent.content)==null?void 0:r.creator))return 100;return 0}_getActionLevel(e){var t;const s=(t=this._plEvent)==null?void 0:t.content[e];return typeof s=="number"?s:50}_getEventTypeLevel(e){var t,s,i;const r=(s=(t=this._plEvent)==null?void 0:t.content.events)==null?void 0:s[e];if(typeof r=="number")return r;{const o=(i=this._plEvent)==null?void 0:i.content.events_default;return typeof o=="number"?o:0}}}const _m="m.room.encrypted";class jo extends Ws{constructor({roomId:e,storage:t,hsApi:s,mediaRepository:i,emitCollectionChange:r,user:o,createRoomEncryption:a,getSyncToken:l,platform:c}){super(),this._roomId=e,this._storage=t,this._hsApi=s,this._mediaRepository=i,this._summary=new ou(e),this._fragmentIdComparer=new Eu([]),this._emitCollectionChange=r,this._timeline=null,this._user=o,this._changedMembersDuringSync=null,this._memberList=null,this._createRoomEncryption=a,this._roomEncryption=null,this._getSyncToken=l,this._platform=c,this._observedEvents=null,this._powerLevels=null,this._powerLevelLoading=null,this._observedMembers=null}async _eventIdsToEntries(e,t){const s=[];return await Promise.all(e.map(async i=>{const r=await t.timelineEvents.getByEventId(this._roomId,i);r&&s.push(new he(r,this._fragmentIdComparer))})),s}_getAdditionalTimelineRetryEntries(e,t){let s=this._roomEncryption.filterUndecryptedEventEntriesForKeys(this._timeline.remoteEntries,t);const i=e.reduce((r,o)=>(r.add(o.id),r),new Set);return s=s.filter(r=>!i.has(r.id)),s}async notifyRoomKey(e,t,s){var i;if(!this._roomEncryption)return;const r=await this._storage.readTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.inboundGroupSessions]);let o=await this._eventIdsToEntries(t,r);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(o,[e]);o=o.concat(a)}if(o.length){await this._decryptEntries(nt.Retry,o,r,s).complete(),(i=this._timeline)==null||i.replaceEntries(o);const l=this._summary.data.applyTimelineEntries(o,!1,!1);await this._summary.writeAndApplyData(l,this._storage)&&this._emitUpdate()}}_setEncryption(e){return e&&!this._roomEncryption?(this._roomEncryption=e,this._timeline&&this._timeline.enableEncryption(this._decryptEntries.bind(this,nt.Timeline)),!0):!1}_decryptEntries(e,t,s,i=null){return new gm(async(o,a)=>{if(s||(s=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions])),o.cancelled)return;const l=t.filter(_=>_.eventType===_m).map(_=>_.event);if(o.preparation=await this._roomEncryption.prepareDecryptAll(l,null,e,s),o.cancelled)return;const c=await o.preparation.decrypt();if(o.preparation=null,o.cancelled)return;const h=[this._storage.storeNames.groupSessionDecryptions],d=this._isTimelineOpen;d&&h.push(this._storage.storeNames.deviceIdentities);const m=await this._storage.readWriteTxn(h);let p;try{p=await c.write(m,a),d&&await p.verifySenders(m)}catch(_){throw m.abort(),_}await m.complete(),p.applyToEntries(t),this._observedEvents&&this._observedEvents.updateEvents(t)},mm(i))}async _getSyncRetryDecryptEntries(e,t,s){let r=(await Promise.all(e.map(async o=>{const a=await t.getEventIdsForMissingKey(o,s);if(a)return this._eventIdsToEntries(a,s)}))).reduce((o,a)=>a?o.concat(a):o,[]);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(r,e).map(l=>l.clone());r=r.concat(a)}return r}async load(e,t,s){s.set("id",this.id);try{if(e&&this._summary.load(e),this._summary.data.encryption){const i=this._createRoomEncryption(this,this._summary.data.encryption);this._setEncryption(i)}if(this._summary.data.needsHeroes){this._heroes=new Gi(this._roomId);const i=await this._heroes.calculateChanges(this._summary.data.heroes,[],t);this._heroes.applyChanges(i,this._summary.data,s)}}catch(i){throw new zn(`Could not load room ${this._roomId}`,i)}}async observeMember(e){this._observedMembers||(this._observedMembers=new Map);const t=this._observedMembers.get(e);if(t)return t;const s=await om({summary:this._summary,roomId:this._roomId,userId:e,storage:this._storage,hsApi:this._hsApi},this._platform.logger);if(!s)return null;const i=new bi(s,()=>this._observedMembers.delete(e));return this._observedMembers.set(e,i),i}async loadMemberList(e=void 0,t=null){if(this._memberList)return this._memberList.retain(),this._memberList;{const s=await nm({summary:this._summary,roomId:this._roomId,hsApi:this._hsApi,storage:this._storage,txn:e,syncToken:this._getSyncToken(),setChangedMembersMap:i=>this._changedMembersDuringSync=i,log:t},this._platform.logger);return this._memberList=new hm({members:s,closeCallback:()=>{this._memberList=null}}),this._memberList}}fillGap(e,t,s=null){return this._platform.logger.wrapOrRun(s,"fillGap",async i=>{if(i.set("id",this.id),i.set("fragment",e.fragmentId),i.set("dir",e.direction.asApiString()),e.edgeReached){i.set("edgeReached",!0);return}const r=await this._hsApi.messages(this._roomId,{from:e.token,dir:e.direction.asApiString(),limit:t,filter:{lazy_load_members:!0,include_redundant_members:!0}},{log:i}).response(),o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations,this._storage.storeNames.timelineFragments]);let a,l;try{a=await this._writeGapFill(r.chunk,o,i);const c=new Fo({roomId:this._roomId,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});l=await new Du({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,relationWriter:c}).writeFragmentFill(e,r,o,i)}catch(c){throw o.abort(),c}await o.complete(),this._roomEncryption&&await this._decryptEntries(nt.Timeline,l.entries,null,i).complete();for(const c of l.fragments)this._fragmentIdComparer.add(c);a&&this._applyGapFill(a),this._timeline&&(this._timeline.replaceEntries(l.updatedEntries),this._timeline.addEntries(l.entries))})}async _writeGapFill(e,t,s){}_applyGapFill(){}get name(){if(this._heroes)return this._heroes.roomName;const e=this._summary.data;return e.name?e.name:e.canonicalAlias?e.canonicalAlias:null}get id(){return this._roomId}get avatarUrl(){return this._summary.data.avatarUrl?this._summary.data.avatarUrl:this._heroes?this._heroes.roomAvatarUrl:null}get avatarColorId(){return this._roomId}get lastMessageTimestamp(){return this._summary.data.lastMessageTimestamp}get isLowPriority(){const e=this._summary.data.tags;return!!(e&&e["m.lowpriority"])}get isEncrypted(){return!!this._summary.data.encryption}get isJoined(){return this.membership==="join"}get isLeft(){return this.membership==="leave"}get canonicalAlias(){return this._summary.data.canonicalAlias}get joinedMemberCount(){return this._summary.data.joinCount}get mediaRepository(){return this._mediaRepository}get membership(){return this._summary.data.membership}isDirectMessageForUserId(e){if(this._summary.data.dmUserId===e)return!0;{const{heroes:t,joinCount:s,inviteCount:i}=this._summary.data;if(t&&t.includes(e)&&s+i===2)return!0}return!1}async _loadPowerLevels(){const e=await this._storage.readTxn([this._storage.storeNames.roomState]),t=await e.roomState.get(this._roomId,"m.room.power_levels","");if(t)return new xs({powerLevelEvent:t.event,ownUserId:this._user.id,membership:this.membership});const s=await e.roomState.get(this._roomId,"m.room.create","");if(s)return new xs({createEvent:s.event,ownUserId:this._user.id,membership:this.membership});{const i=this.membership;return new xs({ownUserId:this._user.id,membership:i})}}async observePowerLevels(){this._powerLevelLoading&&await this._powerLevelLoading;let e=this._powerLevels;if(!e){this._powerLevelLoading=this._loadPowerLevels();const t=await this._powerLevelLoading;e=new bi(t,()=>{this._powerLevels=null}),this._powerLevels=e,this._powerLevelLoading=null}return e}enableKeyBackup(e){var t;(t=this._roomEncryption)==null||t.enableKeyBackup(e),this._timeline&&e&&this._platform.logger.run("enableKeyBackup",s=>this._roomEncryption.restoreMissingSessionsFromBackup(this._timeline.remoteEntries,s))}get _isTimelineOpen(){return!!this._timeline}_emitUpdate(){this.emit("change"),this._emitCollectionChange(this)}openTimeline(e=null){return this._platform.logger.wrapOrRun(e,"open timeline",async t=>{if(t.set("id",this.id),this._timeline)throw new Error("not dealing with load race here for now");this._timeline=new Fs({roomId:this.id,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,pendingEvents:this._getPendingEvents(),closeCallback:()=>{this._timeline=null,this._roomEncryption&&this._roomEncryption.notifyTimelineClosed()},clock:this._platform.clock,logger:this._platform.logger,powerLevelsObservable:await this.observePowerLevels(),hsApi:this._hsApi});try{this._roomEncryption&&this._timeline.enableEncryption(this._decryptEntries.bind(this,nt.Timeline)),await this._timeline.load(this._user,this.membership,t)}catch(s){throw this._timeline.dispose(),s}return this._timeline})}_getPendingEvents(){return null}observeEvent(e){this._observedEvents||(this._observedEvents=new dm(()=>{this._observedEvents=null}));let t=null;this._timeline&&(t=this._timeline.getByEventId(e));const s=this._observedEvents.observe(e,t);return t||this._readEventById(e).then(i=>{s.update(i)}).catch(i=>{console.warn(`could not load event ${e} from storage`,i)}),s}async _readEventById(e){return await new $o({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}).readById(e)}dispose(){var e,t;(e=this._roomEncryption)==null||e.dispose(),(t=this._timeline)==null||t.dispose()}}class gm{constructor(e,t){this._cancelled=!1,this.preparation=null,this._promise=t.wrap("decryptEntries",s=>e(this,s))}complete(){return this._promise}get cancelled(){return this._cancelled}dispose(){this._cancelled=!0,this.preparation&&this.preparation.dispose()}}function Bs(){const e=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);return"t"+"0".repeat(14-e.length)+e}function gn(n){return n.startsWith("t")&&n.length===15}class fm{constructor({roomId:e,storage:t,hsApi:s,pendingEvents:i}){i=i||[],this._roomId=e,this._storage=t,this._hsApi=s,this._pendingEvents=new zi((r,o)=>r.queueIndex-o.queueIndex),this._pendingEvents.setManyUnsorted(i.map(r=>this._createPendingEvent(r))),this._isSending=!1,this._offline=!1,this._roomEncryption=null,this._currentQueueIndex=0}_createPendingEvent(e,t=null){const s=new gu({data:e,remove:()=>this._removeEvent(s),emitUpdate:i=>this._pendingEvents.update(s,i),attachments:t});return s}enableEncryption(e){this._roomEncryption=e}_sendLoop(e){this._isSending=!0,this._sendLoopLogItem=e.runDetached("send queue flush",async t=>{try{for(const s of this._pendingEvents)await t.wrap("send event",async i=>{i.set("queueIndex",s.queueIndex);try{this._currentQueueIndex=s.queueIndex,await this._sendEvent(s,i)}catch(r){r instanceof We?(this._offline=!0,i.set("offline",!0),s.setWaiting()):(i.catch(r),r.name==="HomeServerError"&&(r.statusCode===400||r.statusCode===403||r.statusCode===404)?(i.set("remove",!0),await s.abort()):s.setError(r))}finally{this._currentQueueIndex=0}})}finally{this._isSending=!1,this._sendLoopLogItem=null}})}async _sendEvent(e,t){if(e.needsUpload&&(await t.wrap("upload attachments",s=>e.uploadAttachments(this._hsApi,s)),await this._tryUpdateEvent(e)),e.needsEncryption){e.setEncrypting();const s=e.contentForEncryption,{type:i,content:r}=await t.wrap("encrypt",o=>this._roomEncryption.encrypt(e.eventType,s,this._hsApi,o));e.setEncrypted(i,r),await this._tryUpdateEvent(e)}if(e.needsSending){await e.send(this._hsApi,t);const s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{await this._tryUpdateEventWithTxn(e,s),await this._resolveRemoteIdInPendingRelations(e.txnId,e.remoteId,s)}catch(i){throw s.abort(),i}await s.complete()}}async _resolveRemoteIdInPendingRelations(e,t,s){const i=this._pendingEvents.array.filter(r=>r.relatedTxnId===e&&r.relatedEventId!==t);for(const r of i)r.setRelatedEventId(t),await this._tryUpdateEventWithTxn(r,s);return i}async removeRemoteEchos(e,t,s){const i=[];for(const r of e){const o=r.unsigned&&r.unsigned.transaction_id;let a;if(o?a=this._pendingEvents.array.findIndex(l=>l.txnId===o):a=this._pendingEvents.array.findIndex(l=>l.remoteId===r.event_id),a!==-1){const l=this._pendingEvents.get(a),c=r.event_id;s.log({l:"removeRemoteEcho",queueIndex:l.queueIndex,remoteId:c,txnId:o}),t.pendingEvents.remove(l.roomId,l.queueIndex),i.push(l),await this._resolveRemoteIdInPendingRelations(o,c,t)}}return i}async _removeEvent(e){if(this._pendingEvents.array.indexOf(e)!==-1){const s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{s.pendingEvents.remove(e.roomId,e.queueIndex)}catch{s.abort()}await s.complete();const i=this._pendingEvents.array.indexOf(e);i!==-1&&this._pendingEvents.remove(i)}e.dispose()}emitRemovals(e){for(const t of e){const s=this._pendingEvents.array.indexOf(t);s!==-1&&this._pendingEvents.remove(s),t.dispose()}}resumeSending(e){this._offline=!1,this._pendingEvents.length&&e.wrap("resumeSending",t=>{t.set("id",this._roomId),t.set("pendingEvents",this._pendingEvents.length),this._isSending||this._sendLoop(t),this._sendLoopLogItem&&t.refDetached(this._sendLoopLogItem)})}async enqueueEvent(e,t,s,i){const r=Je(t);let o=null;if(r){const a=Hi(r);if(gn(a)&&(o=a,Vo(r,null)),r.rel_type===ze&&this._pendingEvents.array.some(c=>{const h=Je(c.content);return c.eventType===e&&h&&h.key===r.key&&(c.relatedTxnId===o||h.event_id===r.event_id)})){i.set("already_annotating",!0);return}}await this._enqueueEvent(e,t,s,o,null,i)}async _enqueueEvent(e,t,s,i,r,o){const a=await this._createAndStoreEvent(e,t,i,r,s);this._pendingEvents.set(a),o.set("queueIndex",a.queueIndex),o.set("pendingEvents",this._pendingEvents.length),!this._isSending&&!this._offline&&this._sendLoop(o),this._sendLoopLogItem&&o.refDetached(this._sendLoopLogItem)}async enqueueRedaction(e,t,s){if(this._pendingEvents.array.some(a=>a.eventType===be&&(a.relatedTxnId===e||a.relatedEventId===e))){s.set("already_redacting",!0);return}let r,o;if(gn(e)){r=e;const a=e,l=this._pendingEvents.array.find(c=>c.txnId===a);if(l&&!l.remoteId&&l.status!==D.Sending){s.set("remove",r),await l.abort();return}else if(l)o=l.remoteId;else return}else{o=e;const a=this._pendingEvents.array.find(l=>l.remoteId===o);a&&(r=a.txnId)}s.set("relatedTxnId",r),s.set("relatedEventId",o),await this._enqueueEvent(be,{reason:t},null,r,o,s)}get pendingEvents(){return this._pendingEvents}async _tryUpdateEvent(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{this._tryUpdateEventWithTxn(e,t)}catch(s){throw t.abort(),s}await t.complete()}async _tryUpdateEventWithTxn(e,t){await t.pendingEvents.exists(e.roomId,e.queueIndex)&&t.pendingEvents.update(e.data)}async _createAndStoreEvent(e,t,s,i,r){const o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);let a;try{const l=o.pendingEvents,c=await l.getMaxQueueIndex(this._roomId)||0,d=Math.max(c,this._currentQueueIndex)+1,m=e!==be&&e!==au&&!!this._roomEncryption;a=this._createPendingEvent({roomId:this._roomId,queueIndex:d,eventType:e,content:t,relatedTxnId:s,relatedEventId:i,txnId:Bs(),needsEncryption:m,needsUpload:!!r},r),l.add(a.data)}catch(l){throw o.abort(),l}return await o.complete(),a}dispose(){for(const e of this._pendingEvents)e.dispose()}}class qo{constructor({filename:e,blob:t,platform:s}){this._filename=e,this._unencryptedBlob=t,this._transferredBlob=this._unencryptedBlob,this._platform=s,this._mxcUrl=null,this._encryptionInfo=null,this._uploadRequest=null,this._aborted=!1,this._error=null,this._sentBytes=0}get size(){return this._transferredBlob.size}get sentBytes(){return this._sentBytes}abort(){var e;(e=this._uploadRequest)==null||e.abort()}get localPreview(){return this._unencryptedBlob}async encrypt(){if(this._encryptionInfo)throw new Error("already encrypted");const{info:e,blob:t}=await Hd(this._platform,this._transferredBlob);this._transferredBlob=t,this._encryptionInfo=e}async upload(e,t,s){this._uploadRequest=e.uploadAttachment(this._transferredBlob,this._filename,{uploadProgress:r=>{this._sentBytes=r,t()},log:s});const{content_uri:i}=await this._uploadRequest.response();this._mxcUrl=i}applyToContent(e,t){if(!this._mxcUrl)throw new Error("upload has not finished");let s=e.substr(0,e.lastIndexOf("url"));Rs(`${s}info.size`,t,this._transferredBlob.size),Rs(`${s}info.mimetype`,t,this._unencryptedBlob.mimeType),this._encryptionInfo?Rs(`${s}file`,t,Object.assign(this._encryptionInfo,{mimetype:this._unencryptedBlob.mimeType,url:this._mxcUrl})):Rs(`${s}url`,t,this._mxcUrl)}dispose(){this._unencryptedBlob.dispose(),this._transferredBlob.dispose()}}function Rs(n,e,t){const s=n.split(".");let i=e;for(let o=0;o<s.length-1;o+=1){const a=s[o];i[a]||(i[a]={}),i=i[a]}const r=s[s.length-1];i[r]=t}const ym="m.room.encrypted";class vm extends jo{constructor(e){super(e);const{pendingEvents:t}=e,s=new Fo({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});this._syncWriter=new Mu({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,relationWriter:s,memberWriter:new xu(this.id)}),this._sendQueue=new fm({roomId:this.id,storage:this._storage,hsApi:this._hsApi,pendingEvents:t})}_setEncryption(e){return super._setEncryption(e)?(this._sendQueue.enableEncryption(this._roomEncryption),!0):!1}async prepareSync(e,t,s,i,r){var o;r.set("id",this.id),s&&r.set("newKeys",s.length);let a=this._summary.data.applySyncResponse(e,t,this._user.id),l=this._roomEncryption;!l&&a.encryption&&(r.set("enableEncryption",!0),l=this._createRoomEncryption(this,a.encryption));let c,h;if(l){let d=((o=e?.timeline)==null?void 0:o.events)||[];s&&(c=await this._getSyncRetryDecryptEntries(s,l,i),c.length&&(r.set("retry",c.length),d=d.concat(c.map(m=>m.event)))),d=d.filter(m=>m?.type===ym),d.length&&(h=await l.prepareDecryptAll(d,s,nt.Sync,i))}return{roomEncryption:l,summaryChanges:a,decryptPreparation:h,decryptChanges:null,retryEntries:c}}async afterPrepareSync(e,t){e.decryptPreparation&&await t.wrap("decrypt",async s=>{s.set("id",this.id),e.decryptChanges=await e.decryptPreparation.decrypt(),e.decryptPreparation=null},t.level.Detail)}async writeSync(e,t,{summaryChanges:s,decryptChanges:i,roomEncryption:r,retryEntries:o},a,l){var c;l.set("id",this.id);const h=s.isNewJoin(this._summary.data);h&&(a.roomState.removeAllForRoom(this.id),a.roomMembers.removeAllForRoom(this.id));const{entries:d,updatedEntries:m,newLiveKey:p,memberChanges:_}=await l.wrap("syncWriter",v=>this._syncWriter.writeSync(e,h,s.hasFetchedMembers,a,v),l.level.Detail);if(i){const v=await l.wrap("decryptChanges",k=>i.write(a,k));l.set("decryptionResults",v.results.size),l.set("decryptionErrors",v.errors.size),this._isTimelineOpen&&await v.verifySenders(a),v.applyToEntries(d),o?.length&&(v.applyToEntries(o),m.push(...o))}l.set("newEntries",d.length),l.set("updatedEntries",m.length);let g;r&&(g=await r.writeSync(e,_,a,l),l.set("shouldFlushKeyShares",g.shouldFlush));const b=d.concat(m);s=s.applyTimelineEntries(b,t,!this._isTimelineOpen,this._user.id),s.membership!=="join"?a.roomSummary.remove(this.id):s=this._summary.writeData(s,a),s&&l.set("summaryChanges",s.changedKeys(this._summary.data));let S;s?.needsHeroes&&(this._heroes||(this._heroes=new Gi(this._roomId)),S=await this._heroes.calculateChanges(s.heroes,_,a));let I;Array.isArray((c=e.timeline)==null?void 0:c.events)&&(I=await this._sendQueue.removeRemoteEchos(e.timeline.events,a,l));const C=this._getPowerLevelsEvent(e);return{summaryChanges:s,roomEncryption:r,newEntries:d,updatedEntries:m,newLiveKey:p,removedPendingEvents:I,memberChanges:_,heroChanges:S,powerLevelsEvent:C,encryptionChanges:g}}afterSync(e,t){const{summaryChanges:s,newEntries:i,updatedEntries:r,newLiveKey:o,removedPendingEvents:a,memberChanges:l,powerLevelsEvent:c,heroChanges:h,roomEncryption:d,encryptionChanges:m}=e;if(t.set("id",this.id),this._syncWriter.afterSync(o),this._setEncryption(d),this._roomEncryption&&this._roomEncryption.afterSync(m),l.size){if(this._changedMembersDuringSync)for(const[_,g]of l.entries())this._changedMembersDuringSync.set(_,g.member);if(this._memberList&&this._memberList.afterSync(l),this._observedMembers&&this._updateObservedMembers(l),this._timeline){for(const[_,g]of l.entries())if(_===this._user.id){this._timeline.updateOwnMember(g.member);break}}}let p=!1;if(s&&(this._summary.applyChanges(s),this._summary.data.needsHeroes||(this._heroes=null),p=!0),this._heroes&&h){const _=this.name;this._heroes.applyChanges(h,this._summary.data,t),_!==this.name&&(p=!0)}c&&this._updatePowerLevels(c),p&&this._emitUpdate(),this._timeline&&(this._timeline.replaceEntries(r),this._timeline.addEntries(i)),this._observedEvents&&(this._observedEvents.updateEvents(r),this._observedEvents.updateEvents(i)),a&&this._sendQueue.emitRemovals(a)}_updateObservedMembers(e){for(const[t,s]of e){const i=this._observedMembers.get(t);i&&i.set(s.member)}}_getPowerLevelsEvent(e){var t,s,i;const r=a=>a.state_key===""&&a.type===pm;return(i=(t=e.timeline)==null?void 0:t.events.find(r))!=null?i:(s=e.state)==null?void 0:s.events.find(r)}_updatePowerLevels(e){if(this._powerLevels){const t=new xs({powerLevelEvent:e,ownUserId:this._user.id,membership:this.membership});this._powerLevels.set(t)}}needsAfterSyncCompleted({encryptionChanges:e}){return e?.shouldFlush}async afterSyncCompleted(e,t){t.set("id",this.id),this._roomEncryption&&await this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,null,t)}start(e,t){if(this._roomEncryption){const s=e?.get("share_room_key");s&&t.wrapDetached("flush room keys",i=>(i.set("id",this.id),this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,s,i)))}this._sendQueue.resumeSending(t)}async load(e,t,s){try{await super.load(e,t,s),await this._syncWriter.load(t,s)}catch(i){throw new zn(`Could not load room ${this._roomId}`,i)}}async _writeGapFill(e,t,s){return await this._sendQueue.removeRemoteEchos(e,t,s)}_applyGapFill(e){this._sendQueue.emitRemovals(e)}sendEvent(e,t,s,i=null){return this._platform.logger.wrapOrRun(i,"send",r=>(r.set("id",this.id),this._sendQueue.enqueueEvent(e,t,s,r)))}sendRedaction(e,t,s=null){return this._platform.logger.wrapOrRun(s,"redact",i=>(i.set("id",this.id),this._sendQueue.enqueueRedaction(e,t,i)))}async ensureMessageKeyIsShared(e=null){if(!!this._roomEncryption)return this._platform.logger.wrapOrRun(e,"ensureMessageKeyIsShared",t=>(t.set("id",this.id),this._roomEncryption.ensureMessageKeyIsShared(this._hsApi,t)))}get avatarColorId(){var e;return((e=this._heroes)==null?void 0:e.roomAvatarColorId)||this._roomId}get isUnread(){return this._summary.data.isUnread}get notificationCount(){return this._summary.data.notificationCount}get highlightCount(){return this._summary.data.highlightCount}get isTrackingMembers(){return this._summary.data.isTrackingMembers}async _getLastEventId(){var e;const t=this._syncWriter.lastMessageKey;if(t){const i=await(await this._storage.readTxn([this._storage.storeNames.timelineEvents])).timelineEvents.get(this._roomId,t);return(e=i?.event)==null?void 0:e.event_id}}async clearUnread(e=null){if(this.isUnread||this.notificationCount)return await this._platform.logger.wrapOrRun(e,"clearUnread",async t=>{t.set("id",this.id);const s=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary]);let i;try{i=this._summary.writeClearUnread(s)}catch(r){throw s.abort(),r}await s.complete(),this._summary.applyChanges(i),this._emitUpdate();try{const r=await this._getLastEventId();r&&await this._hsApi.receipt(this._roomId,"m.read",r)}catch(r){if(r.name!=="ConnectionError")throw r}})}leave(e=null){return this._platform.logger.wrapOrRun(e,"leave room",async t=>{t.set("id",this.id),await this._hsApi.leave(this.id,{log:t}).response()})}_getPendingEvents(){return this._sendQueue.pendingEvents}writeIsTrackingMembers(e,t){return this._summary.writeIsTrackingMembers(e,t)}applyIsTrackingMembersChanges(e){this._summary.applyChanges(e)}createAttachment(e,t){return new qo({blob:e,filename:t,platform:this._platform})}dispose(){super.dispose(),this._sendQueue.dispose()}}class wm extends jo{constructor(e){super(e),this._releaseCallback=e.releaseCallback,this._forgetCallback=e.forgetCallback,this._retentionCount=1,this._kickDetails=null,this._kickedBy=null}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._releaseCallback()}async _getKickAuthor(e,t){const s=await t.roomMembers.get(this.id,e);return s?new P(s):P.fromUserId(this.id,e,"join")}async load(e,t,s){const{summary:i,kickDetails:r}=e;return this._kickDetails=r,this._kickDetails&&(this._kickedBy=await this._getKickAuthor(this._kickDetails.sender,t)),super.load(i,t,s)}async writeSync(e,t,s,i,r){if(r.set("id",this.id),s==="leave"){const o=bm(t,this._user.id);if(o||e){const a=o||this._kickDetails;let l;o&&(l=await this._getKickAuthor(o.sender,i));const c=e||this._summary.data;return i.archivedRoomSummary.set({summary:c.serialize(),kickDetails:a}),{kickDetails:a,kickedBy:l,summaryData:c}}}else s==="join"&&i.archivedRoomSummary.remove(this.id);return{}}afterSync({summaryData:e,kickDetails:t,kickedBy:s},i){i.set("id",this.id),e&&this._summary.applyChanges(e),t&&(this._kickDetails=t),s&&(this._kickedBy=s),this._emitUpdate()}get isKicked(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="leave"}get isBanned(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="ban"}get kickedBy(){return this._kickedBy}get kickReason(){var e;return(e=this._kickDetails)==null?void 0:e.reason}isArchived(){return!0}forget(e=null){return this._platform.logger.wrapOrRun(e,"forget room",async t=>{t.set("id",this.id),await this._hsApi.forget(this.id,{log:t}).response();const s=this._storage.storeNames,i=await this._storage.readWriteTxn([s.roomState,s.archivedRoomSummary,s.roomMembers,s.timelineEvents,s.timelineFragments,s.timelineRelations,s.pendingEvents,s.inboundGroupSessions,s.groupSessionDecryptions,s.operations]);i.roomState.removeAllForRoom(this.id),i.archivedRoomSummary.remove(this.id),i.roomMembers.removeAllForRoom(this.id),i.timelineEvents.removeAllForRoom(this.id),i.timelineFragments.removeAllForRoom(this.id),i.timelineRelations.removeAllForRoom(this.id),i.pendingEvents.removeAllForRoom(this.id),i.inboundGroupSessions.removeAllForRoom(this.id),i.groupSessionDecryptions.removeAllForRoom(this.id),await i.operations.removeAllForScope(this.id),await i.complete(),this._retentionCount=0,this._releaseCallback(),this._forgetCallback(this.id)})}join(e=null){return this._platform.logger.wrapOrRun(e,"rejoin archived room",async t=>{await this._hsApi.join(this.id,{log:t}).response()})}}function bm(n,e){var t,s;const i=Oo(n,(r,o)=>(o.type===ce&&o.state_key===e&&o.sender!==o.state_key&&(r=o),r),null);if(i)return{membership:(t=i.content)==null?void 0:t.membership,reason:(s=i.content)==null?void 0:s.reason,sender:i.sender}}async function Sm(n,e,t){const s=await Promise.all(n.map(async i=>{const r=await e.profile(i,{log:t}).response();return new Im(i,r.displayname,r.avatar_url)}));return s.sort((i,r)=>i.name.localeCompare(r.name)),s}class Im{constructor(e,t,s){this.userId=e,this.displayName=t,this.avatarUrl=s}get name(){return this.displayName||this.userId}}class Em{constructor(e){this.userId=e}get displayName(){}get name(){return this.userId}get avatarUrl(){}}function km(n){switch(n){case le.DirectMessage:case le.Private:return!0;case le.Public:return!1}}function Rm(n){switch(n){case le.DirectMessage:return"trusted_private_chat";case le.Private:return"private_chat";case le.Public:return"public_chat"}}class Cm extends Ws{constructor(e,t,s,i,r,o){var a;if(super(),this.id=e,this.options=t,this.updateCallback=s,this.mediaRepository=i,this.platform=r,this.profiles=[],this._isCancelled=!1,this.isEncrypted=t.isEncrypted===void 0?km(t.type):t.isEncrypted,t.name)this._calculatedName=t.name;else{const l={joinCount:1,inviteCount:((a=t.invites)==null?void 0:a.length)||0},c=(t.invites||[]).map(h=>new Em(h));this._calculatedName=Ci(c,l,o)}}async create(e,t){try{let s;if(this.options.avatar){const{avatar:o}=this.options,a=new qo({filename:o.name,blob:o.blob,platform:this.platform});await a.upload(e,()=>{},t),s={info:o.info},a.applyToContent("url",s)}const i={is_direct:this.options.type===le.DirectMessage,preset:Rm(this.options.type),initial_state:[]};this.options.name&&(i.name=this.options.name),this.options.topic&&(i.topic=this.options.topic),this.options.invites&&(i.invite=this.options.invites),this.options.alias&&(i.room_alias_name=this.options.alias),this.options.isFederationDisabled===!0&&(i.creation_content={"m.federate":!1}),this.options.powerLevelContentOverride&&(i.power_level_content_override=this.options.powerLevelContentOverride),this.isEncrypted&&i.initial_state.push(vl()),s&&i.initial_state.push({type:"m.room.avatar",state_key:"",content:s});const r=await e.createRoom(i,{log:t}).response();this._roomId=r.room_id}catch(s){this._error=s}this.emitChange()}async loadProfiles(e,t){try{if(!this.options.name&&this.options.invites){this.profiles=await Sm(this.options.invites,e,t);const s={joinCount:1,inviteCount:this.options.invites.length};this._calculatedName=Ci(this.profiles,s,t),this.emitChange()}}catch{}}emitChange(e){this.updateCallback(this,e),this.emit("change")}get avatarColorId(){var e,t,s;return(s=(t=(e=this.options.invites)==null?void 0:e[0])!=null?t:this._roomId)!=null?s:this.id}get avatarUrl(){var e,t;return(t=(e=this.profiles)==null?void 0:e[0])==null?void 0:t.avatarUrl}get avatarBlobUrl(){var e,t;return(t=(e=this.options.avatar)==null?void 0:e.blob)==null?void 0:t.url}get roomId(){return this._roomId}get name(){return this._calculatedName}get isBeingCreated(){return!0}get error(){return this._error}cancel(){this._isCancelled||(this.dispose(),this._isCancelled=!0,this.emitChange("isCancelled"))}get isCancelled(){return this._isCancelled}dispose(){this.options.avatar&&this.options.avatar.blob.dispose()}async adjustDirectMessageMapIfNeeded(e,t,s,i){if(!this.options.invites||this.options.type!==le.DirectMessage)return;const r=this.options.invites[0],o="m.direct";await i.wrap("set "+o,async a=>{try{const l=await t.readWriteTxn([t.storeNames.accountData]);let c;try{c=await l.accountData.get(o),c||(c={type:o,content:{}});const h=c.content;let d=h[r];d||(h[r]=d=[]),d.push(this._roomId),l.accountData.set(c),await l.complete()}catch(h){throw l.abort(),h}await s.setAccountData(e.id,o,c.content,{log:a}).response()}catch(l){a.catch(l)}})}}class Tm extends Ws{constructor({roomId:e,user:t,hsApi:s,mediaRepository:i,emitCollectionRemove:r,emitCollectionUpdate:o,platform:a}){super(),this._roomId=e,this._user=t,this._hsApi=s,this._emitCollectionRemove=r,this._emitCollectionUpdate=o,this._mediaRepository=i,this._platform=a,this._inviteData=null,this._accepting=!1,this._rejecting=!1,this._accepted=!1,this._rejected=!1}get isInvite(){return!0}get id(){return this._roomId}get name(){return this._inviteData.name||this._inviteData.canonicalAlias}get isDirectMessage(){return this._inviteData.isDirectMessage}get avatarUrl(){return this._inviteData.avatarUrl}get avatarColorId(){return this._inviteData.avatarColorId||this.id}get timestamp(){return this._inviteData.timestamp}get isEncrypted(){return this._inviteData.isEncrypted}get inviter(){return this._inviter}isDirectMessageForUserId(e){return this.isDirectMessage&&this._inviter.userId===e}get isPublic(){return this._inviteData.joinRule==="public"}get canonicalAlias(){return this._inviteData.canonicalAlias}async accept(e=null){await this._platform.logger.wrapOrRun(e,"acceptInvite",async t=>{this._accepting=!0,this._emitChange("accepting"),await this._hsApi.join(this._roomId,{log:t}).response()})}async reject(e=null){await this._platform.logger.wrapOrRun(e,"rejectInvite",async t=>{this._rejecting=!0,this._emitChange("rejecting"),await this._hsApi.leave(this._roomId,{log:t}).response()})}get accepting(){return this._accepting}get accepted(){return this._accepted}get rejecting(){return this._rejecting}get rejected(){return this._rejected}get mediaRepository(){return this._mediaRepository}_emitChange(e){this.emit("change"),this._emitCollectionUpdate(this,e)}load(e,t){t.set("id",this.id),this._inviteData=e,this._inviter=e.inviter?new P(e.inviter):null}async writeSync(e,t,s,i){var r;if(e==="invite"){i.set("id",this.id),i.set("add",!0);const o=(r=t.invite_state)==null?void 0:r.events;if(!Array.isArray(o))return null;const a=this._createSummaryData(o);let l;!a.name&&!a.canonicalAlias&&(l=await this._createHeroes(o,i));const c=this._getMyInvite(o);if(!c)return null;const h=this._getInviter(c,o),d=this._createData(o,c,h,a,l);return s.invites.set(d),{inviteData:d,inviter:h}}else return i.set("id",this.id),i.set("membership",e),s.invites.remove(this.id),{removed:!0,membership:e}}afterSync(e,t){t.set("id",this.id),e&&(e.removed?(this._accepting=!1,this._rejecting=!1,e.membership==="join"?this._accepted=!0:this._rejected=!0,this.emit("change")):(this._inviteData=e.inviteData,this._inviter=e.inviter))}_createData(e,t,s,i,r){const o=r?r.roomName:i.name,a=r?r.roomAvatarUrl:i.avatarUrl,l=r?.roomAvatarColorId||this.id;return{roomId:this.id,isEncrypted:!!i.encryption,isDirectMessage:i.isDirectMessage,name:o,avatarUrl:a,avatarColorId:l,canonicalAlias:i.canonicalAlias,timestamp:this._platform.clock.now(),joinRule:this._getJoinRule(e),inviter:s?.serialize()}}_createSummaryData(e){return e.reduce((t,s)=>Lo(t,s,this._user.id),new Me(null,this.id))}async _createHeroes(e,t){const s=e.filter(h=>h.type===ce),i=s.filter(h=>h.state_key!==this._user.id),r=i.reduce((h,d)=>{const m=P.fromMemberEvent(this.id,d);return h.set(m.userId,new oo(m,null)),h},new Map),o=i.map(h=>h.state_key),a=new Gi(this.id),l=await a.calculateChanges(o,r,null),c=new Me(null,this.id);return c.joinCount=s.reduce((h,d)=>{var m;return h+(((m=d.content)==null?void 0:m.membership)==="join"?1:0)},0),c.inviteCount=s.reduce((h,d)=>{var m;return h+(((m=d.content)==null?void 0:m.membership)==="invite"?1:0)},0),a.applyChanges(l,c,t),a}_getMyInvite(e){return e.find(t=>t.type===ce&&t.state_key===this._user.id)}_getInviter(e,t){const s=t.find(i=>i.type===ce&&i.state_key===e.sender);if(s)return P.fromMemberEvent(this.id,s)}_getJoinRule(e){var t;const s=e.find(i=>i.type==="m.room.join_rules");return s?(t=s.content)==null?void 0:t.join_rule:null}}class rt{constructor(e){this._description=e}static httpPusher(e,t,s,i){return new rt({kind:"http",append:!0,data:Object.assign({},i,{url:e+"/_matrix/push/v1/notify"}),pushkey:s,app_id:t,app_display_name:"Hydrogen",device_display_name:"Hydrogen",lang:"en"})}static createDefaultPayload(e){return{session_id:e}}async enable(e,t){try{t.set("endpoint",new URL(this._description.data.endpoint).host)}catch{t.set("endpoint",null)}await e.setPusher(this._description,{log:t}).response()}async disable(e,t){const s=Object.assign({},this._description,{kind:null});await e.setPusher(s,{log:t}).response()}serialize(){return this._description}equals(e){return this._description.app_id!==e._description.app_id||this._description.pushkey!==e._description.pushkey?!1:JSON.stringify(this._description.data)===JSON.stringify(e._description.data)}}function Rt(n,e){return Yi(n,e,()=>[],(t,s)=>t.push(s))}function Yi(n,e,t,s){return n.reduce((i,r)=>{const o=e(r);let a=i.get(o);return a||(a=t(),i.set(o,a)),s(a,r),i},new Map)}function fn(n,e){return n.reduce((t,s)=>{const i=e(s);return t[i]?t[i]+=1:t[i]=1,t},{})}class Mm{constructor({storage:e}){this._storage=e,this._olmDecryption=null,this._megolmDecryption=null}enableEncryption({olmDecryption:e,megolmDecryption:t}){this._olmDecryption=e,this._megolmDecryption=t}obtainSyncLock(e){var t;return(t=this._olmDecryption)==null?void 0:t.obtainDecryptionLock(e)}async prepareSync(e,t,s,i){i.set("messageTypes",fn(e,a=>a.type));const r=e.filter(a=>a.type==="m.room.encrypted");if(!this._olmDecryption){i.log("can't decrypt, encryption not enabled",i.level.Warn);return}const o=r.filter(a=>{var l;return((l=a.content)==null?void 0:l.algorithm)===Fi});if(o.length){const a=await this._olmDecryption.decryptAll(o,t,s);i.set("decryptedTypes",fn(a.results,c=>{var h;return(h=c.event)==null?void 0:h.type}));for(const c of a.errors)i.child("decrypt_error").catch(c);const l=this._megolmDecryption.roomKeysFromDeviceMessages(a.results,i);return new Am(a,l)}}async writeSync(e,t){return e.olmDecryptChanges.write(t),(await Promise.all(e.newRoomKeys.map(i=>this._megolmDecryption.writeRoomKey(i,t)))).some(i=>!!i)}}class Am{constructor(e,t){this.olmDecryptChanges=e,this.newRoomKeys=t,this.newKeysByRoom=Rt(t,s=>s.roomId)}}const $t=ae+"olmAccount",Ti=ae+"areDeviceKeysUploaded",Ns=ae+"serverOTKCount";async function yn(n,e,t,s,i){const r=n.pickle(e),o=await i.readWriteTxn([i.storeNames.session]);try{o.session.add($t,r),o.session.add(Ti,t),o.session.add(Ns,s)}catch(a){throw o.abort(),a}await o.complete()}class dt{static async load({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:r,olmWorker:o,txn:a}){const l=await a.session.get($t);if(l){const c=new e.Account,h=await a.session.get(Ti);c.unpickle(t,l);const d=await a.session.get(Ns);return new dt({pickleKey:t,hsApi:s,account:c,userId:i,deviceId:r,areDeviceKeysUploaded:h,serverOTKCount:d,olm:e,olmWorker:o})}}static async adoptDehydratedDevice({olm:e,dehydratedDevice:t,pickleKey:s,hsApi:i,userId:r,olmWorker:o,storage:a}){const l=t.adoptUnpickledOlmAccount(),c=JSON.parse(l.one_time_keys()),d=Object.entries(c.curve25519).length,m=!0;return await yn(l,s,m,d,a),new dt({pickleKey:s,hsApi:i,account:l,userId:r,deviceId:t.deviceId,areDeviceKeysUploaded:m,serverOTKCount:d,olm:e,olmWorker:o})}static async create({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:r,olmWorker:o,storage:a}){const l=new e.Account;o?await o.createAccountAndOTKs(l,l.max_number_of_one_time_keys()):(l.create(),l.generate_one_time_keys(l.max_number_of_one_time_keys()));const c=!1,h=0;return a&&await yn(l,t,c,h,a),new dt({pickleKey:t,hsApi:s,account:l,userId:i,deviceId:r,areDeviceKeysUploaded:c,serverOTKCount:h,olm:e,olmWorker:o})}constructor({pickleKey:e,hsApi:t,account:s,userId:i,deviceId:r,areDeviceKeysUploaded:o,serverOTKCount:a,olm:l,olmWorker:c}){this._olm=l,this._pickleKey=e,this._hsApi=t,this._account=s,this._userId=i,this._deviceId=r,this._areDeviceKeysUploaded=o,this._serverOTKCount=a,this._olmWorker=c,this._identityKeys=JSON.parse(this._account.identity_keys())}get identityKeys(){return this._identityKeys}setDeviceId(e){this._deviceId=e}async uploadKeys(e,t,s){var i;const r=JSON.parse(this._account.one_time_keys()),o=Object.entries(r.curve25519);if(o.length||!this._areDeviceKeysUploaded){const a={};if(!this._areDeviceKeysUploaded){s.set("identity",!0);const h=JSON.parse(this._account.identity_keys());a.device_keys=this._deviceKeysPayload(h)}o.length&&(s.set("otks",!0),a.one_time_keys=this._oneTimeKeysPayload(o));const l=t?this._deviceId:void 0,c=await this._hsApi.uploadKeys(l,a,{log:s}).response();this._serverOTKCount=(i=c?.one_time_key_counts)==null?void 0:i.signed_curve25519,s.set("serverOTKCount",this._serverOTKCount),await this._updateSessionStorage(e,h=>{o.length&&(this._account.mark_keys_as_published(),h?.set($t,this._account.pickle(this._pickleKey)),h?.set(Ns,this._serverOTKCount)),this._areDeviceKeysUploaded||(this._areDeviceKeysUploaded=!0,h?.set(Ti,this._areDeviceKeysUploaded))})}}async generateOTKsIfNeeded(e,t){const s=this._account.max_number_of_one_time_keys(),i=Math.floor(s/2);if(this._serverOTKCount<i){const r=JSON.parse(this._account.one_time_keys()),a=Object.entries(r.curve25519).length,l=i-a-this._serverOTKCount;return l>0&&await t.wrap("generate otks",c=>{c.set("max",s),c.set("server",this._serverOTKCount),c.set("unpublished",a),c.set("new",l),c.set("limit",i),this._account.generate_one_time_keys(l),this._updateSessionStorage(e,h=>{h.set($t,this._account.pickle(this._pickleKey))})}),!0}return!1}createInboundOlmSession(e,t){const s=new this._olm.Session;try{return s.create_inbound_from(this._account,e,t),s}catch(i){throw s.free(),i}}async createOutboundOlmSession(e,t){const s=new this._olm.Session;try{return this._olmWorker?await this._olmWorker.createOutboundOlmSession(this._account,s,e,t):s.create_outbound(this._account,e,t),s}catch(i){throw s.free(),i}}writeRemoveOneTimeKey(e,t){this._account.remove_one_time_keys(e),t.session.set($t,this._account.pickle(this._pickleKey))}writeSync(e,t,s){const i=e.signed_curve25519;if(Number.isSafeInteger(i)&&i!==this._serverOTKCount)return t.session.set(Ns,i),s.set("otkCount",i),i}afterSync(e){Number.isSafeInteger(e)&&(this._serverOTKCount=e)}_deviceKeysPayload(e){const t={user_id:this._userId,device_id:this._deviceId,algorithms:[Fi,ke],keys:{}};for(const[s,i]of Object.entries(e))t.keys[`${s}:${this._deviceId}`]=i;return this.signObject(t),t}_oneTimeKeysPayload(e){const t={};for(const[s,i]of e){const r={key:i};this.signObject(r),t[`signed_curve25519:${s}`]=r}return t}async _updateSessionStorage(e,t){if(e){const s=await e.readWriteTxn([e.storeNames.session]);try{await t(s.session)}catch(i){throw s.abort(),i}await s.complete()}else await t(void 0)}signObject(e){const t=e.signatures||{},s=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=this._account.sign(Kn.stringify(e)),e.signatures=t,s!==void 0&&(e.unsigned=s)}pickleWithKey(e){return this._account.pickle(e)}dispose(){this._account.free(),this._account=void 0}}class Ji{constructor(e,t){this._id=e,this._keyDescription=t}get id(){return this._id}get passphraseParams(){var e;return(e=this._keyDescription)==null?void 0:e.passphrase}get algorithm(){var e;return(e=this._keyDescription)==null?void 0:e.algorithm}async isCompatible(e,t){if(this.algorithm==="m.secret_storage.v1.aes-hmac-sha2"){const s=this._keyDescription;if(s.mac){const i=await xm(e.binaryKey,s.iv,t);return s.mac===i}else if(s.passphrase){const i=e.description._keyDescription;return i.passphrase?s.passphrase.algorithm===i.passphrase.algorithm&&s.passphrase.iterations===i.passphrase.iterations&&s.passphrase.salt===i.passphrase.salt:!1}}return!1}}class ns{constructor(e,t){this._keyDescription=e,this._binaryKey=t}withDescription(e){return new ns(e,this._binaryKey)}get description(){return this._keyDescription}get id(){return this._keyDescription.id}get binaryKey(){return this._binaryKey}get algorithm(){return this._keyDescription.algorithm}}async function xm(n,e,t){const{crypto:s,encoding:i}=t,{utf8:r,base64:o}=i,{derive:a,aes:l,hmac:c}=s,h=o.decode(e),d=new Uint8Array(8),m="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",p=r.encode(""),_=await a.hkdf(n,d,p,"SHA-256",512),g=_.slice(0,32),b=_.slice(32),S=await l.encryptCTR({key:g,iv:h,data:r.encode(m)}),I=await c.compute(b,S,"SHA-256");return o.encode(I)}const Nm=5e5,Dm=256;async function Om(n,e,t){const{passphraseParams:s}=n;if(!s)throw new Error("not a passphrase key");if(s.algorithm!=="m.pbkdf2")throw new Error(`Unsupported passphrase algorithm: ${s.algorithm}`);const{utf8:i}=t.encoding,r=await t.crypto.derive.pbkdf2(i.encode(e),s.iterations||Nm,i.encode(s.salt),"SHA-512",s.bits||Dm);return new ns(n,r)}const Vt=[139,1];function Lm(n,e,t,s){const i=s.encoding.base58.decode(e.replace(/ /g,""));let r=0;for(const a of i)r^=a;if(r!==0)throw new Error("Incorrect parity");for(let a=0;a<Vt.length;++a)if(i[a]!==Vt[a])throw new Error("Incorrect prefix");if(i.length!==Vt.length+t.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");const o=Uint8Array.from(i.slice(Vt.length,Vt.length+t.PRIVATE_KEY_LENGTH));return new ns(n,o)}const Qi=`${ae}ssssKey`,vn=`${ae}keyBackupVersion`;var ts=(n=>(n[n.RecoveryKey=0]="RecoveryKey",n[n.Passphrase=1]="Passphrase",n))(ts||{});async function Ho(n){var e;const t=await n.readTxn([n.storeNames.accountData]),s=await t.accountData.get("m.secret_storage.default_key"),i=(e=s?.content)==null?void 0:e.key;if(!i)return;const r=await t.accountData.get(`m.secret_storage.key.${i}`);if(!!r)return new Ji(i,r.content)}async function Pm(n,e,t){const s=await t.session.get(vn);return t.session.set(vn,e),t.session.set(Qi,{id:n.id,binaryKey:n.binaryKey}),s}async function Vm(n){const e=await n.session.get(Qi);if(!e)return;const t=await n.accountData.get(`m.secret_storage.key.${e.id}`);if(t)return new ns(new Ji(e.id,t.content),e.binaryKey)}async function Um(n){n.session.remove(Qi)}async function Fm(n,e,t,s,i){const r=await Ho(t);if(!r)throw new Error("Could not find a default secret storage key in account data");return await Wo(n,e,r,s,i)}async function Wo(n,e,t,s,i){let r;if(n===1)r=await Om(t,e,s);else if(n===0)r=Lm(t,e,i,s);else throw new Error(`Invalid type: ${n}`);return r}async function Bm(n,e,t){const s=await Ho(e);if(await s?.isCompatible(n,t))return n.withDescription(s)}const zo="org.matrix.msc2697.v1.olm.libolm_pickle";async function Km(n,e,t,s){try{const i=await n.getDehydratedDevice({log:s}).response();if(i.device_data.algorithm===zo)return new jm(i,e,t)}catch(i){i.name!=="HomeServerError"&&(s.error=i);return}}async function $m(n,e,t,s,i){var r;const a=(await e.createDehydratedDevice({device_data:{algorithm:zo,account:n.pickleWithKey(t.binaryKey.slice()),passphrase:((r=t.description)==null?void 0:r.passphraseParams)||{}},initial_device_display_name:s}).response()).device_id;return n.setDeviceId(a),await n.uploadKeys(void 0,!0,i),a}class jm{constructor(e,t,s){this._dehydratedDevice=e,this._olm=t,this._platform=s}async decrypt(e,t){const s=new Ji("dehydrated_device",this._dehydratedDevice.device_data.passphrase),i=await Wo(e,t,s,this._platform,this._olm),r=new this._olm.Account;try{const o=this._dehydratedDevice.device_data.account;return r.unpickle(i.binaryKey.slice(),o),new qm(this._dehydratedDevice,r,i)}catch(o){if(r.free(),o.message==="OLM.BAD_ACCOUNT_KEY")return;throw o}}get deviceId(){return this._dehydratedDevice.device_id}}class qm{constructor(e,t,s){this._dehydratedDevice=e,this._account=t,this._key=s}async claim(e,t){try{return(await e.claimDehydratedDevice(this.deviceId,{log:t}).response()).success}catch{return!1}}adoptUnpickledOlmAccount(){const e=this._account;return this._account=void 0,e}get deviceId(){return this._dehydratedDevice.device_id}get key(){return this._key}dispose(){var e;(e=this._account)==null||e.free(),this._account=void 0}}class Hm{tryTake(){return this._promise?!1:(this._promise=new Promise(e=>{this._resolve=e}),!0)}async take(){for(;!this.tryTake();)await this.released()}get isTaken(){return!!this._promise}release(){if(this._resolve){this._promise=void 0;const e=this._resolve;this._resolve=void 0,e()}}released(){return this._promise}}class Wm{constructor(e){this.locks=e}release(){for(const e of this.locks)e.release()}}function Go(n,e,t,s){return{session:n.pickle(s),sessionId:n.session_id(),senderKey:e,lastUsed:t}}class Ks{constructor(e,t,s,i=!1){this.data=e,this.pickleKey=t,this.olm=s,this.isNew=i,this.isModified=i}static create(e,t,s,i,r){const o=Go(t,e,r,i);return new Ks(o,i,s,!0)}get id(){return this.data.sessionId}load(){const e=new this.olm.Session;return e.unpickle(this.pickleKey,this.data.session),e}unload(e){e.free()}save(e){this.data.session=e.pickle(this.pickleKey),this.isModified=!0}}class Yo{constructor(e,t,s){this.event=e,this.senderCurve25519Key=t,this.claimedEd25519Key=s,this.roomTracked=!0}setDevice(e){this.device=e}setRoomNotTrackedYet(){this.roomTracked=!1}get isVerified(){return this.device?this.device.ed25519Key===this.claimedEd25519Key:!1}get isUnverified(){return this.device?!this.isVerified:!this.isVerificationUnknown}get isVerificationUnknown(){return!this.device&&!this.roomTracked}}var $s=(n=>(n[n.PreKey=0]="PreKey",n[n.Normal=1]="Normal",n))($s||{});const wn=4;function Jo(n){n.sort((e,t)=>t.data.lastUsed-e.data.lastUsed)}class zm{constructor(e,t,s,i,r,o){this.account=e,this.pickleKey=t,this.now=s,this.ownUserId=i,this.olm=r,this.senderKeyLock=o}async obtainDecryptionLock(e){var t;const s=new Set;for(const r of e){const o=(t=r.content)==null?void 0:t.sender_key;o&&s.add(o)}const i=await Promise.all(Array.from(s).map(r=>this.senderKeyLock.takeLock(r)));return new Wm(i)}async decryptAll(e,t,s){try{const i=Rt(e,h=>{var d;return(d=h.content)==null?void 0:d.sender_key}),r=this.now(),o=await Promise.all(Array.from(i.entries()).map(([h,d])=>this._decryptAllForSenderKey(h,d,r,s))),a=o.reduce((h,d)=>h.concat(d.results),[]),l=o.reduce((h,d)=>h.concat(d.errors),[]),c=o.map(h=>h.senderKeyDecryption);return new Ym(c,a,l,this.account,t)}catch(i){throw t.release(),i}}async _decryptAllForSenderKey(e,t,s,i){const r=await this._getSessions(e,i),o=new Gm(e,r,s),a=[],l=[];for(const c of t)try{const h=this._decryptForSenderKey(o,c,s);a.push(h)}catch(h){l.push(h)}return{results:a,errors:l,senderKeyDecryption:o}}_decryptForSenderKey(e,t,s){const i=e.senderKey,r=this._getMessageAndValidateEvent(t);let o;try{o=e.decrypt(r)}catch(a){throw new Y("OLM_BAD_ENCRYPTED_MESSAGE",t,{senderKey:i,error:a.message})}if(typeof o!="string"&&r.type===$s.PreKey){let a;try{a=this._createSessionAndDecrypt(i,r,s)}catch(l){throw new Y(`Could not create inbound olm session: ${l.message}`,t,{senderKey:i,error:l})}e.addNewSession(a.session),o=a.plaintext}if(typeof o=="string"){let a;try{a=JSON.parse(o)}catch(l){throw new Y("PLAINTEXT_NOT_JSON",t,{plaintext:o,error:l})}return this._validatePayload(a,t),new Yo(a,i,a.keys.ed25519)}else throw new Y("OLM_NO_MATCHING_SESSION",t,{knownSessionIds:e.sessions.map(a=>a.id)})}_createSessionAndDecrypt(e,t,s){let i;const r=this.account.createInboundOlmSession(e,t.body);try{i=r.decrypt(t.type,t.body);const o=Ks.create(e,r,this.olm,this.pickleKey,s);return o.unload(r),{session:o,plaintext:i}}catch(o){throw r.free(),o}}_getMessageAndValidateEvent(e){var t;const s=(t=e.content)==null?void 0:t.ciphertext;if(!s)throw new Y("OLM_MISSING_CIPHERTEXT",e);const i=s?.[this.account.identityKeys.curve25519];if(!i)throw new Y("OLM_NOT_INCLUDED_IN_RECIPIENTS",e);return i}async _getSessions(e,t){const i=(await t.olmSessions.getAll(e)).map(r=>new Ks(r,this.pickleKey,this.olm));return Jo(i),i}_validatePayload(e,t){var s,i,r;if(e.sender!==t.sender)throw new Y("OLM_FORWARDED_MESSAGE",t,{sentBy:t.sender,encryptedBy:e.sender});if(e.recipient!==this.ownUserId)throw new Y("OLM_BAD_RECIPIENT",t,{recipient:e.recipient});if(((s=e.recipient_keys)==null?void 0:s.ed25519)!==this.account.identityKeys.ed25519)throw new Y("OLM_BAD_RECIPIENT_KEY",t,{key:(i=e.recipient_keys)==null?void 0:i.ed25519});if(!e.type)throw new Y("missing type on payload",t,{payload:e});if(typeof((r=e.keys)==null?void 0:r.ed25519)!="string")throw new Y("Missing or invalid claimed ed25519 key on payload",t,{payload:e})}}class Gm{constructor(e,t,s){this.senderKey=e,this.sessions=t,this.timestamp=s}addNewSession(e){this.sessions.unshift(e)}decrypt(e){for(const t of this.sessions){const s=this.decryptWithSession(t,e);if(typeof s=="string")return Jo(this.sessions),s}}getModifiedSessions(){return this.sessions.filter(e=>e.isModified)}get hasNewSessions(){return this.sessions.some(e=>e.isNew)}decryptWithSession(e,t){if(t.type===void 0||t.body===void 0)throw new Error("Invalid message without type or body");const s=e.load();try{if(t.type===$s.PreKey&&!s.matches_inbound(t.body))return;try{const i=s.decrypt(t.type,t.body);return e.save(s),e.data.lastUsed=this.timestamp,i}catch(i){if(t.type===$s.PreKey)throw new Error(`Error decrypting prekey message with existing session id ${e.id}: ${i.message}`);return}}finally{e.unload(s)}}}class Ym{constructor(e,t,s,i,r){this.senderKeyDecryptions=e,this.results=t,this.errors=s,this.account=i,this.lock=r}get hasNewSessions(){return this.senderKeyDecryptions.some(e=>e.hasNewSessions)}write(e){try{for(const t of this.senderKeyDecryptions){for(const s of t.getModifiedSessions())if(e.olmSessions.set(s.data),s.isNew){const i=s.load();try{this.account.writeRemoveOneTimeKey(i,e)}finally{s.unload(i)}}if(t.sessions.length>wn){const{senderKey:s,sessions:i}=t;for(let r=i.length-1;r>=wn;r-=1){const o=i[r];e.olmSessions.remove(s,o.id)}}}}finally{this.lock.release()}}}function Jm(n){return n.reduce((e,t)=>!e||t<e?t:e,null)}const bn="signed_curve25519",Sn=20;class Qm{constructor(e,t,s,i,r,o,a,l){this.account=e,this.pickleKey=t,this.olm=s,this.storage=i,this.now=r,this.ownUserId=o,this.olmUtil=a,this.senderKeyLock=l}async encrypt(e,t,s,i,r){let o=[];for(let a=0;a<s.length;a+=Sn){const l=s.slice(a,a+Sn),c=await this._encryptForMaxDevices(e,t,l,i,r);o=o.concat(c)}return o}async _encryptForMaxDevices(e,t,s,i,r){const o=await Promise.all(s.map(a=>this.senderKeyLock.takeLock(a.curve25519Key)));try{const{devicesWithoutSession:a,existingEncryptionTargets:l}=await this._findExistingSessions(s),c=this.now();let h=[];try{if(a.length){const p=await r.wrap("create sessions",_=>this._createNewSessions(a,i,c,_));h=h.concat(p)}await this._loadSessions(l),h=h.concat(l);const d={l:"encrypt",targets:h.length},m=r.wrap(d,()=>h.map(p=>{const _=this._encryptForDevice(e,t,p);return new Xm(_,p.device)}));return await this._storeSessions(h,c),m}finally{for(const d of h)d.dispose()}}finally{for(const a of o)a.release()}}async _findExistingSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]),s=await Promise.all(e.map(async o=>await t.olmSessions.getSessionIds(o.curve25519Key))),i=e.filter((o,a)=>{const l=s[a];return!l?.length}),r=e.map((o,a)=>{const l=s[a];if(l?.length>0){const c=Jm(l);return ss.fromSessionId(o,c)}}).filter(o=>!!o);return{devicesWithoutSession:i,existingEncryptionTargets:r}}_encryptForDevice(e,t,s){const{session:i,device:r}=s,o=JSON.stringify(this._buildPlainTextMessageForDevice(e,t,r)),a=i.encrypt(o);return{algorithm:Fi,sender_key:this.account.identityKeys.curve25519,ciphertext:{[r.curve25519Key]:a}}}_buildPlainTextMessageForDevice(e,t,s){return{keys:{ed25519:this.account.identityKeys.ed25519},recipient_keys:{ed25519:s.ed25519Key},recipient:s.userId,sender:this.ownUserId,content:t,type:e}}async _createNewSessions(e,t,s,i){const r=await i.wrap("claim",o=>this._claimOneTimeKeys(t,e,o));try{for(const o of r){const{device:a,oneTimeKey:l}=o;o.session=await this.account.createOutboundOlmSession(a.curve25519Key,l)}await this._storeSessions(r,s)}catch(o){for(const a of r)a.dispose();throw o}return r}async _claimOneTimeKeys(e,t,s){const i=Yi(t,l=>l.userId,()=>new Map,(l,c)=>l.set(c.deviceId,c)),r=Array.from(i.entries()).reduce((l,[c,h])=>(l[c]=Array.from(h.values()).reduce((d,m)=>(d[m.deviceId]=bn,d),{}),l),{}),o=await e.claimKeys({timeout:1e4,one_time_keys:r},{log:s}).response();Object.keys(o.failures).length&&s.log({l:"failures",servers:Object.keys(o.failures)},s.level.Warn);const a=o?.one_time_keys;return this._verifyAndCreateOTKTargets(a,i,s)}_verifyAndCreateOTKTargets(e,t,s){var i;const r=[];for(const[o,a]of Object.entries(e))for(const[l,c]of Object.entries(a)){const[h,d]=Object.entries(c)[0],[m]=h.split(":");if(m===bn){const p=(i=t.get(o))==null?void 0:i.get(l);if(p&&to(this.olmUtil,o,l,p.ed25519Key,d,s)){const g=ss.fromOTK(p,d.key);r.push(g)}}}return r}async _loadSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]);let s=!1;try{await Promise.all(e.map(async i=>{const r=await t.olmSessions.get(i.device.curve25519Key,i.sessionId);if(r&&!s){const o=new this.olm.Session;o.unpickle(this.pickleKey,r.session),i.session=o}}))}catch(i){s=!0;for(const r of e)r.dispose();throw i}}async _storeSessions(e,t){const s=await this.storage.readWriteTxn([this.storage.storeNames.olmSessions]);try{for(const i of e){const r=Go(i.session,i.device.curve25519Key,t,this.pickleKey);s.olmSessions.set(r)}}catch(i){throw s.abort(),i}await s.complete()}}class ss{constructor(e,t,s){this.device=e,this.oneTimeKey=t,this.sessionId=s,this.session=null}static fromOTK(e,t){return new ss(e,t,null)}static fromSessionId(e,t){return new ss(e,null,t)}dispose(){this.session&&this.session.free()}}class Xm{constructor(e,t){this.content=e,this.device=t}}class Zm{constructor(e,t,s,i){this._roomId=e,this._results=t,this._errors=s,this._replayEntries=i}async write(e){return await Promise.all(this._replayEntries.map(async t=>{try{this._handleReplayAttack(this._roomId,t,e)}catch(s){this._errors.set(t.eventId,s)}})),{results:this._results,errors:this._errors}}async _handleReplayAttack(e,t,s){const{messageIndex:i,sessionId:r,eventId:o,timestamp:a}=t,l=await s.groupSessionDecryptions.get(e,r,i);if(l&&l.eventId!==o){const h=l.timestamp<a?o:l.eventId;throw this._results.delete(o),new Y("MEGOLM_REPLAYED_INDEX",event,{messageIndex:i,badEventId:h,otherEventId:l.eventId})}l||s.groupSessionDecryptions.set(e,r,i,{eventId:o,timestamp:a})}}function Mi(n,e){if(n)for(const[t,s]of n.entries())e.set(t,s)}class ep{constructor(e,t,s){this._roomId=e,this._sessionDecryptions=t,this._initialErrors=s}async decrypt(){try{const e=this._initialErrors,t=new Map,s=[];return await Promise.all(this._sessionDecryptions.map(async i=>{const r=await i.decryptAll();Mi(r.errors,e),Mi(r.results,t),s.push(...r.replayEntries)})),new Zm(this._roomId,t,e,s)}finally{this.dispose()}}dispose(){for(const e of this._sessionDecryptions)e.dispose()}}class tp{constructor(e,t,s){this.sessionId=e,this.messageIndex=t,this.event=s}get eventId(){return this.event.event_id}get timestamp(){return this.event.origin_server_ts}}class sp{constructor(e,t,s,i){this.key=e,this.events=t,this.olmWorker=s,this.keyLoader=i,this.decryptionRequests=s?[]:void 0}async decryptAll(){const e=[],t=new Map;let s;return await this.keyLoader.useKey(this.key,async i=>{for(const r of this.events)try{const o=r.content.ciphertext;let a;if(this.olmWorker){const d=this.olmWorker.megolmDecrypt(i,o);this.decryptionRequests.push(d),a=await d.response()}else a=i.decrypt(o);const{plaintext:l}=a;let c;try{c=JSON.parse(l)}catch(d){throw new Y("PLAINTEXT_NOT_JSON",r,{plaintext:l,err:d})}if(c.room_id!==this.key.roomId)throw new Y("MEGOLM_WRONG_ROOM",r,{encryptedRoomId:c.room_id,eventRoomId:this.key.roomId});e.push(new tp(this.key.sessionId,a.message_index,r));const h=new Yo(c,this.key.senderKey,this.key.claimedEd25519Key);t.set(r.event_id,h)}catch(o){if(o.name==="AbortError")return;s||(s=new Map),s.set(r.event_id,o)}}),{results:t,errors:s,replayEntries:e}}dispose(){if(this.decryptionRequests)for(const e of this.decryptionRequests)e.abort()}}function Xi(n){var e;return(e=n.content)==null?void 0:e.sender_key}function Zi(n){var e;return(e=n.content)==null?void 0:e.session_id}function ip(n){var e;return(e=n.content)==null?void 0:e.ciphertext}function rp(n){return typeof Xi(n)=="string"&&typeof Zi(n)=="string"&&typeof ip(n)=="string"}class np{constructor(){this.events=[]}get senderKey(){return Xi(this.events[0])}get sessionId(){return Zi(this.events[0])}}function Ai(n){return Yi(n,e=>`${Xi(e)}|${Zi(e)}`,()=>new np,(e,t)=>e.events.push(t))}class Qo{isForSession(e,t,s){return this.roomId===e&&this.senderKey===t&&this.sessionId===s}get isBetter(){return this._isBetter}set isBetter(e){this._isBetter=e}}function Xo(n,e){return n.first_known_index()<e.first_known_index()}class er extends Qo{checkBetterThanKeyInStorage(e,t){return this._checkBetterThanKeyInStorage(e,void 0,t)}async write(e,t){let s;if(this.isBetter===void 0&&await this._checkBetterThanKeyInStorage(e,(r,o)=>{s=r.pickle(o)},t),this.isBetter===!1)return!1;s||(s=await e.useKey(this,(r,o)=>r.pickle(o)));const i={roomId:this.roomId,senderKey:this.senderKey,sessionId:this.sessionId,session:s,backup:this.backupStatus,source:this.keySource,claimedKeys:{ed25519:this.claimedEd25519Key}};return t.inboundGroupSessions.set(i),!0}get eventIds(){return this._eventIds}async _checkBetterThanKeyInStorage(e,t,s){if(this.isBetter!==void 0)return this.isBetter;let i=e.getCachedKey(this.roomId,this.senderKey,this.sessionId);if(!i){const r=await ta(this.roomId,this.senderKey,this.sessionId,s);r&&(r.hasSession?i=r:r.eventIds&&(this._eventIds=r.eventIds))}if(i){const r=i;await e.useKey(this,async o=>{await e.useKey(r,(a,l)=>{this.isBetter=Xo(o,a),r.isBetter=!this.isBetter,this.isBetter&&t&&t(o,l)})})}else this.isBetter=!0;return this.isBetter}get backupStatus(){return qs.NotBackedUp}}class op extends er{constructor(e){super(),this._decryptionResult=e}get roomId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.room_id}get senderKey(){return this._decryptionResult.senderCurve25519Key}get sessionId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_id}get claimedEd25519Key(){return this._decryptionResult.claimedEd25519Key}get serializationKey(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_key}get serializationType(){return"create"}get keySource(){return is.DeviceMessage}loadInto(e){e.create(this.serializationKey)}}class ap extends er{constructor(e,t,s){super(),this._roomId=e,this.outboundSession=t,this.identityKeys=s,this.isBetter=!0,this._sessionKey=this.outboundSession.session_key()}get roomId(){return this._roomId}get senderKey(){return this.identityKeys.curve25519}get sessionId(){return this.outboundSession.session_id()}get claimedEd25519Key(){return this.identityKeys.ed25519}get serializationKey(){return this._sessionKey}get serializationType(){return"create"}get keySource(){return is.Outbound}loadInto(e){e.create(this.serializationKey)}}class lp extends er{constructor(e,t,s){super(),this._roomId=e,this._sessionId=t,this._backupInfo=s}get roomId(){return this._roomId}get senderKey(){return this._backupInfo.sender_key}get sessionId(){return this._sessionId}get claimedEd25519Key(){var e;return(e=this._backupInfo.sender_claimed_keys)==null?void 0:e.ed25519}get serializationKey(){return this._backupInfo.session_key}get serializationType(){return"import_session"}get keySource(){return is.Backup}loadInto(e){e.import_session(this.serializationKey)}get backupStatus(){return qs.BackedUp}}class Zo extends Qo{constructor(e){super(),this.isBetter=!0,this.storageEntry=e}get roomId(){return this.storageEntry.roomId}get senderKey(){return this.storageEntry.senderKey}get sessionId(){return this.storageEntry.sessionId}get claimedEd25519Key(){return this.storageEntry.claimedKeys.ed25519}get eventIds(){return this.storageEntry.eventIds}get serializationKey(){return this.storageEntry.session||""}get serializationType(){return"unpickle"}loadInto(e,t){e.unpickle(t,this.serializationKey)}get hasSession(){return!!this.serializationKey}}function cp(n){var e;const t=(e=n.event.content)==null?void 0:e.session_key,s=new op(n);if(typeof s.roomId=="string"&&typeof s.sessionId=="string"&&typeof s.senderKey=="string"&&typeof t=="string")return s}function ea(n,e,t){var s;const i=t.session_key,r=t.sender_key,o=(s=t.sender_claimed_keys)==null?void 0:s.ed25519;if(typeof n=="string"&&typeof e=="string"&&typeof r=="string"&&typeof i=="string"&&typeof o=="string")return new lp(n,e,t)}async function ta(n,e,t,s){const i=await s.inboundGroupSessions.get(n,e,t);if(i)return new Zo(i)}class hp{constructor(e,t){this.keyLoader=e,this.olmWorker=t}async addMissingKeyEventIds(e,t,s,i,r){let o=await r.inboundGroupSessions.get(e,t,s);if(!o?.session){if(o){const a=new Set(o.eventIds);for(const l of i)a.add(l);o.eventIds=Array.from(a)}else o={roomId:e,senderKey:t,sessionId:s,eventIds:i};r.inboundGroupSessions.set(o)}}async getEventIdsForMissingKey(e,t,s,i){const r=await i.inboundGroupSessions.get(e,t,s);if(r&&!r.session)return r.eventIds}async hasSession(e,t,s,i){const r=await i.inboundGroupSessions.get(e,t,s);return typeof r?.session=="string"}async prepareDecryptAll(e,t,s,i){const r=new Map,o=[];for(const c of t)rp(c)?o.push(c):r.set(c.event_id,new Y("MEGOLM_INVALID_EVENT",c));const a=Ai(o),l=[];return await Promise.all(Array.from(a.values()).map(async c=>{const h=await this.getRoomKey(e,c.senderKey,c.sessionId,s,i);if(h)l.push(new sp(h,c.events,this.olmWorker,this.keyLoader));else for(const d of c.events)r.set(d.event_id,new Y("MEGOLM_NO_SESSION",d))})),new ep(e,l,r)}async getRoomKey(e,t,s,i,r){if(i){const l=i.find(c=>c.isForSession(e,t,s));if(l&&await l.checkBetterThanKeyInStorage(this.keyLoader,r))return l}const o=this.keyLoader.getCachedKey(e,t,s);if(o)return o;const a=await ta(e,t,s,r);if(a&&a.serializationKey)return a}writeRoomKey(e,t){return e.write(this.keyLoader,t)}roomKeysFromDeviceMessages(e,t){var s,i;const r=[];for(const o of e)((s=o.event)==null?void 0:s.type)!=="m.room_key"||((i=o.event.content)==null?void 0:i.algorithm)!==ke||t.wrap("room_key",a=>{const l=cp(o);l?(a.set("roomId",l.roomId),a.set("id",l.sessionId),r.push(l)):(a.logLevel=a.level.Warn,a.set("invalid",!0))},t.level.Detail);return r}roomKeyFromBackup(e,t,s){return ea(e,t,s)}dispose(){this.keyLoader.dispose()}}class dp extends Bo{constructor(e,t,s){super(s),this.pickleKey=t,this.olm=e}getCachedKey(e,t,s){const i=this.findCachedKeyIndex(e,t,s);if(i!==-1)return this._getByIndexAndMoveUp(i).key}async useKey(e,t){const s=await this.allocateOperation(e);try{return await t(s.session,this.pickleKey)}finally{this.releaseOperation(s)}}get running(){return this._entries.some(e=>e.refCount!==0)}dispose(){for(let e=0;e<this._entries.length;e+=1)this._entries[e].dispose();this._entries.splice(0,this._entries.length)}async allocateOperation(e){let t;for(;(t=this.findIndexForAllocation(e))===-1;)await this.operationBecomesUnused();if(t<this.size){const s=this._getByIndexAndMoveUp(t);return s.isForKey(e)?(s.refCount+=1,s):(s.refCount=1,s.key=e,e.loadInto(s.session,this.pickleKey),s)}else{const s=new this.olm.InboundGroupSession;e.loadInto(s,this.pickleKey);const i=new up(e,s);return this._set(i),i}}releaseOperation(e){e.refCount-=1,e.refCount<=0&&this.resolveUnusedOperation&&(this.resolveUnusedOperation(),this.operationBecomesUnusedPromise=this.resolveUnusedOperation=void 0)}operationBecomesUnused(){return this.operationBecomesUnusedPromise||(this.operationBecomesUnusedPromise=new Promise(e=>{this.resolveUnusedOperation=e})),this.operationBecomesUnusedPromise}findIndexForAllocation(e){let t=this.findIndexSameKey(e);return t===-1&&(this.size<this.limit?t=this.size:(t=this.findIndexSameSessionUnused(e),t===-1&&(t=this.findIndexOldestUnused()))),t}findCachedKeyIndex(e,t,s){return this._entries.reduce((i,r,o,a)=>{const l=i===-1?void 0:a[i];return r.isBest===!0&&r.isForSameSession(e,t,s)&&(!l||r.isBetter(l))?o:i},-1)}findIndexSameKey(e){return this._entries.findIndex(t=>t.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&t.isForKey(e))}findIndexSameSessionUnused(e){return this._entries.reduce((t,s,i,r)=>{const o=t===-1?void 0:r[t];return s.refCount===0&&s.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&(!o||!s.isBetter(o))?i:t},-1)}findIndexOldestUnused(){for(let e=this._entries.length-1;e>=0;e-=1)if(this._entries[e].refCount===0)return e;return-1}}class up{constructor(e,t){this.key=e,this.session=t,this.refCount=1}isForSameSession(e,t,s){return this.key.roomId===e&&this.key.senderKey===t&&this.key.sessionId===s}isBetter(e){return Xo(this.session,e.session)}isForKey(e){return this.key.serializationKey===e.serializationKey&&this.key.serializationType===e.serializationType}dispose(){this.session.free(),this.session=void 0}get isBest(){return this.key.isBetter}}const mp="m.megolm_backup.v1.curve25519-aes-sha2";class tr{constructor(e,t){this.encryption=e,this.decryption=t}static fromAuthData(e,t,s){const i=e.public_key,r=new s.PkDecryption,o=new s.PkEncryption;try{const a=r.init_with_private_key(t);if(a!==i)throw new Error(`Bad backup key, public key does not match. Calculated ${a} but expected ${i}`);o.set_recipient_key(a)}catch(a){throw r.free(),a}return new tr(o,r)}decryptRoomKey(e){const t=this.decryption.decrypt(e.ephemeral,e.mac,e.ciphertext);return JSON.parse(t)}encryptRoomKey(e,t){const s={algorithm:ke,sender_key:e.senderKey,sender_claimed_keys:{ed25519:e.claimedEd25519Key},forwarding_curve25519_key_chain:[],session_key:t};return this.encryption.encrypt(JSON.stringify(s))}dispose(){var e,t;(e=this.decryption)==null||e.free(),this.decryption=void 0,(t=this.encryption)==null||t.free(),this.encryption=void 0}}const pp=200;class sr{constructor(e,t,s,i,r,o,a=1e4){this.backupInfo=e,this.crypto=t,this.hsApi=s,this.keyLoader=i,this.storage=r,this.platform=o,this.maxDelay=a,this.operationInProgress=new Ee(void 0),this._stopped=!1,this._needsNewKey=!1,this._hasBackedUpAllKeys=!1}get hasStopped(){return this._stopped}get error(){return this._error}get version(){return this.backupInfo.version}get needsNewKey(){return this._needsNewKey}get hasBackedUpAllKeys(){return this._hasBackedUpAllKeys}async getRoomKey(e,t,s){const i=await this.hsApi.roomKeyForRoomAndSession(this.backupInfo.version,e,t,{log:s}).response();if(!i.session_data)return;const r=this.crypto.decryptRoomKey(i.session_data);if(r?.algorithm===ke)return ea(e,t,r);r?.algorithm&&s.set("unknown algorithm",r.algorithm)}markAllForBackup(e){return e.inboundGroupSessions.markAllAsNotBackedUp()}flush(e){this.operationInProgress.get()||e.wrapDetached("flush key backup",async t=>{if(this._needsNewKey){t.set("needsNewKey",this._needsNewKey);return}this._stopped=!1,this._error=void 0,this._hasBackedUpAllKeys=!1;const s=this._runFlushOperation(t);this.operationInProgress.set(s);try{await s.result,this._hasBackedUpAllKeys=!0}catch(i){this._stopped=!0,i.name==="HomeServerError"&&(i.errcode==="M_WRONG_ROOM_KEYS_VERSION"||i.errcode==="M_NOT_FOUND")?(t.set("wrong_version",!0),this._needsNewKey=!0):(i.name!=="AbortError"||i.name==="StorageError"&&i.errcode==="AbortError")&&(this._error=i),t.catch(i)}this.operationInProgress.set(void 0)})}_runFlushOperation(e){return new Ao(async(t,s)=>{let i=0,r=0;for(;;){const o=this.platform.random()*this.maxDelay,a=this.platform.clock.createTimeout(o);t(a),await a.elapsed();const l=await this.storage.readTxn([V.inboundGroupSessions]);t(l),i=r+await l.inboundGroupSessions.countNonBackedUpSessions(),s(new In(i,r));const c=(await l.inboundGroupSessions.getFirstNonBackedUpSessions(pp)).map(m=>new Zo(m));if(c.length===0){e.set("total",i);return}const h=await this.encodeKeysForBackup(c),d=this.hsApi.uploadRoomKeysToBackup(this.backupInfo.version,h,{log:e});t(d),await d.response(),await this.markKeysAsBackedUp(c,t),r+=c.length,s(new In(i,r))}})}async encodeKeysForBackup(e){const t={rooms:{}},s=t.rooms;for(const i of e){let r=s[i.roomId];r||(r=s[i.roomId]={sessions:{}}),r.sessions[i.sessionId]=await this.encodeRoomKey(i)}return t}async markKeysAsBackedUp(e,t){const s=await this.storage.readWriteTxn([V.inboundGroupSessions]);t(s);try{await Promise.all(e.map(i=>s.inboundGroupSessions.markAsBackedUp(i.roomId,i.senderKey,i.sessionId)))}catch(i){throw s.abort(),i}await s.complete()}async encodeRoomKey(e){return await this.keyLoader.useKey(e,t=>{const s=t.first_known_index(),i=t.export_session(s);return{first_message_index:s,forwarded_count:0,is_verified:!1,session_data:this.crypto.encryptRoomKey(e,i)}})}dispose(){this.crypto.dispose()}static async fromSecretStorage(e,t,s,i,r,o,a){const l=await s.readSecret("m.megolm_backup.v1",a);if(l){const c=new Uint8Array(e.encoding.base64.decode(l)),h=await i.roomKeysVersion().response();if(h.algorithm===mp){const d=tr.fromAuthData(h.auth_data,c,t);return new sr(h,d,i,r,o,e)}else throw new Error(`Unknown backup algorithm: ${h.algorithm}`)}}}class In{constructor(e,t){this.total=e,this.finished=t}}class _p{constructor({pickleKey:e,olm:t,account:s,keyLoader:i,storage:r,now:o,ownDeviceId:a}){this._pickleKey=e,this._olm=t,this._account=s,this._keyLoader=i,this._storage=r,this._now=o,this._ownDeviceId=a}discardOutboundSession(e,t){t.outboundGroupSessions.remove(e)}async createRoomKeyMessage(e,t){let s=await t.outboundGroupSessions.get(e);if(s){const i=new this._olm.OutboundGroupSession;try{return i.unpickle(this._pickleKey,s.session),this._createRoomKeyMessage(i,e)}finally{i.free()}}}createWithheldMessage(e,t,s){return{algorithm:e.algorithm,code:t,reason:s,room_id:e.room_id,sender_key:this._account.identityKeys.curve25519,session_id:e.session_id}}async ensureOutboundSession(e,t){let s=new this._olm.OutboundGroupSession;try{const i=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let r;try{let o=await i.outboundGroupSessions.get(e);r=await this._readOrCreateSession(s,o,e,t,i),r&&this._writeSession(this._now(),s,e,i)}catch(o){throw i.abort(),o}return await i.complete(),r}finally{s.free()}}async _readOrCreateSession(e,t,s,i,r){if(t&&e.unpickle(this._pickleKey,t.session),!t||this._needsToRotate(e,t.createdAt,i)){t&&(e.free(),e=new this._olm.OutboundGroupSession),e.create();const o=this._createRoomKeyMessage(e,s);return await new ap(s,e,this._account.identityKeys).write(this._keyLoader,r),o}}_writeSession(e,t,s,i){i.outboundGroupSessions.set({roomId:s,session:t.pickle(this._pickleKey),createdAt:e})}async encrypt(e,t,s,i){let r=new this._olm.OutboundGroupSession;try{const o=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let a,l;try{let c=await o.outboundGroupSessions.get(e);a=await this._readOrCreateSession(r,c,e,i,o),l=this._encryptContent(e,r,t,s);const h=a?this._now():c.createdAt;this._writeSession(h,r,e,o)}catch(c){throw o.abort(),c}return await o.complete(),new gp(l,a)}finally{r&&r.free()}}_needsToRotate(e,t,s){let i=6048e5;Number.isSafeInteger(s?.rotation_period_ms)&&(i=s?.rotation_period_ms);let r=100;if(Number.isSafeInteger(s?.rotation_period_msgs)&&(r=s?.rotation_period_msgs),this._now()>t+i||e.message_index()>=r)return!0}_encryptContent(e,t,s,i){const r=JSON.stringify({room_id:e,type:s,content:i}),o=t.encrypt(r);return{algorithm:ke,sender_key:this._account.identityKeys.curve25519,ciphertext:o,session_id:t.session_id(),device_id:this._ownDeviceId}}_createRoomKeyMessage(e,t){return{room_id:t,session_id:e.session_id(),session_key:e.session_key(),algorithm:ke,chain_index:e.message_index()}}}class gp{constructor(e,t){this.content=e,this.roomKeyMessage=t}}const En="m.room.encrypted",kn="m.room.history_visibility",fp=60*1e3;class yp{constructor({room:e,deviceTracker:t,olmEncryption:s,megolmEncryption:i,megolmDecryption:r,encryptionParams:o,storage:a,keyBackup:l,notifyMissingMegolmSession:c,clock:h}){this._room=e,this._deviceTracker=t,this._olmEncryption=s,this._megolmEncryption=i,this._megolmDecryption=r,this._encryptionParams=o,this._senderDeviceCache=new Map,this._storage=a,this._keyBackup=l,this._notifyMissingMegolmSession=c,this._clock=h,this._isFlushingRoomKeyShares=!1,this._lastKeyPreShareTime=null,this._keySharePromise=null,this._historyVisibility=void 0,this._disposed=!1}enableKeyBackup(e){this._keyBackup&&!!e||(this._keyBackup=e)}async restoreMissingSessionsFromBackup(e,t){const s=e.filter(h=>h.isEncrypted&&!h.isDecrypted&&h.event).map(h=>h.event),i=Ai(s),r=Array.from(i.values()),o=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]),a=await Promise.all(r.map(async h=>this._megolmDecryption.hasSession(this._room.id,h.senderKey,h.sessionId,o))),l=r.filter((h,d)=>!a[d]);if(l.length)for(var c=l.length-1;c>=0;c--){const h=l[c];await t.wrap("session",d=>this._requestMissingSessionFromBackup(h.senderKey,h.sessionId,d))}}notifyTimelineClosed(){this._senderDeviceCache=new Map}async writeSync(e,t,s,i){let r=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility,s);const o=[],a=[];if(await Wl(e,c=>{var h;if(c.state_key===""&&c.type===kn){const d=(h=c?.content)==null?void 0:h.history_visibility;if(d!==r)return i.wrap({l:"history_visibility changed",from:r,to:d},async m=>{r=d;const p=await this._deviceTracker.writeHistoryVisibility(this._room,r,s,m);o.push(...p.added),a.push(...p.removed)})}}),t.size){const c=await this._deviceTracker.writeMemberChanges(this._room,t,r,s);o.push(...c.added),a.push(...c.removed)}a.length&&(i.log({l:"discardOutboundSession",leftUsers:a}),this._megolmEncryption.discardOutboundSession(this._room.id,s));let l=!1;return o.length&&(l=await this._addShareRoomKeyOperationForMembers(o,s,i)),{shouldFlush:l,historyVisibility:r}}afterSync({historyVisibility:e}){this._historyVisibility=e}async _loadHistoryVisibilityIfNeeded(e,t=void 0){var s,i;if(!e){t||(t=await this._storage.readTxn([this._storage.storeNames.roomState]));const r=await t.roomState.get(this._room.id,kn,"");if(r)return(i=(s=r.event)==null?void 0:s.content)==null?void 0:i.history_visibility}return e}async prepareDecryptAll(e,t,s,i){var r,o,a;const l=new Map,c=[];for(const d of e)d.redacted_because||((r=d.unsigned)==null?void 0:r.redacted_because)||(((o=d.content)==null?void 0:o.algorithm)!==ke&&l.set(d.event_id,new Error("Unsupported algorithm: "+((a=d.content)==null?void 0:a.algorithm))),c.push(d));const h=await this._megolmDecryption.prepareDecryptAll(this._room.id,c,t,i);return new vp(h,l,s,this,e)}async _processDecryptionResults(e,t,s,i,r,o){const a=e.filter(c=>{const h=s.get(c.event_id);return h?.code==="MEGOLM_NO_SESSION"});if(!a.length)return;const l=Ai(a);i===nt.Sync&&await Promise.all(Array.from(l.values()).map(async c=>{const h=c.events.map(d=>d.event_id);return this._megolmDecryption.addMissingKeyEventIds(this._room.id,c.senderKey,c.sessionId,h,r)})),this._keyBackup&&o.wrapDetached("check key backup",async c=>{if(c.set("source",i),c.set("events",a.length),c.set("sessions",l.size),i===nt.Sync){if(await this._clock.createTimeout(1e4).elapsed(),this._disposed)return;const h=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]);await Promise.all(Array.from(l).map(async([d,m])=>{await this._megolmDecryption.hasSession(this._room.id,m.senderKey,m.sessionId,h)&&l.delete(d)}))}await Promise.all(Array.from(l.values()).map(h=>c.wrap("session",d=>this._requestMissingSessionFromBackup(h.senderKey,h.sessionId,d))))})}async _verifyDecryptionResult(e,t){let s=this._senderDeviceCache.get(e.senderCurve25519Key);s||(s=await this._deviceTracker.getDeviceByCurve25519Key(e.senderCurve25519Key,t),this._senderDeviceCache.set(e.senderCurve25519Key,s)),s?e.setDevice(s):this._room.isTrackingMembers||e.setRoomNotTrackedYet()}async _requestMissingSessionFromBackup(e,t,s){if(!this._keyBackup){s.set("enabled",!1),this._notifyMissingMegolmSession();return}s.set("id",t),s.set("senderKey",e);try{const i=await this._keyBackup.getRoomKey(this._room.id,t,s);if(i){if(i.senderKey!==e){s.set("wrong_sender_key",i.senderKey),s.logLevel=s.level.Warn;return}let r=!1,o;const a=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions]);try{r=await this._megolmDecryption.writeRoomKey(i,a),s.set("isBetter",r),r&&(o=i.eventIds)}catch(l){throw a.abort(),l}await a.complete(),r&&await s.wrap("retryDecryption",l=>this._room.notifyRoomKey(i,o||[],l))}}catch(i){i.name==="HomeServerError"&&i.errcode==="M_NOT_FOUND"?(s.error=i,s.logLevel=s.level.Error):s.set("not_found",!0)}}getEventIdsForMissingKey(e,t){return this._megolmDecryption.getEventIdsForMissingKey(this._room.id,e.senderKey,e.sessionId,t)}async ensureMessageKeyIsShared(e,t){var s;if(!(((s=this._lastKeyPreShareTime)==null?void 0:s.measure())<fp)){this._lastKeyPreShareTime=this._clock.createMeasure();try{this._keySharePromise=(async()=>{var i;const r=await this._megolmEncryption.ensureOutboundSession(this._room.id,this._encryptionParams);r&&((i=this._keyBackup)==null||i.flush(t),await t.wrap("share key",o=>this._shareNewRoomKey(r,e,o)))})(),await this._keySharePromise}finally{this._keySharePromise=null}}}async encrypt(e,t,s,i){var r;this._keySharePromise&&(i.set("waitForRunningKeyShare",!0),await this._keySharePromise);const o=await i.wrap("megolm encrypt",()=>this._megolmEncryption.encrypt(this._room.id,e,t,this._encryptionParams));return o.roomKeyMessage&&((r=this._keyBackup)==null||r.flush(i),await i.wrap("share key",a=>this._shareNewRoomKey(o.roomKeyMessage,s,a))),{type:En,content:o.content}}needsToShareKeys(e){for(const t of e.values())if(t.hasJoined)return!0;return!1}async _shareNewRoomKey(e,t,s){this._historyVisibility=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility),await this._deviceTracker.trackRoom(this._room,this._historyVisibility,s);const i=await this._deviceTracker.devicesForTrackedRoom(this._room.id,t,s),r=Array.from(i.reduce((l,c)=>l.add(c.userId),new Set));let o=await this._storage.readWriteTxn([this._storage.storeNames.operations]),a;try{a=this._writeRoomKeyShareOperation(e,r,o)}catch(l){throw o.abort(),l}await this._processShareRoomKeyOperation(a,t,s)}async _addShareRoomKeyOperationForMembers(e,t,s){const i=await this._megolmEncryption.createRoomKeyMessage(this._room.id,t);return i?(s.log({l:"share key for new members",userIds:e,id:i.session_id,chain_index:i.chain_index}),this._writeRoomKeyShareOperation(i,e,t),!0):!1}async flushPendingRoomKeyShares(e,t,s){if(!this._isFlushingRoomKeyShares){this._isFlushingRoomKeyShares=!0;try{t||(t=await(await this._storage.readTxn([this._storage.storeNames.operations])).operations.getAllByTypeAndScope("share_room_key",this._room.id));for(const i of t)i.type==="share_room_key"&&await s.wrap("operation",r=>this._processShareRoomKeyOperation(i,e,r))}finally{this._isFlushingRoomKeyShares=!1}}}_writeRoomKeyShareOperation(e,t,s){const r={id:Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(),type:"share_room_key",scope:this._room.id,userIds:t,roomKeyMessage:e};return s.operations.add(r),r}async _processShareRoomKeyOperation(e,t,s){s.set("id",e.id),this._historyVisibility=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility),await this._deviceTracker.trackRoom(this._room,this._historyVisibility,s);const i=await this._deviceTracker.devicesForRoomMembers(this._room.id,e.userIds,t,s),r=await s.wrap("olm encrypt",a=>this._olmEncryption.encrypt("m.room_key",e.roomKeyMessage,i,t,a)),o=i.filter(a=>!r.some(l=>l.device===a));await s.wrap("send",a=>this._sendMessagesToDevices(En,r,t,a)),o.length&&await s.wrap("missingDevices",async a=>{a.set("devices",o.map(h=>h.deviceId));const l=e.userIds.filter(h=>o.some(d=>d.userId===h));a.set("unsentUserIds",l),e.userIds=l,await this._updateOperationsStore(h=>h.update(e));const c=this._megolmEncryption.createWithheldMessage(e.roomKeyMessage,"m.no_olm","OTKs exhausted");await this._sendSharedMessageToDevices("org.matrix.room_key.withheld",c,o,t,a)}),await this._updateOperationsStore(a=>a.remove(e.id))}async _updateOperationsStore(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.operations]);try{e(t.operations)}catch(s){throw t.abort(),s}await t.complete()}async _sendSharedMessageToDevices(e,t,s,i,r){const o=Rt(s,c=>c.userId),a={messages:Array.from(o.entries()).reduce((c,[h,d])=>(c[h]=d.reduce((m,p)=>(m[p.deviceId]=t,m),{}),c),{})},l=Bs();await i.sendToDevice(e,a,l,{log:r}).response()}async _sendMessagesToDevices(e,t,s,i){i.set("messages",t.length);const r=Rt(t,l=>l.device.userId),o={messages:Array.from(r.entries()).reduce((l,[c,h])=>(l[c]=h.reduce((d,m)=>(d[m.device.deviceId]=m.content,d),{}),l),{})},a=Bs();await s.sendToDevice(e,o,a,{log:i}).response()}filterUndecryptedEventEntriesForKeys(e,t){return e.filter(s=>{var i,r;if(s.isEncrypted&&!s.isDecrypted){const{event:o}=s;if(o){const a=(i=o.content)==null?void 0:i.sender_key,l=(r=o.content)==null?void 0:r.session_id;return t.some(c=>a===c.senderKey&&l===c.sessionId)}}return!1})}dispose(){this._disposed=!0}}class vp{constructor(e,t,s,i,r){this._megolmDecryptionPreparation=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=r}async decrypt(){return new wp(await this._megolmDecryptionPreparation.decrypt(),this._extraErrors,this._source,this._roomEncryption,this._events)}dispose(){this._megolmDecryptionPreparation.dispose()}}class wp{constructor(e,t,s,i,r){this._megolmDecryptionChanges=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=r}async write(e,t){const{results:s,errors:i}=await this._megolmDecryptionChanges.write(e);return Mi(this._extraErrors,i),await this._roomEncryption._processDecryptionResults(this._events,s,i,this._source,e,t),new bp(s,i,this._roomEncryption)}}class bp{constructor(e,t,s){this.results=e,this.errors=t,this._roomEncryption=s}applyToEntries(e){for(const t of e){const s=this.results.get(t.id);if(s)t.setDecryptionResult(s);else{const i=this.errors.get(t.id);i&&t.setDecryptionError(i)}}}verifySenders(e){return Promise.all(Array.from(this.results.values()).map(t=>this._roomEncryption._verifyDecryptionResult(t,e)))}}const xi=0,Rn=1;function Sp(n,e,t){if(n){if(!n.roomIds.includes(t))return n.roomIds.push(t),n}else return n={userId:e,roomIds:[t],deviceTrackingStatus:xi},n}function Ip(n){var e;const t=n.device_id;return{userId:n.user_id,deviceId:t,ed25519Key:n.keys[`ed25519:${t}`],curve25519Key:n.keys[`curve25519:${t}`],algorithms:n.algorithms,displayName:(e=n.unsigned)==null?void 0:e.device_display_name}}class Ep{constructor({storage:e,getSyncToken:t,olmUtil:s,ownUserId:i,ownDeviceId:r}){this._storage=e,this._getSyncToken=t,this._identityChangedForRoom=null,this._olmUtil=s,this._ownUserId=i,this._ownDeviceId=r}async writeDeviceChanges(e,t,s){const{userIdentities:i}=t;s.set("changed",e.length),await Promise.all(e.map(async r=>{const o=await i.get(r);o&&(s.log({l:"outdated",id:r}),o.deviceTrackingStatus=xi,i.set(o))}))}async writeMemberChanges(e,t,s,i){const r=[],o=[];return await Promise.all(Array.from(t.values()).map(async a=>{if(gs(a.membership,s))await this._addRoomToUserIdentity(a.roomId,a.userId,i)&&r.push(a.userId);else if(gs(a.previousMembership,s)){const{roomId:l}=a;if(a.userId===this._ownUserId){const c=await i.roomMembers.getAllUserIds(l);await Promise.all(c.map(h=>this._removeRoomFromUserIdentity(l,h,i)))}else await this._removeRoomFromUserIdentity(l,a.userId,i);o.push(a.userId)}})),{added:r,removed:o}}async trackRoom(e,t,s){if(e.isTrackingMembers||!e.isEncrypted)return;const i=await e.loadMemberList(void 0,s),r=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary,this._storage.storeNames.userIdentities]);try{let o;try{o=e.writeIsTrackingMembers(!0,r);const a=Array.from(i.members.values());s.set("members",a.length),await Promise.all(a.map(async l=>{gs(l.membership,t)&&await this._addRoomToUserIdentity(l.roomId,l.userId,r)}))}catch(a){throw r.abort(),a}await r.complete(),e.applyIsTrackingMembersChanges(o)}finally{i.release()}}async writeHistoryVisibility(e,t,s,i){const r=[],o=[];return e.isTrackingMembers&&e.isEncrypted&&await i.wrap("rewriting userIdentities",async a=>{const l=await e.loadMemberList(s,a);try{const c=Array.from(l.members.values());a.set("members",c.length),await Promise.all(c.map(async h=>{gs(h.membership,t)?await this._addRoomToUserIdentity(h.roomId,h.userId,s)&&r.push(h.userId):await this._removeRoomFromUserIdentity(h.roomId,h.userId,s)&&o.push(h.userId)}))}finally{l.release()}}),{added:r,removed:o}}async _addRoomToUserIdentity(e,t,s){const{userIdentities:i}=s,r=await i.get(t),o=Sp(r,t,e);return o?(i.set(o),!0):!1}async _removeRoomFromUserIdentity(e,t,s){const{userIdentities:i,deviceIdentities:r}=s,o=await i.get(t);return o?(o.roomIds=o.roomIds.filter(a=>a!==e),o.roomIds.length===0?(i.remove(t),r.removeAllForUser(t)):i.set(o),!0):!1}async _queryKeys(e,t,s){const i=await t.queryKeys({timeout:1e4,device_keys:e.reduce((l,c)=>(l[c]=[],l),{}),token:this._getSyncToken()},{log:s}).response(),r=s.wrap("verify",l=>this._filterVerifiedDeviceKeys(i.device_keys,l)),o=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.deviceIdentities]);let a;try{a=(await Promise.all(r.map(async({userId:c,verifiedKeys:h})=>{const d=h.map(Ip);return await this._storeQueriedDevicesForUserId(c,d,o)}))).reduce((c,h)=>c.concat(h),[]),s.set("devices",a.length)}catch(l){throw o.abort(),l}return await o.complete(),a}async _storeQueriedDevicesForUserId(e,t,s){const i=await s.deviceIdentities.getAllDeviceIds(e);for(const l of i)t.every(c=>c.deviceId!==l)&&s.deviceIdentities.remove(e,l);const r=[],o=[];await Promise.all(t.map(async l=>{if(i.includes(l.deviceId)){const c=await s.deviceIdentities.get(l.userId,l.deviceId);if(c.ed25519Key!==l.ed25519Key){r.push(c);return}}r.push(l),o.push(l)}));for(const l of o)s.deviceIdentities.set(l);const a=await s.userIdentities.get(e);return a.deviceTrackingStatus=Rn,s.userIdentities.set(a),r}_filterVerifiedDeviceKeys(e,t){const s=new Set;return Object.entries(e).map(([r,o])=>{const l=Object.entries(o).filter(([c,h])=>{var d,m;const p=h.device_id;if(h.user_id!==r||p!==c)return!1;const g=(d=h.keys)==null?void 0:d[`ed25519:${c}`],b=(m=h.keys)==null?void 0:m[`curve25519:${c}`];if(typeof g!="string"||typeof b!="string")return!1;if(s.has(b))return t.log({l:"ignore device with duplicate curve25519 key",keys:h},t.level.Warn),!1;s.add(b);const S=this._hasValidSignature(h,t);return S||t.log({l:"ignore device with invalid signature",keys:h},t.level.Warn),S}).map(([,c])=>c);return{userId:r,verifiedKeys:l}})}_hasValidSignature(e,t){var s;const i=e.device_id,r=e.user_id,o=(s=e?.keys)==null?void 0:s[`${eo}:${i}`];return to(this._olmUtil,r,i,o,e,t)}async devicesForTrackedRoom(e,t,s){const i=await this._storage.readTxn([this._storage.storeNames.roomMembers,this._storage.storeNames.userIdentities]),r=await i.roomMembers.getAllUserIds(e);return await this._devicesForUserIds(e,r,i,t,s)}async devicesForRoomMembers(e,t,s,i){const r=await this._storage.readTxn([this._storage.storeNames.userIdentities]);return await this._devicesForUserIds(e,t,r,s,i)}async _devicesForUserIds(e,t,s,i,r){const a=(await Promise.all(t.map(g=>s.userIdentities.get(g)))).filter(g=>g&&g.roomIds.includes(e)),l=a.filter(g=>g.deviceTrackingStatus===Rn),c=a.filter(g=>g.deviceTrackingStatus===xi);r.set("uptodate",l.length),r.set("outdated",c.length);let h;c.length&&(h=await this._queryKeys(c.map(g=>g.userId),i,r));const d=await this._storage.readTxn([this._storage.storeNames.deviceIdentities]);let p=(await Promise.all(l.map(g=>d.deviceIdentities.getAllForUserId(g.userId)))).reduce((g,b)=>g.concat(b),[]);return h&&h.length&&(p=p.concat(h)),p.filter(g=>!(g.userId===this._ownUserId&&g.deviceId===this._ownDeviceId))}async getDeviceByCurve25519Key(e,t){return await t.deviceIdentities.getByCurve25519Key(e)}}class kp{constructor(){this._map=new Map}async takeLock(e){let t=this._map.get(e);return t?await t.take():(t=new Hm,t.tryTake(),this._map.set(e,t)),t.released().then(()=>{Promise.resolve().then(()=>{t.isTaken||this._map.delete(e)})}),t}}class Rp{constructor({key:e,platform:t}){this._key=e,this._platform=t}async readSecret(e,t){var s,i;const r=await t.accountData.get(e);if(!r)return;const o=(i=(s=r?.content)==null?void 0:s.encrypted)==null?void 0:i[this._key.id];if(!o)throw new Error(`Secret ${r.type} is not encrypted for key ${this._key.id}`);if(this._key.algorithm==="m.secret_storage.v1.aes-hmac-sha2")return await this._decryptAESSecret(r.type,o);throw new Error(`Unsupported algorithm for key ${this._key.id}: ${this._key.algorithm}`)}async _decryptAESSecret(e,t){const{base64:s,utf8:i}=this._platform.encoding,r=await this._platform.crypto.derive.hkdf(this._key.binaryKey,new Uint8Array(8).buffer,i.encode(e),"SHA-256",512),o=r.slice(0,32),a=r.slice(32),l=s.decode(t.ciphertext);if(!await this._platform.crypto.hmac.verify(a,s.decode(t.mac),l,"SHA-256"))throw new Error("Bad MAC");const h=await this._platform.crypto.aes.decryptCTR({key:o,iv:s.decode(t.iv),data:l});return i.decode(h)}}const st="DEFAULT_KEY",Ut="pusher";class Cp{constructor({storage:e,hsApi:t,sessionInfo:s,olm:i,olmWorker:r,platform:o,mediaRepository:a}){this._platform=o,this._storage=e,this._hsApi=t,this._mediaRepository=a,this._syncInfo=null,this._sessionInfo=s,this._rooms=new Gt,this._roomUpdateCallback=(l,c)=>this._rooms.update(l.id,c),this._activeArchivedRooms=new Map,this._invites=new Gt,this._inviteUpdateCallback=(l,c)=>this._invites.update(l.id,c),this._roomsBeingCreatedUpdateCallback=(l,c)=>{l.isCancelled?this._roomsBeingCreated.remove(l.id):this._roomsBeingCreated.update(l.id,c)},this._roomsBeingCreated=new Gt,this._user=new sm(s.userId),this._deviceMessageHandler=new Mm({storage:e}),this._olm=i,this._olmUtil=null,this._e2eeAccount=null,this._deviceTracker=null,this._olmEncryption=null,this._keyLoader=null,this._megolmEncryption=null,this._megolmDecryption=null,this._getSyncToken=()=>this.syncToken,this._olmWorker=r,this._keyBackup=new Ee(void 0),this._observedRoomStatus=new Map,i&&(this._olmUtil=new i.Utility,this._deviceTracker=new Ep({storage:e,getSyncToken:this._getSyncToken,olmUtil:this._olmUtil,ownUserId:s.userId,ownDeviceId:s.deviceId})),this._createRoomEncryption=this._createRoomEncryption.bind(this),this._forgetArchivedRoom=this._forgetArchivedRoom.bind(this),this.needsKeyBackup=new Ee(!1)}get fingerprintKey(){var e;return(e=this._e2eeAccount)==null?void 0:e.identityKeys.ed25519}get hasSecretStorageKey(){return this._hasSecretStorageKey}get deviceId(){return this._sessionInfo.deviceId}get userId(){return this._sessionInfo.userId}_setupEncryption(){const e=new kp,t=new zm(this._e2eeAccount,st,this._platform.clock.now,this._user.id,this._olm,e);this._olmEncryption=new Qm(this._e2eeAccount,st,this._olm,this._storage,this._platform.clock.now,this._user.id,this._olmUtil,e),this._keyLoader=new dp(this._olm,st,20),this._megolmEncryption=new _p({account:this._e2eeAccount,pickleKey:st,olm:this._olm,storage:this._storage,keyLoader:this._keyLoader,now:this._platform.clock.now,ownDeviceId:this._sessionInfo.deviceId}),this._megolmDecryption=new hp(this._keyLoader,this._olmWorker),this._deviceMessageHandler.enableEncryption({olmDecryption:t,megolmDecryption:this._megolmDecryption})}_createRoomEncryption(e,t){var s;if(!this._olmEncryption)throw new Error("creating room encryption before encryption got globally enabled");return t.algorithm!==ke?null:new yp({room:e,deviceTracker:this._deviceTracker,olmEncryption:this._olmEncryption,megolmEncryption:this._megolmEncryption,megolmDecryption:this._megolmDecryption,storage:this._storage,keyBackup:(s=this._keyBackup)==null?void 0:s.get(),encryptionParams:t,notifyMissingMegolmSession:()=>{this._keyBackup.get()||this.needsKeyBackup.set(!0)},clock:this._platform.clock})}enableSecretStorage(e,t,s=void 0){return this._platform.logger.wrapOrRun(s,"enable secret storage",async i=>{if(!this._olm)throw new Error("olm required");this._keyBackup.get()&&(this._keyBackup.get().dispose(),this._keyBackup.set(null));const r=await Fm(e,t,this._storage,this._platform,this._olm),o=await this._storage.readTxn([this._storage.storeNames.accountData]);if(await this._createKeyBackup(r,o,i))return await this._writeSSSSKey(r,i),this._keyBackup.get().flush(i),r;throw new Error("Could not read key backup with the given key")})}async _writeSSSSKey(e,t){const s=this._keyBackup.get();if(!s)return;const i=s.version,r=await this._storage.readWriteTxn([this._storage.storeNames.session,this._storage.storeNames.inboundGroupSessions]);try{const o=await Pm(e,i,r);if(t.set("previousBackupVersion",o),t.set("backupVersion",i),!!o&&o!==i){const a=await s.markAllForBackup(r);t.set("amountMarkedForBackup",a)}}catch(o){throw r.abort(),o}await r.complete()}async disableSecretStorage(){const e=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{Um(e)}catch(t){throw e.abort(),t}if(await e.complete(),this._keyBackup.get()){for(const t of this._rooms.values())t.isEncrypted&&t.enableKeyBackup(void 0);this._keyBackup.get().dispose(),this._keyBackup.set(null)}}_createKeyBackup(e,t,s){return s.wrap("enable key backup",async i=>{try{const r=new Rp({key:e,platform:this._platform}),o=await sr.fromSecretStorage(this._platform,this._olm,r,this._hsApi,this._keyLoader,this._storage,t);if(o){for(const a of this._rooms.values())a.isEncrypted&&a.enableKeyBackup(o);return this._keyBackup.set(o),!0}}catch(r){i.catch(r)}return!1})}get keyBackup(){return this._keyBackup}get hasIdentity(){return!!this._e2eeAccount}async createIdentity(e){this._olm&&(this._e2eeAccount||(this._e2eeAccount=await this._createNewAccount(this._sessionInfo.deviceId,this._storage),e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()),await this._e2eeAccount.generateOTKsIfNeeded(this._storage,e),await e.wrap("uploadKeys",t=>this._e2eeAccount.uploadKeys(this._storage,!1,t)))}async dehydrateIdentity(e,t){return t.set("deviceId",e.deviceId),this._olm?e.deviceId!==this.deviceId?(t.set("wrong_device",!0),!1):this._e2eeAccount?(t.set("account_already_setup",!0),!1):await e.claim(this._hsApi,t)?(this._e2eeAccount=await dt.adoptDehydratedDevice({dehydratedDevice:e,hsApi:this._hsApi,olm:this._olm,pickleKey:st,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:this.deviceId,storage:this._storage}),t.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption(),!0):(t.set("already_claimed",!0),!1):(t.set("no_olm",!0),!1)}_createNewAccount(e,t=void 0){return dt.create({hsApi:this._hsApi,olm:this._olm,pickleKey:st,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:e,storage:t})}setupDehydratedDevice(e,t=null){return this._platform.logger.wrapOrRun(t,"setupDehydratedDevice",async s=>{const i=await this._createNewAccount("temp-device-id");try{const r=await $m(i,this._hsApi,e,"Dehydrated device",s);return s.set("deviceId",r),r}finally{i.dispose()}})}async load(e){const t=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.roomSummary,this._storage.storeNames.invites,this._storage.storeNames.roomMembers,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments,this._storage.storeNames.pendingEvents]);this._syncInfo=await t.session.get("sync"),this._olm&&(this._e2eeAccount=await dt.load({hsApi:this._hsApi,olm:this._olm,pickleKey:st,userId:this._sessionInfo.userId,deviceId:this._sessionInfo.deviceId,olmWorker:this._olmWorker,txn:t}),this._e2eeAccount&&(e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()));const s=await this._getPendingEventsByRoom(t),i=await t.invites.getAll(),r=Promise.all(i.map(async l=>{const c=this.createInvite(l.roomId);e.wrap("invite",h=>c.load(l,h)),this._invites.add(c.id,c)})),o=await t.roomSummary.getAll(),a=Promise.all(o.map(async l=>{const c=this.createJoinedRoom(l.roomId,s.get(l.roomId));await e.wrap("room",h=>c.load(l,t,h)),this._rooms.add(c.id,c)}));await Promise.all([r,a]);for(const[l,c]of this.invites){const h=this.rooms.get(l);h&&h.setInvite(c)}}dispose(){var e,t,s,i;(e=this._olmWorker)==null||e.dispose(),this._olmWorker=void 0,(t=this._keyBackup.get())==null||t.dispose(),this._keyBackup.set(void 0),(s=this._megolmDecryption)==null||s.dispose(),this._megolmDecryption=void 0,(i=this._e2eeAccount)==null||i.dispose(),this._e2eeAccount=void 0;for(const r of this._rooms.values())r.dispose();this._rooms=void 0}async start(e,t,s){var i;if(e){const l=await this._storage.readWriteTxn([this._storage.storeNames.session]);l.session.set("serverVersions",e),await l.complete()}if(!this._keyBackup.get()){t&&await s.wrap("SSSSKeyFromDehydratedDeviceKey",async h=>{const d=await Bm(t.key,this._storage,this._platform);d&&(h.set("success",!0),await this._writeSSSSKey(d))});const l=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.accountData]),c=await Vm(l);c&&await this._createKeyBackup(c,l,s)&&((i=this._keyBackup.get())==null||i.flush(s)),this._keyBackup.get()||this._keyBackup.set(null)}const o=await(await this._storage.readWriteTxn([this._storage.storeNames.operations])).operations.getAll(),a=Rt(o,l=>l.scope);for(const l of this._rooms.values()){let c;const h=a.get(l.id);h&&(c=Rt(h,d=>d.type)),l.start(c,s)}}async _getPendingEventsByRoom(e){return(await e.pendingEvents.getAll()).reduce((s,i)=>{const r=s.get(i.roomId);return r?r.push(i):s.set(i.roomId,[i]),s},new Map)}get rooms(){return this._rooms}findDirectMessageForUserId(e){for(const[,t]of this._rooms)if(t.isDirectMessageForUserId(e))return t;for(const[,t]of this._invites)if(t.isDirectMessageForUserId(e))return t}createJoinedRoom(e,t){return new vm({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:this._roomUpdateCallback,hsApi:this._hsApi,mediaRepository:this._mediaRepository,pendingEvents:t,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform})}_createArchivedRoom(e){const t=new wm({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:()=>{},releaseCallback:()=>this._activeArchivedRooms.delete(e),forgetCallback:this._forgetArchivedRoom,hsApi:this._hsApi,mediaRepository:this._mediaRepository,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform});return this._activeArchivedRooms.set(e,t),t}get invites(){return this._invites}createInvite(e){return new Tm({roomId:e,hsApi:this._hsApi,emitCollectionUpdate:this._inviteUpdateCallback,mediaRepository:this._mediaRepository,user:this._user,platform:this._platform})}get roomsBeingCreated(){return this._roomsBeingCreated}createRoom(e){let t;return this._platform.logger.runDetached("create room",async s=>{const i=`local-${Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER)}`;t=new Cm(i,e,this._roomsBeingCreatedUpdateCallback,this._mediaRepository,this._platform,s),this._roomsBeingCreated.set(i,t);const r=[t.create(this._hsApi,s)];e.loadProfiles!==!1&&r.push(t.loadProfiles(this._hsApi,s)),await Promise.all(r),t.roomId&&(this.rooms.get(t.roomId)&&this._tryReplaceRoomBeingCreated(t.roomId,s),await t.adjustDirectMessageMapIfNeeded(this._user,this._storage,this._hsApi,s))}),t}async obtainSyncLock(e){var t;const s=(t=e.to_device)==null?void 0:t.events;if(Array.isArray(s)&&s.length)return await this._deviceMessageHandler.obtainSyncLock(s)}async prepareSync(e,t,s,i){var r;const o=(r=e.to_device)==null?void 0:r.events;if(Array.isArray(o)&&o.length)return await i.wrap("deviceMsgs",a=>this._deviceMessageHandler.prepareSync(o,t,s,a))}async writeSync(e,t,s,i,r){const o={syncInfo:null,e2eeAccountChanges:null},a=e.next_batch;if(a!==this.syncToken){const d={token:a,filterId:t};i.session.set("sync",d),o.syncInfo=d}const l=e.device_one_time_keys_count;this._e2eeAccount&&l&&(o.e2eeAccountChanges=this._e2eeAccount.writeSync(l,i,r));const c=e.device_lists;this._deviceTracker&&Array.isArray(c?.changed)&&c.changed.length&&await r.wrap("deviceLists",d=>this._deviceTracker.writeDeviceChanges(c.changed,i,d)),s&&(o.hasNewRoomKeys=await r.wrap("deviceMsgs",d=>this._deviceMessageHandler.writeSync(s,i,d)));const h=e.account_data;if(Array.isArray(h?.events))for(const d of h.events)typeof d.type=="string"&&i.accountData.set(d);return o}afterSync({syncInfo:e,e2eeAccountChanges:t}){e&&(this._syncInfo=e),this._e2eeAccount&&this._e2eeAccount.afterSync(t)}async afterSyncCompleted(e,t,s){var i;t||await this._e2eeAccount.generateOTKsIfNeeded(this._storage,s)&&await s.wrap("uploadKeys",o=>this._e2eeAccount.uploadKeys(this._storage,!1,o)),e.hasNewRoomKeys&&((i=this._keyBackup.get())==null||i.flush(s))}_tryReplaceRoomBeingCreated(e,t){for(const[,s]of this._roomsBeingCreated)if(s.roomId===e){const i=this._observedRoomStatus.get(s.id);i&&(t.log("replacing room being created").set("localId",s.id).set("roomId",s.roomId),i.set(i.get()|U.Replaced)),s.dispose(),this._roomsBeingCreated.remove(s.id);return}}applyRoomCollectionChangesAfterSync(e,t,s,i){var r,o;for(const a of t)a.shouldAdd?(this._rooms.add(a.id,a.room),this._tryReplaceRoomBeingCreated(a.id,i)):a.shouldRemove&&this._rooms.remove(a.id);for(const a of e)a.shouldAdd?this._invites.add(a.id,a.invite):a.shouldRemove&&this._invites.remove(a.id);if(this._observedRoomStatus.size!==0){for(const a of s)a.shouldAdd&&((r=this._observedRoomStatus.get(a.id))==null||r.set(U.Archived));for(const a of t)a.shouldAdd&&((o=this._observedRoomStatus.get(a.id))==null||o.set(U.Joined));for(const a of e){const l=this._observedRoomStatus.get(a.id);if(l){const c=l.get()|U.Invited;if(a.shouldAdd)l.set(c);else if(a.shouldRemove){const h=c^U.Invited;l.set(h)}}}}}_forgetArchivedRoom(e){const t=this._observedRoomStatus.get(e);t&&t.set((t.get()|U.Archived)^U.Archived)}get syncToken(){var e;return(e=this._syncInfo)==null?void 0:e.token}get syncFilterId(){var e;return(e=this._syncInfo)==null?void 0:e.filterId}get user(){return this._user}get mediaRepository(){return this._mediaRepository}enablePushNotifications(e){return e?this._enablePush():this._disablePush()}async _enablePush(){return this._platform.logger.run("enablePush",async e=>{const t=rt.createDefaultPayload(this._sessionInfo.id),s=await this._platform.notificationService.enablePush(rt,t);if(!s)return e.set("no_pusher",!0),!1;await s.enable(this._hsApi,e);const i=await this._storage.readWriteTxn([this._storage.storeNames.session]);return i.session.set(Ut,s.serialize()),await i.complete(),!0})}async _disablePush(){return this._platform.logger.run("disablePush",async e=>{await this._platform.notificationService.disablePush();const s=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(Ut);if(!s)return!0;await new rt(s).disable(this._hsApi,e);const r=await this._storage.readWriteTxn([this._storage.storeNames.session]);return r.session.remove(Ut),await r.complete(),!0})}async arePushNotificationsEnabled(){return await this._platform.notificationService.isPushEnabled()?!!await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(Ut):!1}async checkPusherEnabledOnHomeserver(){const t=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(Ut);if(!t)return!1;const s=new rt(t),i=await this._hsApi.getPushers().response();return(i?.pushers||[]).map(o=>new rt(o)).some(o=>o.equals(s))}async getRoomStatus(e){if(!!this._roomsBeingCreated.get(e))return U.BeingCreated;if(!!this._rooms.get(e))return U.Joined;{const i=!!this._invites.get(e),o=await(await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary])).archivedRoomSummary.has(e);return i&&o?U.Invited|U.Archived:i?U.Invited:o?U.Archived:U.None}}async observeRoomStatus(e){let t=this._observedRoomStatus.get(e);if(!t){const s=await this.getRoomStatus(e);t=new bi(s,()=>{this._observedRoomStatus.delete(e)}),this._observedRoomStatus.set(e,t)}return t}createOrGetArchivedRoomForSync(e){let t=this._activeArchivedRooms.get(e);return t?t.retain():t=this._createArchivedRoom(e),t}loadArchivedRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"loadArchivedRoom",async s=>{s.set("id",e);const i=this._activeArchivedRooms.get(e);if(i)return i.retain(),i;const r=await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary,this._storage.storeNames.roomMembers]),o=await r.archivedRoomSummary.get(e);if(o){const a=this._createArchivedRoom(e);return await a.load(o,r,s),a}})}joinRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"joinRoom",async s=>(await this._hsApi.joinIdOrAlias(e,{log:s}).response()).room_id)}}class Tp{constructor({username:e,password:t,homeserver:s}){this._username=e,this._password=t,this.homeserver=s}async login(e,t,s){return await e.passwordLogin(this._username,this._password,t,{log:s}).response()}}class Mp{constructor({homeserver:e,loginToken:t}){this.homeserver=e,this._loginToken=t}async login(e,t,s){return await e.tokenLogin(this._loginToken,Bs(),t,{log:s}).response()}}class Ap{constructor(e){this._homeserver=e}get homeserver(){return this._homeserver}createSSORedirectURL(e){return`${this._homeserver}/_matrix/client/r0/login/sso/redirect?redirectUrl=${e}`}}class ir{constructor(e,t){this._session=e,this._params=t}setNextStage(e){this._nextStage=e}get nextStage(){return this._nextStage}}class xp extends ir{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.dummy"}}class Np extends ir{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.terms"}get privacyPolicy(){var e;return(e=this._params)==null?void 0:e.policies.privacy_policy}get termsOfService(){var e;return(e=this._params)==null?void 0:e.policies.terms_of_service}}class Dp extends ir{constructor(e,t,s){super(e,t),this._type=s}generateAuthenticationData(){if(!this._token)throw new Error("No token provided for TokenAuth");return{session:this._session,type:this._type,token:this._token}}setToken(e){this._token=e}get type(){return this._type}}class Op{constructor(e,t,s){this._hsApi=e,this._accountDetails=t,this._flowSelector=s??(i=>i[0])}async start(){const e=await this._hsApi.register(this._accountDetails.username,this._accountDetails.password,this._accountDetails.initialDeviceDisplayName,void 0,this._accountDetails.inhibitLogin).response();return this.parseStagesFromResponse(e)}async submitStage(e){const t=e.generateAuthenticationData(),{username:s,password:i,initialDeviceDisplayName:r,inhibitLogin:o}=this._accountDetails,a=this._hsApi.register(s,i,r,t,o),l=await a.response(),c=await a.responseCode(),h=il(Jt({},l),{status:c});return this.parseRegistrationResponse(h,e)}parseStagesFromResponse(e){const{session:t,params:s}=e,i=this._flowSelector(e.flows);if(!i)throw new Error("flowSelector did not return any flow!");let r,o;for(const a of i.stages){const l=this._createRegistrationStage(a,t,s);r?(o.setNextStage(l),o=l):(r=l,o=l)}return r}async parseRegistrationResponse(e,t){var s;switch(e.status){case 200:this._sessionInfo=e;return;case 401:if((s=e.completed)!=null&&s.includes(t.type))return t.nextStage;throw new Error("This stage could not be completed!")}}_createRegistrationStage(e,t,s){switch(e){case"m.login.dummy":return new xp(t,s?.[e]);case"m.login.terms":return new Np(t,s?.[e]);case"org.matrix.msc3231.login.registration_token":case"m.login.registration_token":return new Dp(t,s?.[e],e);default:throw new Error(`Unknown stage: ${e}`)}}get sessionInfo(){return this._sessionInfo}}const M=Pe("NotLoading","Login","LoginFailed","QueryAccount","AccountSetup","Loading","SessionSetup","Migrating","FirstSync","Error","Ready"),De=Pe("Connection","Credentials","Unknown");class rr{constructor(e){this._platform=e,this._sessionStartedByReconnector=!1,this._status=new Ee(M.NotLoading),this._error=null,this._loginFailure=null,this._reconnector=null,this._session=null,this._sync=null,this._sessionId=null,this._storage=null,this._requestScheduler=null,this._olmPromise=e.loadOlm(),this._workerPromise=e.loadOlmWorker(),this._accountSetup=void 0}createNewSessionId(){return Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER).toString()}get sessionId(){return this._sessionId}async startWithExistingSession(e){this._status.get()===M.NotLoading&&(this._status.set(M.Loading),await this._platform.logger.run("load session",async t=>{t.set("id",e);try{const s=await this._platform.sessionInfoStorage.get(e);if(!s)throw new Error("Invalid session id: "+e);await this._loadSessionInfo(s,null,t),t.set("status",this._status.get())}catch(s){t.catch(s),this._error=s,this._status.set(M.Error)}}))}_parseLoginOptions(e,t){const s=e.flows,i={homeserver:t};for(const r of s)r.type==="m.login.password"?i.password=(o,a)=>new Tp({homeserver:t,username:o,password:a}):r.type==="m.login.sso"&&s.find(o=>o.type==="m.login.token")?i.sso=new Ap(t):r.type==="m.login.token"&&(i.token=o=>new Mp({homeserver:t,loginToken:o}));return i}queryLogin(e){return new Ao(async t=>{e=await Fd(e,(r,o)=>t(this._platform.request(r,o)));const s=new it({homeserver:e,request:this._platform.request}),i=await t(s.getLoginFlows()).response();return this._parseLoginOptions(i,e)})}async startRegistration(e,t,s,i,r){const o=this._platform.request,a=new it({homeserver:e,request:o});return new Op(a,{username:t,password:s,initialDeviceDisplayName:i},r)}async startWithLogin(e,{inspectAccountSetup:t}={}){const s=this._status.get();s!==M.LoginFailed&&s!==M.NotLoading&&s!==M.Error||(this._resetStatus(),await this._platform.logger.run("login",async i=>{this._status.set(M.Login);const r=this._platform.clock;let o;try{const l=this._platform.request,c=new it({homeserver:e.homeserver,request:l}),h=await e.login(c,"Hydrogen",i),d=this.createNewSessionId();o={id:d,deviceId:h.device_id,userId:h.user_id,homeServer:e.homeserver,homeserver:e.homeserver,accessToken:h.access_token,lastUsed:r.now()},i.set("id",d)}catch(l){this._error=l,l.name==="HomeServerError"?(l.errcode==="M_FORBIDDEN"?this._loginFailure=De.Credentials:this._loginFailure=De.Unknown,i.set("loginFailure",this._loginFailure),this._status.set(M.LoginFailed)):l.name==="ConnectionError"?(this._loginFailure=De.Connection,this._status.set(M.LoginFailed)):this._status.set(M.Error);return}let a;t&&(a=await this._inspectAccountAfterLogin(o,i),a&&(o.deviceId=a.deviceId)),await this._platform.sessionInfoStorage.add(o);try{await this._loadSessionInfo(o,a,i),i.set("status",this._status.get())}catch(l){i.catch(l),a?.dispose(),this._error=l,this._status.set(M.Error)}}))}async _loadSessionInfo(e,t,s){s.set("appVersion",this._platform.version);const i=this._platform.clock;this._sessionStartedByReconnector=!1,this._status.set(M.Loading),this._reconnector=new jd({onlineStatus:this._platform.onlineStatus,retryDelay:new No(i.createTimeout),createMeasure:i.createMeasure});const r=new it({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request,reconnector:this._reconnector});this._sessionId=e.id,this._storage=await this._platform.storageFactory.create(e.id,s);const o={id:e.id,deviceId:e.deviceId,userId:e.userId,homeserver:e.homeServer},a=await this._olmPromise;let l=null;this._workerPromise&&(l=await this._workerPromise),this._requestScheduler=new Gd({hsApi:r,clock:i}),this._requestScheduler.start();const c=new Wd({homeserver:e.homeServer,platform:this._platform});if(this._session=new Cp({storage:this._storage,sessionInfo:o,hsApi:this._requestScheduler.hsApi,olm:a,olmWorker:l,mediaRepository:c,platform:this._platform}),await this._session.load(s),t?(await s.wrap("dehydrateIdentity",h=>this._session.dehydrateIdentity(t,h)),await this._session.setupDehydratedDevice(t.key,s)):this._session.hasIdentity||(this._status.set(M.SessionSetup),await s.wrap("createIdentity",h=>this._session.createIdentity(h))),this._sync=new Qd({hsApi:this._requestScheduler.hsApi,storage:this._storage,session:this._session,logger:this._platform.logger}),this._reconnectSubscription=this._reconnector.connectionStatus.subscribe(h=>{h===zt.Online&&this._platform.logger.runDetached("reconnect",async d=>{this._requestScheduler.start(),this._sync.start(),this._sessionStartedByReconnector=!0;const m=t;t=void 0,await d.wrap("session start",p=>this._session.start(this._reconnector.lastVersionsResponse,m,p))})}),await s.wrap("wait first sync",()=>this._waitForFirstSync()),!this._isDisposed&&(this._status.set(M.Ready),!this._sessionStartedByReconnector)){const h=await r.versions({timeout:1e4,log:s}).response();if(this._isDisposed)return;const d=t;t=void 0,await s.wrap("session start",m=>this._session.start(h,d,m))}}async _waitForFirstSync(){this._sync.start(),this._status.set(M.FirstSync),this._waitForFirstSyncHandle=this._sync.status.waitFor(e=>{var t;return e===L.Stopped?((t=this._sync.error)==null?void 0:t.name)!=="ConnectionError":e===L.Syncing});try{if(await this._waitForFirstSyncHandle.promise,this._sync.status.get()===L.Stopped&&this._sync.error)throw this._sync.error}catch(e){if(e.name==="AbortError")return;throw e}finally{this._waitForFirstSyncHandle=null}}_inspectAccountAfterLogin(e,t){return t.wrap("inspectAccount",async s=>{var i;this._status.set(M.QueryAccount);const r=new it({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request}),o=await this._olmPromise;let a;try{a=await Km(r,o,this._platform,s)}catch(l){if(l.name==="HomeServerError")s.set("not_supported",!0);else throw l}if(a){let l;const c=new Promise(d=>l=d);this._accountSetup=new Lp(a,l),this._status.set(M.AccountSetup),await c;const h=(i=this._accountSetup)==null?void 0:i._dehydratedDevice;return this._accountSetup=null,h}})}get accountSetup(){return this._accountSetup}get loadStatus(){return this._status}get loadError(){return this._error}get loginFailure(){return this._loginFailure}get sync(){return this._sync}get session(){return this._session}get reconnector(){return this._reconnector}get _isDisposed(){return!this._reconnector}startLogout(e){return this._platform.logger.run("logout",async t=>{this._sessionId=e,t.set("id",this._sessionId);const s=await this._platform.sessionInfoStorage.get(this._sessionId);if(!s)throw new Error(`Could not find session for id ${this._sessionId}`);try{await new it({homeserver:s.homeServer,accessToken:s.accessToken,request:this._platform.request}).logout({log:t}).response()}catch{}await this.deleteSession(t)})}dispose(){this._reconnectSubscription&&(this._reconnectSubscription(),this._reconnectSubscription=null),this._reconnector=null,this._requestScheduler&&(this._requestScheduler.stop(),this._requestScheduler=null),this._sync&&(this._sync.stop(),this._sync=null),this._session&&(this._session.dispose(),this._session=null),this._waitForFirstSyncHandle&&(this._waitForFirstSyncHandle.dispose(),this._waitForFirstSyncHandle=null),this._storage&&(this._storage.close(),this._storage=null)}async deleteSession(e){this._sessionId&&(this.dispose(),await Promise.all([e.wrap("storageFactory",()=>this._platform.storageFactory.delete(this._sessionId)),e.wrap("sessionInfoStorage",()=>this._platform.sessionInfoStorage.delete(this._sessionId))]),this._sessionId=null)}_resetStatus(){this._status.set(M.NotLoading),this._error=null,this._loginFailure=null}}class Lp{constructor(e,t){this._encryptedDehydratedDevice=e,this._dehydratedDevice=void 0,this._finishStage=t}get encryptedDehydratedDevice(){return this._encryptedDehydratedDevice}finish(e){this._dehydratedDevice=e,this._finishStage()}}class Pp{constructor(e){this._observables=new Map,this._allowsChild=e,this._path=new Ae([],e),this._pathObservable=new Ee(this._path)}get pathObservable(){return this._pathObservable}get path(){return this._path}push(e,...t){const s=this.path.with(new oe(e,...t));s&&this.applyPath(s)}applyPath(e){const t=this._path;this._path=e;for(let s=t.segments.length-1;s>=0;s-=1){const i=t.segments[s];if(!this._path.get(i.type)){const r=this._observables.get(i.type);r?.emitIfChanged()}}for(const s of this._path.segments){const i=this._observables.get(s.type);i?.emitIfChanged()}this._pathObservable.set(this._path)}observe(e){let t=this._observables.get(e);return t||(t=new Up(this,e),this._observables.set(e,t)),t}pathFrom(e){let t,s;for(s=0;s<e.length;s+=1){if(!this._allowsChild(t,e[s]))return new Ae(e.slice(0,s),this._allowsChild);t=e[s]}return new Ae(e,this._allowsChild)}segment(e,...t){return new oe(e,...t)}}function Vp(n,e){if(n===e)return!0;if(Array.isArray(n)&&Array.isArray(e)){const t=Math.max(n.length,e.length);for(let s=0;s<t;s+=1)if(n[s]!==e[s])return!1;return!0}return!1}class oe{constructor(e,...t){this.type=e,this.value=t[0]===void 0?!0:t[0]}}class Ae{constructor(e=[],t){this._segments=e,this._allowsChild=t}clone(){return new Ae(this._segments.slice(),this._allowsChild)}with(e){let t=this._segments.length-1;do{if(this._allowsChild(this._segments[t],e)){const s=this._segments.slice(0,t+1);return s.push(e),new Ae(s,this._allowsChild)}t-=1}while(t>=-1)}until(e){const t=this._segments.findIndex(s=>s.type===e);return t!==-1?new Ae(this._segments.slice(0,t+1),this._allowsChild):new Ae([],this._allowsChild)}get(e){return this._segments.find(t=>t.type===e)}replace(e){const t=this._segments.findIndex(s=>s.type===e.type);if(t!==-1){const s=this._segments[t-1];if(this._allowsChild(s,e)){const i=this._segments[t+1];if(!i||this._allowsChild(e,i)){const r=this._segments.slice();return r[t]=e,new Ae(r,this._allowsChild)}}}}get segments(){return this._segments}}class Up extends Tt{constructor(e,t){var s;super(),this._navigation=e,this._type=t,this._lastSetValue=(s=e.path.get(t))==null?void 0:s.value}get(){const t=this._navigation.path.get(this._type);return t?.value}emitIfChanged(){const e=this.get();Vp(e,this._lastSetValue)||(this._lastSetValue=e,this.emit(e))}}class Fp{constructor(e,t,s,i){this._isApplyingUrl=!1,this._history=e,this._navigation=t,this._parseUrlPath=s,this._stringifyPath=i,this._defaultSessionId=this._getLastSessionId()}_getLastSessionId(){var e;const s=(e=this._urlAsNavPath(this._history.getLastSessionUrl()||"").get("session"))==null?void 0:e.value;if(typeof s=="string")return s}attach(){this._subscription=this._history.subscribe(e=>this._applyUrl(e)),this._pathSubscription=this._navigation.pathObservable.subscribe(e=>this._applyNavPathToHistory(e)),this._applyUrl(this._history.get())}dispose(){this._subscription&&(this._subscription=this._subscription()),this._pathSubscription&&(this._pathSubscription=this._pathSubscription())}_applyNavPathToHistory(e){const t=this.urlForPath(e);t!==this._history.get()&&(this._isApplyingUrl?this._history.replaceUrlSilently(t):this._history.pushUrlSilently(t))}_applyNavPathToNavigation(e){this._isApplyingUrl=!0,this._navigation.applyPath(e),this._isApplyingUrl=!1}_urlAsNavPath(e){const t=this._history.urlAsPath(e);return this._navigation.pathFrom(this._parseUrlPath(t,this._navigation.path,this._defaultSessionId))}_applyUrl(e){const t=this._urlAsNavPath(e);this._applyNavPathToNavigation(t)}pushUrl(e){this._history.pushUrl(e)}tryRestoreLastUrl(){const e=this._urlAsNavPath(this._history.getLastSessionUrl()||"");return e.segments.length!==0?(this._applyNavPathToNavigation(e),!0):!1}urlForSegments(e){let t=this._navigation.path;for(const s of e)if(t=t.with(s),!t)return;return this.urlForPath(t)}urlForSegment(e,...t){return this.urlForSegments([this._navigation.segment(e,...t)])}urlUntilSegment(e){return this.urlForPath(this._navigation.path.until(e))}urlForPath(e){return this._history.pathAsUrl(this._stringifyPath(e))}openRoomActionUrl(e){const t=`${this._stringifyPath(this._navigation.path.until("session"))}/open-room/${e}`;return this._history.pathAsUrl(t)}createSSOCallbackURL(){return window.location.origin}normalizeUrl(){this._history.replaceUrlSilently(`${window.location.origin}/${window.location.hash}`)}}function Bp(){return new Pp($p)}function Kp({history:n,navigation:e}){return new Fp(n,e,qp,Hp)}function $p(n,e){const{type:t}=e;switch(n?.type){case void 0:return t==="login"||t==="session"||t==="sso"||t==="logout";case"session":return t==="room"||t==="rooms"||t==="settings"||t==="create-room";case"rooms":return t==="room"||t==="empty-grid-tile";case"room":return t==="lightbox"||t==="right-panel";case"right-panel":return t==="details"||t==="members"||t==="member";default:return!1}}function jp(n,e,t){if(n.value.includes(e))return n;{const s=t.get("empty-grid-tile"),i=t.get("room");let r=0;s?r=s.value:i&&(r=n.value.indexOf(i.value));const o=n.value.slice();return o[r]=e,new oe("rooms",o)}}function Cn(n,e,...t){n.push(new oe("right-panel")),n.push(new oe(e,...t))}function Ni(n,e){const t=n.path.segments,s=t.findIndex(r=>r.type==="right-panel");let i=e;return s!==-1&&(i=e.until("room"),i=i.with(t[s]),i=i.with(t[s+1])),i}function qp(n,e,t){const s=n.substring(1).split("/"),i=s[Symbol.iterator](),r=[];let o;for(;!(o=i.next()).done;){const a=o.value;if(a==="rooms"){const l=i.next().value;if(l===void 0)break;const c=l.split(",");r.push(new oe(a,c));const h=parseInt(i.next().value||"0",10),d=c[h];d?r.push(new oe("room",d)):r.push(new oe("empty-grid-tile",h))}else if(a==="open-room"){const l=i.next().value;if(!l)break;const c=e.get("rooms");if(c&&r.push(jp(c,l,e)),r.push(new oe("room",l)),s.findIndex(m=>m==="open-room")>=s.length-2){const m=e.segments,p=m.findIndex(_=>_.type==="right-panel");p!==-1&&r.push(...m.slice(p))}}else if(a==="last-session"){let l=e.get("session");typeof l?.value!="string"&&t&&(l=new oe("session",t)),l&&r.push(l)}else if(a==="details"||a==="members")Cn(r,a);else if(a==="member"){const l=i.next().value;if(!l)break;Cn(r,a,l)}else if(a.includes("loginToken")){const l=a.split("=").pop();r.push(new oe("sso",l))}else{const l=i.next().value;r.push(new oe(a,l))}}return r}function Hp(n){let e="",t;for(const s of n.segments){switch(s.type){case"rooms":e+=`/rooms/${s.value.join(",")}`;break;case"empty-grid-tile":e+=`/${s.value}`;break;case"room":t?.type==="rooms"?e+=`/${t.value.indexOf(s.value)}`:e+=`/${s.type}/${s.value}`;break;case"right-panel":case"sso":continue;default:e+=`/${s.type}`,s.value&&s.value!==!0&&(e+=`/${s.value}`)}t=s}return e}class A extends Ws{constructor(e){super(),this._isDisposed=!1,this._options=e}childOptions(e){return Object.assign({},this._options,e)}get options(){return this._options}getOption(e){return this._options[e]}observeNavigation(e,t){const i=this.navigation.observe(e).subscribe(r=>{t(r,e)});this.track(i)}track(e){return this.disposables||(this.disposables=new qi),this.disposables.track(e)}untrack(e){if(this.disposables)return this.disposables.untrack(e)}dispose(){this.disposables&&this.disposables.dispose(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}disposeTracked(e){if(this.disposables)return this.disposables.disposeTracked(e)}i18n(e,...t){let s="";for(let i=0;i<e.length;++i)s=s+e[i],i<t.length&&(s=s+t[i]);return s}emitChange(e){this._options.emitChange?this._options.emitChange(e):this.emit("change",e)}get platform(){return this._options.platform}get clock(){return this._options.platform.clock}get logger(){return this.platform.logger}get urlCreator(){return this._options.urlCreator}get navigation(){return this._options.navigation}}function _e(n){let e=n.charAt(0);return(e==="!"||e==="@"||e==="#")&&(e=n.charAt(1)),e.toUpperCase()}function Wp(n){let e=0,t,s;if(n.length===0)return e;for(t=0;t<n.length;t++)s=n.charCodeAt(t),e=(e<<5)-e+s,e|=0;return Math.abs(e)}function ge(n){return Wp(n)%8+1}function Ue(n,e,t,s){if(n){const i=e*t.devicePixelRatio;return s.mxcUrlThumbnail(n,i,i,"crop")}return null}const Tn=["roomBeingCreated","invite","room"];class nr extends A{constructor(e){super(e),this._isOpen=!1,this._hidden=!1}get hidden(){return this._hidden}set hidden(e){e!==this._hidden&&(this._hidden=e,this.emitChange("hidden"))}close(){this._isOpen&&(this._isOpen=!1,this.emitChange("isOpen"))}open(){this._isOpen||(this._isOpen=!0,this.emitChange("isOpen"))}get isOpen(){return this._isOpen}compare(e){return e.kind!==this.kind?Tn.indexOf(this.kind)-Tn.indexOf(e.kind):0}get avatarLetter(){return _e(this.name)}get avatarColorNumber(){return ge(this._avatarSource.avatarColorId)}avatarUrl(e){return Ue(this._avatarSource.avatarUrl,e,this.platform,this._avatarSource.mediaRepository)}get avatarTitle(){return this.name}}class zp extends nr{constructor(e){super(e);const{room:t}=e;this._room=t,this._url=this.urlCreator.openRoomActionUrl(this._room.id)}get kind(){return"room"}get url(){return this._url}compare(e){const t=super.compare(e);if(t!==0)return t;const s=this._room,i=e._room;if(s.isLowPriority!==i.isLowPriority)return s.isLowPriority?1:-1;const r=s.lastMessageTimestamp,o=i.lastMessageTimestamp,a=Number.isSafeInteger(r),l=Number.isSafeInteger(o);if(a!==l)return l?1:-1;const c=o-r;if(c===0||!l||!a){const h=this.name.localeCompare(e.name);return h===0?this._room.id.localeCompare(e._room.id):h}return c}get isUnread(){return this._room.isUnread}get name(){return this._room.name||this.i18n`Empty Room`}get badgeCount(){return this._room.notificationCount}get isHighlighted(){return this._room.highlightCount!==0}get _avatarSource(){return this._room}}function Di(n,e){return n===e?0:n<e?-1:1}class Gp extends nr{constructor(e){super(e);const{invite:t}=e;this._invite=t,this._url=this.urlCreator.openRoomActionUrl(this._invite.id)}get busy(){return this._invite.accepting||this._invite.rejecting}get kind(){return"invite"}get url(){return this._url}get name(){return this._invite.name}get isHighlighted(){return!0}get isUnread(){return!0}get badgeCount(){return this.i18n`!`}get _avatarSource(){return this._invite}compare(e){const t=super.compare(e);if(t!==0)return t;const s=e._invite.timestamp-this._invite.timestamp;return s!==0?s:Di(this._invite.id,e._invite.id)}}class Yp extends nr{constructor(e){super(e);const{roomBeingCreated:t}=e;this._roomBeingCreated=t,this._url=this.urlCreator.openRoomActionUrl(this._roomBeingCreated.id)}get busy(){return!this._roomBeingCreated.error}get kind(){return"roomBeingCreated"}get isHighlighted(){return!this.busy}get badgeCount(){return!this.busy&&this.i18n`Failed`}get url(){return this._url}get name(){return this._roomBeingCreated.name}get _avatarSource(){return this._roomBeingCreated}compare(e){const t=super.compare(e);if(t!==0)return t;const s=Di(this.name,e.name);return s===0?Di(this._roomBeingCreated.id,e._roomBeingCreated.id):s}avatarUrl(e){var t;return(t=this._roomBeingCreated.avatarBlobUrl)!=null?t:super.avatarUrl(e)}}class Jp{constructor(e){this._parts=e.split(" ").map(t=>t.toLowerCase().trim())}matches(e){const t=e.name.toLowerCase();return this._parts.every(s=>t.includes(s))}}class Qp extends xt{constructor(e,t){super(),this._source=e,this._apply=t,this._subscription=null}hasApply(){return!!this._apply}setApply(e){this._apply=e,e&&this.applyOnce(this._apply)}applyOnce(e){for(const[t,s]of this._source)e(t,s)}onAdd(e,t){this._apply&&this._apply(e,t),this.emitAdd(e,t)}onRemove(e,t){this.emitRemove(e,t)}onUpdate(e,t,s){this._apply&&this._apply(e,t,s),this.emitUpdate(e,t,s)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._apply&&this.applyOnce(this._apply),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription=this._subscription()}onReset(){this._apply&&this.applyOnce(this._apply),this.emitReset()}[Symbol.iterator](){return this._source[Symbol.iterator]()}get size(){return this._source.size}get(e){return this._source.get(e)}}class Xp extends A{constructor(e){super(e);const{session:t}=e;this._tileViewModelsMap=this._mapTileViewModels(t.roomsBeingCreated,t.invites,t.rooms),this._tileViewModelsFilterMap=new Qp(this._tileViewModelsMap),this._tileViewModels=this._tileViewModelsFilterMap.sortValues((s,i)=>s.compare(i)),this._currentTileVM=null,this._setupNavigation(),this._closeUrl=this.urlCreator.urlForSegment("session"),this._settingsUrl=this.urlCreator.urlForSegment("settings"),this._createRoomUrl=this.urlCreator.urlForSegment("create-room")}_mapTileViewModels(e,t,s){return t.join(e,s).mapValues((r,o)=>{var a;let l;return r.isBeingCreated?l=new Yp(this.childOptions({roomBeingCreated:r,emitChange:o})):r.isInvite?l=new Gp(this.childOptions({invite:r,emitChange:o})):l=new zp(this.childOptions({room:r,emitChange:o})),((a=this.navigation.path.get("room"))==null?void 0:a.value)===r.id&&(l.open(),this._updateCurrentVM(l)),l})}_updateCurrentVM(e){var t;(t=this._currentTileVM)==null||t.close(),this._currentTileVM=e}get closeUrl(){return this._closeUrl}get settingsUrl(){return this._settingsUrl}get createRoomUrl(){return this._createRoomUrl}_setupNavigation(){const e=this.navigation.observe("room");this.track(e.subscribe(s=>this._open(s)));const t=this.navigation.observe("rooms");this.gridEnabled=!!t.get(),this.track(t.subscribe(s=>{const i=this.gridEnabled^!!s;this.gridEnabled=!!s,i&&this.emitChange("gridEnabled")}))}_open(e){var t,s;(t=this._currentTileVM)==null||t.close(),this._currentTileVM=null,e&&(this._currentTileVM=this._tileViewModelsMap.get(e),(s=this._currentTileVM)==null||s.open())}toggleGrid(){const e=this.navigation.path.get("room");let t=this.navigation.path.until("session");this.gridEnabled?e&&(t=t.with(e),t=Ni(this.navigation,t)):e?(t=t.with(this.navigation.segment("rooms",[e.value])),t=t.with(e),t=Ni(this.navigation,t)):(t=t.with(this.navigation.segment("rooms",[])),t=t.with(this.navigation.segment("empty-grid-tile",0))),this.navigation.applyPath(t)}get tileViewModels(){return this._tileViewModels}clearFilter(){this._tileViewModelsFilterMap.setApply(null),this._tileViewModelsFilterMap.applyOnce((e,t)=>t.hidden=!1)}setFilter(e){if(e=e.trim(),e.length===0)return this.clearFilter(),!1;{const t=!this._tileViewModelsFilterMap.hasApply(),s=new Jp(e);return this._tileViewModelsFilterMap.setApply((i,r)=>{r.hidden=!s.matches(r)}),t}}}class we{constructor(e,t,s,i){this._remove=e,this._update=t,this._replace=s,this._updateParams=i}get shouldReplace(){return this._replace}get shouldRemove(){return this._remove}get shouldUpdate(){return this._update}get updateParams(){return this._updateParams}static Remove(){return new we(!0,!1,!1,null)}static Update(e){return new we(!1,!0,!1,e)}static Nothing(){return new we(!1,!1,!1,null)}static Replace(e){return new we(!1,!1,!0,e)}}class Zp extends Mt{constructor(e,t){super(),this._entries=e,this._tiles=null,this._entrySubscription=null,this._tileOptions=t,this._emitSpontanousUpdate=this._emitSpontanousUpdate.bind(this)}_createTile(e){const t=this._tileOptions.tileClassForEntry(e);if(t)return new t(e,this._tileOptions)}_emitSpontanousUpdate(e,t){const s=e.lowerEntry,i=this._findTileIdx(s);this.emitUpdate(i,e,t)}onSubscribeFirst(){this._entrySubscription=this._entries.subscribe(this),this._populateTiles()}_populateTiles(){this._tiles=[];let e=null;for(let s of this._entries)(!e||!e.tryIncludeEntry(s))&&(e=this._createTile(s),e&&this._tiles.push(e));let t=null;for(let s of this._tiles)t&&t.updateNextSibling(s),s.updatePreviousSibling(t),t=s;t&&t.updateNextSibling(null);for(const s of this._tiles)s.setUpdateEmit(this._emitSpontanousUpdate)}_findTileIdx(e){return Ge(this._tiles,e,(t,s)=>-s.compareEntry(t))}_findTileAtIdx(e,t){const s=this._getTileAtIdx(t);if(s&&s.compareEntry(e)===0)return s}_getTileAtIdx(e){return e>=0&&e<this._tiles.length?this._tiles[e]:null}onUnsubscribeLast(){this._entrySubscription=this._entrySubscription();for(let e=0;e<this._tiles.length;e+=1)this._tiles[e].dispose();this._tiles=null}onReset(){this._buildInitialTiles(),this.emitReset()}onAdd(e,t){const s=this._findTileIdx(t),i=this._getTileAtIdx(s-1);if(i&&i.tryIncludeEntry(t)){this.emitUpdate(s-1,i);return}const r=this._getTileAtIdx(s);if(r&&r.tryIncludeEntry(t)){this.emitUpdate(s,r);return}const o=this._createTile(t);o&&(i&&(i.updateNextSibling(o),o.updatePreviousSibling(i)),r&&(o.updateNextSibling(r),r.updatePreviousSibling(o)),this._tiles.splice(s,0,o),this.emitAdd(s,o),o.setUpdateEmit(this._emitSpontanousUpdate))}onUpdate(e,t,s){if(!this._tiles)return;const i=this._findTileIdx(t),r=this._findTileAtIdx(t,i);if(r){const o=r.updateEntry(t,s);if(o.shouldReplace){const a=this._createTile(t);a?(this._replaceTile(i,r,a,o.updateParams),a.setUpdateEmit(this._emitSpontanousUpdate)):this._removeTile(i,r)}o.shouldRemove&&this._removeTile(i,r),o.shouldUpdate&&this.emitUpdate(i,r,o.updateParams)}}_replaceTile(e,t,s,i){t.dispose();const r=this._getTileAtIdx(e-1),o=this._getTileAtIdx(e+1);this._tiles[e]=s,r?.updateNextSibling(s),s.updatePreviousSibling(r),s.updateNextSibling(o),o?.updatePreviousSibling(s),this.emitUpdate(e,s,i)}_removeTile(e,t){const s=this._getTileAtIdx(e-1),i=this._getTileAtIdx(e+1);this._tiles.splice(e,1),t.dispose(),this.emitRemove(e,t),s?.updateNextSibling(i),i?.updatePreviousSibling(s)}onRemove(e,t){const s=this._findTileIdx(t),i=this._findTileAtIdx(t,s);i&&(i.removeEntry(t)?this._removeTile(s,i):this.emitUpdate(s,i))}onMove(){}[Symbol.iterator](){return this._tiles.values()}get length(){return this._tiles.length}getFirst(){return this._tiles[0]}getTileIndex(e){const t=Ge(this._tiles,e,(i,r)=>i.compare(r)),s=this._tiles[t];return s?.compare(e)===0?t:-1}sliceIterator(e,t){return this._tiles.slice(e,t)[Symbol.iterator]()}}class e_ extends A{constructor(e){super(e);const{timeline:t,tileOptions:s}=e;this._timeline=this.track(t),this._tiles=new Zp(t.entries,s),this._startTile=null,this._endTile=null,this._topLoadingPromise=null,this._requestedStartTile=null,this._requestedEndTile=null,this._requestScheduled=!1,this._showJumpDown=!1}setVisibleTileRange(e,t){this._requestedStartTile=e,this._requestedEndTile=t,this._requestScheduled||(Promise.resolve().then(()=>{this._setVisibleTileRange(this._requestedStartTile,this._requestedEndTile),this._requestScheduled=!1}),this._requestScheduled=!0)}_setVisibleTileRange(e,t){let s;if(e&&t){this._startTile=e,this._endTile=t;const i=this._tiles.getTileIndex(this._startTile),r=this._tiles.getTileIndex(this._endTile);for(const o of this._tiles.sliceIterator(i,r+1))o.notifyVisible();s=i<10,this._setShowJumpDown(r<this._tiles.length-1)}else s=!0,this._setShowJumpDown(!1);s&&!this._topLoadingPromise&&(this._topLoadingPromise=this._timeline.loadAtTop(10).then(i=>{this._topLoadingPromise=null,i||this.setVisibleTileRange(this._requestedStartTile,this._requestedEndTile)}))}get tiles(){return this._tiles}_setShowJumpDown(e){this._showJumpDown!==e&&(this._showJumpDown=e,this.emitChange("showJumpDown"))}get showJumpDown(){return this._showJumpDown}}class t_ extends A{constructor(e){super(e.options),this._roomVM=e,this._isEmpty=!0,this._replyVM=null}setReplyingTo(e){var t;(new Boolean(e)!==new Boolean(this._replyVM)||!((t=this._replyVM)!=null&&t.id.equals(e.asEventKey())))&&(this._replyVM=this.disposeTracked(this._replyVM),e&&(this._replyVM=this.track(this._roomVM._createTile(e)),this._replyVM.notifyVisible()),this.emitChange("replyViewModel"),this.emit("focus"))}clearReplyingTo(){this.setReplyingTo(null)}get replyViewModel(){return this._replyVM}get isEncrypted(){return this._roomVM.isEncrypted}async sendMessage(e){const t=await this._roomVM._sendMessage(e,this._replyVM);return t&&(this._isEmpty=!0,this.emitChange("canSend"),this.clearReplyingTo()),t}sendPicture(){this._roomVM._pickAndSendPicture()}sendFile(){this._roomVM._pickAndSendFile()}sendVideo(){this._roomVM._pickAndSendVideo()}get canSend(){return!this._isEmpty}async setInput(e){const t=this._isEmpty;this._isEmpty=e.length===0,t&&!this._isEmpty&&this._roomVM._room.ensureMessageKeyIsShared(),t!==this._isEmpty&&this.emitChange("canSend")}get kind(){return"composer"}}function Yt(n){return{w:n.width,h:n.height,mimetype:n.blob.mimeType,size:n.blob.size}}class os extends A{constructor(e,t){super(t),this._entry=e,this._emitUpdate=void 0}get shape(){return null}get isContinuation(){return!1}get hasDateSeparator(){return!1}get id(){return this._entry.asEventKey()}get eventId(){return this._entry.id}get isPending(){return this._entry.isPending}get isUnsent(){return this._entry.isPending&&this._entry.pendingEvent.status!==D.Sent}get canAbortSending(){return this._entry.isPending&&!this._entry.pendingEvent.hasStartedSending}abortSending(){var e;(e=this._entry.pendingEvent)==null||e.abort()}setUpdateEmit(e){this._emitUpdate=e}emitChange(e){this._emitUpdate&&this._emitUpdate(this,e),super.emitChange(e)}get upperEntry(){return this._entry}get lowerEntry(){return this._entry}compare(e){return this.upperEntry.compare(e.upperEntry)}compareEntry(e){return this._entry.compare(e)}updateEntry(e,t){const s=this.shape==="redacted";return!e.isGap&&e.isRedacted!==s?we.Replace("shape"):(this._entry=e,we.Update(t))}removeEntry(){return!0}tryIncludeEntry(){return!1}updatePreviousSibling(){}updateNextSibling(){}notifyVisible(){}dispose(){this.setUpdateEmit(null),super.dispose()}get _room(){return this._roomVM.room}get _roomVM(){return this._options.roomVM}get _timeline(){return this._options.timeline}get _powerLevels(){return this._timeline.powerLevels}get _ownMember(){return this._options.timeline.me}}class s_ extends os{constructor(e,t){super(e,t),this._loading=!1,this._error=null,this._isAtTop=!0,this._siblingChanged=!1}async fill(){if(!this._loading&&!this._entry.edgeReached){this._loading=!0,this.emitChange("isLoading");try{await this._room.fillGap(this._entry,10)}catch(e){throw console.error(`room.fillGap(): ${e.message}:
${e.stack}`),this._error=e,this.emitChange("error"),e}finally{this._loading=!1,this.emitChange("isLoading")}return!0}return!1}async notifyVisible(){let e=0,t;this._siblingChanged=!1;do t=await this.fill(),e=e+1;while(e<10&&!this._siblingChanged&&t&&!this.isDisposed)}get isAtTop(){return this._isAtTop}updatePreviousSibling(e){super.updatePreviousSibling(e);const t=!e;this._isAtTop!==t&&(this._isAtTop=t,this.emitChange("isAtTop")),this._siblingChanged=!0}updateNextSibling(){this._siblingChanged=!0}updateEntry(e,t){return super.updateEntry(e,t),e.isGap?we.Nothing():we.Remove()}get shape(){return"gap"}get isLoading(){return this._loading}get error(){return this._error?`Could not load ${this._entry.prev_batch?"previous":"next"} messages: ${this._error.message}`:null}}class i_{constructor(e){this._parentTile=e,this._map=new Gt,this._reactions=this._map.sortValues((t,s)=>t._compare(s))}update(e,t){if(e){for(const s in e)if(e.hasOwnProperty(s)){const i=e[s],r=this._map.get(s);r?r._tryUpdate(i)&&this._map.update(s):this._map.add(s,new Mn(s,i,null,this._parentTile))}}if(t)for(const[s,i]of t.entries()){const r=this._map.get(s);r?(r._tryUpdatePending(i),this._map.update(s)):this._map.add(s,new Mn(s,null,i,this._parentTile))}for(const s of this._map.keys()){const i=t?.has(s),r=e?.hasOwnProperty(s);!r&&!i?this._map.remove(s):r?i||this._map.get(s)._tryUpdatePending(null)&&this._map.update(s):this._map.get(s)._tryUpdate(null)&&this._map.update(s)}}get reactions(){return this._reactions}getReaction(e){return this._map.get(e)}}class Mn{constructor(e,t,s,i){this._key=e,this._annotation=t,this._pending=s,this._parentTile=i,this._isToggling=!1}_tryUpdate(e){const t=!!this._annotation!=!!e,i=this._annotation&&e&&(e.me!==this._annotation.me||e.count!==this._annotation.count||e.firstTimestamp!==this._annotation.firstTimestamp);return t||i?(this._annotation=e,!0):!1}_tryUpdatePending(e){return!e&&!this._pending?!1:(this._pending=e,!0)}get key(){return this._key}get count(){var e,t;return(((e=this._pending)==null?void 0:e.count)||0)+(((t=this._annotation)==null?void 0:t.count)||0)}get isPending(){return this._pending!==null}get isActive(){var e;return((e=this._annotation)==null?void 0:e.me)||this.isPending}get firstTimestamp(){let e=Number.MAX_SAFE_INTEGER;return this._annotation&&(e=Math.min(e,this._annotation.firstTimestamp)),this._pending&&(e=Math.min(e,this._pending.firstTimestamp)),e}_compare(e){if(e===this)return 0;if(this.count!==e.count)return e.count-this.count;{const t=this.firstTimestamp-e.firstTimestamp;return t===0?this.key<e.key?-1:1:t}}async toggle(e=null){if(this._isToggling){console.log("busy toggling reaction already");return}this._isToggling=!0;try{await this._parentTile.toggleReaction(this.key,e)}finally{this._isToggling=!1}}}class Qe extends os{constructor(e,t){super(e,t),this._date=this._entry.timestamp?new Date(this._entry.timestamp):null,this._isContinuation=!1,this._reactions=null,this._replyTile=null,(this._entry.annotations||this._entry.pendingAnnotations)&&this._updateReactions(),this._updateReplyTileIfNeeded(void 0)}notifyVisible(){var e;super.notifyVisible(),(e=this._replyTile)==null||e.notifyVisible()}get _mediaRepository(){return this._room.mediaRepository}get permaLink(){return`https://matrix.to/#/${encodeURIComponent(this._room.id)}/${encodeURIComponent(this._entry.id)}`}get senderProfileLink(){return`https://matrix.to/#/${encodeURIComponent(this.sender)}`}get displayName(){return this._entry.displayName||this.sender}get sender(){return this._entry.sender}get memberPanelLink(){return`${this.urlCreator.urlUntilSegment("room")}/member/${this.sender}`}get avatarColorNumber(){return ge(this._entry.sender)}avatarUrl(e){return Ue(this._entry.avatarUrl,e,this.platform,this._mediaRepository)}get avatarLetter(){return _e(this.sender)}get avatarTitle(){return this.displayName}get date(){return this._date&&this._date.toLocaleDateString({},{month:"numeric",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get isOwn(){return this._entry.sender===this._ownMember.userId}get isContinuation(){return this._isContinuation}get isUnverified(){return this._entry.isUnverified}get isReply(){return this._entry.isReply}_getContent(){return this._entry.content}updatePreviousSibling(e){super.updatePreviousSibling(e);let t=!1;if(e&&e instanceof Qe&&e.sender===this.sender){const s=this._entry.timestamp,i=e._entry.timestamp;t=s-i<5*60*1e3}t!==this._isContinuation&&(this._isContinuation=t,this.emitChange("isContinuation"))}updateEntry(e,t){const s=super.updateEntry(e,t);return s.shouldUpdate&&this._updateReactions(),this._updateReplyTileIfNeeded(t),s}_updateReplyTileIfNeeded(e){var t,s;const i=this._entry.contextEntry;if(i){const r=(t=this._replyTile)==null?void 0:t.updateEntry(i,e);if(r?.shouldReplace||!this._replyTile){this.disposeTracked(this._replyTile);const o=this._options.tileClassForEntry,a=o(i);a&&(this._replyTile=new a(i,this._options))}r?.shouldUpdate&&((s=this._replyTile)==null||s.emitChange())}}startReply(){this._roomVM.startReply(this._entry)}reply(e,t,s=null){return this._room.sendEvent("m.room.message",this._entry.reply(e,t),null,s)}redact(e,t){return this._room.sendRedaction(this._entry.id,e,t)}get canRedact(){return this._powerLevels.canRedactFromSender(this._entry.sender)}get reactions(){return this.shape!=="redacted"?this._reactions:null}get canReact(){return this._powerLevels.canSendType("m.reaction")}react(e,t=null){return this.logger.wrapOrRun(t,"react",async s=>{var i,r;if(!this.canReact){s.set("powerlevel_lacking",!0);return}if(this._entry.haveAnnotation(e)){s.set("already_reacted",!0);return}const o=(r=(i=this._entry.pendingAnnotations)==null?void 0:i.get(e))==null?void 0:r.redactionEntry;o&&!o.pendingEvent.hasStartedSending?(s.set("abort_redaction",!0),await o.pendingEvent.abort()):await this._room.sendEvent("m.reaction",this._entry.annotate(e),null,s)})}redactReaction(e,t=null){return this.logger.wrapOrRun(t,"redactReaction",async s=>{var i,r;if(!this._powerLevels.canRedactFromSender(this._ownMember.userId)){s.set("powerlevel_lacking",!0);return}if(!this._entry.haveAnnotation(e)){s.set("not_yet_reacted",!0);return}let o=(r=(i=this._entry.pendingAnnotations)==null?void 0:i.get(e))==null?void 0:r.annotationEntry;o||(o=await this._timeline.getOwnAnnotationEntry(this._entry.id,e)),o?await this._room.sendRedaction(o.id,null,s):s.set("no_reaction",!0)})}toggleReaction(e,t=null){return this.logger.wrapOrRun(t,"toggleReaction",async s=>{this._entry.haveAnnotation(e)?await this.redactReaction(e,s):await this.react(e,s)})}_updateReactions(){const{annotations:e,pendingAnnotations:t}=this._entry;!e&&!t?this._reactions&&(this._reactions=null):(this._reactions||(this._reactions=new i_(this)),this._reactions.update(e,t))}get replyTile(){return this._entry.contextEventId?this._replyTile:null}}const r_="(?:https|http|ftp):\\/\\/",sa="[^\\s.,?!)]",An="[a-zA-Z0-9:.\\[\\]-]",n_=`${An}*(?=${An})${sa}`,o_=`(?:[\\/#](?:[^\\s]*${sa})?)`,a_=`${r_}${n_}${o_}?`,l_=new RegExp(a_,"gi");function ia(n,e){const t=n.matchAll(l_);let s=0;for(let r of t){const o=n.slice(s,r.index);e(o,!1),e(r[0],!0);const a=r[0].length;s=r.index+a}const i=n.slice(s);e(i,!1)}function c_(n){const e=[],t=n.split(`
`),s=(i,r)=>{r?e.push(new Oi(i,[new Ct(i)])):e.push(new Ct(i))};for(let i=0;i<t.length;i+=1){const r=t[i];r.length&&ia(r,s),i>=t.length-1||e.push(new ra)}return new or(n,e)}function h_(n){return new or(n,[new Ct(n)])}class d_{constructor(e,t){this.level=e,this.inlines=t}get type(){return"header"}}class xn{constructor(e,t){this.language=e,this.text=t}get type(){return"codeblock"}}class u_{constructor(e,t){this.items=t,this.startOffset=e}get type(){return"list"}}class m_{constructor(e,t){this.head=e,this.body=t}get type(){return"table"}}class p_{get type(){return"rule"}}class ra{get type(){return"newline"}}class Cs{constructor(e,t){this.format=e.toLowerCase(),this.children=t}get type(){return"format"}}class __{constructor(e,t,s,i,r){this.src=e,this.width=t,this.height=s,this.alt=i,this.title=r}get type(){return"image"}}class g_{constructor(e,t,s){this.id=e,this.href=t,this.children=s}get type(){return"pill"}get avatarColorNumber(){return ge(this.id)}get avatarInitials(){return _e(this.id)}}class Oi{constructor(e,t){this.url=e,this.inlines=t}get type(){return"link"}}class Ct{constructor(e){this.text=e}get type(){return"text"}}function f_(n){return n.type==="format"&&n.format==="blockquote"}class or{constructor(e,t){this.sourceString=e,this.parts=t}insertEmote(e){let t=0;for(;t<this.parts.length&&f_(this.parts[t]);t++);this.parts.splice(t,0,new Ct(e))}}const jt=Pe("Plain","Html");class na extends Qe{constructor(e,t){super(e,t),this._messageBody=null,this._format=null}get shape(){return"message"}_parseBody(e){return h_(e)}_getBodyFormat(){return jt.Plain}get body(){const e=this._getBody(),t=this._getBodyFormat();return(!this._messageBody||this._messageBody.sourceString!==e||this._format!==t)&&(this._messageBody=this._parseBody(e,t),this._format=t),this._messageBody}}const y_=["EM","STRONG","CODE","DEL","SPAN"],v_=["DIV","BLOCKQUOTE"],w_=["https","http","ftp","mailto","magnet"].map(n=>`${n}://`),b_="https://matrix.to",Nn=`${b_}/#/`;class S_{constructor(e,t){this.result=e,this.mediaRepository=t}parsePillLink(e){if(!e.startsWith(Nn))return null;const t=e.substring(Nn.length);return t[0]==="@"?t:null}parseLink(e,t){const s=this.result.getAttributeValue(e,"href"),i=s?.toLowerCase();if(!i||!w_.some(o=>i.startsWith(o)))return new Cs("span",t);const r=this.parsePillLink(s);return r?new g_(r,s,t):new Oi(s,t)}parseList(e){const t=this.result;let s=null;t.getNodeElementName(e)==="OL"&&(s=parseInt(t.getAttributeValue(e,"start"))||1);const i=[];for(const r of t.getChildNodes(e)){if(t.getNodeElementName(r)!=="LI")continue;const o=this.parseAnyNodes(t.getChildNodes(r));i.push(o)}return new u_(s,i)}_ensureElement(e,t){return e&&this.result.isElementNode(e)&&this.result.getNodeElementName(e)===t}parseCodeBlock(e){const t=this.result;let s;for(const o of t.getChildNodes(e)){s=o;break}let i=null;if(!this._ensureElement(s,"CODE"))return new xn(i,this.result.getNodeText(e));const r=t.getAttributeValue(s,"class")||"";for(const o of r.split(" "))if(o.startsWith("language-")&&!o.startsWith("language-_")){i=o.substring(9);break}return new xn(i,this.result.getNodeText(s))}parseImage(e){const t=this.result,s=t.getAttributeValue(e,"src")||"",i=this.mediaRepository.mxcUrl(s);if(!i)return null;const r=parseInt(t.getAttributeValue(e,"width"))||null,o=parseInt(t.getAttributeValue(e,"height"))||null,a=t.getAttributeValue(e,"alt"),l=t.getAttributeValue(e,"title");return new __(i,r,o,a,l)}parseTableRow(e,t){const s=[];for(const i of this.result.getChildNodes(e)){if(!this._ensureElement(i,t))continue;const r=this.result.getChildNodes(i),o=this.parseInlineNodes(r);s.push(o)}return s}parseTableHead(e){let t=null;for(const s of this.result.getChildNodes(e)){t=s;break}return this._ensureElement(t,"TR")?this.parseTableRow(t,"TH"):null}parseTableBody(e){const t=[];for(const s of this.result.getChildNodes(e))!this._ensureElement(s,"TR")||t.push(this.parseTableRow(s,"TD"));return t}parseTable(e){const t=Array.from(this.result.getChildNodes(e));let s,i;return this._ensureElement(t[0],"THEAD")&&this._ensureElement(t[1],"TBODY")?(s=this.parseTableHead(t[0]),i=this.parseTableBody(t[1])):this._ensureElement(t[0],"TBODY")&&(s=null,i=this.parseTableBody(t[0])),new m_(s,i)}parseInlineElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"A":{const r=this.parseInlineNodes(i);return this.parseLink(e,r)}case"BR":return new ra;default:{if(!y_.includes(s))return null;const r=this.parseInlineNodes(i);return new Cs(s,r)}}}parseInlineNode(e){return this.result.isElementNode(e)?this.parseInlineElement(e):null}parseBlockElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const r=this.parseInlineNodes(i);return new d_(parseInt(s[1]),r)}case"UL":case"OL":return this.parseList(e);case"PRE":return this.parseCodeBlock(e);case"HR":return new p_;case"IMG":return this.parseImage(e);case"P":{const r=this.parseInlineNodes(i);return new Cs(s,r)}case"TABLE":return this.parseTable(e);default:{if(!v_.includes(s))return null;const r=this.parseAnyNodes(i);return new Cs(s,r)}}}parseBlockNode(e){return this.result.isElementNode(e)?this.parseBlockElement(e):null}_parseTextParts(e,t){if(!this.result.isTextNode(e))return!1;const s=(i,r)=>{r?t.push(new Oi(i,[new Ct(i)])):t.push(new Ct(i))};return ia(this.result.getNodeText(e),s),!0}_isAllowedNode(e){return!this._ensureElement(e,"MX-REPLY")}_parseInlineNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const i=this.parseInlineNode(s);if(i){t.push(i);continue}this._isAllowedNode(s)&&this._parseInlineNodes(this.result.getChildNodes(s),t)}}parseInlineNodes(e){const t=[];return this._parseInlineNodes(e,t),t}_parseAnyNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const i=this.parseInlineNode(s)||this.parseBlockNode(s);if(i){t.push(i);continue}this._isAllowedNode(s)&&this._parseAnyNodes(this.result.getChildNodes(s),t)}}parseAnyNodes(e){const t=[];return this._parseAnyNodes(e,t),t}}function I_(n,e,t){const s=n.parseHTML(t),r=new S_(s,e).parseAnyNodes(s.rootNodes);return new or(t,r)}class E_ extends na{_getContentString(e){var t;return((t=this._getContent())==null?void 0:t[e])||""}_getPlainBody(){return this._getContentString("body")}_getFormattedBody(){return this._getContentString("formatted_body")}_getBody(){return this._getBodyFormat()===jt.Html?this._getFormattedBody():this._getPlainBody()}_getBodyFormat(){var e;return((e=this._getContent())==null?void 0:e.format)==="org.matrix.custom.html"?jt.Html:jt.Plain}_parseBody(e,t){var s;let i;return t===jt.Html?i=I_(this.platform,this._mediaRepository,e):i=c_(e),((s=this._getContent())==null?void 0:s.msgtype)==="m.emote"&&i.insertEmote(`* ${this.displayName} `),i}}class Dn extends Qe{get shape(){return"redacted"}get description(){const{redactionReason:e}=this._entry;return this.isRedacting?e?this.i18n`This message is being deleted (${e})`:this.i18n`This message is being deleted`:e?this.i18n`This message has been deleted (${e}).`:this.i18n`This message has been deleted.`}get isRedacting(){return this._entry.isRedacting}get canRedact(){return!1}abortPendingRedaction(){return this._entry.abortPendingRedaction()}}const k_=300,R_=400;class oa extends Qe{constructor(e,t){super(e,t),this._decryptedThumbnail=null,this._decryptedFile=null,this._isVisible=!1,this._error=null,this._downloading=!1,this._downloadError=null}async downloadMedia(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("status");let s;try{s=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(s,t)}catch(i){this._downloadError=i}finally{s?.dispose(),this._downloading=!1}this.emitChange("status")}get isUploading(){return this.isPending&&this._entry.pendingEvent.status===D.UploadingAttachments}get uploadPercentage(){const{pendingEvent:e}=this._entry;return e&&Math.round(e.attachmentsSentBytes/e.attachmentsTotalBytes*100)}get status(){const{pendingEvent:e}=this._entry;switch(e?.status){case D.Waiting:return this.i18n`Waiting`;case D.EncryptingAttachments:case D.Encrypting:return this.i18n`Encrypting`;case D.UploadingAttachments:return this.i18n`Uploading`;case D.Sending:return this.i18n`Sending`;case D.Error:return this.i18n`Error: ${e.error.message}`;default:return this._downloadError?"Download failed":this._downloading?this.i18n`Downloading`:""}}get thumbnailUrl(){var e,t;if(!this._isVisible)return"";if(this._decryptedThumbnail)return this._decryptedThumbnail.url;{const s=(e=this._getContent().info)==null?void 0:e.thumbnail_url;if(s)return this._mediaRepository.mxcUrlThumbnail(s,this.width,this.height,"scale")}if(this._entry.isPending){const s=this._entry.pendingEvent.getAttachment("info.thumbnail_url");return s&&s.localPreview.url}if(this._isMainResourceImage()){if(this._decryptedFile)return this._decryptedFile.url;{const s=(t=this._getContent())==null?void 0:t.url;if(typeof s=="string")return this._mediaRepository.mxcUrlThumbnail(s,this.width,this.height,"scale")}}return""}notifyVisible(){super.notifyVisible(),this._isVisible=!0,this.emitChange("thumbnailUrl"),this.isPending||this._tryLoadEncryptedThumbnail()}get width(){var e;const t=(e=this._getContent())==null?void 0:e.info;return Math.round(t?.w*this._scaleFactor())}get height(){var e;const t=(e=this._getContent())==null?void 0:e.info;return Math.round(t?.h*this._scaleFactor())}get mimeType(){var e;const t=(e=this._getContent())==null?void 0:e.info;return t?.mimetype}get label(){return this._getContent().body}get error(){return this._error?`Could not load media: ${this._error.message}`:null}setViewError(e){this._error=e,this.emitChange("error")}async _loadEncryptedFile(e){const t=await this._mediaRepository.downloadEncryptedFile(e,!0);if(this.isDisposed){t.dispose();return}return this.track(t)}async _tryLoadEncryptedThumbnail(){var e;try{const t=(e=this._getContent().info)==null?void 0:e.thumbnail_file,s=this._getContent().file;t?(this._decryptedThumbnail=await this._loadEncryptedFile(t),this.emitChange("thumbnailUrl")):s&&this._isMainResourceImage()&&(this._decryptedFile=await this._loadEncryptedFile(s),this.emitChange("thumbnailUrl"))}catch(t){this._error=t,this.emitChange("error")}}_scaleFactor(){var e;const t=(e=this._getContent())==null?void 0:e.info,s=k_/t?.h,i=R_/t?.w;return Math.min(i,s,1)}_isMainResourceImage(){return!0}}class C_ extends oa{constructor(e,t){super(e,t),this._lightboxUrl=this.urlCreator.urlForSegments([this.navigation.segment("room",this._room.id),this.navigation.segment("lightbox",this._entry.id)])}get lightboxUrl(){return this.isPending?"":this._lightboxUrl}get shape(){return"image"}}class T_ extends oa{async loadVideo(){const e=this._getContent().file;e&&!this._decryptedFile&&(this._decryptedFile=await this._loadEncryptedFile(e),this.emitChange("videoUrl"))}get videoUrl(){var e;if(this._decryptedFile)return this._decryptedFile.url;const t=(e=this._getContent())==null?void 0:e.url;return typeof t=="string"?this._mediaRepository.mxcUrl(t):""}get shape(){return"video"}_isMainResourceImage(){return!1}}function M_(n,e=2){if(Number.isSafeInteger(n)){const t=Math.min(3,Math.floor(Math.log(n)/Math.log(1024))),s=Math.round(n/Math.pow(1024,t)).toFixed(e);switch(t){case 0:return`${s} bytes`;case 1:return`${s} KB`;case 2:return`${s} MB`;case 3:return`${s} GB`}}return""}class A_ extends Qe{constructor(e,t){super(e,t),this._downloadError=null,this._downloading=!1}async download(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("label");let s;try{s=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(s,t)}catch(i){this._downloadError=i}finally{s?.dispose(),this._downloading=!1}this.emitChange("label")}get label(){var e;if(this._downloadError)return`Could not download file: ${this._downloadError.message}`;const s=this._getContent().body;if(this._entry.isPending){const{pendingEvent:i}=this._entry;switch(i?.status){case D.Waiting:return this.i18n`Waiting to send ${s}`;case D.EncryptingAttachments:case D.Encrypting:return this.i18n`Encrypting ${s}`;case D.UploadingAttachments:{const r=Math.round(i.attachmentsSentBytes/i.attachmentsTotalBytes*100);return this.i18n`Uploading ${s}: ${r}%`}case D.Sending:case D.Sent:return this.i18n`Sending ${s}`;case D.Error:return this.i18n`Error: could not send ${s}: ${i.error.message}`;default:return`Unknown send status for ${s}`}}else{const i=M_((e=this._getContent().info)==null?void 0:e.size);return this._downloading?this.i18n`Downloading ${s} (${i})`:this.i18n`Download ${s} (${i})`}}get shape(){return"file"}}class x_ extends Qe{get shape(){return"location"}get mapsLink(){try{const e=new URL(this._getContent().geo_uri);if(e.protocol!=="geo:")return"";const[t,...s]=e.pathname.split(";"),[i,r]=t.split(","),o=parseFloat(i),a=parseFloat(r);let l;for(const c of s){const[h,d]=c.split("=");h==="u"&&(l=parseFloat(d))}if(this.platform.isIOS)return`http://maps.apple.com/?ll=${o},${a}`;{let c=`geo:${o},${a}`;return l&&(c=c+`;u=${l}`),c}}catch{return""}}get label(){return this.i18n`${this.displayName} sent their location`}}class N_ extends os{get shape(){return"announcement"}get announcement(){const e=this._entry.content;return`${this._entry.displayName||this._entry.sender} named the room "${e?.name}"`}}class D_ extends os{get shape(){return"announcement"}get announcement(){var e,t;const{sender:s,content:i,prevContent:r,stateKey:o}=this._entry,a=this._entry.displayName||s,l=s===o?a:((e=this._entry.content)==null?void 0:e.displayname)||o,c=i&&i.membership,h=r&&r.membership;if(h==="join"&&c==="join"){if(i.avatar_url!==r.avatar_url)return`${a} changed their avatar`;if(i.displayname!==r.displayname)return i.displayname?`${(t=r.displayname)!=null?t:o} changed their name to ${i.displayname}`:`${o} removed their name (${r.displayname})`}else{if(c==="join")return`${l} joined the room`;if(c==="invite")return`${l} was invited to the room by ${a}`;if(h==="invite"){if(c==="join")return`${l} accepted the invitation to join the room`;if(c==="leave")return`${l} declined the invitation to join the room`}else if(c==="leave"){if(o===s)return`${l} left the room`;{const d=i.reason;return`${l} was kicked from the room by ${a}${d?`: ${d}`:""}`}}else if(c==="ban")return`${l} was banned from the room by ${a}`}return`${s} membership changed to ${i.membership}`}}class O_ extends na{updateEntry(e,t){const s=super.updateEntry(e,t);return e.eventType!=="m.room.encrypted"?we.Replace("shape"):s}get shape(){return"message-status"}_getBody(){const e=this._entry.decryptionError,t=e?.code;let s;return t==="MEGOLM_NO_SESSION"?s=this.i18n`The sender hasn't sent us the key for this message yet.`:s=e?.message||this.i18n`Could not decrypt message because of unknown reason.`,s}}class L_ extends os{get shape(){return"announcement"}get announcement(){const e=this._entry.displayName||this._entry.sender;return this.i18n`${e} has enabled end-to-end encryption`}}class P_ extends Qe{get shape(){return"missing-attachment"}get label(){const e=this._getContent().body;return this._getContent().msgtype==="m.image"?this.i18n`The image ${e} wasn't fully sent previously and could not be recovered.`:this.i18n`The file ${e} wasn't fully sent previously and could not be recovered.`}}function V_(n){if(n.isGap)return s_;if(n.isPending&&n.pendingEvent.isMissingAttachments)return P_;if(n.eventType)switch(n.eventType){case"m.room.message":{if(n.isRedacted)return Dn;const e=n.content;switch(e&&e.msgtype){case"m.text":case"m.notice":case"m.emote":return E_;case"m.image":return C_;case"m.video":return T_;case"m.file":return A_;case"m.location":return x_;default:return}}case"m.room.name":return N_;case"m.room.member":return D_;case"m.room.encrypted":return n.isRedacted?Dn:O_;case"m.room.encryption":return L_;default:return}}class On extends A{constructor(e){super(e);const{room:t,tileClassForEntry:s}=e;this._room=t,this._timelineVM=null,this._tileClassForEntry=s??V_,this._tileOptions=void 0,this._onRoomChange=this._onRoomChange.bind(this),this._timelineError=null,this._sendError=null,this._composerVM=null,t.isArchived?this._composerVM=this.track(new F_(this.childOptions({archivedRoom:t}))):this._recreateComposerOnPowerLevelChange(),this._clearUnreadTimout=null,this._closeUrl=this.urlCreator.urlUntilSegment("session")}async load(){this._room.on("change",this._onRoomChange);try{const e=await this._room.openTimeline();this._tileOptions=this.childOptions({roomVM:this,timeline:e,tileClassForEntry:this._tileClassForEntry}),this._timelineVM=this.track(new e_(this.childOptions({tileOptions:this._tileOptions,timeline:e}))),this.emitChange("timelineViewModel")}catch(e){console.error(`room.openTimeline(): ${e.message}:
${e.stack}`),this._timelineError=e,this.emitChange("error")}this._clearUnreadAfterDelay()}async _recreateComposerOnPowerLevelChange(){const e=await this._room.observePowerLevels(),t=()=>e.get().canSendType("m.room.message");let s=t();const i=r=>{this._composerVM=this.disposeTracked(this._composerVM),r?this._composerVM=this.track(new t_(this)):this._composerVM=this.track(new B_(this.childOptions())),this.emitChange("powerLevelObservable")};this.track(e.subscribe(()=>{const r=t();s!==r&&(i(r),s=r)})),i(s)}async _clearUnreadAfterDelay(){if(!(this._room.isArchived||this._clearUnreadTimout)){this._clearUnreadTimout=this.clock.createTimeout(2e3);try{await this._clearUnreadTimout.elapsed(),await this._room.clearUnread(),this._clearUnreadTimout=null}catch(e){if(e.name!=="AbortError")throw e}}}focus(){this._clearUnreadAfterDelay()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange),this._room.isArchived&&this._room.release(),this._clearUnreadTimout&&(this._clearUnreadTimout.abort(),this._clearUnreadTimout=null)}_onRoomChange(){this._composerVM.emitChange(),this.emitChange()}get kind(){return"room"}get closeUrl(){return this._closeUrl}get name(){return this._room.name||this.i18n`Empty Room`}get id(){return this._room.id}get timelineViewModel(){return this._timelineVM}get isEncrypted(){return this._room.isEncrypted}get error(){return this._timelineError?`Something went wrong loading the timeline: ${this._timelineError.message}`:this._sendError?`Something went wrong sending your message: ${this._sendError.message}`:""}get avatarLetter(){return _e(this.name)}get avatarColorNumber(){return ge(this._room.avatarColorId)}avatarUrl(e){return Ue(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}get canLeave(){return this._room.isJoined}leaveRoom(){this._room.leave()}get canForget(){return this._room.isArchived}forgetRoom(){this._room.forget()}get canRejoin(){return this._room.isArchived}rejoinRoom(){this._room.join()}_createTile(e){if(this._tileOptions){const t=this._tileOptions.tileClassForEntry(e);if(t)return new t(e,this._tileOptions)}}async _processCommandJoin(e){var t,s,i,r;try{const o=await this._options.client.session.joinRoom(e);await(await this._options.client.session.observeRoomStatus(o)).waitFor(l=>l===U.Joined),this.navigation.push("room",o)}catch(o){let a;((t=o.statusCode)!=null?t:o.status)===400?a=new Error(`/join : '${e}' was not legal room ID or room alias`):((s=o.statusCode)!=null?s:o.status)===404||((i=o.statusCode)!=null?i:o.status)===502||o.message=="Internal Server Error"?a=new Error(`/join : room '${e}' not found`):((r=o.statusCode)!=null?r:o.status)===403?a=new Error(`/join : you're not invited to join '${e}'`):a=o,this._sendError=a,this._timelineError=null,this.emitChange("error")}}async _processCommand(e){let t;const[s,...i]=e.substring(1).split(" ");switch(s){case"me":e=i.join(" "),t="m.emote";break;case"join":if(i.length===1){const r=i[0];await this._processCommandJoin(r)}else this._sendError=new Error("join syntax: /join <room-id>"),this._timelineError=null,this.emitChange("error");break;case"shrug":e="\xAF\\_(\u30C4)_/\xAF "+i.join(" "),t="m.text";break;case"tableflip":e="(\u256F\xB0\u25A1\xB0\uFF09\u256F\uFE35 \u253B\u2501\u253B "+i.join(" "),t="m.text";break;case"unflip":e="\u252C\u2500\u2500\u252C \u30CE( \u309C-\u309C\u30CE) "+i.join(" "),t="m.text";break;case"lenny":e="( \u0361\xB0 \u035C\u0296 \u0361\xB0) "+i.join(" "),t="m.text";break;default:this._sendError=new Error(`no command name "${s}". To send the message instead of executing, please type "/${e}"`),this._timelineError=null,this.emitChange("error"),e=void 0}return{type:t,message:e}}async _sendMessage(e,t){if(!this._room.isArchived&&e){let s={type:"m.text",message:e};e.startsWith("//")?s.message=e.substring(1).trim():e.startsWith("/")&&(s=await this._processCommand(e));try{const i=s.type,r=s.message;i&&r&&(t?await t.reply(i,r):await this._room.sendEvent("m.room.message",{msgtype:i,body:r}))}catch(i){return console.error(`room.sendMessage(): ${i.message}:
${i.stack}`),this._sendError=i,this._timelineError=null,this.emitChange("error"),!1}return!0}return!1}async _pickAndSendFile(){try{const e=await this.platform.openFile();return e?this._sendFile(e):void 0}catch(e){console.error(e)}}async _sendFile(e){const t={body:e.name,msgtype:"m.file"};await this._room.sendEvent("m.room.message",t,{url:this._room.createAttachment(e.blob,e.name)})}async _pickAndSendVideo(){try{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}const e=await this.platform.openFile("video/*");if(!e)return;if(!e.blob.mimeType.startsWith("video/"))return this._sendFile(e);let t;try{t=await this.platform.loadVideo(e.blob)}catch(l){throw l instanceof window.MediaError&&l.code===4?new Error(`this browser does not support videos of type ${e?.blob.mimeType}.`):l}const s={body:e.name,msgtype:"m.video",info:U_(t)},i={url:this._room.createAttachment(t.blob,e.name)},o=await this.platform.settingsStorage.getInt("sentImageSizeLimit")||Math.min(t.maxDimension,800),a=await t.scale(o);s.info.thumbnail_info=Yt(a),i["info.thumbnail_url"]=this._room.createAttachment(a.blob,e.name),await this._room.sendEvent("m.room.message",s,i)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}async _pickAndSendPicture(){try{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}const e=await this.platform.openFile("image/*");if(!e)return;if(!e.blob.mimeType.startsWith("image/"))return this._sendFile(e);let t=await this.platform.loadImage(e.blob);const s=await this.platform.settingsStorage.getInt("sentImageSizeLimit");if(s&&t.maxDimension>s){const o=await t.scale(s);t.dispose(),t=o}const i={body:e.name,msgtype:"m.image",info:Yt(t)},r={url:this._room.createAttachment(t.blob,e.name)};if(t.maxDimension>600){const o=await t.scale(400);i.info.thumbnail_info=Yt(o),r["info.thumbnail_url"]=this._room.createAttachment(o.blob,e.name)}await this._room.sendEvent("m.room.message",i,r)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}get room(){return this._room}get composerViewModel(){return this._composerVM}openDetailsPanel(){let e=this.navigation.path.until("room");e=e.with(this.navigation.segment("right-panel",!0)),e=e.with(this.navigation.segment("details",!0)),this.navigation.applyPath(e)}startReply(e){this._room.isArchived||this._composerVM.setReplyingTo(e)}dismissError(){this._sendError=null,this.emitChange("error")}}function U_(n){const e=Yt(n);return e.duration=n.duration,e}class F_ extends A{constructor(e){super(e),this._archivedRoom=e.archivedRoom}get description(){return this._archivedRoom.isKicked?this._archivedRoom.kickReason?this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name}.`:this._archivedRoom.isBanned?this._archivedRoom.kickReason?this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name}.`:this.i18n`You left this room`}get kind(){return"disabled"}}class B_ extends A{get description(){return this.i18n`You do not have the powerlevel necessary to send messages`}get kind(){return"disabled"}}class K_ extends A{constructor(e){super(e);const{roomIdOrAlias:t,session:s}=e;this._session=s,this.roomIdOrAlias=t,this._error=null,this._busy=!1}get error(){var e;return(e=this._error)==null?void 0:e.message}async join(){this._busy=!0,this.emitChange("busy");try{const e=await this._session.joinRoom(this.roomIdOrAlias);this.navigation.push("room",e)}catch(e){this._error=e,this._busy=!1,this.emitChange("error")}}get busy(){return this._busy}get kind(){return"unknown"}}class $_ extends A{constructor(e){super(e);const{invite:t,mediaRepository:s}=e;this._invite=t,this._mediaRepository=s,this._onInviteChange=this._onInviteChange.bind(this),this._error=null,this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._invite.on("change",this._onInviteChange),this._inviter=null,this._invite.inviter&&(this._inviter=new j_(this._invite.inviter,s,this.platform)),this._roomDescription=this._createRoomDescription()}get kind(){return"invite"}get closeUrl(){return this._closeUrl}get name(){return this._invite.name}get id(){return this._invite.id}get isEncrypted(){return this._invite.isEncrypted}get isDirectMessage(){return this._invite.isDirectMessage}get inviter(){return this._inviter}get busy(){return this._invite.accepting||this._invite.rejecting}get error(){return this._error?`Something went wrong: ${this._error.message}`:""}get avatarLetter(){return _e(this.name)}get avatarColorNumber(){return ge(this._invite.avatarColorId)}avatarUrl(e){return Ue(this._invite.avatarUrl,e,this.platform,this._mediaRepository)}_createRoomDescription(){const e=[];return this._invite.isPublic?e.push("Public room"):e.push("Private room"),this._invite.canonicalAlias&&e.push(this._invite.canonicalAlias),e.join(" \u2022 ")}get roomDescription(){return this._roomDescription}get avatarTitle(){return this.name}focus(){}async accept(){try{await this._invite.accept()}catch(e){this._error=e,this.emitChange("error")}}async reject(){try{await this._invite.reject()}catch(e){this._error=e,this.emitChange("error")}}_onInviteChange(){this.emitChange()}dispose(){super.dispose(),this._invite.off("change",this._onInviteChange)}}class j_{constructor(e,t,s){this._member=e,this._mediaRepository=t,this._platform=s}get id(){return this._member.userId}get name(){return this._member.name}get avatarLetter(){return _e(this.name)}get avatarColorNumber(){return ge(this._member.userId)}avatarUrl(e){return Ue(this._member.avatarUrl,e,this._platform,this._mediaRepository)}get avatarTitle(){return this.name}}class q_ extends A{constructor(e){super(e);const{roomBeingCreated:t,mediaRepository:s}=e;this._roomBeingCreated=t,this._mediaRepository=s,this._onRoomChange=this._onRoomChange.bind(this),this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._roomBeingCreated.on("change",this._onRoomChange)}get kind(){return"roomBeingCreated"}get closeUrl(){return this._closeUrl}get name(){return this._roomBeingCreated.name}get id(){return this._roomBeingCreated.id}get isEncrypted(){return this._roomBeingCreated.isEncrypted}get error(){const{error:e}=this._roomBeingCreated;return e?e.name==="ConnectionError"?this.i18n`You seem to be offline`:e.message:""}get avatarLetter(){return _e(this.name)}get avatarColorNumber(){return ge(this._roomBeingCreated.avatarColorId)}get avatarTitle(){return this.name}avatarUrl(e){var t;return(t=this._roomBeingCreated.avatarBlobUrl)!=null?t:Ue(this._roomBeingCreated.avatarUrl,e,this.platform,this._mediaRepository)}focus(){}_onRoomChange(){this.emitChange()}cancel(){this._roomBeingCreated.cancel(),this.navigation.applyPath(this.navigation.path.until("session"))}dispose(){super.dispose(),this._roomBeingCreated.off("change",this._onRoomChange)}}class H_ extends A{constructor(e){super(e),this._eventId=e.eventId,this._unencryptedImageUrl=null,this._decryptedImage=null,this._closeUrl=this.urlCreator.urlUntilSegment("room"),this._eventEntry=null,this._date=null,this._subscribeToEvent(e.room,e.eventId)}_subscribeToEvent(e,t){const s=e.observeEvent(t);this.track(s.subscribe(i=>{this._loadEvent(e,i)})),this._loadEvent(e,s.get())}async _loadEvent(e,t){if(!t)return;const{mediaRepository:s}=e;this._eventEntry=t;const{content:i}=this._eventEntry;this._date=this._eventEntry.timestamp?new Date(this._eventEntry.timestamp):null,i.url?(this._unencryptedImageUrl=s.mxcUrl(i.url),this.emitChange("imageUrl")):i.file&&(this._decryptedImage=this.track(await s.downloadEncryptedFile(i.file)),this.emitChange("imageUrl"))}get imageWidth(){var e,t,s;return(s=(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.info)==null?void 0:s.w}get imageHeight(){var e,t,s;return(s=(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.info)==null?void 0:s.h}get name(){var e,t;return(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.body}get sender(){var e;return(e=this._eventEntry)==null?void 0:e.displayName}get imageUrl(){return this._decryptedImage?this._decryptedImage.url:this._unencryptedImageUrl?this._unencryptedImageUrl:""}get date(){return this._date&&this._date.toLocaleDateString({},{weekday:"long",year:"numeric",month:"long",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get closeUrl(){return this._closeUrl}close(){this.platform.history.pushUrl(this.closeUrl)}}const X=Pe("Disconnected","Connecting","FirstSync","Sending","Syncing","SyncError");class W_ extends A{constructor(e){super(e);const{sync:t,reconnector:s,session:i}=e;this._sync=t,this._reconnector=s,this._status=this._calculateState(s.connectionStatus.get(),t.status.get()),this._session=i,this._setupKeyBackupUrl=this.urlCreator.urlForSegment("settings"),this._dismissSecretStorage=!1}start(){const e=()=>this._updateStatus();this.track(this._sync.status.subscribe(e)),this.track(this._reconnector.connectionStatus.subscribe(e)),this.track(this._session.needsKeyBackup.subscribe(()=>{this.emitChange()}))}get setupKeyBackupUrl(){return this._setupKeyBackupUrl}get isShown(){return this._session.needsKeyBackup.get()&&!this._dismissSecretStorage||this._status!==X.Syncing}get statusLabel(){switch(this._status){case X.Disconnected:{const e=Math.round(this._reconnector.retryIn/1e3);return this.i18n`Disconnected, trying to reconnect in ${e}s`}case X.Connecting:return this.i18n`Trying to reconnect now`;case X.FirstSync:return this.i18n`Catching up with your conversations`;case X.SyncError:return this.i18n`Sync failed because of ${this._sync.error}`}return this._session.needsKeyBackup.get()?this.i18n`Set up session backup to decrypt older messages.`:""}get isWaiting(){switch(this._status){case X.Connecting:case X.FirstSync:return!0;default:return!1}}_updateStatus(){const e=this._calculateState(this._reconnector.connectionStatus.get(),this._sync.status.get());e!==this._status&&(e===X.Disconnected?this._retryTimer=this.track(this.clock.createInterval(()=>{this.emitChange("statusLabel")},1e3)):this._retryTimer=this.disposeTracked(this._retryTimer),this._status=e,this.emitChange())}_calculateState(e,t){if(e!==zt.Online)switch(e){case zt.Reconnecting:return X.Connecting;case zt.Waiting:return X.Disconnected}else if(t!==L.Syncing)switch(t){case L.InitialSync:case L.CatchupSync:return X.FirstSync;case L.Stopped:return X.SyncError}else return X.Syncing}get isConnectNowShown(){return this._status===X.Disconnected}get isSecretStorageShown(){return this._status===X.Syncing&&this._session.needsKeyBackup.get()&&!this._dismissSecretStorage}get canDismiss(){return this.isSecretStorageShown}dismiss(){this.isSecretStorageShown&&(this._dismissSecretStorage=!0,this.emitChange())}connectNow(){this.isConnectNowShown&&this._reconnector.tryNow()}}function Ln(n){return n.map((e,t)=>{if(!n.slice(0,t).includes(e))return e})}class z_ extends A{constructor(e){super(e),this._width=e.width,this._height=e.height,this._createRoomViewModelObservable=e.createRoomViewModelObservable,this._selectedIndex=0,this._viewModelsObservables=[],this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("empty-grid-tile");this.track(e.subscribe(s=>{typeof s=="number"&&this._setFocusIndex(s)})),typeof e.get()=="number"&&(this._selectedIndex=e.get());const t=this.navigation.observe("room");this.track(t.subscribe(s=>{s&&this._setFocusRoom(s)}))}roomViewModelAt(e){var t;return(t=this._viewModelsObservables[e])==null?void 0:t.get()}get focusIndex(){return this._selectedIndex}get width(){return this._width}get height(){return this._height}_switchToRoom(e){let t=this.navigation.path.until("rooms");t=t.with(this.navigation.segment("room",e)),t=Ni(this.navigation,t),this.navigation.applyPath(t)}focusTile(e){if(e===this._selectedIndex)return;const t=this._viewModelsObservables[e];t?this._switchToRoom(t.id):this.navigation.push("empty-grid-tile",e)}initializeRoomIdsAndTransferVM(e,t){e=Ln(e);let s=!1;if(t){const r=e.indexOf(t.id);r!==-1&&(this._viewModelsObservables[r]=this.track(t),t.subscribe(o=>this._refreshRoomViewModel(o)),s=!0)}this.setRoomIds(e);const i=this.navigation.path.get("room");if(i){const r=this._viewModelsObservables.findIndex(o=>o&&o.id===i.value);r!==-1&&(this._selectedIndex=r)}return s}setRoomIds(e){e=Ln(e);let t=!1;const s=this._height*this._width;for(let i=0;i<s;i+=1){const r=e[i],o=this._viewModelsObservables[i];if(!o&&r||o&&o.id!==r){if(o&&(this._viewModelsObservables[i]=this.disposeTracked(o)),r){const a=this._createRoomViewModelObservable(r);this._viewModelsObservables[i]=this.track(a),a.subscribe(l=>this._refreshRoomViewModel(l)),a.initialize()}t=!0}}return t&&this.emitChange(),t}_refreshRoomViewModel(e){this.emitChange(),e?.focus()}releaseRoomViewModel(e){const t=this._viewModelsObservables.findIndex(s=>s&&s.id===e);if(t!==-1){const s=this._viewModelsObservables[t];return this.untrack(s),s.unsubscribeAll(),this._viewModelsObservables[t]=null,s}}_setFocusIndex(e){var t;if(e===this._selectedIndex||e>=this._width*this._height)return;this._selectedIndex=e;const s=this._viewModelsObservables[this._selectedIndex];(t=s?.get())==null||t.focus(),this.emitChange("focusIndex")}_setFocusRoom(e){const t=this._viewModelsObservables.findIndex(s=>s?.id===e);t>=0&&this._setFocusIndex(t)}}const re=Pe("Enabled","SetupKey","SetupPhrase","Pending","NewVersionAvailable"),Ft=Pe("Writing","Stopped","Done","Pending");class G_ extends A{constructor(e){super(e),this._session=e.session,this._error=null,this._isBusy=!1,this._dehydratedDeviceId=void 0,this._status=void 0,this._backupOperation=this._session.keyBackup.flatMap(t=>t.operationInProgress),this._progress=this._backupOperation.flatMap(t=>t.progress),this.track(this._backupOperation.subscribe(()=>{this._reevaluateStatus(),this.emitChange("isBackingUp")})),this.track(this._progress.subscribe(()=>this.emitChange("backupPercentage"))),this._reevaluateStatus(),this.track(this._session.keyBackup.subscribe(()=>{this._reevaluateStatus()&&this.emitChange("status")}))}_reevaluateStatus(){if(this._isBusy)return!1;let e;const t=this._session.keyBackup.get();t?e=t.needsNewKey?re.NewVersionAvailable:re.Enabled:t===null?e=this.showPhraseSetup()?re.SetupPhrase:re.SetupKey:e=re.Pending;const s=e!==this._status;return this._status=e,s}get decryptAction(){return this.i18n`Set up`}get purpose(){return this.i18n`set up key backup`}offerDehydratedDeviceSetup(){return!0}get dehydratedDeviceId(){return this._dehydratedDeviceId}get isBusy(){return this._isBusy}get backupVersion(){var e;return(e=this._session.keyBackup.get())==null?void 0:e.version}get backupWriteStatus(){const e=this._session.keyBackup.get();if(e){if(e.hasStopped)return Ft.Stopped}else return Ft.Pending;return e.operationInProgress.get()?Ft.Writing:e.hasBackedUpAllKeys?Ft.Done:Ft.Pending}get backupError(){var e,t;return(t=(e=this._session.keyBackup.get())==null?void 0:e.error)==null?void 0:t.message}get status(){return this._status}get error(){var e;return(e=this._error)==null?void 0:e.message}showPhraseSetup(){this._status===re.SetupKey&&(this._status=re.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===re.SetupPhrase&&(this._status=re.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t,s){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const i=await this._session.enableSecretStorage(e,t);s&&(this._dehydratedDeviceId=await this._session.setupDehydratedDevice(i))}catch(i){console.error(i),this._error=i,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}enterSecurityPhrase(e,t){this._enterCredentials(ts.Passphrase,e,t)}enterSecurityKey(e,t){this._enterCredentials(ts.RecoveryKey,e,t)}async disable(){try{this._isBusy=!0,this.emitChange("isBusy"),await this._session.disableSecretStorage()}catch(e){console.error(e),this._error=e,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}get isBackingUp(){return!!this._backupOperation.get()}get backupPercentage(){const e=this._progress.get();return e?Math.round(e.finished/e.total*100):0}get backupInProgressLabel(){const e=this._progress.get();return e?this.i18n`${e.finished} of ${e.total}`:this.i18n``}cancelBackup(){var e;(e=this._backupOperation.get())==null||e.abort()}startBackup(){var e;(e=this._session.keyBackup.get())==null||e.flush()}}async function Y_(n,e,t,s){const i=new Map;n.text&&i.set("text",n.text),i.set("user_agent",n.userAgent),i.set("app",n.app),i.set("version",n.version),n.label&&i.set("label",n.label),i.set("file",{name:"logs.json",blob:e});const r=new Map;r.set("Accept","application/json");const o=s(t,{method:"POST",body:i,headers:r});let a;try{a=await o.response()}catch(h){throw new Error(`Could not submit logs to ${t}, got error ${h.message}`)}const{status:l,body:c}=a;if(l<200||l>=300)throw new Error(`Could not submit logs to ${t}, got status code ${l} with body ${c}`)}class J_{constructor(){this.supported=null,this.enabled=!1,this.updating=!1,this.enabledOnServer=null,this.serverError=null}}function Q_(n){const t=Math.ceil(n.length/4);let s="";for(let i=0;i<t;i+=1)s+=(s.length?" ":"")+n.slice(i*4,(i+1)*4);return s}class X_ extends A{constructor(e){super(e),this._updateService=e.updateService;const{client:t}=e;this._client=t,this._keyBackupViewModel=this.track(new G_(this.childOptions({session:this._session}))),this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._estimate=null,this.sentImageSizeLimit=null,this.minSentImageSizeLimit=400,this.maxSentImageSizeLimit=4e3,this.pushNotifications=new J_,this._activeTheme=void 0,this._logsFeedbackMessage=void 0}get _session(){return this._client.session}async logout(){this.navigation.push("logout",this._client.sessionId)}setSentImageSizeLimit(e){e>this.maxSentImageSizeLimit||e<this.minSentImageSizeLimit?(this.sentImageSizeLimit=null,this.platform.settingsStorage.remove("sentImageSizeLimit")):(this.sentImageSizeLimit=Math.round(e),this.platform.settingsStorage.setInt("sentImageSizeLimit",e)),this.emitChange("sentImageSizeLimit")}async load(){this._estimate=await this.platform.estimateStorageUsage(),this.sentImageSizeLimit=await this.platform.settingsStorage.getInt("sentImageSizeLimit"),this.pushNotifications.supported=await this.platform.notificationService.supportsPush(),this.pushNotifications.enabled=await this._session.arePushNotificationsEnabled(),this._activeTheme=await this.platform.themeLoader.getActiveTheme(),this.emitChange("")}get closeUrl(){return this._closeUrl}get fingerprintKey(){const e=this._session.fingerprintKey;return e?Q_(e):null}get deviceId(){return this._session.deviceId}get userId(){return this._session.userId}get version(){const{updateService:e}=this.platform;return e?`${e.version} (${e.buildHash})`:this.i18n`development version`}checkForUpdate(){var e;(e=this.platform.updateService)==null||e.checkForUpdate()}get showUpdateButton(){return!!this.platform.updateService}get keyBackupViewModel(){return this._keyBackupViewModel}get storageQuota(){var e;return this._formatBytes((e=this._estimate)==null?void 0:e.quota)}get storageUsage(){var e;return this._formatBytes((e=this._estimate)==null?void 0:e.usage)}get themeMapping(){return this.platform.themeLoader.themeMapping}get activeTheme(){return this._activeTheme}_formatBytes(e){return typeof e=="number"?Math.round(e/(1024*1024)).toFixed(1)+" MB":this.i18n`unknown`}async exportLogs(){const e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}get canSendLogsToServer(){return!!this.platform.config.bugReportEndpointUrl}get logsServer(){const{bugReportEndpointUrl:e}=this.platform.config;try{if(e)return new URL(e).hostname}catch{}return""}async sendLogsToServer(){const{bugReportEndpointUrl:e}=this.platform.config;if(e){this._logsFeedbackMessage=this.i18n`Sending logs`,this.emitChange();try{const t=await this.logger.export();await Y_({app:"hydrogen",userAgent:this.platform.description,version:"0.3.0",text:`Submit logs from settings for user ${this._session.userId} on device ${this._session.deviceId}`},t.asBlob(),e,this.platform.request),this._logsFeedbackMessage=this.i18n`Logs sent succesfully!`,this.emitChange()}catch(t){this._logsFeedbackMessage=t.message,this.emitChange()}}}get logsFeedbackMessage(){return this._logsFeedbackMessage}async togglePushNotifications(){this.pushNotifications.updating=!0,this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null,this.emitChange("pushNotifications.updating");try{await this._session.enablePushNotifications(!this.pushNotifications.enabled)&&(this.pushNotifications.enabled=!this.pushNotifications.enabled,this.pushNotifications.enabled&&this.platform.notificationService.showNotification(this.i18n`Push notifications are now enabled`))}finally{this.pushNotifications.updating=!1,this.emitChange("pushNotifications.updating")}}async checkPushEnabledOnServer(){this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null;try{this.pushNotifications.enabledOnServer=await this._session.checkPusherEnabledOnHomeserver(),this.emitChange("pushNotifications.enabledOnServer")}catch(e){this.pushNotifications.serverError=e,this.emitChange("pushNotifications.serverError")}}changeThemeOption(e,t){this.platform.themeLoader.setTheme(e,t),this.emitChange("themeOption")}}class Z_ extends A{constructor(e){super(e);const{session:t}=e;this._session=t,this._name=void 0,this._topic=void 0,this._roomAlias=void 0,this._isPublic=!1,this._isEncrypted=!0,this._isAdvancedShown=!1,this._isFederationDisabled=!1,this._avatarScaledBlob=void 0,this._avatarFileName=void 0,this._avatarInfo=void 0}get isPublic(){return this._isPublic}get isEncrypted(){return this._isEncrypted}get canCreate(){return!!this._name}avatarUrl(){return this._avatarScaledBlob.url}get avatarTitle(){return this._name}get avatarLetter(){return""}get avatarColorNumber(){return 0}get hasAvatar(){return!!this._avatarScaledBlob}get isFederationDisabled(){return this._isFederationDisabled}get isAdvancedShown(){return this._isAdvancedShown}setName(e){this._name=e,this.emitChange("canCreate")}setRoomAlias(e){this._roomAlias=e}setTopic(e){this._topic=e}setPublic(e){this._isPublic=e,this.emitChange("isPublic")}setEncrypted(e){this._isEncrypted=e,this.emitChange("isEncrypted")}setFederationDisabled(e){this._isFederationDisabled=e,this.emitChange("isFederationDisabled")}toggleAdvancedShown(){this._isAdvancedShown=!this._isAdvancedShown,this.emitChange("isAdvancedShown")}create(){var e,t;let s;this._avatarScaledBlob&&(s={info:this._avatarInfo,name:this._avatarFileName,blob:this._avatarScaledBlob});const i=this._session.createRoom({type:this.isPublic?le.Public:le.Private,name:(e=this._name)!=null?e:void 0,topic:(t=this._topic)!=null?t:void 0,isEncrypted:!this.isPublic&&this._isEncrypted,isFederationDisabled:this._isFederationDisabled,alias:this.isPublic?eg(this._roomAlias):void 0,avatar:s});this.navigation.push("room",i.id)}async selectAvatar(){if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}this._avatarScaledBlob&&this._avatarScaledBlob.dispose(),this._avatarScaledBlob=void 0,this._avatarFileName=void 0,this._avatarInfo=void 0;const e=await this.platform.openFile("image/*");if(!e||!e.blob.mimeType.startsWith("image/")){this.emitChange("hasAvatar");return}let t=await this.platform.loadImage(e.blob);const s=800;if(t.maxDimension>s){const i=await t.scale(s);t.dispose(),t=i}this._avatarScaledBlob=t.blob,this._avatarInfo=Yt(t),this._avatarFileName=e.name,this.emitChange("hasAvatar")}}function eg(n){n.startsWith("#")&&(n=n.substr(1));const e=n.indexOf(":");return e!==-1&&(n=n.substr(0,e)),n}class Pn extends Ee{constructor(e,t){super(null),this._statusSubscription=null,this._sessionViewModel=e,this.id=t}async initialize(){const{session:e}=this._sessionViewModel._client,t=await e.observeRoomStatus(this.id);this.set(await this._statusToViewModel(t.get())),this._statusSubscription=t.subscribe(async s=>{var i;(i=this.get())==null||i.dispose(),this.set(await this._statusToViewModel(s))})}async _statusToViewModel(e){if(e&U.Replaced)if(e&U.BeingCreated){const{session:t}=this._sessionViewModel._client,s=t.roomsBeingCreated.get(this.id);this._sessionViewModel.notifyRoomReplaced(s.id,s.roomId)}else throw new Error("Don't know how to replace a room with this status: "+(e^U.Replaced));else return e&U.BeingCreated?this._sessionViewModel._createRoomBeingCreatedViewModel(this.id):e&U.Invited?this._sessionViewModel._createInviteViewModel(this.id):e&U.Joined?this._sessionViewModel._createRoomViewModelInstance(this.id):e&U.Archived?await this._sessionViewModel._createArchivedRoomViewModel(this.id):this._sessionViewModel._createUnknownRoomViewModel(this.id)}dispose(){var e;this._statusSubscription&&(this._statusSubscription=this._statusSubscription()),this.unsubscribeAll(),(e=this.get())==null||e.dispose()}}class tg extends A{constructor(e){super(e),this._room=e.room,this._onRoomChange=this._onRoomChange.bind(this),this._room.on("change",this._onRoomChange)}get type(){return"room-details"}get shouldShowBackButton(){return!1}get previousSegmentName(){return!1}get roomId(){return this._room.id}get canonicalAlias(){return this._room.canonicalAlias}get name(){return this._room.name}get isEncrypted(){return!!this._room.isEncrypted}get memberCount(){return this._room.joinedMemberCount}get avatarLetter(){return _e(this.name)}get avatarColorNumber(){return ge(this._room.avatarColorId)}avatarUrl(e){return Ue(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}_onRoomChange(){this.emitChange()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange)}openPanel(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}class sg extends A{constructor(e){super(e),this._member=this._options.member,this._mediaRepository=e.mediaRepository,this._previousName=null,this._nameChanged=!0}get name(){return`${this._member.name}${this._disambiguationPart}`}get _disambiguationPart(){return this._disambiguate?` (${this.userId})`:""}get userId(){return this._member.userId}get previousName(){return this._previousName}get nameChanged(){return this._nameChanged}get detailsUrl(){const e=this.navigation.path.get("room").value;return`${this.urlCreator.openRoomActionUrl(e)}/member/${this._member.userId}`}_updatePreviousName(e){const t=this._member.name;t!==e?(this._previousName=t,this._nameChanged=!0):this._nameChanged=!1}setDisambiguation(e){this._disambiguate=e,this.emitChange()}updateFrom(e){this._updatePreviousName(e.name),this._member=e}get avatarLetter(){return _e(this.name)}get avatarColorNumber(){return ge(this.userId)}avatarUrl(e){return Ue(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}}function ig(n){const e=new Intl.Collator,t=s=>s.charAt(0)==="@"?s.slice(1):s;return function(i,r){const o=n.getUserLevel(i.userId),a=n.getUserLevel(r.userId);if(o!==a)return a-o;const l=t(i.name),c=t(r.name);return e.compare(l,c)}}class rg{constructor(){this._map=new Map}_unDisambiguate(e,t){const s=t.indexOf(e);if(s!==-1){const[i]=t.splice(s,1);i.setDisambiguation(!1)}}_handlePreviousName(e){const t=e.previousName;if(typeof t!="string")return;const s=this._map.get(t);if(Array.isArray(s)){if(this._unDisambiguate(e,s),s.length===1){const i=s[0];i.setDisambiguation(!1),this._map.set(t,i)}}else this._map.delete(t)}_updateMap(e){const t=e.name,s=this._map.get(t);if(s){if(Array.isArray(s))return s.findIndex(i=>i.userId===e.userId)!==-1?void 0:(s.push(e),s);if(e.userId!==s.userId){const i=[s,e];return this._map.set(t,i),i}}else this._map.set(t,e)}disambiguate(e){if(!e.nameChanged)return;this._handlePreviousName(e);const t=this._updateMap(e);t?.forEach(s=>s.setDisambiguation(!0))}}class ng extends A{constructor(e){super(e);const t=e.members,s=e.powerLevelsObservable;this.track(s.subscribe(()=>{}));const i=s.get();this.memberTileViewModels=this._mapTileViewModels(t.members.filterValues(r=>r.membership==="join")).sortValues(ig(i)),this.nameDisambiguator=new rg,this.mediaRepository=e.mediaRepository}get type(){return"member-list"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"details"}_mapTileViewModels(e){const t=(i,r)=>{const o=this.mediaRepository,a=new sg(this.childOptions({member:i,emitChange:r,mediaRepository:o}));return this.nameDisambiguator.disambiguate(a),a},s=(i,r,o)=>{i.updateFrom(o),this.nameDisambiguator.disambiguate(i)};return e.mapValues(t,s)}}class og extends A{constructor(e){super(e),this._observableMember=e.observableMember,this._mediaRepository=e.mediaRepository,this._member=this._observableMember.get(),this._isEncrypted=e.isEncrypted,this._powerLevelsObservable=e.powerLevelsObservable,this._session=e.session,this.track(this._powerLevelsObservable.subscribe(()=>this._onPowerLevelsChange())),this.track(this._observableMember.subscribe(()=>this._onMemberChange()))}get name(){return this._member.name}get userId(){return this._member.userId}get type(){return"member-details"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"members"}get role(){return this.powerLevel>=100?this.i18n`Admin`:this.powerLevel>=50?this.i18n`Moderator`:this.powerLevel===0?this.i18n`Default`:this.i18n`Custom (${this.powerLevel})`}_onMemberChange(){this._member=this._observableMember.get(),this.emitChange("member")}_onPowerLevelsChange(){this.emitChange("role")}get avatarLetter(){return _e(this.name)}get avatarColorNumber(){return ge(this.userId)}avatarUrl(e){return Ue(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}get isEncrypted(){return this._isEncrypted}get powerLevel(){var e;return(e=this._powerLevelsObservable.get())==null?void 0:e.getUserLevel(this._member.userId)}get linkToUser(){return`https://matrix.to/#/${encodeURIComponent(this._member.userId)}`}async openDirectMessage(){const e=this._session.findDirectMessageForUserId(this.userId);let t=e?.id;t||(t=(await this._session.createRoom({type:le.DirectMessage,invites:[this.userId]})).id),this.navigation.push("room",t)}}class ag extends A{constructor(e){super(e),this._room=e.room,this._session=e.session,this._members=null,this._setupNavigation()}get activeViewModel(){return this._activeViewModel}async _getMemberListArguments(){this._members||(this._members=await this._room.loadMemberList(),this.track(()=>this._members.release()));const e=this._room,t=await this._room.observePowerLevels();return{members:this._members,powerLevelsObservable:t,mediaRepository:e.mediaRepository}}async _getMemberDetailsArguments(){const t=this.navigation.path.get("member").value,s=await this._room.observeMember(t);if(!s)return!1;const i=this._room.isEncrypted,r=await this._room.observePowerLevels();return{observableMember:s,isEncrypted:i,powerLevelsObservable:r,mediaRepository:this._room.mediaRepository,session:this._session}}_setupNavigation(){this._hookUpdaterToSegment("details",tg,()=>({room:this._room})),this._hookUpdaterToSegment("members",ng,()=>this._getMemberListArguments()),this._hookUpdaterToSegment("member",og,()=>this._getMemberDetailsArguments(),()=>{const e=`${this.urlCreator.urlUntilSegment("room")}/members`;this.urlCreator.pushUrl(e)})}_hookUpdaterToSegment(e,t,s,i){const r=this.navigation.observe(e),o=this._setupUpdater(e,t,s,i);this.track(r.subscribe(o))}_setupUpdater(e,t,s,i){const r=async(o=!1)=>{var a;if(o||(this._activeViewModel=this.disposeTracked(this._activeViewModel)),!!((a=this.navigation.path.get(e))!=null&&a.value)){const c=await s();if(!c&&i){i();return}this._activeViewModel=this.track(new t(this.childOptions(c)))}this.emitChange("activeViewModel")};return r(!0),r}closePanel(){const e=this.navigation.path.until("room");this.navigation.applyPath(e)}showPreviousPanel(){const e=this.activeViewModel.previousSegmentName;if(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}}class lg extends A{constructor(e){super(e);const{client:t}=e;this._client=this.track(t),this._sessionStatusViewModel=this.track(new W_(this.childOptions({sync:t.sync,reconnector:t.reconnector,session:t.session}))),this._leftPanelViewModel=this.track(new Xp(this.childOptions({session:this._client.session}))),this._settingsViewModel=null,this._roomViewModelObservable=null,this._gridViewModel=null,this._createRoomViewModel=null,this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("rooms");this.track(e.subscribe(a=>{this._updateGrid(a)})),e.get()&&this._updateGrid(e.get());const t=this.navigation.observe("room");this.track(t.subscribe(a=>{this._gridViewModel||this._updateRoom(a),this._updateRightPanel()})),this._gridViewModel||this._updateRoom(t.get());const s=this.navigation.observe("settings");this.track(s.subscribe(a=>{this._updateSettings(a)})),this._updateSettings(s.get());const i=this.navigation.observe("create-room");this.track(i.subscribe(a=>{this._updateCreateRoom(a)})),this._updateCreateRoom(i.get());const r=this.navigation.observe("lightbox");this.track(r.subscribe(a=>{this._updateLightbox(a)})),this._updateLightbox(r.get());const o=this.navigation.observe("right-panel");this.track(o.subscribe(()=>this._updateRightPanel())),this._updateRightPanel()}get id(){return this._client.sessionId}start(){this._sessionStatusViewModel.start()}get activeMiddleViewModel(){var e;return((e=this._roomViewModelObservable)==null?void 0:e.get())||this._gridViewModel||this._settingsViewModel||this._createRoomViewModel}get roomGridViewModel(){return this._gridViewModel}get leftPanelViewModel(){return this._leftPanelViewModel}get sessionStatusViewModel(){return this._sessionStatusViewModel}get settingsViewModel(){return this._settingsViewModel}get currentRoomViewModel(){var e;return(e=this._roomViewModelObservable)==null?void 0:e.get()}get rightPanelViewModel(){return this._rightPanelViewModel}get createRoomViewModel(){return this._createRoomViewModel}_updateGrid(e){var t;const s=!(this._gridViewModel&&e),i=this.navigation.path.get("room");if(e)this._gridViewModel?this._gridViewModel.setRoomIds(e):(this._gridViewModel=this.track(new z_(this.childOptions({width:3,height:2,createRoomViewModelObservable:r=>new Pn(this,r)}))),(t=this._roomViewModelObservable)==null||t.unsubscribeAll(),this._gridViewModel.initializeRoomIdsAndTransferVM(e,this._roomViewModelObservable)?this._roomViewModelObservable=this.untrack(this._roomViewModelObservable):this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)));else if(this._gridViewModel&&!e){if(i){const r=this._gridViewModel.releaseRoomViewModel(i.value);r&&(this._roomViewModelObservable=this.track(r),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}))}this._gridViewModel=this.disposeTracked(this._gridViewModel)}s&&this.emitChange("activeMiddleViewModel")}_createRoomViewModelInstance(e){const t=this._client.session.rooms.get(e);if(t){const s=new On(this.childOptions({room:t}));return s.load(),s}return null}_createUnknownRoomViewModel(e){return new K_(this.childOptions({roomIdOrAlias:e,session:this._client.session}))}async _createArchivedRoomViewModel(e){const t=await this._client.session.loadArchivedRoom(e);if(t){const s=new On(this.childOptions({room:t}));return s.load(),s}return null}_createInviteViewModel(e){const t=this._client.session.invites.get(e);return t?new $_(this.childOptions({invite:t,mediaRepository:this._client.session.mediaRepository})):null}_createRoomBeingCreatedViewModel(e){const t=this._client.session.roomsBeingCreated.get(e);return t?new q_(this.childOptions({roomBeingCreated:t,mediaRepository:this._client.session.mediaRepository})):null}_updateRoom(e){var t;if(((t=this._roomViewModelObservable)==null?void 0:t.id)===e)return;if(this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)),!e){this.emitChange("activeMiddleViewModel");return}const s=new Pn(this,e);this._roomViewModelObservable=this.track(s),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}),s.initialize()}_updateSettings(e){this._settingsViewModel&&(this._settingsViewModel=this.disposeTracked(this._settingsViewModel)),e&&(this._settingsViewModel=this.track(new X_(this.childOptions({client:this._client}))),this._settingsViewModel.load()),this.emitChange("activeMiddleViewModel")}_updateCreateRoom(e){this._createRoomViewModel&&(this._createRoomViewModel=this.disposeTracked(this._createRoomViewModel)),e&&(this._createRoomViewModel=this.track(new Z_(this.childOptions({session:this._client.session})))),this.emitChange("activeMiddleViewModel")}_updateLightbox(e){if(this._lightboxViewModel&&(this._lightboxViewModel=this.disposeTracked(this._lightboxViewModel)),e){const t=this._roomFromNavigation();this._lightboxViewModel=this.track(new H_(this.childOptions({eventId:e,room:t})))}this.emitChange("lightboxViewModel")}get lightboxViewModel(){return this._lightboxViewModel}_roomFromNavigation(){var e;const t=(e=this.navigation.path.get("room"))==null?void 0:e.value;return this._client.session.rooms.get(t)}_updateRightPanel(){var e;if(this._rightPanelViewModel=this.disposeTracked(this._rightPanelViewModel),!!((e=this.navigation.path.get("right-panel"))!=null&&e.value)){const s=this._roomFromNavigation();this._rightPanelViewModel=this.track(new ag(this.childOptions({room:s,session:this._client.session})))}this.emitChange("rightPanelViewModel")}notifyRoomReplaced(e,t){this.navigation.push("room",t)}}class cg extends A{constructor(e){super(e),this._accountSetup=e.accountSetup,this._dehydratedDevice=void 0,this._decryptDehydratedDeviceViewModel=void 0,this._accountSetup.encryptedDehydratedDevice&&(this._decryptDehydratedDeviceViewModel=new hg(this,t=>{this._dehydratedDevice=t,this._decryptDehydratedDeviceViewModel=void 0,this.emitChange("deviceDecrypted")}))}get decryptDehydratedDeviceViewModel(){return this._decryptDehydratedDeviceViewModel}get deviceDecrypted(){return!!this._dehydratedDevice}get dehydratedDeviceId(){return this._accountSetup.encryptedDehydratedDevice.deviceId}finish(){this._accountSetup.finish(this._dehydratedDevice)}}class hg extends A{constructor(e,t){super(e.options),this._accountSetupViewModel=e,this._isBusy=!1,this._status=re.SetupKey,this._error=void 0,this._decryptedCallback=t}get decryptAction(){return this.i18n`Restore`}get purpose(){return this.i18n`claim your dehydrated device`}get offerDehydratedDeviceSetup(){return!1}get dehydratedDeviceId(){var e;return(e=this._accountSetupViewModel._dehydratedDevice)==null?void 0:e.deviceId}get isBusy(){return this._isBusy}get backupVersion(){return 0}get status(){return this._status}get error(){var e;return(e=this._error)==null?void 0:e.message}showPhraseSetup(){this._status===re.SetupKey&&(this._status=re.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===re.SetupPhrase&&(this._status=re.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const{encryptedDehydratedDevice:s}=this._accountSetupViewModel._accountSetup,i=await s.decrypt(e,t);this._decryptedCallback(i)}catch(s){console.error(s),this._error=s,this.emitChange("error")}finally{this._isBusy=!1,this.emitChange("")}}enterSecurityPhrase(e){this._enterCredentials(ts.Passphrase,e)}enterSecurityKey(e){this._enterCredentials(ts.RecoveryKey,e)}disable(){}}class aa extends A{constructor(e){super(e);const{client:t,ready:s,homeserver:i,deleteSessionOnCancel:r}=e;this._client=t,this._ready=s,this._homeserver=i,this._deleteSessionOnCancel=r,this._loading=!1,this._error=null,this.backUrl=this.urlCreator.urlForSegment("session",!0),this._accountSetupViewModel=void 0}async start(){if(!this._loading)try{this._loading=!0,this.emitChange("loading"),this._waitHandle=this._client.loadStatus.waitFor(s=>(s===M.AccountSetup?this._accountSetupViewModel=new cg(this.childOptions({accountSetup:this._client.accountSetup})):this._accountSetupViewModel=void 0,this.emitChange("loadLabel"),s===M.FirstSync&&this._client.sync.status.get()===L.CatchupSync||s===M.LoginFailed||s===M.Error||s===M.Ready));try{await this._waitHandle.promise}catch{return}const e=this._client.loadStatus.get(),t=this._client.loadError;if(e===M.FirstSync||e===M.Ready){const s=this._client;this._client=null,this._ready(s)}t&&console.error("session load error",t)}catch(e){this._error=e,console.error("error thrown during session load",e.stack)}finally{this._loading=!1,this.emitChange("loading")}}dispose(){this._client&&(this._client.dispose(),this._client=null),this._waitHandle&&(this._waitHandle.dispose(),this._waitHandle=null)}get loading(){const e=this._client;return e&&e.loadStatus.get()===M.AccountSetup?!1:this._loading}get loadLabel(){const e=this._client,t=this._getError();if(t||e&&e.loadStatus.get()===M.Error)return`Something went wrong: ${t&&t.message}.`;if(e)switch(e.loadStatus.get()){case M.QueryAccount:return"Querying account encryption setup\u2026";case M.AccountSetup:return"";case M.SessionSetup:return"Setting up your encryption keys\u2026";case M.Loading:return"Loading your conversations\u2026";case M.FirstSync:return"Getting your conversations from the server\u2026";default:return this._client.loadStatus.get()}return"Preparing\u2026"}_getError(){var e;return this._error||((e=this._client)==null?void 0:e.loadError)}get hasError(){return!!this._getError()}async exportLogs(){const e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}async logout(){await this._client.logout(),this.navigation.push("session",!0)}get accountSetupViewModel(){return this._accountSetupViewModel}}class dg extends A{constructor(e){super(e);const{loginOptions:t,attemptLogin:s}=e;this._loginOptions=t,this._attemptLogin=s,this._isBusy=!1,this._errorMessage=""}get isBusy(){return this._isBusy}get errorMessage(){return this._errorMessage}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async login(e,t){this._errorMessage="",this.emitChange("errorMessage");const s=await this._attemptLogin(this._loginOptions.password(e,t));let i="";switch(s){case De.Credentials:i=this.i18n`Your username and/or password don't seem to be correct.`;break;case De.Connection:i=this.i18n`Can't connect to ${this._loginOptions.homeserver}.`;break;case De.Unknown:i=this.i18n`Something went wrong while checking your login and password.`;break}i&&this._showError(i)}}class ug extends A{constructor(e){super(e),this._sso=e.loginOptions.sso,this._isBusy=!1}get isBusy(){return this._isBusy}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}async startSSOLogin(){await this.platform.settingsStorage.setString("sso_ongoing_login_homeserver",this._sso.homeserver);const e=this._sso.createSSORedirectURL(this.urlCreator.createSSOCallbackURL());this.platform.openUrl(e)}}class mg extends A{constructor(e){super(e);const{loginToken:t,client:s,attemptLogin:i}=e;this._loginToken=t,this._client=s,this._attemptLogin=i,this._errorMessage="",this.performSSOLoginCompletion()}get errorMessage(){return this._errorMessage}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async performSSOLoginCompletion(){if(!this._loginToken)return;const e=await this.platform.settingsStorage.getString("sso_ongoing_login_homeserver");let t;try{t=await this._client.queryLogin(e).result}catch(r){this._showError(r.message);return}if(!t.token){this.navigation.push("session");return}const s=await this._attemptLogin(t.token(this._loginToken));let i="";switch(s){case De.Credentials:i=this.i18n`Your login token is invalid.`;break;case De.Connection:i=this.i18n`Can't connect to ${e}.`;break;case De.Unknown:i=this.i18n`Something went wrong while checking your login token.`;break}i&&this._showError(i)}}class pg extends A{constructor(e){super(e),this._hideHomeserver=!1,this._isBusy=!1,this._errorMessage="";const{ready:t,defaultHomeserver:s,loginToken:i}=e;this._ready=t,this._loginToken=i,this._client=new rr(this.platform),this._homeserver=s,this._initViewModels()}get passwordLoginViewModel(){return this._passwordLoginViewModel}get startSSOLoginViewModel(){return this._startSSOLoginViewModel}get completeSSOLoginViewModel(){return this._completeSSOLoginViewModel}get homeserver(){return this._homeserver}get resolvedHomeserver(){var e;return(e=this._loginOptions)==null?void 0:e.homeserver}get errorMessage(){return this._errorMessage}get showHomeserver(){return!this._hideHomeserver}get loadViewModel(){return this._loadViewModel}get isBusy(){return this._isBusy}get isFetchingLoginOptions(){return!!this._abortQueryOperation}goBack(){this.navigation.push("session")}_initViewModels(){this._loginToken?(this._hideHomeserver=!0,this._completeSSOLoginViewModel=this.track(new mg(this.childOptions({client:this._client,attemptLogin:e=>this.attemptLogin(e),loginToken:this._loginToken}))),this.emitChange("completeSSOLoginViewModel")):this.queryHomeserver()}_showPasswordLogin(){this._passwordLoginViewModel=this.track(new dg(this.childOptions({loginOptions:this._loginOptions,attemptLogin:e=>this.attemptLogin(e)}))),this.emitChange("passwordLoginViewModel")}_showSSOLogin(){this._startSSOLoginViewModel=this.track(new ug(this.childOptions({loginOptions:this._loginOptions}))),this.emitChange("startSSOLoginViewModel")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}_setBusy(e){var t,s;this._isBusy=e,(t=this._passwordLoginViewModel)==null||t.setBusy(e),(s=this._startSSOLoginViewModel)==null||s.setBusy(e),this.emitChange("isBusy")}async attemptLogin(e){this._setBusy(!0),this._client.startWithLogin(e,{inspectAccountSetup:!0});const t=this._client.loadStatus;return await t.waitFor(r=>r!==M.Login).promise,this._setBusy(!1),t.get()===M.LoginFailed?this._client.loginFailure:(this._hideHomeserver=!0,this.emitChange("hideHomeserver"),this._disposeViewModels(),this._createLoadViewModel(),null)}_createLoadViewModel(){this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription),this._loadViewModel=this.disposeTracked(this._loadViewModel),this._loadViewModel=this.track(new aa(this.childOptions({ready:e=>{this._client=null,this._ready(e)},client:this._client,homeserver:this._homeserver}))),this._loadViewModel.start(),this.emitChange("loadViewModel"),this._loadViewModelSubscription=this.track(this._loadViewModel.disposableOn("change",()=>{this._loadViewModel.loading||(this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription)),this._setBusy(!1)}))}_disposeViewModels(){this._startSSOLoginViewModel=this.disposeTracked(this._startSSOLoginViewModel),this._passwordLoginViewModel=this.disposeTracked(this._passwordLoginViewModel),this._completeSSOLoginViewModel=this.disposeTracked(this._completeSSOLoginViewModel),this.emitChange("disposeViewModels")}async setHomeserver(e){this._homeserver=e,this._loginOptions=void 0,this._queriedHomeserver=void 0,this._showError(""),this._disposeViewModels(),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange("loginViewModels"),this.disposeTracked(this._abortHomeserverQueryTimeout);const t=this.clock.createTimeout(1e3);this._abortHomeserverQueryTimeout=this.track(()=>t.abort());try{await t.elapsed()}catch(s){if(s.name==="AbortError")return;throw s}this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this.queryHomeserver()}async queryHomeserver(){if(!(this._homeserver===this._queriedHomeserver||this._homeserver==="")){this._queriedHomeserver=this._homeserver,this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation);try{const e=this._client.queryLogin(this._homeserver);this._abortQueryOperation=this.track(()=>e.abort()),this.emitChange("isFetchingLoginOptions"),this._loginOptions=await e.result,this.emitChange("resolvedHomeserver")}catch(e){if(e.name==="AbortError")return;this._loginOptions=void 0}finally{this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange("isFetchingLoginOptions")}this._loginOptions?(this._loginOptions.sso&&this._showSSOLogin(),this._loginOptions.password&&this._showPasswordLogin(),!this._loginOptions.sso&&!this._loginOptions.password&&this._showError("This homeserver supports neither SSO nor password based login flows")):this._showError(`Could not query login methods supported by ${this.homeserver}`)}}dispose(){super.dispose(),this._client&&this._client.deleteSession()}}class _g extends A{constructor(e){super(e),this._sessionId=e.sessionId,this._busy=!1,this._showConfirm=!0,this._error=void 0}get showConfirm(){return this._showConfirm}get busy(){return this._busy}get cancelUrl(){return this.urlCreator.urlForSegment("session",!0)}async logout(){this._busy=!0,this._showConfirm=!1,this.emitChange("busy");try{await new rr(this.platform).startLogout(this._sessionId),this.navigation.push("session",!0)}catch(e){this._error=e,this._busy=!1,this.emitChange("busy")}}get status(){return this._error?this.i18n`Could not log out of device: ${this._error.message}`:this.i18n`Logging out Please don't close the app.`}}class gg extends A{constructor(e,t){super(e),this._pickerVM=t,this._sessionInfo=e.sessionInfo,this._isDeleting=!1,this._isClearing=!1,this._error=null,this._exportDataUrl=null}get error(){return this._error&&this._error.message}get id(){return this._sessionInfo.id}get openUrl(){return this.urlCreator.urlForSegment("session",this.id)}get label(){const{userId:e,comment:t}=this._sessionInfo;return t?`${e} (${t})`:e}get sessionInfo(){return this._sessionInfo}get exportDataUrl(){return this._exportDataUrl}get avatarColorNumber(){return ge(this._sessionInfo.userId)}get avatarInitials(){return _e(this._sessionInfo.userId)}}class fg extends A{constructor(e){super(e),this._sessions=new zi((t,s)=>t.id.localeCompare(s.id)),this._loadViewModel=null,this._error=null}async load(){const e=await this.platform.sessionInfoStorage.getAll();this._sessions.setManyUnsorted(e.map(t=>new gg(this.childOptions({sessionInfo:t}),this)))}get loadViewModel(){return this._loadViewModel}get sessions(){return this._sessions}get cancelUrl(){return this.urlCreator.urlForSegment("login")}}class yg extends A{constructor(e){super(e),this._error=null,this._sessionPickerViewModel=null,this._sessionLoadViewModel=null,this._loginViewModel=null,this._logoutViewModel=null,this._sessionViewModel=null,this._pendingClient=null}async load(){this.track(this.navigation.observe("login").subscribe(()=>this._applyNavigation())),this.track(this.navigation.observe("session").subscribe(()=>this._applyNavigation())),this.track(this.navigation.observe("sso").subscribe(()=>this._applyNavigation())),this._applyNavigation(!0)}async _applyNavigation(e){var t,s,i;const r=this.navigation.path.get("login"),o=(t=this.navigation.path.get("logout"))==null?void 0:t.value,a=(s=this.navigation.path.get("session"))==null?void 0:s.value,l=(i=this.navigation.path.get("sso"))==null?void 0:i.value;if(r)this.activeSection!=="login"&&this._showLogin();else if(o)this.activeSection!=="logout"&&this._showLogout(o);else if(a===!0)this.activeSection!=="picker"&&this._showPicker();else if(a){if(!this._sessionViewModel||this._sessionViewModel.id!==a)if(this._pendingClient&&this._pendingClient.sessionId===a){const c=this._pendingClient;this._pendingClient=null,this._showSession(c)}else this._pendingClient&&(this._pendingClient.dispose(),this._pendingClient=null),this._showSessionLoader(a)}else if(l)this.urlCreator.normalizeUrl(),this.activeSection!=="login"&&this._showLogin(l);else try{if(!(e&&this.urlCreator.tryRestoreLastUrl())){const c=await this.platform.sessionInfoStorage.getAll();c.length===0?this.navigation.push("login"):c.length===1?this.navigation.push("session",c[0].id):this.navigation.push("session")}}catch(c){this._setSection(()=>this._error=c)}}async _showPicker(){this._setSection(()=>{this._sessionPickerViewModel=new fg(this.childOptions())});try{await this._sessionPickerViewModel.load()}catch(e){this._setSection(()=>this._error=e)}}_showLogin(e){this._setSection(()=>{this._loginViewModel=new pg(this.childOptions({defaultHomeserver:this.platform.config.defaultHomeServer,ready:t=>{this._pendingClient=t,this.navigation.push("session",t.sessionId)},loginToken:e}))})}_showLogout(e){this._setSection(()=>{this._logoutViewModel=new _g(this.childOptions({sessionId:e}))})}_showSession(e){this._setSection(()=>{this._sessionViewModel=new lg(this.childOptions({client:e})),this._sessionViewModel.start()})}_showSessionLoader(e){const t=new rr(this.platform);t.startWithExistingSession(e),this._setSection(()=>{this._sessionLoadViewModel=new aa(this.childOptions({client:t,ready:s=>this._showSession(s)})),this._sessionLoadViewModel.start()})}get activeSection(){return this._error?"error":this._sessionViewModel?"session":this._loginViewModel?"login":this._logoutViewModel?"logout":this._sessionPickerViewModel?"picker":this._sessionLoadViewModel?"loading":"redirecting"}_setSection(e){this._error=null,this._sessionPickerViewModel=this.disposeTracked(this._sessionPickerViewModel),this._sessionLoadViewModel=this.disposeTracked(this._sessionLoadViewModel),this._loginViewModel=this.disposeTracked(this._loginViewModel),this._logoutViewModel=this.disposeTracked(this._logoutViewModel),this._sessionViewModel=this.disposeTracked(this._sessionViewModel),e(),this._sessionPickerViewModel&&this.track(this._sessionPickerViewModel),this._sessionLoadViewModel&&this.track(this._sessionLoadViewModel),this._loginViewModel&&this.track(this._loginViewModel),this._logoutViewModel&&this.track(this._logoutViewModel),this._sessionViewModel&&this.track(this._sessionViewModel),this.emitChange("activeSection")}get error(){return this._error}get sessionViewModel(){return this._sessionViewModel}get loginViewModel(){return this._loginViewModel}get logoutViewModel(){return this._logoutViewModel}get sessionPickerViewModel(){return this._sessionPickerViewModel}get sessionLoadViewModel(){return this._sessionLoadViewModel}}const vg=""+new URL("download-sandbox.html",import.meta.url).href,wg=""+new URL("main.js",import.meta.url).href,bg=""+new URL("olm.wasm",import.meta.url).href,Sg=""+new URL("olm.js",import.meta.url).href,Ig=""+new URL("olm_legacy.js",import.meta.url).href;let Ts={},Vn=0;function Eg(n,e){return new Promise((t,s)=>{let i=document.getElementsByClassName(n)[0];i?(clearInterval(Ts[n]),t(i)):Ts[n]=setInterval(()=>{let r=document.getElementsByClassName(n)[0];r?(clearInterval(Ts[n]),t(r)):Vn++,e!==-1&&Vn>=e&&(clearInterval(Ts[n]),s(`Can't find elem with className ${n}`))},100)})}const Un="resizerSize";let Bt={};async function Fn(n,e){Eg(e,-1).then(r=>{if(Bt[e]=r,!Bt[e]?.getElementsByClassName("hydrogen-resizer")[0]){let o=document.createElement("div");o.classList.add("hydrogen-resizer"),Bt[e]?.prepend(o),o.addEventListener("mousedown",t,!1);let a=localStorage.getItem(`${n}-${Un}`);a!==null&&(Bt[e].style.height=a)}}).catch(r=>{console.error(r)});function t(){window.addEventListener("mousemove",s,!1),window.addEventListener("mouseup",i,!1)}function s(r){document.body.style.userSelect="none",r.stopPropagation();const o=Math.min(Math.max(window.innerHeight-r.clientY,150),window.innerHeight-100)+"px";let a=Bt[e];a&&(a.style.height=o),localStorage.setItem(`${n}-${Un}`,o)}function i(r){document.body.style.userSelect="initial",r.stopPropagation(),window.removeEventListener("mousemove",s,!1),window.removeEventListener("mouseup",i,!1)}}const kg={downloadSandbox:vg,worker:wg,olm:{wasm:bg,legacyBundle:Ig,wasmBundle:Sg}};async function Rg(n){const e=document.querySelector("#hydrogen"),t={push:{appId:"io.element.hydrogen.web",gatewayUrl:"https://chat.smart4.io",applicationServerKey:"BC-gpSdVHEXhvHSHS0AzzWrQoukv2BE7KzpoPO_FfPacqOo3l1pdqz7rSgmB04pZCWaHPz7XRe6fjLaC-WPDopM"},defaultHomeServer:n||"im.smart4.io",bugReportEndpointUrl:""},s=new Vd({container:e,assetPaths:kg,config:t,options:{development:!1}}),i=Bp();s.setNavigation(i);const r=Kp({navigation:i,history:s.history});r.attach();const o=new yg({platform:s,urlCreator:r,navigation:i});await o.load(),s.createAndMountRootView(o),Fn("list","LeftPanel"),setInterval(()=>{Fn("conversation","RoomView")},10)}humhub.module("hydrogen",function(n){var e=function(){Rg(n.config.matrixServerUrl)},t=function(){};n.export({init:e,unload:t})});
